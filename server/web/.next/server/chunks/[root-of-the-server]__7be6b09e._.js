module.exports=[46786,(e,t,r)=>{t.exports=e.x("os",()=>require("os"))},4446,(e,t,r)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,r)=>{t.exports=e.x("tls",()=>require("tls"))},60438,(e,t,r)=>{t.exports=e.x("perf_hooks",()=>require("perf_hooks"))},47320,e=>{"use strict";let t,r,i,n,o,a,s,c,d,l,u;var p,h,f,m,g,y=e.i(98490),w=e.i(18006),b=e.i(95912),E=e.i(72560),_=e.i(76852),A=e.i(38533),T=e.i(55822),v=e.i(54068),k=e.i(66843),R=e.i(99385),I=e.i(54196),S=e.i(75293),x=e.i(2144),U=e.i(33599),O=e.i(36497),D=e.i(93695);e.i(79178);var C=e.i(96717),N=e.i(23480);let P=Symbol.for("better-auth:global"),L=null,j={},q="1.4.15";function B(){return globalThis[P]||(globalThis[P]={version:q,epoch:1,context:j},L=globalThis[P]),(L=globalThis[P]).version!==q&&(L.version=q,L.epoch++),globalThis[P]}let H=import("node:async_hooks").then(e=>e.AsyncLocalStorage).catch(e=>{if("AsyncLocalStorage"in globalThis)return globalThis.AsyncLocalStorage;throw console.warn("[better-auth] Warning: AsyncLocalStorage is not available in this environment. Some features may not work as expected."),console.warn("[better-auth] Please read more about this warning at https://better-auth.com/docs/installation#mount-handler"),console.warn("[better-auth] If you are using Cloudflare Workers, please see: https://developers.cloudflare.com/workers/configuration/compatibility-flags/#nodejs-compatibility-flag"),e});async function $(){let e=await H;if(null!==e)return e;throw Error("getAsyncLocalStorage is only available in server code")}let M=async()=>{let e=B();if(!e.context.endpointContextAsyncStorage){let t=await $();e.context.endpointContextAsyncStorage=new t}return e.context.endpointContextAsyncStorage};async function z(){let e=(await M()).getStore();if(!e)throw Error("No auth context found. Please make sure you are calling this function within a `runWithEndpointContext` callback.");return e}async function V(e,t){return(await M()).run(e,t)}let K=async()=>{let e=B();if(!e.context.requestStateAsyncStorage){let t=await $();e.context.requestStateAsyncStorage=new t}return e.context.requestStateAsyncStorage};async function W(){return void 0!==(await K()).getStore()}async function F(){let e=(await K()).getStore();if(!e)throw Error("No request state found. Please make sure you are calling this function within a `runWithRequestState` callback.");return e}async function Z(e,t){return(await K()).run(e,t)}function J(e){let t=Object.freeze({});return{get ref(){return t},async get(){let r=await F();if(!r.has(t)){let i=await e();return r.set(t,i),i}return r.get(t)},async set(e){(await F()).set(t,e)}}}let G=async()=>{let e=B();if(!e.context.adapterAsyncStorage){let t=await $();e.context.adapterAsyncStorage=new t}return e.context.adapterAsyncStorage},Y=async e=>G().then(t=>t.getStore()||e).catch(()=>e),Q=async(e,t)=>G().then(r=>r.run(e,t)).catch(e=>{throw e}),X=async(e,t)=>G().then(r=>e.transaction(async e=>r.run(e,t))).catch(e=>{throw e}),{get:ee,set:et}=J(()=>null);var er=e.i(54343);let ei=(0,er.createRandomStringGenerator)("a-z","0-9","A-Z","-_");function en(e,t){"string"==typeof e&&(e=new TextEncoder().encode(e)),"string"==typeof t&&(t=new TextEncoder().encode(t));let r=new Uint8Array(e),i=new Uint8Array(t),n=r.length^i.length,o=Math.max(r.length,i.length);for(let e=0;e<o;e++)n|=(e<r.length?r[e]:0)^(e<i.length?i[e]:0);return 0===n}function eo(e,t=""){if(!Number.isSafeInteger(e)||e<0){let r=t&&`"${t}" `;throw Error(`${r}expected integer >= 0, got ${e}`)}}function ea(e,t,r=""){let i=e instanceof Uint8Array||ArrayBuffer.isView(e)&&"Uint8Array"===e.constructor.name,n=e?.length,o=void 0!==t;if(!i||o&&n!==t)throw Error((r&&`"${r}" `)+"expected Uint8Array"+(o?` of length ${t}`:"")+", got "+(i?`length=${n}`:`type=${typeof e}`));return e}function es(e){if("function"!=typeof e||"function"!=typeof e.create)throw Error("Hash must wrapped by utils.createHasher");eo(e.outputLen),eo(e.blockLen)}function ec(e,t=!0){if(e.destroyed)throw Error("Hash instance has been destroyed");if(t&&e.finished)throw Error("Hash#digest() has already been called")}function ed(e,t){ea(e,void 0,"digestInto() output");let r=t.outputLen;if(e.length<r)throw Error('"digestInto() output" expected to be of length >='+r)}function el(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function eu(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function ep(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function eh(e,t){return e<<32-t|e>>>t}function ef(e,t){return e<<t|e>>>32-t>>>0}let em=68===new Uint8Array(new Uint32Array([0x11223344]).buffer)[0]?e=>e:function(e){for(let r=0;r<e.length;r++){var t;e[r]=(t=e[r])<<24&0xff000000|t<<8&0xff0000|t>>>8&65280|t>>>24&255}return e},eg="function"==typeof Uint8Array.from([]).toHex&&"function"==typeof Uint8Array.fromHex;function ey(e){return e>=48&&e<=57?e-48:e>=65&&e<=70?e-55:e>=97&&e<=102?e-87:void 0}let ew=async()=>{};async function eb(e,t,r){let i=Date.now();for(let n=0;n<e;n++){r(n);let e=Date.now()-i;e>=0&&e<t||(await ew(),i+=e)}}function eE(e,t=""){if("string"==typeof e){if("string"!=typeof e)throw Error("string expected");return new Uint8Array(new TextEncoder().encode(e))}return ea(e,void 0,t)}function e_(e,t){if(void 0!==t&&"[object Object]"!==({}).toString.call(t))throw Error("options must be object or undefined");return Object.assign(e,t)}class eA{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(es(e),ea(t,void 0,"key"),this.iHash=e.create(),"function"!=typeof this.iHash.update)throw Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,i=new Uint8Array(r);i.set(t.length>r?e.create().update(t).digest():t);for(let e=0;e<i.length;e++)i[e]^=54;this.iHash.update(i),this.oHash=e.create();for(let e=0;e<i.length;e++)i[e]^=106;this.oHash.update(i),eu(i)}update(e){return ec(this),this.iHash.update(e),this}digestInto(e){ec(this),ea(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});let{oHash:t,iHash:r,finished:i,destroyed:n,blockLen:o,outputLen:a}=this;return e.finished=i,e.destroyed=n,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}let eT=(e,t,r)=>new eA(e,t).update(r).digest();eT.create=(e,t)=>new eA(e,t);let ev=Uint8Array.of(0),ek=Uint8Array.of(),eR=(e,t,r,i,n)=>{var o;return function(e,t,r,i=32){es(e),eo(i,"length");let n=e.outputLen;if(i>255*n)throw Error("Length must be <= 255*HashLen");let o=Math.ceil(i/n);void 0===r?r=ek:ea(r,void 0,"info");let a=new Uint8Array(o*n),s=eT.create(e,t),c=s._cloneInto(),d=new Uint8Array(s.outputLen);for(let e=0;e<o;e++)ev[0]=e+1,c.update(0===e?ek:d).update(r).update(ev).digestInto(d),a.set(d,n*e),s._cloneInto(c);return s.destroy(),c.destroy(),eu(d,ev),a.slice(0,i)}(e,(o=r,es(e),void 0===o&&(o=new Uint8Array(e.outputLen)),eT(e,o,t)),i,n)};class eI{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,r,i){this.blockLen=e,this.outputLen=t,this.padOffset=r,this.isLE=i,this.buffer=new Uint8Array(e),this.view=ep(this.buffer)}update(e){ec(this),ea(e);let{view:t,buffer:r,blockLen:i}=this,n=e.length;for(let o=0;o<n;){let a=Math.min(i-this.pos,n-o);if(a===i){let t=ep(e);for(;i<=n-o;o+=i)this.process(t,o);continue}r.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){ec(this),ed(e,this),this.finished=!0;let{buffer:t,view:r,blockLen:i,isLE:n}=this,{pos:o}=this;t[o++]=128,eu(this.buffer.subarray(o)),this.padOffset>i-o&&(this.process(r,0),o=0);for(let e=o;e<i;e++)t[e]=0;r.setBigUint64(i-8,BigInt(8*this.length),n),this.process(r,0);let a=ep(e),s=this.outputLen;if(s%4)throw Error("_sha2: outputLen must be aligned to 32bit");let c=s/4,d=this.get();if(c>d.length)throw Error("_sha2: outputLen bigger than state");for(let e=0;e<c;e++)a.setUint32(4*e,d[e],n)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let r=e.slice(0,t);return this.destroy(),r}_cloneInto(e){(e||=new this.constructor).set(...this.get());let{blockLen:t,buffer:r,length:i,finished:n,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=n,e.length=i,e.pos=a,i%t&&e.buffer.set(r),e}clone(){return this._cloneInto()}}let eS=Uint32Array.from([0x6a09e667,0xbb67ae85,0x3c6ef372,0xa54ff53a,0x510e527f,0x9b05688c,0x1f83d9ab,0x5be0cd19]),ex=Uint32Array.from([0xc1059ed8,0x367cd507,0x3070dd17,0xf70e5939,0xffc00b31,0x68581511,0x64f98fa7,0xbefa4fa4]),eU=Uint32Array.from([0xcbbb9d5d,0xc1059ed8,0x629a292a,0x367cd507,0x9159015a,0x3070dd17,0x152fecd8,0xf70e5939,0x67332667,0xffc00b31,0x8eb44a87,0x68581511,0xdb0c2e0d,0x64f98fa7,0x47b5481d,0xbefa4fa4]),eO=Uint32Array.from([0x6a09e667,0xf3bcc908,0xbb67ae85,0x84caa73b,0x3c6ef372,0xfe94f82b,0xa54ff53a,0x5f1d36f1,0x510e527f,0xade682d1,0x9b05688c,0x2b3e6c1f,0x1f83d9ab,0xfb41bd6b,0x5be0cd19,0x137e2179]),eD=BigInt(0x100000000-1),eC=BigInt(32);function eN(e,t=!1){let r=e.length,i=new Uint32Array(r),n=new Uint32Array(r);for(let o=0;o<r;o++){let{h:r,l:a}=function(e,t=!1){return t?{h:Number(e&eD),l:Number(e>>eC&eD)}:{h:0|Number(e>>eC&eD),l:0|Number(e&eD)}}(e[o],t);[i[o],n[o]]=[r,a]}return[i,n]}let eP=Uint32Array.from([0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,0xe49b69c1,0xefbe4786,0xfc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x6ca6351,0x14292967,0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2]),eL=new Uint32Array(64);class ej extends eI{constructor(e){super(64,e,8,!1)}get(){let{A:e,B:t,C:r,D:i,E:n,F:o,G:a,H:s}=this;return[e,t,r,i,n,o,a,s]}set(e,t,r,i,n,o,a,s){this.A=0|e,this.B=0|t,this.C=0|r,this.D=0|i,this.E=0|n,this.F=0|o,this.G=0|a,this.H=0|s}process(e,t){for(let r=0;r<16;r++,t+=4)eL[r]=e.getUint32(t,!1);for(let e=16;e<64;e++){let t=eL[e-15],r=eL[e-2],i=eh(t,7)^eh(t,18)^t>>>3,n=eh(r,17)^eh(r,19)^r>>>10;eL[e]=n+eL[e-7]+i+eL[e-16]|0}let{A:r,B:i,C:n,D:o,E:a,F:s,G:c,H:d}=this;for(let e=0;e<64;e++){var l,u,p,h;let t=d+(eh(a,6)^eh(a,11)^eh(a,25))+((l=a)&s^~l&c)+eP[e]+eL[e]|0,f=(eh(r,2)^eh(r,13)^eh(r,22))+((u=r)&(p=i)^u&(h=n)^p&h)|0;d=c,c=s,s=a,a=o+t|0,o=n,n=i,i=r,r=t+f|0}r=r+this.A|0,i=i+this.B|0,n=n+this.C|0,o=o+this.D|0,a=a+this.E|0,s=s+this.F|0,c=c+this.G|0,d=d+this.H|0,this.set(r,i,n,o,a,s,c,d)}roundClean(){eu(eL)}destroy(){this.set(0,0,0,0,0,0,0,0),eu(this.buffer)}}class eq extends ej{A=0|eS[0];B=0|eS[1];C=0|eS[2];D=0|eS[3];E=0|eS[4];F=0|eS[5];G=0|eS[6];H=0|eS[7];constructor(){super(32)}}let eB=eN(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(e=>BigInt(e))),eH=eB[0],e$=eB[1],eM=new Uint32Array(80),ez=new Uint32Array(80),eV=function(e,t={}){let r=(t,r)=>e(r).update(t).digest(),i=e(void 0);return r.outputLen=i.outputLen,r.blockLen=i.blockLen,r.create=t=>e(t),Object.assign(r,t),Object.freeze(r)}(()=>new eq,{oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,1])}),eK=new TextEncoder,eW=new TextDecoder;function eF(...e){let t=new Uint8Array(e.reduce((e,{length:t})=>e+t,0)),r=0;for(let i of e)t.set(i,r),r+=i.length;return t}function eZ(e,t,r){if(t<0||t>=0x100000000)throw RangeError(`value must be >= 0 and <= ${0x100000000-1}. Received ${t}`);e.set([t>>>24,t>>>16,t>>>8,255&t],r)}function eJ(e){let t=Math.floor(e/0x100000000),r=new Uint8Array(8);return eZ(r,t,0),eZ(r,e%0x100000000,4),r}function eG(e){let t=new Uint8Array(4);return eZ(t,e),t}function eY(e){let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);if(i>127)throw TypeError("non-ASCII string encountered in encode()");t[r]=i}return t}function eQ(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64("string"==typeof e?e:eW.decode(e),{alphabet:"base64url"});let t=e;t instanceof Uint8Array&&(t=eW.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/");try{var r=t;if(Uint8Array.fromBase64)return Uint8Array.fromBase64(r);let e=atob(r),i=new Uint8Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return i}catch{throw TypeError("The input to be decoded is not correctly encoded.")}}function eX(e){let t=e;return("string"==typeof t&&(t=eK.encode(t)),Uint8Array.prototype.toBase64)?t.toBase64({alphabet:"base64url",omitPadding:!0}):(function(e){if(Uint8Array.prototype.toBase64)return e.toBase64();let t=[];for(let r=0;r<e.length;r+=32768)t.push(String.fromCharCode.apply(null,e.subarray(r,r+32768)));return btoa(t.join(""))})(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}e.s(["decode",()=>eQ,"encode",()=>eX],9217);let e0=Symbol();class e1 extends Error{static code="ERR_JOSE_GENERIC";code="ERR_JOSE_GENERIC";constructor(e,t){super(e,t),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}}class e2 extends e1{static code="ERR_JWT_CLAIM_VALIDATION_FAILED";code="ERR_JWT_CLAIM_VALIDATION_FAILED";claim;reason;payload;constructor(e,t,r="unspecified",i="unspecified"){super(e,{cause:{claim:r,reason:i,payload:t}}),this.claim=r,this.reason=i,this.payload=t}}class e5 extends e1{static code="ERR_JWT_EXPIRED";code="ERR_JWT_EXPIRED";claim;reason;payload;constructor(e,t,r="unspecified",i="unspecified"){super(e,{cause:{claim:r,reason:i,payload:t}}),this.claim=r,this.reason=i,this.payload=t}}class e6 extends e1{static code="ERR_JOSE_ALG_NOT_ALLOWED";code="ERR_JOSE_ALG_NOT_ALLOWED"}class e3 extends e1{static code="ERR_JOSE_NOT_SUPPORTED";code="ERR_JOSE_NOT_SUPPORTED"}class e8 extends e1{static code="ERR_JWE_DECRYPTION_FAILED";code="ERR_JWE_DECRYPTION_FAILED";constructor(e="decryption operation failed",t){super(e,t)}}class e4 extends e1{static code="ERR_JWE_INVALID";code="ERR_JWE_INVALID"}class e9 extends e1{static code="ERR_JWS_INVALID";code="ERR_JWS_INVALID"}class e7 extends e1{static code="ERR_JWT_INVALID";code="ERR_JWT_INVALID"}class te extends e1{static code="ERR_JWK_INVALID";code="ERR_JWK_INVALID"}class tt extends e1{static code="ERR_JWKS_INVALID";code="ERR_JWKS_INVALID"}class tr extends e1{static code="ERR_JWKS_NO_MATCHING_KEY";code="ERR_JWKS_NO_MATCHING_KEY";constructor(e="no applicable key found in the JSON Web Key Set",t){super(e,t)}}class ti extends e1{[Symbol.asyncIterator];static code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";constructor(e="multiple matching keys found in the JSON Web Key Set",t){super(e,t)}}class tn extends e1{static code="ERR_JWKS_TIMEOUT";code="ERR_JWKS_TIMEOUT";constructor(e="request timed out",t){super(e,t)}}class to extends e1{static code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";constructor(e="signature verification failed",t){super(e,t)}}function ta(e){switch(e){case"A128GCM":case"A128GCMKW":case"A192GCM":case"A192GCMKW":case"A256GCM":case"A256GCMKW":return 96;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return 128;default:throw new e3(`Unsupported JWE Algorithm: ${e}`)}}function ts(e,t){if(t.length<<3!==ta(e))throw new e4("Invalid Initialization Vector length")}function tc(e,t){let r=e.byteLength<<3;if(r!==t)throw new e4(`Invalid Content Encryption Key length. Expected ${t} bits, got ${r} bits`)}let td=(e,t="algorithm.name")=>TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`);function tl(e){return parseInt(e.name.slice(4),10)}function tu(e,t){if(t&&!e.usages.includes(t))throw TypeError(`CryptoKey does not support this operation, its usages must include ${t}.`)}function tp(e,t,r){switch(t){case"A128GCM":case"A192GCM":case"A256GCM":{if("AES-GCM"!==e.algorithm.name)throw td("AES-GCM");let r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw td(r,"algorithm.length");break}case"A128KW":case"A192KW":case"A256KW":{if("AES-KW"!==e.algorithm.name)throw td("AES-KW");let r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw td(r,"algorithm.length");break}case"ECDH":switch(e.algorithm.name){case"ECDH":case"X25519":break;default:throw td("ECDH or X25519")}break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":if("PBKDF2"!==e.algorithm.name)throw td("PBKDF2");break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":{if("RSA-OAEP"!==e.algorithm.name)throw td("RSA-OAEP");let r=parseInt(t.slice(9),10)||1;if(tl(e.algorithm.hash)!==r)throw td(`SHA-${r}`,"algorithm.hash");break}default:throw TypeError("CryptoKey does not support this operation")}tu(e,r)}function th(e,t,...r){if((r=r.filter(Boolean)).length>2){let t=r.pop();e+=`one of type ${r.join(", ")}, or ${t}.`}else 2===r.length?e+=`one of type ${r[0]} or ${r[1]}.`:e+=`of type ${r[0]}.`;return null==t?e+=` Received ${t}`:"function"==typeof t&&t.name?e+=` Received function ${t.name}`:"object"==typeof t&&null!=t&&t.constructor?.name&&(e+=` Received an instance of ${t.constructor.name}`),e}let tf=(e,...t)=>th("Key must be ",e,...t),tm=(e,t,...r)=>th(`Key for the ${e} algorithm must be `,t,...r);function tg(e){if(!ty(e))throw Error("CryptoKey instance expected")}let ty=e=>{if(e?.[Symbol.toStringTag]==="CryptoKey")return!0;try{return e instanceof CryptoKey}catch{return!1}},tw=e=>e?.[Symbol.toStringTag]==="KeyObject",tb=e=>ty(e)||tw(e);async function tE(e,t,r,i,n){if(!(r instanceof Uint8Array))throw TypeError(tf(r,"Uint8Array"));let o=parseInt(e.slice(1,4),10),a=await crypto.subtle.importKey("raw",r.subarray(o>>3),"AES-CBC",!1,["encrypt"]),s=await crypto.subtle.importKey("raw",r.subarray(0,o>>3),{hash:`SHA-${o<<1}`,name:"HMAC"},!1,["sign"]),c=new Uint8Array(await crypto.subtle.encrypt({iv:i,name:"AES-CBC"},a,t)),d=eF(n,i,c,eJ(n.length<<3));return{ciphertext:c,tag:new Uint8Array((await crypto.subtle.sign("HMAC",s,d)).slice(0,o>>3)),iv:i}}async function t_(e,t,r,i,n){let o;r instanceof Uint8Array?o=await crypto.subtle.importKey("raw",r,"AES-GCM",!1,["encrypt"]):(tp(r,e,"encrypt"),o=r);let a=new Uint8Array(await crypto.subtle.encrypt({additionalData:n,iv:i,name:"AES-GCM",tagLength:128},o,t)),s=a.slice(-16);return{ciphertext:a.slice(0,-16),tag:s,iv:i}}async function tA(e,t,r,i,n){if(!ty(r)&&!(r instanceof Uint8Array))throw TypeError(tf(r,"CryptoKey","KeyObject","Uint8Array","JSON Web Key"));if(i)ts(e,i);else i=crypto.getRandomValues(new Uint8Array(ta(e)>>3));switch(e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return r instanceof Uint8Array&&tc(r,parseInt(e.slice(-3),10)),tE(e,t,r,i,n);case"A128GCM":case"A192GCM":case"A256GCM":return r instanceof Uint8Array&&tc(r,parseInt(e.slice(1,4),10)),t_(e,t,r,i,n);default:throw new e3("Unsupported JWE Content Encryption Algorithm")}}function tT(e,t){if(e.algorithm.length!==parseInt(t.slice(1,4),10))throw TypeError(`Invalid key size for alg: ${t}`)}function tv(e,t,r){return e instanceof Uint8Array?crypto.subtle.importKey("raw",e,"AES-KW",!0,[r]):(tp(e,t,r),e)}async function tk(e,t,r){let i=await tv(t,e,"wrapKey");tT(i,e);let n=await crypto.subtle.importKey("raw",r,{hash:"SHA-256",name:"HMAC"},!0,["sign"]);return new Uint8Array(await crypto.subtle.wrapKey("raw",n,i,"AES-KW"))}async function tR(e,t,r){let i=await tv(t,e,"unwrapKey");tT(i,e);let n=await crypto.subtle.unwrapKey("raw",r,i,"AES-KW",{hash:"SHA-256",name:"HMAC"},!0,["sign"]);return new Uint8Array(await crypto.subtle.exportKey("raw",n))}async function tI(e,t){let r=`SHA-${e.slice(-3)}`;return new Uint8Array(await crypto.subtle.digest(r,t))}function tS(e){return eF(eG(e.length),e)}async function tx(e,t,r){let i=t>>3,n=Math.ceil(i/32),o=new Uint8Array(32*n);for(let t=1;t<=n;t++){let i=new Uint8Array(4+e.length+r.length);i.set(eG(t),0),i.set(e,4),i.set(r,4+e.length);let n=await tI("sha256",i);o.set(n,(t-1)*32)}return o.slice(0,i)}async function tU(e,t,r,i,n=new Uint8Array,o=new Uint8Array){var a;tp(e,"ECDH"),tp(t,"ECDH","deriveBits");let s=eF(tS(eY(r)),tS(n),tS(o),eG(i),new Uint8Array);return tx(new Uint8Array(await crypto.subtle.deriveBits({name:e.algorithm.name,public:e},t,"X25519"===(a=e).algorithm.name?256:Math.ceil(parseInt(a.algorithm.namedCurve.slice(-3),10)/8)<<3)),i,s)}function tO(e){switch(e.algorithm.namedCurve){case"P-256":case"P-384":case"P-521":return!0;default:return"X25519"===e.algorithm.name}}async function tD(e,t,r,i){if(!(e instanceof Uint8Array)||e.length<8)throw new e4("PBES2 Salt Input must be 8 or more octets");let n=eF(eY(t),Uint8Array.of(0),e),o=parseInt(t.slice(13,16),10),a={hash:`SHA-${t.slice(8,11)}`,iterations:r,name:"PBKDF2",salt:n},s=await (i instanceof Uint8Array?crypto.subtle.importKey("raw",i,"PBKDF2",!1,["deriveBits"]):(tp(i,t,"deriveBits"),i));return new Uint8Array(await crypto.subtle.deriveBits(a,s,o))}async function tC(e,t,r,i=2048,n=crypto.getRandomValues(new Uint8Array(16))){let o=await tD(n,e,i,t);return{encryptedKey:await tk(e.slice(-6),o,r),p2c:i,p2s:eX(n)}}async function tN(e,t,r,i,n){let o=await tD(n,e,i,t);return tR(e.slice(-6),o,r)}function tP(e,t){if(e.startsWith("RS")||e.startsWith("PS")){let{modulusLength:r}=t.algorithm;if("number"!=typeof r||r<2048)throw TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}}let tL=e=>{switch(e){case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":return"RSA-OAEP";default:throw new e3(`alg ${e} is not supported either by JOSE or your javascript runtime`)}};async function tj(e,t,r){return tp(t,e,"encrypt"),tP(e,t),new Uint8Array(await crypto.subtle.encrypt(tL(e),t,r))}async function tq(e,t,r){return tp(t,e,"decrypt"),tP(e,t),new Uint8Array(await crypto.subtle.decrypt(tL(e),t,r))}function tB(e){if("object"!=typeof e||null===e||"[object Object]"!==Object.prototype.toString.call(e))return!1;if(null===Object.getPrototypeOf(e))return!0;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}let tH=e=>tB(e)&&"string"==typeof e.kty;async function t$(e){if(!e.alg)throw TypeError('"alg" argument is required when "jwk.alg" is not present');let{algorithm:t,keyUsages:r}=function(e){let t,r;switch(e.kty){case"AKP":switch(e.alg){case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":t={name:e.alg},r=e.priv?["sign"]:["verify"];break;default:throw new e3('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new e3('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"EC":switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},r=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},r=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new e3('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"OKP":switch(e.alg){case"Ed25519":case"EdDSA":t={name:"Ed25519"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new e3('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;default:throw new e3('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}(e),i={...e};return"AKP"!==i.kty&&delete i.alg,delete i.use,crypto.subtle.importKey("jwk",i,t,e.ext??(!e.d&&!e.priv),e.key_ops??r)}let tM=async(e,r,i,n=!1)=>{let o=(t||=new WeakMap).get(e);if(o?.[i])return o[i];let a=await t$({...r,alg:i});return n&&Object.freeze(e),o?o[i]=a:t.set(e,{[i]:a}),a};async function tz(e,r){if(e instanceof Uint8Array||ty(e))return e;if(tw(e)){if("secret"===e.type)return e.export();if("toCryptoKey"in e&&"function"==typeof e.toCryptoKey)try{return((e,r)=>{let i,n=(t||=new WeakMap).get(e);if(n?.[r])return n[r];let o="public"===e.type,a=!!o;if("x25519"===e.asymmetricKeyType){switch(r){case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":break;default:throw TypeError("given KeyObject instance cannot be used for this algorithm")}i=e.toCryptoKey(e.asymmetricKeyType,a,o?[]:["deriveBits"])}if("ed25519"===e.asymmetricKeyType){if("EdDSA"!==r&&"Ed25519"!==r)throw TypeError("given KeyObject instance cannot be used for this algorithm");i=e.toCryptoKey(e.asymmetricKeyType,a,[o?"verify":"sign"])}switch(e.asymmetricKeyType){case"ml-dsa-44":case"ml-dsa-65":case"ml-dsa-87":if(r!==e.asymmetricKeyType.toUpperCase())throw TypeError("given KeyObject instance cannot be used for this algorithm");i=e.toCryptoKey(e.asymmetricKeyType,a,[o?"verify":"sign"])}if("rsa"===e.asymmetricKeyType){let t;switch(r){case"RSA-OAEP":t="SHA-1";break;case"RS256":case"PS256":case"RSA-OAEP-256":t="SHA-256";break;case"RS384":case"PS384":case"RSA-OAEP-384":t="SHA-384";break;case"RS512":case"PS512":case"RSA-OAEP-512":t="SHA-512";break;default:throw TypeError("given KeyObject instance cannot be used for this algorithm")}if(r.startsWith("RSA-OAEP"))return e.toCryptoKey({name:"RSA-OAEP",hash:t},a,o?["encrypt"]:["decrypt"]);i=e.toCryptoKey({name:r.startsWith("PS")?"RSA-PSS":"RSASSA-PKCS1-v1_5",hash:t},a,[o?"verify":"sign"])}if("ec"===e.asymmetricKeyType){let t=new Map([["prime256v1","P-256"],["secp384r1","P-384"],["secp521r1","P-521"]]).get(e.asymmetricKeyDetails?.namedCurve);if(!t)throw TypeError("given KeyObject instance cannot be used for this algorithm");"ES256"===r&&"P-256"===t&&(i=e.toCryptoKey({name:"ECDSA",namedCurve:t},a,[o?"verify":"sign"])),"ES384"===r&&"P-384"===t&&(i=e.toCryptoKey({name:"ECDSA",namedCurve:t},a,[o?"verify":"sign"])),"ES512"===r&&"P-521"===t&&(i=e.toCryptoKey({name:"ECDSA",namedCurve:t},a,[o?"verify":"sign"])),r.startsWith("ECDH-ES")&&(i=e.toCryptoKey({name:"ECDH",namedCurve:t},a,o?[]:["deriveBits"]))}if(!i)throw TypeError("given KeyObject instance cannot be used for this algorithm");return n?n[r]=i:t.set(e,{[r]:i}),i})(e,r)}catch(e){if(e instanceof TypeError)throw e}let i=e.export({format:"jwk"});return tM(e,i,r)}if(tH(e))return e.k?eQ(e.k):tM(e,e,r,!0);throw Error("unreachable")}function tV(e){switch(e){case"A128GCM":return 128;case"A192GCM":return 192;case"A256GCM":case"A128CBC-HS256":return 256;case"A192CBC-HS384":return 384;case"A256CBC-HS512":return 512;default:throw new e3(`Unsupported JWE Algorithm: ${e}`)}}let tK=e=>crypto.getRandomValues(new Uint8Array(tV(e)>>3));async function tW(e){if(tw(e))if("secret"!==e.type)return e.export({format:"jwk"});else e=e.export();if(e instanceof Uint8Array)return{kty:"oct",k:eX(e)};if(!ty(e))throw TypeError(tf(e,"CryptoKey","KeyObject","Uint8Array"));if(!e.extractable)throw TypeError("non-extractable CryptoKey cannot be exported as a JWK");let{ext:t,key_ops:r,alg:i,use:n,...o}=await crypto.subtle.exportKey("jwk",e);return"AKP"===o.kty&&(o.alg=i),o}async function tF(e){return tW(e)}async function tZ(e,t){if(!(e instanceof Uint8Array))throw TypeError("First argument must be a buffer");if(!(t instanceof Uint8Array))throw TypeError("Second argument must be a buffer");let r={name:"HMAC",hash:"SHA-256"},i=await crypto.subtle.generateKey(r,!1,["sign"]),n=new Uint8Array(await crypto.subtle.sign(r,i,e)),o=new Uint8Array(await crypto.subtle.sign(r,i,t)),a=0,s=-1;for(;++s<32;)a|=n[s]^o[s];return 0===a}async function tJ(e,t,r,i,n,o){let a,s;if(!(t instanceof Uint8Array))throw TypeError(tf(t,"Uint8Array"));let c=parseInt(e.slice(1,4),10),d=await crypto.subtle.importKey("raw",t.subarray(c>>3),"AES-CBC",!1,["decrypt"]),l=await crypto.subtle.importKey("raw",t.subarray(0,c>>3),{hash:`SHA-${c<<1}`,name:"HMAC"},!1,["sign"]),u=eF(o,i,r,eJ(o.length<<3)),p=new Uint8Array((await crypto.subtle.sign("HMAC",l,u)).slice(0,c>>3));try{a=await tZ(n,p)}catch{}if(!a)throw new e8;try{s=new Uint8Array(await crypto.subtle.decrypt({iv:i,name:"AES-CBC"},d,r))}catch{}if(!s)throw new e8;return s}async function tG(e,t,r,i,n,o){let a;t instanceof Uint8Array?a=await crypto.subtle.importKey("raw",t,"AES-GCM",!1,["decrypt"]):(tp(t,e,"decrypt"),a=t);try{return new Uint8Array(await crypto.subtle.decrypt({additionalData:o,iv:i,name:"AES-GCM",tagLength:128},a,eF(r,n)))}catch{throw new e8}}async function tY(e,t,r,i,n,o){if(!ty(t)&&!(t instanceof Uint8Array))throw TypeError(tf(t,"CryptoKey","KeyObject","Uint8Array","JSON Web Key"));if(!i)throw new e4("JWE Initialization Vector missing");if(!n)throw new e4("JWE Authentication Tag missing");switch(ts(e,i),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return t instanceof Uint8Array&&tc(t,parseInt(e.slice(-3),10)),tJ(e,t,r,i,n,o);case"A128GCM":case"A192GCM":case"A256GCM":return t instanceof Uint8Array&&tc(t,parseInt(e.slice(1,4),10)),tG(e,t,r,i,n,o);default:throw new e3("Unsupported JWE Content Encryption Algorithm")}}async function tQ(e,t,r,i){let n=e.slice(0,7),o=await tA(n,r,t,i,new Uint8Array);return{encryptedKey:o.ciphertext,iv:eX(o.iv),tag:eX(o.tag)}}async function tX(e,t,r,i,n){return tY(e.slice(0,7),t,r,i,n,new Uint8Array)}async function t0(e,t,r,i,n={}){let o,a,s;switch(e){case"dir":s=r;break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{let c;if(tg(r),!tO(r))throw new e3("ECDH with the provided key is not allowed or not supported by your javascript runtime");let{apu:d,apv:l}=n;c=n.epk?await tz(n.epk,e):(await crypto.subtle.generateKey(r.algorithm,!0,["deriveBits"])).privateKey;let{x:u,y:p,crv:h,kty:f}=await tF(c),m=await tU(r,c,"ECDH-ES"===e?t:e,"ECDH-ES"===e?tV(t):parseInt(e.slice(-5,-2),10),d,l);if(a={epk:{x:u,crv:h,kty:f}},"EC"===f&&(a.epk.y=p),d&&(a.apu=eX(d)),l&&(a.apv=eX(l)),"ECDH-ES"===e){s=m;break}s=i||tK(t);let g=e.slice(-6);o=await tk(g,m,s);break}case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":s=i||tK(t),tg(r),o=await tj(e,r,s);break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{s=i||tK(t);let{p2c:c,p2s:d}=n;({encryptedKey:o,...a}=await tC(e,r,s,c,d));break}case"A128KW":case"A192KW":case"A256KW":s=i||tK(t),o=await tk(e,r,s);break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{s=i||tK(t);let{iv:c}=n;({encryptedKey:o,...a}=await tQ(e,r,s,c));break}default:throw new e3('Invalid or unsupported "alg" (JWE Algorithm) header value')}return{cek:s,encryptedKey:o,parameters:a}}function t1(...e){let t,r=e.filter(Boolean);if(0===r.length||1===r.length)return!0;for(let e of r){let r=Object.keys(e);if(!t||0===t.size){t=new Set(r);continue}for(let e of r){if(t.has(e))return!1;t.add(e)}}return!0}function t2(e,t,r,i,n){let o;if(void 0!==n.crit&&i?.crit===void 0)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!i||void 0===i.crit)return new Set;if(!Array.isArray(i.crit)||0===i.crit.length||i.crit.some(e=>"string"!=typeof e||0===e.length))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');for(let a of(o=void 0!==r?new Map([...Object.entries(r),...t.entries()]):t,i.crit)){if(!o.has(a))throw new e3(`Extension Header Parameter "${a}" is not recognized`);if(void 0===n[a])throw new e(`Extension Header Parameter "${a}" is missing`);if(o.get(a)&&void 0===i[a])throw new e(`Extension Header Parameter "${a}" MUST be integrity protected`)}return new Set(i.crit)}let t5=e=>e?.[Symbol.toStringTag],t6=(e,t,r)=>{if(void 0!==t.use){let e;switch(r){case"sign":case"verify":e="sig";break;case"encrypt":case"decrypt":e="enc"}if(t.use!==e)throw TypeError(`Invalid key for this operation, its "use" must be "${e}" when present`)}if(void 0!==t.alg&&t.alg!==e)throw TypeError(`Invalid key for this operation, its "alg" must be "${e}" when present`);if(Array.isArray(t.key_ops)){let i;switch(!0){case"sign"===r||"verify"===r:case"dir"===e:case e.includes("CBC-HS"):i=r;break;case e.startsWith("PBES2"):i="deriveBits";break;case/^A\d{3}(?:GCM)?(?:KW)?$/.test(e):i=!e.includes("GCM")&&e.endsWith("KW")?"encrypt"===r?"wrapKey":"unwrapKey":r;break;case"encrypt"===r&&e.startsWith("RSA"):i="wrapKey";break;case"decrypt"===r:i=e.startsWith("RSA")?"unwrapKey":"deriveBits"}if(i&&t.key_ops?.includes?.(i)===!1)throw TypeError(`Invalid key for this operation, its "key_ops" must include "${i}" when present`)}return!0};function t3(e,t,r){switch(e.substring(0,2)){case"A1":case"A2":case"di":case"HS":case"PB":((e,t,r)=>{if(!(t instanceof Uint8Array)){if(tH(t)){if("oct"===t.kty&&"string"==typeof t.k&&t6(e,t,r))return;throw TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!tb(t))throw TypeError(tm(e,t,"CryptoKey","KeyObject","JSON Web Key","Uint8Array"));if("secret"!==t.type)throw TypeError(`${t5(t)} instances for symmetric algorithms must be of type "secret"`)}})(e,t,r);break;default:((e,t,r)=>{if(tH(t))switch(r){case"decrypt":case"sign":if("oct"!==t.kty&&("AKP"===t.kty&&"string"==typeof t.priv||"string"==typeof t.d)&&t6(e,t,r))return;throw TypeError("JSON Web Key for this operation must be a private JWK");case"encrypt":case"verify":if("oct"!==t.kty&&void 0===t.d&&void 0===t.priv&&t6(e,t,r))return;throw TypeError("JSON Web Key for this operation must be a public JWK")}if(!tb(t))throw TypeError(tm(e,t,"CryptoKey","KeyObject","JSON Web Key"));if("secret"===t.type)throw TypeError(`${t5(t)} instances for asymmetric algorithms must not be of type "secret"`);if("public"===t.type)switch(r){case"sign":throw TypeError(`${t5(t)} instances for asymmetric algorithm signing must be of type "private"`);case"decrypt":throw TypeError(`${t5(t)} instances for asymmetric algorithm decryption must be of type "private"`)}if("private"===t.type)switch(r){case"verify":throw TypeError(`${t5(t)} instances for asymmetric algorithm verifying must be of type "public"`);case"encrypt":throw TypeError(`${t5(t)} instances for asymmetric algorithm encryption must be of type "public"`)}})(e,t,r)}}class t8{#e;#t;#r;#i;#n;#o;#a;#s;constructor(e){if(!(e instanceof Uint8Array))throw TypeError("plaintext must be an instance of Uint8Array");this.#e=e}setKeyManagementParameters(e){if(this.#s)throw TypeError("setKeyManagementParameters can only be called once");return this.#s=e,this}setProtectedHeader(e){if(this.#t)throw TypeError("setProtectedHeader can only be called once");return this.#t=e,this}setSharedUnprotectedHeader(e){if(this.#r)throw TypeError("setSharedUnprotectedHeader can only be called once");return this.#r=e,this}setUnprotectedHeader(e){if(this.#i)throw TypeError("setUnprotectedHeader can only be called once");return this.#i=e,this}setAdditionalAuthenticatedData(e){return this.#n=e,this}setContentEncryptionKey(e){if(this.#o)throw TypeError("setContentEncryptionKey can only be called once");return this.#o=e,this}setInitializationVector(e){if(this.#a)throw TypeError("setInitializationVector can only be called once");return this.#a=e,this}async encrypt(e,t){let r,i,n,o,a,s;if(!this.#t&&!this.#i&&!this.#r)throw new e4("either setProtectedHeader, setUnprotectedHeader, or sharedUnprotectedHeader must be called before #encrypt()");if(!t1(this.#t,this.#i,this.#r))throw new e4("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");let c={...this.#t,...this.#i,...this.#r};if(t2(e4,new Map,t?.crit,this.#t,c),void 0!==c.zip)throw new e3('JWE "zip" (Compression Algorithm) Header Parameter is not supported.');let{alg:d,enc:l}=c;if("string"!=typeof d||!d)throw new e4('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("string"!=typeof l||!l)throw new e4('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');if(this.#o&&("dir"===d||"ECDH-ES"===d))throw TypeError(`setContentEncryptionKey cannot be called with JWE "alg" (Algorithm) Header ${d}`);t3("dir"===d?l:d,e,"encrypt");{let n,o=await tz(e,d);({cek:i,encryptedKey:r,parameters:n}=await t0(d,l,o,this.#o,this.#s)),n&&(t&&e0 in t?this.#i?this.#i={...this.#i,...n}:this.setUnprotectedHeader(n):this.#t?this.#t={...this.#t,...n}:this.setProtectedHeader(n))}if(this.#t?a=eY(o=eX(JSON.stringify(this.#t))):(o="",a=new Uint8Array),this.#n){let e=eY(s=eX(this.#n));n=eF(a,eY("."),e)}else n=a;let{ciphertext:u,tag:p,iv:h}=await tA(l,this.#e,i,this.#a,n),f={ciphertext:eX(u)};return h&&(f.iv=eX(h)),p&&(f.tag=eX(p)),r&&(f.encrypted_key=eX(r)),s&&(f.aad=s),this.#t&&(f.protected=o),this.#r&&(f.unprotected=this.#r),this.#i&&(f.header=this.#i),f}}class t4{#c;constructor(e){this.#c=new t8(e)}setContentEncryptionKey(e){return this.#c.setContentEncryptionKey(e),this}setInitializationVector(e){return this.#c.setInitializationVector(e),this}setProtectedHeader(e){return this.#c.setProtectedHeader(e),this}setKeyManagementParameters(e){return this.#c.setKeyManagementParameters(e),this}async encrypt(e,t){let r=await this.#c.encrypt(e,t);return[r.protected,r.encrypted_key,r.iv,r.ciphertext,r.tag].join(".")}}let t9=e=>Math.floor(e.getTime()/1e3),t7=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i;function re(e){let t,r=t7.exec(e);if(!r||r[4]&&r[1])throw TypeError("Invalid time period format");let i=parseFloat(r[2]);switch(r[3].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":t=Math.round(i);break;case"minute":case"minutes":case"min":case"mins":case"m":t=Math.round(60*i);break;case"hour":case"hours":case"hr":case"hrs":case"h":t=Math.round(3600*i);break;case"day":case"days":case"d":t=Math.round(86400*i);break;case"week":case"weeks":case"w":t=Math.round(604800*i);break;default:t=Math.round(0x1e187e0*i)}return"-"===r[1]||"ago"===r[4]?-t:t}function rt(e,t){if(!Number.isFinite(t))throw TypeError(`Invalid ${e} input`);return t}let rr=e=>e.includes("/")?e.toLowerCase():`application/${e.toLowerCase()}`;function ri(e,t,r={}){var i,n;let o,a;try{o=JSON.parse(eW.decode(t))}catch{}if(!tB(o))throw new e7("JWT Claims Set must be a top-level JSON object");let{typ:s}=r;if(s&&("string"!=typeof e.typ||rr(e.typ)!==rr(s)))throw new e2('unexpected "typ" JWT header value',o,"typ","check_failed");let{requiredClaims:c=[],issuer:d,subject:l,audience:u,maxTokenAge:p}=r,h=[...c];for(let e of(void 0!==p&&h.push("iat"),void 0!==u&&h.push("aud"),void 0!==l&&h.push("sub"),void 0!==d&&h.push("iss"),new Set(h.reverse())))if(!(e in o))throw new e2(`missing required "${e}" claim`,o,e,"missing");if(d&&!(Array.isArray(d)?d:[d]).includes(o.iss))throw new e2('unexpected "iss" claim value',o,"iss","check_failed");if(l&&o.sub!==l)throw new e2('unexpected "sub" claim value',o,"sub","check_failed");if(u&&(i=o.aud,n="string"==typeof u?[u]:u,"string"==typeof i?!n.includes(i):!(Array.isArray(i)&&n.some(Set.prototype.has.bind(new Set(i))))))throw new e2('unexpected "aud" claim value',o,"aud","check_failed");switch(typeof r.clockTolerance){case"string":a=re(r.clockTolerance);break;case"number":a=r.clockTolerance;break;case"undefined":a=0;break;default:throw TypeError("Invalid clockTolerance option type")}let{currentDate:f}=r,m=t9(f||new Date);if((void 0!==o.iat||p)&&"number"!=typeof o.iat)throw new e2('"iat" claim must be a number',o,"iat","invalid");if(void 0!==o.nbf){if("number"!=typeof o.nbf)throw new e2('"nbf" claim must be a number',o,"nbf","invalid");if(o.nbf>m+a)throw new e2('"nbf" claim timestamp check failed',o,"nbf","check_failed")}if(void 0!==o.exp){if("number"!=typeof o.exp)throw new e2('"exp" claim must be a number',o,"exp","invalid");if(o.exp<=m-a)throw new e5('"exp" claim timestamp check failed',o,"exp","check_failed")}if(p){let e=m-o.iat;if(e-a>("number"==typeof p?p:re(p)))throw new e5('"iat" claim timestamp check failed (too far in the past)',o,"iat","check_failed");if(e<0-a)throw new e2('"iat" claim timestamp check failed (it should be in the past)',o,"iat","check_failed")}return o}class rn{#d;constructor(e){if(!tB(e))throw TypeError("JWT Claims Set MUST be an object");this.#d=structuredClone(e)}data(){return eK.encode(JSON.stringify(this.#d))}get iss(){return this.#d.iss}set iss(e){this.#d.iss=e}get sub(){return this.#d.sub}set sub(e){this.#d.sub=e}get aud(){return this.#d.aud}set aud(e){this.#d.aud=e}set jti(e){this.#d.jti=e}set nbf(e){"number"==typeof e?this.#d.nbf=rt("setNotBefore",e):e instanceof Date?this.#d.nbf=rt("setNotBefore",t9(e)):this.#d.nbf=t9(new Date)+re(e)}set exp(e){"number"==typeof e?this.#d.exp=rt("setExpirationTime",e):e instanceof Date?this.#d.exp=rt("setExpirationTime",t9(e)):this.#d.exp=t9(new Date)+re(e)}set iat(e){void 0===e?this.#d.iat=t9(new Date):e instanceof Date?this.#d.iat=rt("setIssuedAt",t9(e)):"string"==typeof e?this.#d.iat=rt("setIssuedAt",t9(new Date)+re(e)):this.#d.iat=rt("setIssuedAt",e)}}class ro{#o;#a;#s;#t;#l;#u;#p;#h;constructor(e={}){this.#h=new rn(e)}setIssuer(e){return this.#h.iss=e,this}setSubject(e){return this.#h.sub=e,this}setAudience(e){return this.#h.aud=e,this}setJti(e){return this.#h.jti=e,this}setNotBefore(e){return this.#h.nbf=e,this}setExpirationTime(e){return this.#h.exp=e,this}setIssuedAt(e){return this.#h.iat=e,this}setProtectedHeader(e){if(this.#t)throw TypeError("setProtectedHeader can only be called once");return this.#t=e,this}setKeyManagementParameters(e){if(this.#s)throw TypeError("setKeyManagementParameters can only be called once");return this.#s=e,this}setContentEncryptionKey(e){if(this.#o)throw TypeError("setContentEncryptionKey can only be called once");return this.#o=e,this}setInitializationVector(e){if(this.#a)throw TypeError("setInitializationVector can only be called once");return this.#a=e,this}replicateIssuerAsHeader(){return this.#l=!0,this}replicateSubjectAsHeader(){return this.#u=!0,this}replicateAudienceAsHeader(){return this.#p=!0,this}async encrypt(e,t){let r=new t4(this.#h.data());return this.#t&&(this.#l||this.#u||this.#p)&&(this.#t={...this.#t,iss:this.#l?this.#h.iss:void 0,sub:this.#u?this.#h.sub:void 0,aud:this.#p?this.#h.aud:void 0}),r.setProtectedHeader(this.#t),this.#a&&r.setInitializationVector(this.#a),this.#o&&r.setContentEncryptionKey(this.#o),this.#s&&r.setKeyManagementParameters(this.#s),r.encrypt(e,t)}}function ra(e,t){let r=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:parseInt(e.slice(-3),10)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case"Ed25519":case"EdDSA":return{name:"Ed25519"};case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":return{name:e};default:throw new e3(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}async function rs(e,t,r){if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw TypeError(tf(t,"CryptoKey","KeyObject","JSON Web Key"));return crypto.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[r])}return!function(e,t,r){switch(t){case"HS256":case"HS384":case"HS512":{if("HMAC"!==e.algorithm.name)throw td("HMAC");let r=parseInt(t.slice(2),10);if(tl(e.algorithm.hash)!==r)throw td(`SHA-${r}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if("RSASSA-PKCS1-v1_5"!==e.algorithm.name)throw td("RSASSA-PKCS1-v1_5");let r=parseInt(t.slice(2),10);if(tl(e.algorithm.hash)!==r)throw td(`SHA-${r}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if("RSA-PSS"!==e.algorithm.name)throw td("RSA-PSS");let r=parseInt(t.slice(2),10);if(tl(e.algorithm.hash)!==r)throw td(`SHA-${r}`,"algorithm.hash");break}case"Ed25519":case"EdDSA":if("Ed25519"!==e.algorithm.name)throw td("Ed25519");break;case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":let i;if(i=e.algorithm,i.name!==t)throw td(t);break;case"ES256":case"ES384":case"ES512":{if("ECDSA"!==e.algorithm.name)throw td("ECDSA");let r=function(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw Error("unreachable")}}(t);if(e.algorithm.namedCurve!==r)throw td(r,"algorithm.namedCurve");break}default:throw TypeError("CryptoKey does not support this operation")}tu(e,r)}(t,e,r),t}async function rc(e,t,r){let i=await rs(e,t,"sign");return tP(e,i),new Uint8Array(await crypto.subtle.sign(ra(e,i.algorithm),i,r))}class rd{#d;#t;#i;constructor(e){if(!(e instanceof Uint8Array))throw TypeError("payload must be an instance of Uint8Array");this.#d=e}setProtectedHeader(e){if(this.#t)throw TypeError("setProtectedHeader can only be called once");return this.#t=e,this}setUnprotectedHeader(e){if(this.#i)throw TypeError("setUnprotectedHeader can only be called once");return this.#i=e,this}async sign(e,t){let r,i,n,o;if(!this.#t&&!this.#i)throw new e9("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!t1(this.#t,this.#i))throw new e9("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let a={...this.#t,...this.#i},s=t2(e9,new Map([["b64",!0]]),t?.crit,this.#t,a),c=!0;if(s.has("b64")&&"boolean"!=typeof(c=this.#t.b64))throw new e9('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:d}=a;if("string"!=typeof d||!d)throw new e9('JWS "alg" (Algorithm) Header Parameter missing or invalid');t3(d,e,"sign"),c?i=eY(r=eX(this.#d)):(i=this.#d,r=""),this.#t?o=eY(n=eX(JSON.stringify(this.#t))):(n="",o=new Uint8Array);let l=eF(o,eY("."),i),u=await tz(e,d),p={signature:eX(await rc(d,u,l)),payload:r};return this.#i&&(p.header=this.#i),this.#t&&(p.protected=n),p}}class rl{#c;constructor(e){this.#c=new rd(e)}setProtectedHeader(e){return this.#c.setProtectedHeader(e),this}async sign(e,t){let r=await this.#c.sign(e,t);if(void 0===r.payload)throw TypeError("use the flattened module for creating JWS with b64: false");return`${r.protected}.${r.payload}.${r.signature}`}}class ru{#t;#h;constructor(e={}){this.#h=new rn(e)}setIssuer(e){return this.#h.iss=e,this}setSubject(e){return this.#h.sub=e,this}setAudience(e){return this.#h.aud=e,this}setJti(e){return this.#h.jti=e,this}setNotBefore(e){return this.#h.nbf=e,this}setExpirationTime(e){return this.#h.exp=e,this}setIssuedAt(e){return this.#h.iat=e,this}setProtectedHeader(e){return this.#t=e,this}async sign(e,t){let r=new rl(this.#h.data());if(r.setProtectedHeader(this.#t),Array.isArray(this.#t?.crit)&&this.#t.crit.includes("b64")&&!1===this.#t.b64)throw new e7("JWTs MUST NOT use unencoded payload");return r.sign(e,t)}}var rp=e.i(9217),rp=rp;let rh=(e,t)=>{if("string"!=typeof e||!e)throw new te(`${t} missing or invalid`)};async function rf(e,t){let r,i;if(tH(e))r=e;else if(tb(e))r=await tF(e);else throw TypeError(tf(e,"CryptoKey","KeyObject","JSON Web Key"));if("sha256"!==(t??="sha256")&&"sha384"!==t&&"sha512"!==t)throw TypeError('digestAlgorithm must one of "sha256", "sha384", or "sha512"');switch(r.kty){case"AKP":rh(r.alg,'"alg" (Algorithm) Parameter'),rh(r.pub,'"pub" (Public key) Parameter'),i={alg:r.alg,kty:r.kty,pub:r.pub};break;case"EC":rh(r.crv,'"crv" (Curve) Parameter'),rh(r.x,'"x" (X Coordinate) Parameter'),rh(r.y,'"y" (Y Coordinate) Parameter'),i={crv:r.crv,kty:r.kty,x:r.x,y:r.y};break;case"OKP":rh(r.crv,'"crv" (Subtype of Key Pair) Parameter'),rh(r.x,'"x" (Public Key) Parameter'),i={crv:r.crv,kty:r.kty,x:r.x};break;case"RSA":rh(r.e,'"e" (Exponent) Parameter'),rh(r.n,'"n" (Modulus) Parameter'),i={e:r.e,kty:r.kty,n:r.n};break;case"oct":rh(r.k,'"k" (Key Value) Parameter'),i={k:r.k,kty:r.kty};break;default:throw new e3('"kty" (Key Type) Parameter missing or unsupported')}let n=eY(JSON.stringify(i));return eX(await tI(t,n))}async function rm(e,t,r){let i;if(!tB(e))throw TypeError("JWK must be an object");switch(t??=e.alg,i??=r?.extractable??e.ext,e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw TypeError('missing "k" (Key Value) Parameter value');return eQ(e.k);case"RSA":if("oth"in e&&void 0!==e.oth)throw new e3('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');return t$({...e,alg:t,ext:i});case"AKP":if("string"!=typeof e.alg||!e.alg)throw TypeError('missing "alg" (Algorithm) Parameter value');if(void 0!==t&&t!==e.alg)throw TypeError("JWK alg and alg option value mismatch");return t$({...e,ext:i});case"EC":case"OKP":return t$({...e,alg:t,ext:i});default:throw new e3('Unsupported "kty" (Key Type) Parameter value')}}async function rg(e,t,r,i,n){switch(e){case"dir":if(void 0!==r)throw new e4("Encountered unexpected JWE Encrypted Key");return t;case"ECDH-ES":if(void 0!==r)throw new e4("Encountered unexpected JWE Encrypted Key");case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{let n,o;if(!tB(i.epk))throw new e4('JOSE Header "epk" (Ephemeral Public Key) missing or invalid');if(tg(t),!tO(t))throw new e3("ECDH with the provided key is not allowed or not supported by your javascript runtime");let a=await rm(i.epk,e);if(tg(a),void 0!==i.apu){if("string"!=typeof i.apu)throw new e4('JOSE Header "apu" (Agreement PartyUInfo) invalid');try{n=eQ(i.apu)}catch{throw new e4("Failed to base64url decode the apu")}}if(void 0!==i.apv){if("string"!=typeof i.apv)throw new e4('JOSE Header "apv" (Agreement PartyVInfo) invalid');try{o=eQ(i.apv)}catch{throw new e4("Failed to base64url decode the apv")}}let s=await tU(a,t,"ECDH-ES"===e?i.enc:e,"ECDH-ES"===e?tV(i.enc):parseInt(e.slice(-5,-2),10),n,o);if("ECDH-ES"===e)return s;if(void 0===r)throw new e4("JWE Encrypted Key missing");return tR(e.slice(-6),s,r)}case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":if(void 0===r)throw new e4("JWE Encrypted Key missing");return tg(t),tq(e,t,r);case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{let o;if(void 0===r)throw new e4("JWE Encrypted Key missing");if("number"!=typeof i.p2c)throw new e4('JOSE Header "p2c" (PBES2 Count) missing or invalid');let a=n?.maxPBES2Count||1e4;if(i.p2c>a)throw new e4('JOSE Header "p2c" (PBES2 Count) out is of acceptable bounds');if("string"!=typeof i.p2s)throw new e4('JOSE Header "p2s" (PBES2 Salt) missing or invalid');try{o=eQ(i.p2s)}catch{throw new e4("Failed to base64url decode the p2s")}return tN(e,t,r,i.p2c,o)}case"A128KW":case"A192KW":case"A256KW":if(void 0===r)throw new e4("JWE Encrypted Key missing");return tR(e,t,r);case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{let n,o;if(void 0===r)throw new e4("JWE Encrypted Key missing");if("string"!=typeof i.iv)throw new e4('JOSE Header "iv" (Initialization Vector) missing or invalid');if("string"!=typeof i.tag)throw new e4('JOSE Header "tag" (Authentication Tag) missing or invalid');try{n=eQ(i.iv)}catch{throw new e4("Failed to base64url decode the iv")}try{o=eQ(i.tag)}catch{throw new e4("Failed to base64url decode the tag")}return tX(e,t,r,n,o)}default:throw new e3('Invalid or unsupported "alg" (JWE Algorithm) header value')}}function ry(e,t){if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)}async function rw(e,t,r){let i,n,o,a,s,c,d;if(!tB(e))throw new e4("Flattened JWE must be an object");if(void 0===e.protected&&void 0===e.header&&void 0===e.unprotected)throw new e4("JOSE Header missing");if(void 0!==e.iv&&"string"!=typeof e.iv)throw new e4("JWE Initialization Vector incorrect type");if("string"!=typeof e.ciphertext)throw new e4("JWE Ciphertext missing or incorrect type");if(void 0!==e.tag&&"string"!=typeof e.tag)throw new e4("JWE Authentication Tag incorrect type");if(void 0!==e.protected&&"string"!=typeof e.protected)throw new e4("JWE Protected Header incorrect type");if(void 0!==e.encrypted_key&&"string"!=typeof e.encrypted_key)throw new e4("JWE Encrypted Key incorrect type");if(void 0!==e.aad&&"string"!=typeof e.aad)throw new e4("JWE AAD incorrect type");if(void 0!==e.header&&!tB(e.header))throw new e4("JWE Shared Unprotected Header incorrect type");if(void 0!==e.unprotected&&!tB(e.unprotected))throw new e4("JWE Per-Recipient Unprotected Header incorrect type");if(e.protected)try{let t=eQ(e.protected);i=JSON.parse(eW.decode(t))}catch{throw new e4("JWE Protected Header is invalid")}if(!t1(i,e.header,e.unprotected))throw new e4("JWE Protected, JWE Unprotected Header, and JWE Per-Recipient Unprotected Header Parameter names must be disjoint");let l={...i,...e.header,...e.unprotected};if(t2(e4,new Map,r?.crit,i,l),void 0!==l.zip)throw new e3('JWE "zip" (Compression Algorithm) Header Parameter is not supported.');let{alg:u,enc:p}=l;if("string"!=typeof u||!u)throw new e4("missing JWE Algorithm (alg) in JWE Header");if("string"!=typeof p||!p)throw new e4("missing JWE Encryption Algorithm (enc) in JWE Header");let h=r&&ry("keyManagementAlgorithms",r.keyManagementAlgorithms),f=r&&ry("contentEncryptionAlgorithms",r.contentEncryptionAlgorithms);if(h&&!h.has(u)||!h&&u.startsWith("PBES2"))throw new e6('"alg" (Algorithm) Header Parameter value not allowed');if(f&&!f.has(p))throw new e6('"enc" (Encryption Algorithm) Header Parameter value not allowed');if(void 0!==e.encrypted_key)try{n=eQ(e.encrypted_key)}catch{throw new e4("Failed to base64url decode the encrypted_key")}let m=!1;"function"==typeof t&&(t=await t(i,e),m=!0),t3("dir"===u?p:u,t,"decrypt");let g=await tz(t,u);try{o=await rg(u,g,n,l,r)}catch(e){if(e instanceof TypeError||e instanceof e4||e instanceof e3)throw e;o=tK(p)}if(void 0!==e.iv)try{a=eQ(e.iv)}catch{throw new e4("Failed to base64url decode the iv")}if(void 0!==e.tag)try{s=eQ(e.tag)}catch{throw new e4("Failed to base64url decode the tag")}let y=void 0!==e.protected?eY(e.protected):new Uint8Array;c=void 0!==e.aad?eF(y,eY("."),eY(e.aad)):y;try{d=eQ(e.ciphertext)}catch{throw new e4("Failed to base64url decode the ciphertext")}let w={plaintext:await tY(p,o,d,a,s,c)};if(void 0!==e.protected&&(w.protectedHeader=i),void 0!==e.aad)try{w.additionalAuthenticatedData=eQ(e.aad)}catch{throw new e4("Failed to base64url decode the aad")}return(void 0!==e.unprotected&&(w.sharedUnprotectedHeader=e.unprotected),void 0!==e.header&&(w.unprotectedHeader=e.header),m)?{...w,key:g}:w}async function rb(e,t,r){if(e instanceof Uint8Array&&(e=eW.decode(e)),"string"!=typeof e)throw new e4("Compact JWE must be a string or Uint8Array");let{0:i,1:n,2:o,3:a,4:s,length:c}=e.split(".");if(5!==c)throw new e4("Invalid Compact JWE");let d=await rw({ciphertext:a,iv:o||void 0,protected:i,tag:s||void 0,encrypted_key:n||void 0},t,r),l={plaintext:d.plaintext,protectedHeader:d.protectedHeader};return"function"==typeof t?{...l,key:d.key}:l}async function rE(e,t,r){let i=await rb(e,t,r),n=ri(i.protectedHeader,i.plaintext,r),{protectedHeader:o}=i;if(void 0!==o.iss&&o.iss!==n.iss)throw new e2('replicated "iss" claim header parameter mismatch',n,"iss","mismatch");if(void 0!==o.sub&&o.sub!==n.sub)throw new e2('replicated "sub" claim header parameter mismatch',n,"sub","mismatch");if(void 0!==o.aud&&JSON.stringify(o.aud)!==JSON.stringify(n.aud))throw new e2('replicated "aud" claim header parameter mismatch',n,"aud","mismatch");let a={payload:n,protectedHeader:o};return"function"==typeof t?{...a,key:i.key}:a}async function r_(e,t,r,i){let n=await rs(e,t,"verify");tP(e,n);let o=ra(e,n.algorithm);try{return await crypto.subtle.verify(o,n,r,i)}catch{return!1}}async function rA(e,t,r){let i,n;if(!tB(e))throw new e9("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new e9('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new e9("JWS Protected Header incorrect type");if(void 0===e.payload)throw new e9("JWS Payload missing");if("string"!=typeof e.signature)throw new e9("JWS Signature missing or incorrect type");if(void 0!==e.header&&!tB(e.header))throw new e9("JWS Unprotected Header incorrect type");let o={};if(e.protected)try{let t=eQ(e.protected);o=JSON.parse(eW.decode(t))}catch{throw new e9("JWS Protected Header is invalid")}if(!t1(o,e.header))throw new e9("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let a={...o,...e.header},s=t2(e9,new Map([["b64",!0]]),r?.crit,o,a),c=!0;if(s.has("b64")&&"boolean"!=typeof(c=o.b64))throw new e9('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:d}=a;if("string"!=typeof d||!d)throw new e9('JWS "alg" (Algorithm) Header Parameter missing or invalid');let l=r&&ry("algorithms",r.algorithms);if(l&&!l.has(d))throw new e6('"alg" (Algorithm) Header Parameter value not allowed');if(c){if("string"!=typeof e.payload)throw new e9("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new e9("JWS Payload must be a string or an Uint8Array instance");let u=!1;"function"==typeof t&&(t=await t(o,e),u=!0),t3(d,t,"verify");let p=eF(void 0!==e.protected?eY(e.protected):new Uint8Array,eY("."),"string"==typeof e.payload?c?eY(e.payload):eK.encode(e.payload):e.payload);try{i=eQ(e.signature)}catch{throw new e9("Failed to base64url decode the signature")}let h=await tz(t,d);if(!await r_(d,h,i,p))throw new to;if(c)try{n=eQ(e.payload)}catch{throw new e9("Failed to base64url decode the payload")}else n="string"==typeof e.payload?eK.encode(e.payload):e.payload;let f={payload:n};return(void 0!==e.protected&&(f.protectedHeader=o),void 0!==e.header&&(f.unprotectedHeader=e.header),u)?{...f,key:h}:f}async function rT(e,t,r){if(e instanceof Uint8Array&&(e=eW.decode(e)),"string"!=typeof e)throw new e9("Compact JWS must be a string or Uint8Array");let{0:i,1:n,2:o,length:a}=e.split(".");if(3!==a)throw new e9("Invalid Compact JWS");let s=await rA({payload:n,protected:i,signature:o},t,r),c={payload:s.payload,protectedHeader:s.protectedHeader};return"function"==typeof t?{...c,key:s.key}:c}async function rv(e,t,r){let i=await rT(e,t,r);if(i.protectedHeader.crit?.includes("b64")&&!1===i.protectedHeader.b64)throw new e7("JWTs MUST NOT use unencoded payload");let n={payload:ri(i.protectedHeader,i.payload,r),protectedHeader:i.protectedHeader};return"function"==typeof t?{...n,key:i.key}:n}async function rk(e,t,r=3600){return await new ru(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(Math.floor(Date.now()/1e3)+r).sign(new TextEncoder().encode(t))}async function rR(e,t){try{return(await rv(e,new TextEncoder().encode(t))).payload}catch{return null}}let rI=new Uint8Array([66,101,116,116,101,114,65,117,116,104,46,106,115,32,71,101,110,101,114,97,116,101,100,32,69,110,99,114,121,112,116,105,111,110,32,75,101,121]),rS="A256CBC-HS512";async function rx(e,t,r,i=3600){let n=eR(eV,new TextEncoder().encode(t),new TextEncoder().encode(r),rI,64),o=await rf({kty:"oct",k:rp.encode(n)},"sha256");return await new ro(e).setProtectedHeader({alg:"dir",enc:rS,kid:o}).setIssuedAt().setExpirationTime((Date.now()/1e3|0)+i).setJti(crypto.randomUUID()).encrypt(n)}async function rU(e,t,r){if(!e)return null;try{let{payload:i}=await rE(e,async({kid:e})=>{let i=eR(eV,new TextEncoder().encode(t),new TextEncoder().encode(r),rI,64);if(void 0===e||e===await rf({kty:"oct",k:rp.encode(i)},"sha256"))return i;throw Error("no matching decryption secret")},{clockTolerance:15,keyManagementAlgorithms:["dir"],contentEncryptionAlgorithms:[rS,"A256GCM"]});return i}catch{return null}}var rO=e.i(6928);let rD=e=>{if("string"==typeof e&&(e=new TextEncoder().encode(e)),0===e.byteLength)return"";let t=new Uint8Array(e),r="";for(let e of t)r+=e.toString(16).padStart(2,"0");return r};function rC(e,t,r,i){var n;let o,{c:a,dkLen:s,DK:c,PRF:d,PRFSalt:l}=function(e,t,r,i){es(e);let{c:n,dkLen:o,asyncTick:a}=e_({dkLen:32,asyncTick:10},i);if(eo(n,"c"),eo(o,"dkLen"),eo(a,"asyncTick"),n<1)throw Error("iterations (c) must be >= 1");let s=eE(t,"password"),c=eE(r,"salt"),d=new Uint8Array(o),l=eT.create(e,s),u=l._cloneInto().update(c);return{c:n,dkLen:o,asyncTick:a,DK:d,PRF:l,PRFSalt:u}}(e,t,r,i),u=new Uint8Array(4),p=ep(u),h=new Uint8Array(d.outputLen);for(let e=1,t=0;t<s;e++,t+=d.outputLen){let r=c.subarray(t,t+d.outputLen);p.setInt32(0,e,!1),(o=l._cloneInto(o)).update(u).digestInto(h),r.set(h.subarray(0,r.length));for(let e=1;e<a;e++){d._cloneInto(o).update(h).digestInto(h);for(let e=0;e<r.length;e++)r[e]^=h[e]}}return n=o,d.destroy(),l.destroy(),n&&n.destroy(),eu(h),c}function rN(e,t,r,i,n,o){let a=e[t++]^r[i++],s=e[t++]^r[i++],c=e[t++]^r[i++],d=e[t++]^r[i++],l=e[t++]^r[i++],u=e[t++]^r[i++],p=e[t++]^r[i++],h=e[t++]^r[i++],f=e[t++]^r[i++],m=e[t++]^r[i++],g=e[t++]^r[i++],y=e[t++]^r[i++],w=e[t++]^r[i++],b=e[t++]^r[i++],E=e[t++]^r[i++],_=e[t++]^r[i++],A=a,T=s,v=c,k=d,R=l,I=u,S=p,x=h,U=f,O=m,D=g,C=y,N=w,P=b,L=E,j=_;for(let e=0;e<8;e+=2)R^=ef(A+N|0,7),U^=ef(R+A|0,9),N^=ef(U+R|0,13),A^=ef(N+U|0,18),O^=ef(I+T|0,7),P^=ef(O+I|0,9),T^=ef(P+O|0,13),I^=ef(T+P|0,18),L^=ef(D+S|0,7),v^=ef(L+D|0,9),S^=ef(v+L|0,13),D^=ef(S+v|0,18),k^=ef(j+C|0,7),x^=ef(k+j|0,9),C^=ef(x+k|0,13),j^=ef(C+x|0,18),T^=ef(A+k|0,7),v^=ef(T+A|0,9),k^=ef(v+T|0,13),A^=ef(k+v|0,18),S^=ef(I+R|0,7),x^=ef(S+I|0,9),R^=ef(x+S|0,13),I^=ef(R+x|0,18),C^=ef(D+O|0,7),U^=ef(C+D|0,9),O^=ef(U+C|0,13),D^=ef(O+U|0,18),N^=ef(j+L|0,7),P^=ef(N+j|0,9),L^=ef(P+N|0,13),j^=ef(L+P|0,18);n[o++]=a+A|0,n[o++]=s+T|0,n[o++]=c+v|0,n[o++]=d+k|0,n[o++]=l+R|0,n[o++]=u+I|0,n[o++]=p+S|0,n[o++]=h+x|0,n[o++]=f+U|0,n[o++]=m+O|0,n[o++]=g+D|0,n[o++]=y+C|0,n[o++]=w+N|0,n[o++]=b+P|0,n[o++]=E+L|0,n[o++]=_+j|0}function rP(e,t,r,i,n){let o=i+0,a=i+16*n;for(let i=0;i<16;i++)r[a+i]=e[t+(2*n-1)*16+i];for(let i=0;i<n;i++,o+=16,t+=16)rN(r,a,e,t,r,o),i>0&&(a+=16),rN(r,o,e,t+=16,r,a)}async function rL(e,t,r){let i,{N:n,r:o,p:a,dkLen:s,blockSize32:c,V:d,B32:l,B:u,tmp:p,blockMixCb:h,asyncTick:f}=function(e,t,r){let{N:i,r:n,p:o,dkLen:a,asyncTick:s,maxmem:c,onProgress:d}=e_({dkLen:32,asyncTick:10,maxmem:0x40000400},r);if(eo(i,"N"),eo(n,"r"),eo(o,"p"),eo(a,"dkLen"),eo(s,"asyncTick"),eo(c,"maxmem"),void 0!==d&&"function"!=typeof d)throw Error("progressCb must be a function");let l=128*n,u=l/4;if(i<=1||(i&i-1)!=0||i>0x100000000)throw Error('"N" expected a power of 2, and 2^1 <= N <= 2^32');if(o<1||o>0x1fffffffe0/l)throw Error('"p" expected integer 1..((2^32 - 1) * 32) / (128 * r)');if(a<1||a>0x1fffffffe0)throw Error('"dkLen" expected integer 1..(2^32 - 1) * 32');if(l*(i+o)>c)throw Error('"maxmem" limit was hit, expected 128*r*(N+p) <= "maxmem"='+c);let p=rC(eV,e,t,{c:1,dkLen:l*o}),h=el(p),f=el(new Uint8Array(l*i)),m=el(new Uint8Array(l)),g=()=>{};if(d){let e=2*i*o,t=Math.max(Math.floor(e/1e4),1),r=0;g=()=>{r++,d&&(!(r%t)||r===e)&&d(r/e)}}return{N:i,r:n,p:o,dkLen:a,blockSize32:u,V:f,B32:h,B:p,tmp:m,blockMixCb:g,asyncTick:s}}(e,t,r);em(l);for(let e=0;e<a;e++){let t=c*e;for(let e=0;e<c;e++)d[e]=l[t+e];let r=0;await eb(n-1,f,()=>{rP(d,r,d,r+=c,o),h()}),rP(d,(n-1)*c,l,t,o),h(),await eb(n,f,()=>{let e=(l[t+c-16]&n-1)>>>0;for(let r=0;r<c;r++)p[r]=l[t+r]^d[e*c+r];rP(p,0,l,t,o),h()})}return em(l),i=rC(eV,e,u,{c:1,dkLen:s}),eu(u,d,p),i}async function rj(e,t){return await rL(e.normalize("NFKC"),t,{N:16384,p:1,r:16,dkLen:64,maxmem:0x4000000})}let rq=async e=>{let t=rD(crypto.getRandomValues(new Uint8Array(16))),r=await rj(e,t);return`${t}:${rD(r)}`},rB=async({hash:e,password:t})=>{let[r,i]=e.split(":");if(!r||!i)throw new rO.BetterAuthError("Invalid password hash");return en(await rj(t,r),function(e){if("string"!=typeof e)throw Error("hex string expected, got "+typeof e);if(eg)return Uint8Array.fromHex(e);let t=e.length,r=t/2;if(t%2)throw Error("hex string expected, got unpadded hex of length "+t);let i=new Uint8Array(r);for(let t=0,n=0;t<r;t++,n+=2){let r=ey(e.charCodeAt(n)),o=ey(e.charCodeAt(n+1));if(void 0===r||void 0===o)throw Error('hex string expected, got non-hex character "'+(e[n]+e[n+1])+'" at index '+n);i[t]=16*r+o}return i}(i))};function rH(){let e="u">typeof globalThis&&globalThis.crypto;if(e&&"object"==typeof e.subtle&&null!=e.subtle)return e.subtle;throw Error("crypto.subtle must be defined")}function r$(e){return e?"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"}function rM(e,t,r){let i="",n=0,o=0;for(let r of e)for(n=n<<8|r,o+=8;o>=6;)o-=6,i+=t[n>>o&63];if(o>0&&(i+=t[n<<6-o&63]),r){let e=(4-i.length%4)%4;i+="=".repeat(e)}return i}function rz(e,t){let r=new Map;for(let e=0;e<t.length;e++)r.set(t[e],e);let i=[],n=0,o=0;for(let t of e){if("="===t)break;let e=r.get(t);if(void 0===e)throw Error(`Invalid Base64 character: ${t}`);n=n<<6|e,(o+=6)>=8&&(o-=8,i.push(n>>o&255))}return Uint8Array.from(i)}let rV={encode(e,t={}){let r=r$(!1);return rM("string"==typeof e?new TextEncoder().encode(e):new Uint8Array(e),r,t.padding??!0)},decode(e){"string"!=typeof e&&(e=new TextDecoder().decode(e));let t=r$(e.includes("-")||e.includes("_"));return rz(e,t)}},rK={encode(e,t={}){let r=r$(!0);return rM("string"==typeof e?new TextEncoder().encode(e):new Uint8Array(e),r,t.padding??!0)},decode(e){let t=r$(e.includes("-")||e.includes("_"));return rz(e,t)}};function rW(e,t){return{digest:async r=>{let i=new TextEncoder,n="string"==typeof r?i.encode(r):r,o=await rH().digest(e,n);return"hex"===t?Array.from(new Uint8Array(o)).map(e=>e.toString(16).padStart(2,"0")).join(""):"base64"===t||"base64url"===t||"base64urlnopad"===t?t.includes("url")?rK.encode(o,{padding:"base64urlnopad"!==t}):rV.encode(o):o}}}function rF(e){if("boolean"!=typeof e)throw Error(`boolean expected, not ${e}`)}function rZ(e){if(!Number.isSafeInteger(e)||e<0)throw Error("positive integer expected, got "+e)}function rJ(e,t,r=""){let i=e instanceof Uint8Array||ArrayBuffer.isView(e)&&"Uint8Array"===e.constructor.name,n=e?.length,o=void 0!==t;if(!i||o&&n!==t)throw Error((r&&`"${r}" `)+"expected Uint8Array"+(o?` of length ${t}`:"")+", got "+(i?`length=${n}`:`type=${typeof e}`));return e}function rG(e,t=!0){if(e.destroyed)throw Error("Hash instance has been destroyed");if(t&&e.finished)throw Error("Hash#digest() has already been called")}function rY(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function rQ(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}let rX=68===new Uint8Array(new Uint32Array([0x11223344]).buffer)[0],r0="function"==typeof Uint8Array.from([]).toHex&&"function"==typeof Uint8Array.fromHex,r1=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function r2(e){return e>=48&&e<=57?e-48:e>=65&&e<=70?e-55:e>=97&&e<=102?e-87:void 0}function r5(e,t,r=!0){if(void 0===t)return new Uint8Array(e);if(t.length!==e)throw Error('"output" expected Uint8Array of length '+e+", got: "+t.length);if(r&&t.byteOffset%4!=0)throw Error("invalid output, must be aligned");return t}function r6(e){return Uint8Array.from(e)}function r3(e=32){let t="object"==typeof globalThis?globalThis.crypto:null;if("function"!=typeof t?.getRandomValues)throw Error("crypto.getRandomValues must be defined");return t.getRandomValues(new Uint8Array(e))}function r8(e,t=r3){let{nonceLength:r}=e;rZ(r);let i=(e,t)=>{let r=function(...e){let t=0;for(let r=0;r<e.length;r++){let i=e[r];rJ(i),t+=i.length}let r=new Uint8Array(t);for(let t=0,i=0;t<e.length;t++){let n=e[t];r.set(n,i),i+=n.length}return r}(e,t);return t.fill(0),r};return(n,...o)=>({encrypt(a){rJ(a);let s=t(r),c=e(n,s,...o).encrypt(a);return c instanceof Promise?c.then(e=>i(s,e)):i(s,c)},decrypt(t){rJ(t);let i=t.subarray(0,r),a=t.subarray(r);return e(n,i,...o).decrypt(a)}})}let r4=e=>Uint8Array.from(e.split(""),e=>e.charCodeAt(0)),r9=r4("expand 16-byte k"),r7=r4("expand 32-byte k"),ie=rY(r9),it=rY(r7);function ir(e,t){return e<<t|e>>>32-t}function ii(e){return e.byteOffset%4==0}let io=0x100000000-1,ia=Uint32Array.of();function is(e,t){let{allowShortKeys:r,extendNonceFn:i,counterLength:n,counterRight:o,rounds:a}=function(e,t){if(null==t||"object"!=typeof t)throw Error("options must be defined");return Object.assign(e,t)}({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if("function"!=typeof e)throw Error("core must be a function");return rZ(n),rZ(a),rF(o),rF(r),(t,s,c,d,l=0)=>{let u,p;rJ(t,void 0,"key"),rJ(s,void 0,"nonce"),rJ(c,void 0,"data");let h=c.length;if(void 0===d&&(d=new Uint8Array(h)),rJ(d,void 0,"output"),rZ(l),l<0||l>=io)throw Error("arx: counter overflow");if(d.length<h)throw Error(`arx: output (${d.length}) is shorter than data (${h})`);let f=[],m=t.length;if(32===m)f.push(u=r6(t)),p=it;else if(16===m&&r)(u=new Uint8Array(32)).set(t),u.set(t,16),p=ie,f.push(u);else throw rJ(t,32,"arx key"),Error("invalid key size");ii(s)||f.push(s=r6(s));let g=rY(u);if(i){if(24!==s.length)throw Error("arx: extended nonce must be 24 bytes");i(p,g,rY(s.subarray(0,16)),g),s=s.subarray(16)}let y=16-n;if(y!==s.length)throw Error(`arx: nonce must be ${y} or 16 bytes`);if(12!==y){let e=new Uint8Array(12);e.set(s,o?0:12-s.length),s=e,f.push(s)}return!function(e,t,r,i,n,o,a,s){let c=n.length,d=new Uint8Array(64),l=rY(d),u=ii(n)&&ii(o),p=u?rY(n):ia,h=u?rY(o):ia;for(let f=0;f<c;a++){if(e(t,r,i,l,a,s),a>=io)throw Error("arx: counter overflow");let m=Math.min(64,c-f);if(u&&64===m){let e=f/4;if(f%4!=0)throw Error("arx: invalid block position");for(let t=0,r;t<16;t++)h[r=e+t]=p[r]^l[t];f+=64;continue}for(let e=0,t;e<m;e++)o[t=f+e]=n[t]^d[e];f+=m}}(e,p,g,rY(s),c,d,l,a),rQ(...f),d}}function ic(e,t){return 255&e[t++]|(255&e[t++])<<8}class id{blockLen=16;outputLen=16;buffer=new Uint8Array(16);r=new Uint16Array(10);h=new Uint16Array(10);pad=new Uint16Array(8);pos=0;finished=!1;constructor(e){const t=ic(e=r6(rJ(e,32,"key")),0),r=ic(e,2),i=ic(e,4),n=ic(e,6),o=ic(e,8),a=ic(e,10),s=ic(e,12),c=ic(e,14);this.r[0]=8191&t,this.r[1]=(t>>>13|r<<3)&8191,this.r[2]=(r>>>10|i<<6)&7939,this.r[3]=(i>>>7|n<<9)&8191,this.r[4]=(n>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|s<<5)&8065,this.r[8]=(s>>>8|c<<8)&8191,this.r[9]=c>>>5&127;for(let t=0;t<8;t++)this.pad[t]=ic(e,16+2*t)}process(e,t,r=!1){let{h:i,r:n}=this,o=n[0],a=n[1],s=n[2],c=n[3],d=n[4],l=n[5],u=n[6],p=n[7],h=n[8],f=n[9],m=ic(e,t+0),g=ic(e,t+2),y=ic(e,t+4),w=ic(e,t+6),b=ic(e,t+8),E=ic(e,t+10),_=ic(e,t+12),A=ic(e,t+14),T=i[0]+(8191&m),v=i[1]+((m>>>13|g<<3)&8191),k=i[2]+((g>>>10|y<<6)&8191),R=i[3]+((y>>>7|w<<9)&8191),I=i[4]+((w>>>4|b<<12)&8191),S=i[5]+(b>>>1&8191),x=i[6]+((b>>>14|E<<2)&8191),U=i[7]+((E>>>11|_<<5)&8191),O=i[8]+((_>>>8|A<<8)&8191),D=i[9]+(A>>>5|2048*!r),C=0,N=0+T*o+5*f*v+5*h*k+5*p*R+5*u*I;C=N>>>13,N&=8191,N+=5*l*S+5*d*x+5*c*U+5*s*O+5*a*D,C+=N>>>13,N&=8191;let P=C+T*a+v*o+5*f*k+5*h*R+5*p*I;C=P>>>13,P&=8191,P+=5*u*S+5*l*x+5*d*U+5*c*O+5*s*D,C+=P>>>13,P&=8191;let L=C+T*s+v*a+k*o+5*f*R+5*h*I;C=L>>>13,L&=8191,L+=5*p*S+5*u*x+5*l*U+5*d*O+5*c*D,C+=L>>>13,L&=8191;let j=C+T*c+v*s+k*a+R*o+5*f*I;C=j>>>13,j&=8191,j+=5*h*S+5*p*x+5*u*U+5*l*O+5*d*D,C+=j>>>13,j&=8191;let q=C+T*d+v*c+k*s+R*a+I*o;C=q>>>13,q&=8191,q+=5*f*S+5*h*x+5*p*U+5*u*O+5*l*D,C+=q>>>13,q&=8191;let B=C+T*l+v*d+k*c+R*s+I*a;C=B>>>13,B&=8191,B+=S*o+5*f*x+5*h*U+5*p*O+5*u*D,C+=B>>>13,B&=8191;let H=C+T*u+v*l+k*d+R*c+I*s;C=H>>>13,H&=8191,H+=S*a+x*o+5*f*U+5*h*O+5*p*D,C+=H>>>13,H&=8191;let $=C+T*p+v*u+k*l+R*d+I*c;C=$>>>13,$&=8191,$+=S*s+x*a+U*o+5*f*O+5*h*D,C+=$>>>13,$&=8191;let M=C+T*h+v*p+k*u+R*l+I*d;C=M>>>13,M&=8191,M+=S*c+x*s+U*a+O*o+5*f*D,C+=M>>>13,M&=8191;let z=C+T*f+v*h+k*p+R*u+I*l;C=z>>>13,z&=8191,z+=S*d+x*c+U*s+O*a+D*o,C+=z>>>13,z&=8191,N=8191&(C=(C=(C<<2)+C|0)+N|0),C>>>=13,P+=C,i[0]=N,i[1]=P,i[2]=L,i[3]=j,i[4]=q,i[5]=B,i[6]=H,i[7]=$,i[8]=M,i[9]=z}finalize(){let{h:e,pad:t}=this,r=new Uint16Array(10),i=e[1]>>>13;e[1]&=8191;for(let t=2;t<10;t++)e[t]+=i,i=e[t]>>>13,e[t]&=8191;e[0]+=5*i,i=e[0]>>>13,e[0]&=8191,e[1]+=i,i=e[1]>>>13,e[1]&=8191,e[2]+=i,r[0]=e[0]+5,i=r[0]>>>13,r[0]&=8191;for(let t=1;t<10;t++)r[t]=e[t]+i,i=r[t]>>>13,r[t]&=8191;r[9]-=8192;let n=(1^i)-1;for(let e=0;e<10;e++)r[e]&=n;n=~n;for(let t=0;t<10;t++)e[t]=e[t]&n|r[t];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=65535&o;for(let r=1;r<8;r++)o=(e[r]+t[r]|0)+(o>>>16)|0,e[r]=65535&o;rQ(r)}update(e){rG(this),rJ(e);let{buffer:t,blockLen:r}=this,i=(e=r6(e)).length;for(let n=0;n<i;){let o=Math.min(r-this.pos,i-n);if(o===r){for(;r<=i-n;n+=r)this.process(e,n);continue}t.set(e.subarray(n,n+o),this.pos),this.pos+=o,n+=o,this.pos===r&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){rQ(this.h,this.r,this.buffer,this.pad)}digestInto(e){rG(this);rJ(e,void 0,"output");let t=this.outputLen;if(e.length<t)throw Error("digestInto() expects output buffer of length at least "+t);this.finished=!0;let{buffer:r,h:i}=this,{pos:n}=this;if(n){for(r[n++]=1;n<16;n++)r[n]=0;this.process(r,0,!0)}this.finalize();let o=0;for(let t=0;t<8;t++)e[o++]=i[t]>>>0,e[o++]=i[t]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let r=e.slice(0,t);return this.destroy(),r}}let il=(f=e=>new id(e),(s=(e,t)=>f(t).update(e).digest()).outputLen=(c=f(new Uint8Array(32))).outputLen,s.blockLen=c.blockLen,s.create=e=>f(e),s);function iu(e,t,r,i,n,o=20){let a=e[0],s=e[1],c=e[2],d=e[3],l=t[0],u=t[1],p=t[2],h=t[3],f=t[4],m=t[5],g=t[6],y=t[7],w=r[0],b=r[1],E=r[2],_=a,A=s,T=c,v=d,k=l,R=u,I=p,S=h,x=f,U=m,O=g,D=y,C=n,N=w,P=b,L=E;for(let e=0;e<o;e+=2)x=x+(C=ir(C^(_=_+k|0),16))|0,_=_+(k=ir(k^x,12))|0,x=x+(C=ir(C^_,8))|0,k=ir(k^x,7),U=U+(N=ir(N^(A=A+R|0),16))|0,A=A+(R=ir(R^U,12))|0,U=U+(N=ir(N^A,8))|0,R=ir(R^U,7),O=O+(P=ir(P^(T=T+I|0),16))|0,T=T+(I=ir(I^O,12))|0,O=O+(P=ir(P^T,8))|0,I=ir(I^O,7),D=D+(L=ir(L^(v=v+S|0),16))|0,v=v+(S=ir(S^D,12))|0,D=D+(L=ir(L^v,8))|0,S=ir(S^D,7),O=O+(L=ir(L^(_=_+R|0),16))|0,_=_+(R=ir(R^O,12))|0,O=O+(L=ir(L^_,8))|0,R=ir(R^O,7),D=D+(C=ir(C^(A=A+I|0),16))|0,A=A+(I=ir(I^D,12))|0,D=D+(C=ir(C^A,8))|0,I=ir(I^D,7),x=x+(N=ir(N^(T=T+S|0),16))|0,T=T+(S=ir(S^x,12))|0,x=x+(N=ir(N^T,8))|0,S=ir(S^x,7),U=U+(P=ir(P^(v=v+k|0),16))|0,v=v+(k=ir(k^U,12))|0,U=U+(P=ir(P^v,8))|0,k=ir(k^U,7);let j=0;i[j++]=a+_|0,i[j++]=s+A|0,i[j++]=c+T|0,i[j++]=d+v|0,i[j++]=l+k|0,i[j++]=u+R|0,i[j++]=p+I|0,i[j++]=h+S|0,i[j++]=f+x|0,i[j++]=m+U|0,i[j++]=g+O|0,i[j++]=y+D|0,i[j++]=n+C|0,i[j++]=w+N|0,i[j++]=b+P|0,i[j++]=E+L|0}let ip=is(iu,{counterRight:!1,counterLength:4,allowShortKeys:!1}),ih=is(iu,{counterRight:!1,counterLength:8,extendNonceFn:function(e,t,r,i){let n=e[0],o=e[1],a=e[2],s=e[3],c=t[0],d=t[1],l=t[2],u=t[3],p=t[4],h=t[5],f=t[6],m=t[7],g=r[0],y=r[1],w=r[2],b=r[3];for(let e=0;e<20;e+=2)p=p+(g=ir(g^(n=n+c|0),16))|0,n=n+(c=ir(c^p,12))|0,p=p+(g=ir(g^n,8))|0,c=ir(c^p,7),h=h+(y=ir(y^(o=o+d|0),16))|0,o=o+(d=ir(d^h,12))|0,h=h+(y=ir(y^o,8))|0,d=ir(d^h,7),f=f+(w=ir(w^(a=a+l|0),16))|0,a=a+(l=ir(l^f,12))|0,f=f+(w=ir(w^a,8))|0,l=ir(l^f,7),m=m+(b=ir(b^(s=s+u|0),16))|0,s=s+(u=ir(u^m,12))|0,m=m+(b=ir(b^s,8))|0,u=ir(u^m,7),f=f+(b=ir(b^(n=n+d|0),16))|0,n=n+(d=ir(d^f,12))|0,f=f+(b=ir(b^n,8))|0,d=ir(d^f,7),m=m+(g=ir(g^(o=o+l|0),16))|0,o=o+(l=ir(l^m,12))|0,m=m+(g=ir(g^o,8))|0,l=ir(l^m,7),p=p+(y=ir(y^(a=a+u|0),16))|0,a=a+(u=ir(u^p,12))|0,p=p+(y=ir(y^a,8))|0,u=ir(u^p,7),h=h+(w=ir(w^(s=s+c|0),16))|0,s=s+(c=ir(c^h,12))|0,h=h+(w=ir(w^s,8))|0,c=ir(c^h,7);let E=0;i[E++]=n,i[E++]=o,i[E++]=a,i[E++]=s,i[E++]=g,i[E++]=y,i[E++]=w,i[E++]=b},allowShortKeys:!1}),im=new Uint8Array(16),ig=(e,t)=>{e.update(t);let r=t.length%16;r&&e.update(im.subarray(r))},iy=new Uint8Array(32);function iw(e,t,r,i,n){var o,a;let s,c;void 0!==n&&rJ(n,void 0,"AAD");let d=e(t,r,iy),l=(o=i.length,a=n?n.length:0,rF(!0),(c=new DataView((s=new Uint8Array(16)).buffer,s.byteOffset,s.byteLength)).setBigUint64(0,BigInt(a),!0),c.setBigUint64(8,BigInt(o),!0),s),u=il.create(d);n&&ig(u,n),ig(u,i),u.update(l);let p=u.digest();return rQ(d,l),p}let ib=e=>(t,r,i)=>({encrypt(n,o){let a=n.length;(o=r5(a+16,o,!1)).set(n);let s=o.subarray(0,-16);e(t,r,s,s,1);let c=iw(e,t,r,s,i);return o.set(c,a),rQ(c),o},decrypt(n,o){o=r5(n.length-16,o,!1);let a=n.subarray(0,-16),s=n.subarray(-16),c=iw(e,t,r,a,i);if(!function(e,t){if(e.length!==t.length)return!1;let r=0;for(let i=0;i<e.length;i++)r|=e[i]^t[i];return 0===r}(s,c))throw Error("invalid tag");return o.set(n.subarray(0,-16)),e(t,r,o,o,1),rQ(c),o}});ib(ip);let iE=((e,t)=>{function r(i,...n){if(rJ(i,void 0,"key"),!rX)throw Error("Non little-endian hardware is not yet supported");void 0!==e.nonceLength&&rJ(n[0],e.varSizeNonce?void 0:e.nonceLength,"nonce");let o=e.tagLength;o&&void 0!==n[1]&&rJ(n[1],void 0,"AAD");let a=t(i,...n),s=(e,t)=>{if(void 0!==t){if(2!==e)throw Error("cipher output not supported");rJ(t,void 0,"output")}},c=!1;return{encrypt(e,t){if(c)throw Error("cannot encrypt() twice with same key + nonce");return c=!0,rJ(e),s(a.encrypt.length,t),a.encrypt(e,t)},decrypt(e,t){if(rJ(e),o&&e.length<o)throw Error('"ciphertext" expected length bigger than tagLength='+o);return s(a.decrypt.length,t),a.decrypt(e,t)}}}return Object.assign(r,e),r})({blockSize:64,nonceLength:24,tagLength:16},ib(ih)),i_={name:"HMAC",hash:"SHA-256"},iA=async({key:e,data:t})=>{let r=await rW("SHA-256").digest(e),i=function(e){if("string"!=typeof e)throw Error("string expected");return new Uint8Array(new TextEncoder().encode(e))}(t);var n=r8(iE)(new Uint8Array(r)).encrypt(i);if(rJ(n),r0)return n.toHex();let o="";for(let e=0;e<n.length;e++)o+=r1[n[e]];return o},iT=async({key:e,data:t})=>{let r=await rW("SHA-256").digest(e),i=function(e){if("string"!=typeof e)throw Error("hex string expected, got "+typeof e);if(r0)return Uint8Array.fromHex(e);let t=e.length,r=t/2;if(t%2)throw Error("hex string expected, got unpadded hex of length "+t);let i=new Uint8Array(r);for(let t=0,n=0;t<r;t++,n+=2){let r=r2(e.charCodeAt(n)),o=r2(e.charCodeAt(n+1));if(void 0===r||void 0===o)throw Error('hex string expected, got non-hex character "'+(e[n]+e[n+1])+'" at index '+n);i[t]=16*r+o}return i}(t),n=r8(iE)(new Uint8Array(r));return new TextDecoder().decode(n.decrypt(i))},iv=async e=>{let t="string"==typeof e?new TextEncoder().encode(e):e;return await rH().importKey("raw",t,i_,!1,["sign","verify"])},ik=async(e,t)=>{let r=await iv(t);return btoa(String.fromCharCode(...new Uint8Array(await rH().sign(i_.name,r,new TextEncoder().encode(e)))))},iR=(e,t="ms")=>new Date(Date.now()+("sec"===t?1e3*e:e));var iI=e.i(99919),iS=e.i(27532);let ix=iS.object({id:iS.string(),createdAt:iS.date().default(()=>new Date),updatedAt:iS.date().default(()=>new Date)});var iU=e.i(58184);let iO=ix.extend({providerId:iS.string(),accountId:iS.string(),userId:iU.coerce.string(),accessToken:iS.string().nullish(),refreshToken:iS.string().nullish(),idToken:iS.string().nullish(),accessTokenExpiresAt:iS.date().nullish(),refreshTokenExpiresAt:iS.date().nullish(),scope:iS.string().nullish(),password:iS.string().nullish()}),iD=iS.object({key:iS.string(),count:iS.number(),lastRequest:iS.number()}),iC=ix.extend({userId:iU.coerce.string(),expiresAt:iS.date(),token:iS.string(),ipAddress:iS.string().nullish(),userAgent:iS.string().nullish()}),iN=ix.extend({email:iS.string().transform(e=>e.toLowerCase()),emailVerified:iS.boolean().default(!1),name:iS.string(),image:iS.string().nullish()}),iP=ix.extend({value:iS.string(),expiresAt:iS.date(),identifier:iS.string()});e.s([],35546);let iL={OK:200,CREATED:201,ACCEPTED:202,NO_CONTENT:204,MULTIPLE_CHOICES:300,MOVED_PERMANENTLY:301,FOUND:302,SEE_OTHER:303,NOT_MODIFIED:304,TEMPORARY_REDIRECT:307,BAD_REQUEST:400,UNAUTHORIZED:401,PAYMENT_REQUIRED:402,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,NOT_ACCEPTABLE:406,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_TIMEOUT:408,CONFLICT:409,GONE:410,LENGTH_REQUIRED:411,PRECONDITION_FAILED:412,PAYLOAD_TOO_LARGE:413,URI_TOO_LONG:414,UNSUPPORTED_MEDIA_TYPE:415,RANGE_NOT_SATISFIABLE:416,EXPECTATION_FAILED:417,"I'M_A_TEAPOT":418,MISDIRECTED_REQUEST:421,UNPROCESSABLE_ENTITY:422,LOCKED:423,FAILED_DEPENDENCY:424,TOO_EARLY:425,UPGRADE_REQUIRED:426,PRECONDITION_REQUIRED:428,TOO_MANY_REQUESTS:429,REQUEST_HEADER_FIELDS_TOO_LARGE:431,UNAVAILABLE_FOR_LEGAL_REASONS:451,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505,VARIANT_ALSO_NEGOTIATES:506,INSUFFICIENT_STORAGE:507,LOOP_DETECTED:508,NOT_EXTENDED:510,NETWORK_AUTHENTICATION_REQUIRED:511};var ij=class extends Error{constructor(e="INTERNAL_SERVER_ERROR",t,r={},i="number"==typeof e?e:iL[e]){super(t?.message,t?.cause?{cause:t.cause}:void 0),this.status=e,this.body=t,this.headers=r,this.statusCode=i,this.name="APIError",this.status=e,this.headers=r,this.statusCode=i,this.body=t?{code:t?.message?.toUpperCase().replace(/ /g,"_").replace(/[^A-Z0-9_]/g,""),...t}:void 0}},iq=class extends ij{constructor(e,t){super(400,{message:e,code:"VALIDATION_ERROR"}),this.message=e,this.issues=t,this.issues=t}},iB=class extends Error{constructor(e){super(e),this.name="BetterCallError"}};let iH=function(e,t){class r extends e{#f;constructor(...e){if(function(){let e=Object.getOwnPropertyDescriptor(Error,"stackTraceLimit");return void 0===e?Object.isExtensible(Error):Object.prototype.hasOwnProperty.call(e,"writable")?e.writable:void 0!==e.set}()){const t=Error.stackTraceLimit;Error.stackTraceLimit=0,super(...e),Error.stackTraceLimit=t}else super(...e);const t=Error().stack;t&&(this.#f=function(e){let t=e.split("\n    at ");return t.length<=1?e:(t.splice(1,1),t.join("\n    at "))}(t.replace(/^Error/,this.name)))}get errorStack(){return this.#f}}return Object.defineProperty(r.prototype,"constructor",{get:()=>t,enumerable:!1,configurable:!0}),r}(ij,Error),i$=/^application\/([a-z0-9.+-]*\+)?json/i;async function iM(e,t){let r=e.headers.get("content-type")||"",i=r.toLowerCase();if(e.body){if(t&&t.length>0&&!t.some(e=>{let t=i.split(";")[0].trim(),r=e.toLowerCase().trim();return t===r||t.includes(r)})){if(!i)throw new iH(415,{message:`Content-Type is required. Allowed types: ${t.join(", ")}`,code:"UNSUPPORTED_MEDIA_TYPE"});throw new iH(415,{message:`Content-Type "${r}" is not allowed. Allowed types: ${t.join(", ")}`,code:"UNSUPPORTED_MEDIA_TYPE"})}if(i$.test(i))return await e.json();if(i.includes("application/x-www-form-urlencoded")){let t=await e.formData(),r={};return t.forEach((e,t)=>{r[t]=e.toString()}),r}if(i.includes("multipart/form-data")){let t=await e.formData(),r={};return t.forEach((e,t)=>{r[t]=e}),r}return i.includes("text/plain")?await e.text():i.includes("application/octet-stream")?await e.arrayBuffer():i.includes("application/pdf")||i.includes("image/")||i.includes("video/")?await e.blob():i.includes("application/stream")||e.body instanceof ReadableStream?e.body:await e.text()}}function iz(e){return e instanceof iH||e?.name==="APIError"}async function iV(e){try{return{data:await e,error:null}}catch(e){return{data:null,error:e}}}function iK(e){return e instanceof Request||"[object Request]"===Object.prototype.toString.call(e)}function iW(e,t){if(e instanceof Response)return t?.headers instanceof Headers&&t.headers.forEach((t,r)=>{e.headers.set(r,t)}),e;if(e&&"object"==typeof e&&"_flag"in e&&"json"===e._flag){let r=e.body,i=e.routerResponse;if(i instanceof Response)return i;let n=new Headers;if(i?.headers){let e=new Headers(i.headers);for(let[t,r]of e.entries())e.set(t,r)}if(e.headers)for(let[t,r]of new Headers(e.headers).entries())n.set(t,r);if(t?.headers)for(let[e,r]of new Headers(t.headers).entries())n.set(e,r);return n.set("Content-Type","application/json"),new Response(JSON.stringify(r),{...i,headers:n,status:e.status??t?.status??i?.status,statusText:t?.statusText??i?.statusText})}if(iz(e))return iW(e.body,{status:t?.status??e.statusCode,statusText:e.status.toString(),headers:t?.headers||e.headers});let r=e,i=new Headers(t?.headers);if(e){if("string"==typeof e)r=e,i.set("Content-Type","text/plain");else if(e instanceof ArrayBuffer||ArrayBuffer.isView(e))r=e,i.set("Content-Type","application/octet-stream");else if(e instanceof Blob)r=e,i.set("Content-Type",e.type||"application/octet-stream");else if(e instanceof FormData)r=e;else if(e instanceof URLSearchParams)r=e,i.set("Content-Type","application/x-www-form-urlencoded");else if(e instanceof ReadableStream)r=e,i.set("Content-Type","application/octet-stream");else if(function(e){if(void 0===e)return!1;let t=typeof e;return"string"===t||"number"===t||"boolean"===t||null===t||"object"===t&&(!!Array.isArray(e)||!e.buffer&&(e.constructor&&"Object"===e.constructor.name||"function"==typeof e.toJSON))}(e)){let t,n;t=0,n=new WeakMap,r=JSON.stringify(e,(e,r)=>{if("bigint"==typeof r)return r.toString();if("object"==typeof r&&null!==r){if(n.has(r))return`[Circular ref-${n.get(r)}]`;n.set(r,t++)}return r},void 0),i.set("Content-Type","application/json")}}else null===e&&(r=JSON.stringify(null)),i.set("content-type","application/json");return new Response(r,{...t,headers:i})}let iF={name:"HMAC",hash:"SHA-256"},iZ=async e=>{let t="string"==typeof e?new TextEncoder().encode(e):e;return await rH().importKey("raw",t,iF,!1,["sign","verify"])},iJ=async(e,t,r)=>{try{let i=atob(e),n=new Uint8Array(i.length);for(let e=0,t=i.length;e<t;e++)n[e]=i.charCodeAt(e);return await rH().verify(iF,r,n,new TextEncoder().encode(t))}catch(e){return!1}},iG=async(e,t)=>{let r=await iZ(t);return btoa(String.fromCharCode(...new Uint8Array(await rH().sign(iF.name,r,new TextEncoder().encode(e)))))},iY=async(e,t)=>{let r=await iG(e,t);return encodeURIComponent(e=`${e}.${r}`)},iQ=(e,t)=>{let r=e;if(t)if("secure"===t)r="__Secure-"+e;else{if("host"!==t)return;r="__Host-"+e}return r},iX=(e,t,r={})=>{let i;if(i=r?.prefix==="secure"?`__Secure-${e}=${t}`:r?.prefix==="host"?`__Host-${e}=${t}`:`${e}=${t}`,e.startsWith("__Secure-")&&!r.secure&&(r.secure=!0),e.startsWith("__Host-")&&(r.secure||(r.secure=!0),"/"!==r.path&&(r.path="/"),r.domain&&(r.domain=void 0)),r&&"number"==typeof r.maxAge&&r.maxAge>=0){if(r.maxAge>3456e4)throw Error("Cookies Max-Age SHOULD NOT be greater than 400 days (34560000 seconds) in duration.");i+=`; Max-Age=${Math.floor(r.maxAge)}`}if(r.domain&&"host"!==r.prefix&&(i+=`; Domain=${r.domain}`),r.path&&(i+=`; Path=${r.path}`),r.expires){if(r.expires.getTime()-Date.now()>3456e7)throw Error("Cookies Expires SHOULD NOT be greater than 400 days (34560000 seconds) in the future.");i+=`; Expires=${r.expires.toUTCString()}`}return r.httpOnly&&(i+="; HttpOnly"),r.secure&&(i+="; Secure"),r.sameSite&&(i+=`; SameSite=${r.sameSite.charAt(0).toUpperCase()+r.sameSite.slice(1)}`),r.partitioned&&(r.secure||(r.secure=!0),i+="; Partitioned"),i},i0=async(e,t,r,i)=>iX(e,t=await iY(t,r),i);async function i1(e,t={}){let r={body:t.body,query:t.query};if(e.body){let i=await e.body["~standard"].validate(t.body);if(i.issues)return{data:null,error:i2(i.issues,"body")};r.body=i.value}if(e.query){let i=await e.query["~standard"].validate(t.query);if(i.issues)return{data:null,error:i2(i.issues,"query")};r.query=i.value}return e.requireHeaders&&!t.headers?{data:null,error:{message:"Headers is required",issues:[]}}:e.requireRequest&&!t.request?{data:null,error:{message:"Request is required",issues:[]}}:{data:r,error:null}}function i2(e,t){return{message:e.map(e=>`[${e.path?.length?`${t}.`+e.path.map(e=>"object"==typeof e?e.key:e).join("."):t}] ${e.message}`).join("; "),issues:e}}let i5=async(e,{options:t,path:r})=>{let i,n=new Headers,{data:o,error:a}=await i1(t,e);if(a)throw new iq(a.message,a.issues);let s="headers"in e?e.headers instanceof Headers?e.headers:new Headers(e.headers):"request"in e&&iK(e.request)?e.request.headers:null,c=s?.get("cookie"),d=c?function(e){if("string"!=typeof e)throw TypeError("argument str must be a string");let t=new Map,r=0;for(;r<e.length;){let i=e.indexOf("=",r);if(-1===i)break;let n=e.indexOf(";",r);if(-1===n)n=e.length;else if(n<i){r=e.lastIndexOf(";",i-1)+1;continue}let o=e.slice(r,i).trim();if(!t.has(o)){let r=e.slice(i+1,n).trim();34===r.codePointAt(0)&&(r=r.slice(1,-1)),t.set(o,function(e){try{return e.includes("%")?decodeURIComponent(e):e}catch{return e}}(r))}r=n+1}return t}(c):void 0,l={...e,body:o.body,query:o.query,path:e.path||r||"virtual:",context:"context"in e&&e.context?e.context:{},returned:void 0,headers:e?.headers,request:e?.request,params:"params"in e?e.params:void 0,method:e.method??(Array.isArray(t.method)?t.method[0]:"*"===t.method?"GET":t.method),setHeader:(e,t)=>{n.set(e,t)},getHeader:e=>s?s.get(e):null,getCookie:(e,t)=>{let r=iQ(e,t);return r&&d?.get(r)||null},getSignedCookie:async(e,t,r)=>{let i=iQ(e,r);if(!i)return null;let n=d?.get(i);if(!n)return null;let o=n.lastIndexOf(".");if(o<1)return null;let a=n.substring(0,o),s=n.substring(o+1);return 44===s.length&&s.endsWith("=")?!!await iJ(s,a,await iZ(t))&&a:null},setCookie:(e,t,r)=>{var i;let o=iX(e,i=encodeURIComponent(i=t),r);return n.append("set-cookie",o),o},setSignedCookie:async(e,t,r,i)=>{let o=await i0(e,t,r,i);return n.append("set-cookie",o),o},redirect:e=>(n.set("location",e),new iH("FOUND",void 0,n)),error:(e,t,r)=>new iH(e,t,r),setStatus:e=>{i=e},json:(t,r)=>e.asResponse?{body:r?.body||t,routerResponse:r,_flag:"json"}:t,responseHeaders:n,get responseStatus(){return i}};for(let e of t.use||[]){let t=await e({...l,returnHeaders:!0,asResponse:!1});t.response&&Object.assign(l.context,t.response),t.headers&&t.headers.forEach((e,t)=>{l.responseHeaders.set(t,e)})}return l};function i6(e,t,r){let i="string"==typeof e?e:void 0,n="object"==typeof t?t:e,o="function"==typeof t?t:r;if(("GET"===n.method||"HEAD"===n.method)&&n.body)throw new iB("Body is not allowed with GET or HEAD methods");if(i&&/\/{2,}/.test(i))throw new iB("Path cannot contain consecutive slashes");let a=async(...e)=>{let t=e[0]||{},{data:r,error:a}=await iV(i5(t,{options:n,path:i}));if(a){if(!(a instanceof iq))throw a;throw n.onValidationError&&await n.onValidationError({message:a.message,issues:a.issues}),new iH(400,{message:a.message,code:"VALIDATION_ERROR"})}let s=await o(r).catch(async e=>{if(iz(e)){let r=n.onAPIError;if(r&&await r(e),t.asResponse)return e}throw e}),c=r.responseHeaders,d=r.responseStatus;return t.asResponse?iW(s,{headers:c,status:d}):t.returnHeaders?t.returnStatus?{headers:c,response:s,status:d}:{headers:c,response:s}:t.returnStatus?{response:s,status:d}:s};return a.options=n,a.path=i,a}function i3(e,t){let r=async r=>{let i="function"==typeof e?e:t,n=await i5(r,{options:"function"==typeof e?{}:e,path:"/"});if(!i)throw Error("handler must be defined");let o=await i(n),a=n.responseHeaders;return r.returnHeaders?{headers:a,response:o}:o};return r.options="function"==typeof e?{}:e,r}i6.create=e=>(t,r,i)=>i6(t,{...r,use:[...r?.use||[],...e?.use||[]]},i),i3.create=e=>function(t,r){if("function"==typeof t)return i3({use:e?.use},t);if(!r)throw Error("Middleware handler is required");return i3({...t,method:"*",use:[...e?.use||[],...t.use||[]]},r)};let i8={};function i4(e){switch(e.constructor.name){case"ZodString":default:return"string";case"ZodNumber":return"number";case"ZodBoolean":return"boolean";case"ZodObject":return"object";case"ZodArray":return"array"}}function i9(e){let t=[];return e.metadata?.openapi?.parameters?t.push(...e.metadata.openapi.parameters):e.query instanceof iS.ZodObject&&Object.entries(e.query.shape).forEach(([e,r])=>{r instanceof iS.ZodObject&&t.push({name:e,in:"query",schema:{type:i4(r),..."minLength"in r&&r.minLength?{minLength:r.minLength}:{},description:r.description}})}),t}function i7(e){return{400:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}},description:"Bad Request. Usually due to missing parameters, or invalid parameters."},401:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}},required:["message"]}}},description:"Unauthorized. Due to missing or invalid authentication."},403:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Forbidden. You do not have permission to access this resource or to perform this action."},404:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Not Found. The requested resource was not found."},429:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Too Many Requests. You have exceeded the rate limit. Try again later."},500:{content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}},description:"Internal Server Error. This is a problem with the server that you cannot fix."},...e}}async function ne(e,t){return Object.entries(e).forEach(([e,t])=>{let r=t.options;if(!(!t.path||r.metadata?.SERVER_ONLY)&&("GET"===r.method&&(i8[t.path]={get:{tags:["Default",...r.metadata?.openapi?.tags||[]],description:r.metadata?.openapi?.description,operationId:r.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:i9(r),responses:i7(r.metadata?.openapi?.responses)}}),"POST"===r.method)){let e=function(e){if(e.metadata?.openapi?.requestBody)return e.metadata.openapi.requestBody;if(e.body&&(e.body instanceof iS.ZodObject||e.body instanceof iS.ZodOptional)){let t=e.body.shape;if(!t)return;let r={},i=[];return Object.entries(t).forEach(([e,t])=>{t instanceof iS.ZodObject&&(r[e]={type:i4(t),description:t.description},t instanceof iS.ZodOptional||i.push(e))}),{required:!(e.body instanceof iS.ZodOptional)&&!!e.body,content:{"application/json":{schema:{type:"object",properties:r,required:i}}}}}}(r);i8[t.path]={post:{tags:["Default",...r.metadata?.openapi?.tags||[]],description:r.metadata?.openapi?.description,operationId:r.metadata?.openapi?.operationId,security:[{bearerAuth:[]}],parameters:i9(r),...e?{requestBody:e}:{requestBody:{content:{"application/json":{schema:{type:"object",properties:{}}}}}},responses:i7(r.metadata?.openapi?.responses)}}}}),{openapi:"3.1.1",info:{title:"Better Auth",description:"API Reference for your Better Auth Instance",version:"1.1.0"},components:{schemas:{}},security:[{apiKeyCookie:[]}],servers:[{url:t?.url}],tags:[{name:"Default",description:"Default endpoints that are included with Better Auth by default. These endpoints are not part of any plugin."}],paths:i8}}let nt=((d=function(){}).prototype=Object.create(null),Object.freeze(d.prototype),d);function nr(){return{root:{key:""},static:new nt}}function ni(e){let[t,...r]=e.split("/");return""===r[r.length-1]?r.slice(0,-1):r}function nn(e,t){let r=new nt;for(let[i,n]of t){let t=i<0?e.slice(-(i+1)).join("/"):e[i];if("string"==typeof n)r[n]=t;else{let e=t.match(n);if(e)for(let t in e.groups)r[t]=e.groups[t]}}return r}function no(e,t="",r,i){t=t.toUpperCase(),47!==r.charCodeAt(0)&&(r=`/${r}`);let n=ni(r=r.replace(/\\:/g,"%3A")),o=e.root,a=0,s=[],c=[];for(let e=0;e<n.length;e++){let t=n[e];if(t.startsWith("**")){o.wildcard||(o.wildcard={key:"**"}),o=o.wildcard,s.push([-(e+1),t.split(":")[1]||"_",2===t.length]);break}if("*"===t||t.includes(":")){if(o.param||(o.param={key:"*"}),o=o.param,"*"===t)s.push([e,`_${a++}`,!0]);else if(t.includes(":",1)){let r=function(e){let t=e.replace(/:(\w+)/g,(e,t)=>`(?<${t}>[^/]+)`).replace(/\./g,"\\.");return RegExp(`^${t}$`)}(t);c[e]=r,o.hasRegexParam=!0,s.push([e,r,!1])}else s.push([e,t.slice(1),!1]);continue}"\\*"===t?t=n[e]="*":"\\*\\*"===t&&(t=n[e]="**");let r=o.static?.[t];if(r)o=r;else{let e={key:t};o.static||(o.static=new nt),o.static[t]=e,o=e}}let d=s.length>0;o.methods||(o.methods=new nt),o.methods[t]??=[],o.methods[t].push({data:i||null,paramsRegexp:c,paramsMap:d?s:void 0}),d||(e.static["/"+n.join("/")]=o)}let na=new WeakMap;function ns(e,t){let r=t.fields,i={};for(let t in e){let n=r[t];if(!n){i[t]=e[t];continue}(!1!==n.returned||"id"===t)&&(i[t]=e[t])}return i}function nc(e,t,r){let i=`${t}:${r}`;na.has(e)||na.set(e,new Map);let n=na.get(e);if(n.has(i))return n.get(i);let o="output"===r?(0,iI.getAuthTables)(e)[t]?.fields??{}:{},a="user"===t||"session"===t||"account"===t?e[t]?.additionalFields:void 0,s={...o,...a??{}};for(let r of e.plugins||[])r.schema&&r.schema[t]&&(s={...s,...r.schema[t].fields});return n.set(i,s),s}function nd(e,t){return ns(t,{fields:nc(e,"user","output")})}function nl(e,t){return ns(t,{fields:nc(e,"session","output")})}function nu(e,t){let{accessToken:r,refreshToken:i,idToken:n,accessTokenExpiresAt:o,refreshTokenExpiresAt:a,password:s,...c}=ns(t,{fields:nc(e,"account","output")});return c}function np(e,t){let r=t.action||"create",i=t.fields,n=Object.assign(Object.create(null),null);for(let t in i){if(t in e){if(!1===i[t].input){if(void 0!==i[t].defaultValue&&"update"!==r){n[t]=i[t].defaultValue;continue}if(e[t])throw new iH("BAD_REQUEST",{message:`${t} is not allowed to be set`});continue}if(i[t].validator?.input&&void 0!==e[t]){let r=i[t].validator.input["~standard"].validate(e[t]);if(r instanceof Promise)throw new iH("INTERNAL_SERVER_ERROR",{message:"Async validation is not supported for additional fields"});if("issues"in r&&r.issues)throw new iH("BAD_REQUEST",{message:r.issues[0]?.message||"Validation Error"});n[t]=r.value;continue}if(i[t].transform?.input&&void 0!==e[t]){n[t]=i[t].transform?.input(e[t]);continue}n[t]=e[t];continue}if(void 0!==i[t].defaultValue&&"create"===r){if("function"==typeof i[t].defaultValue){n[t]=i[t].defaultValue();continue}n[t]=i[t].defaultValue;continue}if(i[t].required&&"create"===r)throw new iH("BAD_REQUEST",{message:`${t} is required`})}return n}function nh(e,t={},r){return np(t,{fields:nc(e,"user","input"),action:r})}function nf(e,t){return np(t||{},{fields:nc(e,"user","input")})}function nm(e,t){return np(t,{fields:nc(e,"account","input")})}function ng(e,t){return np(t,{fields:nc(e,"session","input")})}function ny(e,t){if(!t)return e;for(let r in t){let i=t[r]?.modelName;for(let n in i&&(e[r].modelName=i),e[r].fields){let i=t[r]?.fields?.[n];i&&(e[r].fields[n].fieldName=i)}}return e}e.i(75973);var nw=e.i(75722);function nb(e){let t=e.split("."),r=parseInt(t[t.length-1]||"0",10);return isNaN(r)?0:r}function nE(e,t){let r={};for(let i in e)r[i]={name:i,value:"",attributes:{...t,maxAge:0}};return r}let n_=e=>(t,r,i)=>{let n=function(e,t){let r={};for(let[i,n]of Object.entries(function(e){let t=e.headers?.get("cookie");if(!t)return{};let r={};for(let e of t.split("; ")){let[t,...i]=e.split("=");t&&i.length>0&&(r[t]=i.join("="))}return r}(t)))i.startsWith(e)&&(r[i]=n);return r}(t,i),o=i.context.logger;return{getValue:()=>Object.keys(n).sort((e,t)=>nb(e)-nb(t)).map(e=>n[e]).join(""),hasChunks:()=>Object.keys(n).length>0,chunk(i,a){let s=nE(n,r);for(let e in n)delete n[e];for(let c of function(e,t,r,i){let n=Math.ceil(t.value.length/3896);if(1===n)return r[t.name]=t.value,[t];let o=[];for(let e=0;e<n;e++){let i=`${t.name}.${e}`,n=3896*e,a=t.value.substring(n,n+3896);o.push({...t,name:i,value:a}),r[i]=a}return i.debug(`CHUNKING_${e.toUpperCase()}_COOKIE`,{message:`${e} cookie exceeds allowed 4096 bytes.`,emptyCookieSize:200,valueSize:t.value.length,chunkCount:n,chunks:o.map(e=>e.value.length+200)}),o}(e,{name:t,value:i,attributes:{...r,...a}},n,o))s[c.name]=c;return Object.values(s)},clean(){let e=nE(n,r);for(let e in n)delete n[e];return Object.values(e)},setCookies(e){for(let t of e)i.setCookie(t.name,t.value,t.attributes)}}},nA=n_("Session"),nT=n_("Account");function nv(e,t){let r=e.getCookie(t);if(r)return r;let i=[],n=e.headers?.get("cookie");if(!n)return null;let o={};for(let e of n.split("; ")){let[t,...r]=e.split("=");t&&r.length>0&&(o[t]=r.join("="))}for(let[e,r]of Object.entries(o))if(e.startsWith(t+".")){let t=parseInt(e.split(".").at(-1)||"0",10);isNaN(t)||i.push({index:t,value:r})}return i.length>0?(i.sort((e,t)=>e.index-t.index),i.map(e=>e.value).join("")):null}async function nk(e,t){let r=e.context.authCookies.accountData,i={maxAge:300,...r.attributes},n=await rx(t,e.context.secret,"better-auth-account",i.maxAge);if(n.length>4096){let t=nT(r.name,i,e),o=t.chunk(n,i);t.setCookies(o)}else{let t=nT(r.name,i,e);if(t.hasChunks()){let e=t.clean();t.setCookies(e)}e.setCookie(r.name,n,i)}}async function nR(e){let t=nv(e,e.context.authCookies.accountData.name);if(t){let r=(0,nw.safeJSONParse)(await rU(t,e.context.secret,"better-auth-account"));if(r)return r}return null}let nI=iS.optional(iS.object({disableCookieCache:iU.coerce.boolean().meta({description:"Disable cookie cache and fetch session from database"}).optional(),disableRefresh:iU.coerce.boolean().meta({description:"Disable session refresh. Useful for checking session status, without updating the session"}).optional()})),nS=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)(?: (ago|from now))?$/i;function nx(e){let t,r=nS.exec(e);if(!r||r[4]&&r[1])throw TypeError(`Invalid time string format: "${e}". Use formats like "7d", "30m", "1 hour", etc.`);let i=parseFloat(r[2]),n=r[3].toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":t=315576e5*i;break;case"months":case"month":case"mo":t=2592e6*i;break;case"weeks":case"week":case"w":t=6048e5*i;break;case"days":case"day":case"d":t=864e5*i;break;case"hours":case"hour":case"hrs":case"hr":case"h":t=36e5*i;break;case"minutes":case"minute":case"mins":case"min":case"m":t=6e4*i;break;case"seconds":case"second":case"secs":case"sec":case"s":t=1e3*i;break;default:throw TypeError(`Unknown time unit: "${n}"`)}return"-"===r[1]||"ago"===r[4]?-t:t}function nU(e){return Math.round(nx(e)/1e3)}function nO(e){let t=new Map;return e.split(", ").forEach(e=>{let[r,...i]=e.split(";").map(e=>e.trim()),[n,...o]=(r||"").split("="),a=o.join("=");if(!n||void 0===a)return;let s={value:a};i.forEach(e=>{let[t,...r]=e.split("="),i=r.join("="),n=t.trim().toLowerCase();switch(n){case"max-age":s["max-age"]=i?parseInt(i.trim(),10):void 0;break;case"expires":s.expires=i?new Date(i.trim()):void 0;break;case"domain":s.domain=i?i.trim():void 0;break;case"path":s.path=i?i.trim():void 0;break;case"secure":s.secure=!0;break;case"httponly":s.httponly=!0;break;case"samesite":s.samesite=i?i.trim().toLowerCase():void 0;break;default:s[n]=!i||i.trim()}}),t.set(n,s)}),t}e.i(76365);var nD=e.i(38722);let nC=new Map,nN={decode:(e,t="utf-8")=>(nC.has(t)||nC.set(t,new TextDecoder(t)),nC.get(t).decode(e)),encode:new TextEncoder().encode},nP=(e="SHA-256",t="none")=>{let r={importKey:async(t,r)=>rH().importKey("raw","string"==typeof t?new TextEncoder().encode(t):t,{name:"HMAC",hash:{name:e}},!1,[r]),sign:async(e,i)=>{"string"==typeof e&&(e=await r.importKey(e,"sign"));let n=await rH().sign("HMAC",e,"string"==typeof i?new TextEncoder().encode(i):i);return"hex"===t?rD(n):"base64"===t||"base64url"===t||"base64urlnopad"===t?rK.encode(n,{padding:"base64urlnopad"!==t}):n},verify:async(e,i,n)=>("string"==typeof e&&(e=await r.importKey(e,"verify")),"hex"===t&&(n=(e=>{if(!e)return"";if("string"==typeof e){if(e.length%2!=0||!RegExp("^[0123456789abcdef]+$").test(e))throw Error("Invalid hexadecimal string");let t=new Uint8Array(e.length/2);for(let r=0;r<e.length;r+=2)t[r/2]=parseInt(e.slice(r,r+2),16);return new TextDecoder().decode(t)}return new TextDecoder().decode(e)})(n)),("base64"===t||"base64url"===t||"base64urlnopad"===t)&&(n=await rV.decode(n)),rH().verify("HMAC",e,"string"==typeof n?new TextEncoder().encode(n):n,"string"==typeof i?new TextEncoder().encode(i):i))};return r};function nL(e){let t=(e.advanced?.useSecureCookies!==void 0?e.advanced?.useSecureCookies:void 0!==e.baseURL?!!e.baseURL.startsWith("https://"):nD.isProduction)?"__Secure-":"",r=!!e.advanced?.crossSubDomainCookies?.enabled,i=r?e.advanced?.crossSubDomainCookies?.domain||(e.baseURL?new URL(e.baseURL).hostname:void 0):void 0;if(r&&!i)throw new rO.BetterAuthError("baseURL is required when crossSubdomainCookies are enabled");return function(n,o={}){let a=e.advanced?.cookiePrefix||"better-auth",s=e.advanced?.cookies?.[n]?.name||`${a}.${n}`,c=e.advanced?.cookies?.[n]?.attributes;return{name:`${t}${s}`,attributes:{secure:!!t,sameSite:"lax",path:"/",httpOnly:!0,...r?{domain:i}:{},...e.advanced?.defaultCookieAttributes,...o,...c}}}}async function nj(e,t,r){if(e.context.options.session?.cookieCache?.enabled){let i,n=Object.entries(t.session).reduce((t,[r,i])=>{let n=e.context.options.session?.additionalFields?.[r];return n&&!1===n.returned||(t[r]=i),t},{}),o=nd(e.context.options,t.user),a=e.context.options.session?.cookieCache?.version,s="1";if(a){if("string"==typeof a)s=a;else if("function"==typeof a){let e=a(t.session,t.user);s=e instanceof Promise?await e:e}}let c={session:n,user:o,updatedAt:Date.now(),version:s},d={...e.context.authCookies.sessionData.attributes,maxAge:r?void 0:e.context.authCookies.sessionData.attributes.maxAge},l=iR(d.maxAge||60,"sec").getTime(),u=e.context.options.session?.cookieCache?.strategy||"compact";if((i="jwe"===u?await rx(c,e.context.secret,"better-auth-session",d.maxAge||300):"jwt"===u?await rk(c,e.context.secret,d.maxAge||300):rK.encode(JSON.stringify({session:c,expiresAt:l,signature:await nP("SHA-256","base64urlnopad").sign(e.context.secret,JSON.stringify({...c,expiresAt:l}))}),{padding:!1})).length>4093){let t=nA(e.context.authCookies.sessionData.name,d,e),r=t.chunk(i,d);t.setCookies(r)}else{let t=nA(e.context.authCookies.sessionData.name,d,e);if(t.hasChunks()){let e=t.clean();t.setCookies(e)}e.setCookie(e.context.authCookies.sessionData.name,i,d)}}}async function nq(e,t,r,i){let n=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);r=void 0!==r?r:!!n;let o=e.context.authCookies.sessionToken.attributes,a=r?void 0:e.context.sessionConfig.expiresIn;await e.setSignedCookie(e.context.authCookies.sessionToken.name,t.session.token,e.context.secret,{...o,maxAge:a,...i}),r&&await e.setSignedCookie(e.context.authCookies.dontRememberToken.name,"true",e.context.secret,e.context.authCookies.dontRememberToken.attributes),await nj(e,t,r),e.context.setNewSession(t),e.context.options.secondaryStorage&&await e.context.secondaryStorage?.set(t.session.token,JSON.stringify({user:t.user,session:t.session}),Math.floor((new Date(t.session.expiresAt).getTime()-Date.now())/1e3))}function nB(e,t){e.setCookie(t.name,"",{...t.attributes,maxAge:0})}function nH(e,t){if(nB(e,e.context.authCookies.sessionToken),nB(e,e.context.authCookies.sessionData),e.context.options.account?.storeAccountCookie){nB(e,e.context.authCookies.accountData);let t=nT(e.context.authCookies.accountData.name,e.context.authCookies.accountData.attributes,e),r=t.clean();t.setCookies(r)}"cookie"===e.context.oauthConfig.storeStateStrategy&&nB(e,e.context.createAuthCookie("oauth_state"));let r=nA(e.context.authCookies.sessionData.name,e.context.authCookies.sessionData.attributes,e),i=r.clean();r.setCookies(i),t||nB(e,e.context.authCookies.dontRememberToken)}async function n$(e,t,r){let i=e.body?.callbackURL||e.context.options.baseURL;if(!i)throw new iH("BAD_REQUEST",{message:"callbackURL is required"});let n=ei(128),o=ei(32),a=e.context.oauthConfig.storeStateStrategy,s={...r||{},callbackURL:i,codeVerifier:n,errorURL:e.body?.errorCallbackURL,newUserURL:e.body?.newUserCallbackURL,link:t,expiresAt:Date.now()+6e5,requestSignUp:e.body?.requestSignUp,state:o};if(await et(s),"cookie"===a){let t=await iA({key:e.context.secret,data:JSON.stringify(s)}),r=e.context.createAuthCookie("oauth_state",{maxAge:6e5});return e.setCookie(r.name,t,r.attributes),{state:o,codeVerifier:n}}let c=e.context.createAuthCookie("state",{maxAge:3e5});await e.setSignedCookie(c.name,o,e.context.secret,c.attributes);let d=new Date;d.setMinutes(d.getMinutes()+10);let l=await e.context.internalAdapter.createVerificationValue({value:JSON.stringify(s),identifier:o,expiresAt:d});if(!l)throw e.context.logger.error("Unable to create verification. Make sure the database adapter is properly working and there is a verification table in the database"),new iH("INTERNAL_SERVER_ERROR",{message:"Unable to create verification"});return{state:l.identifier,codeVerifier:n}}async function nM(e){let t,r=e.query.state||e.body.state,i=e.context.oauthConfig.storeStateStrategy,n=iS.looseObject({callbackURL:iS.string(),codeVerifier:iS.string(),errorURL:iS.string().optional(),newUserURL:iS.string().optional(),expiresAt:iS.number(),link:iS.object({email:iS.string(),userId:iU.coerce.string()}).optional(),requestSignUp:iS.boolean().optional(),state:iS.string().optional()}),o=e.context.oauthConfig?.skipStateCookieCheck;if("cookie"===i){let i=e.context.createAuthCookie("oauth_state"),o=e.getCookie(i.name);if(!o){e.context.logger.error("State Mismatch. OAuth state cookie not found",{state:r});let t=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${t}?error=please_restart_the_process`)}try{let r=await iT({key:e.context.secret,data:o});t=n.parse(JSON.parse(r))}catch(r){e.context.logger.error("Failed to decrypt or parse OAuth state cookie",{error:r});let t=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${t}?error=please_restart_the_process`)}if(!e.context.oauthConfig?.skipStateCookieCheck&&t.state&&t.state!==r){e.context.logger.error("State Mismatch. State parameter does not match",{expected:t.state,received:r});let i=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${i}?error=state_mismatch`)}nB(e,i)}else{let i=await e.context.internalAdapter.findVerificationValue(r);if(!i){e.context.logger.error("State Mismatch. Verification not found",{state:r});let t=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${t}?error=please_restart_the_process`)}t=n.parse(JSON.parse(i.value));let a=e.context.createAuthCookie("state"),s=await e.getSignedCookie(a.name,e.context.secret);if(!o&&(!s||s!==r)){let t=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${t}?error=state_mismatch`)}nB(e,a),await e.context.internalAdapter.deleteVerificationValue(i.id)}if(t.errorURL||(t.errorURL=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`),t.expiresAt<Date.now()){let t=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${t}?error=please_restart_the_process`)}return t&&await et(t),t}function nz(e,t){return e&&t.options.account?.encryptOAuthTokens?iT({key:t.secret,data:e}):e}function nV(e,t){return t.options.account?.encryptOAuthTokens&&e?iA({key:t.secret,data:e}):e}function nK(e,t="/api/auth"){try{let t=new URL(e);if("http:"!==t.protocol&&"https:"!==t.protocol)throw new rO.BetterAuthError(`Invalid base URL: ${e}. URL must include 'http://' or 'https://'`)}catch(t){if(t instanceof rO.BetterAuthError)throw t;throw new rO.BetterAuthError(`Invalid base URL: ${e}. Please provide a valid base URL.`,{cause:t})}if(function(e){try{return"/"!==(new URL(e).pathname.replace(/\/+$/,"")||"/")}catch{throw new rO.BetterAuthError(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}(e))return e;let r=e.replace(/\/+$/,"");return t&&"/"!==t?(t=t.startsWith("/")?t:`/${t}`,`${r}${t}`):r}function nW(e,t){return!!e&&""!==e.trim()&&("proto"===t?"http"===e||"https"===e:"host"===t&&![/\.\./,/\0/,/[\s]/,/^[.]/,/[<>'"]/,/javascript:/i,/file:/i,/data:/i].some(t=>t.test(e))&&(/^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*(:[0-9]{1,5})?$/.test(e)||/^(\d{1,3}\.){3}\d{1,3}(:[0-9]{1,5})?$/.test(e)||/^\[[0-9a-fA-F:]+\](:[0-9]{1,5})?$/.test(e)||/^localhost(:[0-9]{1,5})?$/i.test(e)))}function nF(e,t,r,i,n){if(e)return nK(e,t);if(!1!==i){let e=nD.env.BETTER_AUTH_URL||nD.env.NEXT_PUBLIC_BETTER_AUTH_URL||nD.env.PUBLIC_BETTER_AUTH_URL||nD.env.NUXT_PUBLIC_BETTER_AUTH_URL||nD.env.NUXT_PUBLIC_AUTH_URL||("/"!==nD.env.BASE_URL?nD.env.BASE_URL:void 0);if(e)return nK(e,t)}let o=r?.headers.get("x-forwarded-host"),a=r?.headers.get("x-forwarded-proto");if(o&&a&&n&&nW(a,"proto")&&nW(o,"host"))try{return nK(`${a}://${o}`,t)}catch(e){}if(r){let e=nZ(r.url);if(!e)throw new rO.BetterAuthError("Could not get origin from request. Please provide a valid base URL.");return nK(e,t)}}function nZ(e){try{let t=new URL(e);return"null"===t.origin?null:t.origin}catch{return null}}function nJ(e){return"-"===e||"^"===e||"$"===e||"+"===e||"."===e||"("===e||")"===e||"|"===e||"["===e||"]"===e||"{"===e||"}"===e||"*"===e||"?"===e||"\\"===e?`\\${e}`:e}function nG(e,t){if("string"!=typeof t)throw TypeError(`Sample must be a string, but ${typeof t} given`);return e.test(t)}function nY(e,t){if("string"!=typeof e&&!Array.isArray(e))throw TypeError(`The first argument must be a single pattern string or an array of patterns, but ${typeof e} given`);if(("string"==typeof t||"boolean"==typeof t)&&(t={separator:t}),2==arguments.length&&!(void 0===t||"object"==typeof t&&null!==t&&!Array.isArray(t)))throw TypeError(`The second argument must be an options object or a string/boolean separator, but ${typeof t} given`);if("\\"===(t=t||{}).separator)throw Error("\\ is not a valid separator because it is used for escaping. Try setting the separator to `true` instead");let r=function e(t,r=!0){if(Array.isArray(t))return`(?:${t.map(t=>`^${e(t,r)}$`).join("|")})`;let i="",n="",o=".";!0===r?(i="/",n="[/\\\\]",o="[^/\\\\]"):r&&((n=function(e){let t="";for(let r=0;r<e.length;r++)t+=nJ(e[r]);return t}(i=r)).length>1?(n=`(?:${n})`,o=`((?!${n}).)`):o=`[^${n}]`);let a=r?`${n}+?`:"",s=r?`${n}*?`:"",c=r?t.split(i):[t],d="";for(let e=0;e<c.length;e++){let t=c[e],i=c[e+1],n="";if(t||!(e>0)){if(r&&(n=e===c.length-1?s:"**"!==i?a:""),r&&"**"===t){n&&(d+=0===e?"":n,d+=`(?:${o}*?${n})*?`);continue}for(let e=0;e<t.length;e++){let r=t[e];"\\"===r?e<t.length-1&&(d+=nJ(t[e+1]),e++):"?"===r?d+=o:"*"===r?d+=`${o}*?`:d+=nJ(r)}d+=n}}return d}(e,t.separator),i=RegExp(`^${r}$`,t.flags),n=nG.bind(null,i);return n.options=t,n.pattern=e,n.regexp=i,n}let nQ=(e,t,r)=>{if(e.startsWith("/"))return!!r?.allowRelativePaths&&e.startsWith("/")&&/^\/(?!\/|\\|%2f|%5c)[\w\-.\+/@]*(?:\?[\w\-.\+/=&%@]*)?$/.test(e);if(t.includes("*")||t.includes("?")){if(t.includes("://"))return nY(t)(nZ(e)||e);let r=function(e){try{return new URL(e).host}catch{return null}}(e);return!!r&&nY(t)(r)}let i=function(e){try{return new URL(e).protocol}catch{return null}}(e);return"http:"!==i&&"https:"!==i&&i?e.startsWith(t):t===nZ(e)};var nX=e.i(21228),n0=e.i(32749);let n1=i3(async()=>({})),n2=i3.create({use:[n1,i3(async()=>({}))]}),n5=[n1];function n6(e,t,r){let i="string"==typeof e?e:void 0,n="object"==typeof t?t:e,o="function"==typeof t?t:r;return i?i6(i,{...n,use:[...n?.use||[],...n5]},async e=>V(e,()=>o(e))):i6({...n,use:[...n?.use||[],...n5]},async e=>V(e,()=>o(e)))}function n3(e){return e.context.skipOriginCheck&&e.context.options.advanced?.disableCSRFCheck===void 0}let n8=(0,n0.deprecate)(function(){},"disableOriginCheck: true currently also disables CSRF checks. In a future version, disableOriginCheck will ONLY disable URL validation. To keep CSRF disabled, add disableCSRFCheck: true to your config."),n4=n2(async e=>{if(e.request?.method==="GET"||e.request?.method==="OPTIONS"||e.request?.method==="HEAD"||!e.request||(await n7(e),e.context.skipOriginCheck))return;let{body:t,query:r}=e,i=t?.callbackURL||r?.callbackURL,n=t?.redirectTo,o=t?.errorCallbackURL,a=t?.newUserCallbackURL,s=(t,r)=>{if(t&&!e.context.isTrustedOrigin(t,{allowRelativePaths:"origin"!==r}))throw e.context.logger.error(`Invalid ${r}: ${t}`),e.context.logger.info(`If it's a valid URL, please add ${t} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${e.context.trustedOrigins}`),new iH("FORBIDDEN",{message:`Invalid ${r}`})};i&&s(i,"callbackURL"),n&&s(n,"redirectURL"),o&&s(o,"errorCallbackURL"),a&&s(a,"newUserCallbackURL")}),n9=e=>n2(async t=>{if(!t.request||t.context.skipOriginCheck)return;let r=e(t),i=(e,r)=>{if(e&&!t.context.isTrustedOrigin(e,{allowRelativePaths:"origin"!==r}))throw t.context.logger.error(`Invalid ${r}: ${e}`),t.context.logger.info(`If it's a valid URL, please add ${e} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${t.context.trustedOrigins}`),new iH("FORBIDDEN",{message:`Invalid ${r}`})};for(let e of Array.isArray(r)?r:[r])i(e,"callbackURL")});async function n7(e,t=!1){let r=e.request?.headers;if(!r||!e.request)return;let i=r.get("origin")||r.get("referer")||"",n=r.has("cookie");if(e.context.skipCSRFCheck)return;if(n3(e)){e.context.options.advanced?.disableOriginCheck===!0&&n8();return}if(!(t||n))return;if(!i||"null"===i)throw new iH("FORBIDDEN",{message:nX.BASE_ERROR_CODES.MISSING_OR_NULL_ORIGIN});let o=Array.isArray(e.context.options.trustedOrigins)?e.context.trustedOrigins:[...e.context.trustedOrigins,...(await e.context.options.trustedOrigins?.(e.request))?.filter(e=>!!e)||[]];if(!o.some(e=>nQ(i,e)))throw e.context.logger.error(`Invalid origin: ${i}`),e.context.logger.info(`If it's a valid URL, please add ${i} to trustedOrigins in your auth config
`,`Current list of trustedOrigins: ${o}`),new iH("FORBIDDEN",{message:"Invalid origin"})}let oe=n2(async e=>{e.request&&await ot(e)});async function ot(e){let t=e.request;if(!t||e.context.skipCSRFCheck||n3(e))return;let r=t.headers;if(r.has("cookie"))return await n7(e);let i=r.get("Sec-Fetch-Site"),n=r.get("Sec-Fetch-Mode"),o=r.get("Sec-Fetch-Dest");if(i&&i.trim()||n&&n.trim()||o&&o.trim()){if("cross-site"===i&&"navigate"===n)throw e.context.logger.error("Blocked cross-site navigation login attempt (CSRF protection)",{secFetchSite:i,secFetchMode:n,secFetchDest:o}),new iH("FORBIDDEN",{message:nX.BASE_ERROR_CODES.CROSS_SITE_NAVIGATION_LOGIN_BLOCKED});return await n7(e,!0)}}var or=Object.defineProperty,oi=Object.getOwnPropertyDescriptor,on=Object.getOwnPropertyNames,oo=Object.prototype.hasOwnProperty,oa=(e,t,r,i)=>{if(t&&"object"==typeof t||"function"==typeof t)for(var n,o=on(t),a=0,s=o.length;a<s;a++)n=o[a],oo.call(e,n)||n===r||or(e,n,{get:(e=>t[e]).bind(null,n),enumerable:!(i=oi(t,n))||i.enumerable});return e},os=e.i(93012);async function oc(t,r){let i;if(t.database)i="function"==typeof t.database?t.database(t):await r(t);else{let r=Object.keys((0,iI.getAuthTables)(t)).reduce((e,t)=>(e[t]=[],e),{}),{memoryAdapter:n}=await e.A(48752);i=n(r)(t)}return i.transaction||(os.logger.warn("Adapter does not correctly implement transaction function, patching it automatically. Please update your adapter implementation."),i.transaction=async e=>e(i)),i}async function od(t){return oc(t,async t=>{let{createKyselyAdapter:r}=await e.A(76246),{kysely:i,databaseType:n,transaction:o}=await r(t);if(!i)throw new rO.BetterAuthError("Failed to initialize database adapter");let{kyselyAdapter:a}=await e.A(76246);return a(i,{type:n||"sqlite",debugLogs:!!t.database&&"debugLogs"in t.database&&t.database.debugLogs,transaction:o})(t)})}let ol=(e,t)=>({type:e,...t});function ou(e,t){let r=t.id?{id:t.id}:{};for(let i in e){let n=e[i],o=t[i];void 0!==o&&(r[n.fieldName||i]=o)}return r}function op(e,t){if(!t)return null;let r={id:t.id};for(let[i,n]of Object.entries(e))r[i]=t[n.fieldName||i];return r}function oh(e,t){let r=t.hooks;return{createWithHooks:async function(t,i,n){let o=await z().catch(()=>null),a=t;for(let e of r||[]){let t=e[i]?.create?.before;if(t){let e=await t(a,o);if(!1===e)return null;"object"==typeof e&&"data"in e&&(a={...a,...e.data})}}let s=n?await n.fn(a):null,c=!n||n.executeMainFn?await (await Y(e)).create({model:i,data:a,forceAllowId:!0}):s;for(let e of r||[]){let t=e[i]?.create?.after;t&&await t(c,o)}return c},updateWithHooks:async function(t,i,n,o){let a=await z().catch(()=>null),s=t;for(let e of r||[]){let r=e[n]?.update?.before;if(r){let e=await r(t,a);if(!1===e)return null;"object"==typeof e&&"data"in e&&(s={...s,...e.data})}}let c=o?await o.fn(s):null,d=!o||o.executeMainFn?await (await Y(e)).update({model:n,update:s,where:i}):c;for(let e of r||[]){let t=e[n]?.update?.after;t&&await t(d,a)}return d},updateManyWithHooks:async function(t,i,n,o){let a=await z().catch(()=>null),s=t;for(let e of r||[]){let r=e[n]?.update?.before;if(r){let e=await r(t,a);if(!1===e)return null;"object"==typeof e&&"data"in e&&(s={...s,...e.data})}}let c=o?await o.fn(s):null,d=!o||o.executeMainFn?await (await Y(e)).updateMany({model:n,update:s,where:i}):c;for(let e of r||[]){let t=e[n]?.update?.after;t&&await t(d,a)}return d},deleteWithHooks:async function(t,i,n){let o=await z().catch(()=>null),a=null;try{a=(await (await Y(e)).findMany({model:i,where:t,limit:1}))[0]||null}catch{}if(a)for(let e of r||[]){let t=e[i]?.delete?.before;if(t&&await t(a,o)===!1)return null}let s=n?await n.fn(t):null,c=!n||n.executeMainFn?await (await Y(e)).delete({model:i,where:t}):s;if(a)for(let e of r||[]){let t=e[i]?.delete?.after;t&&await t(a,o)}return c},deleteManyWithHooks:async function(t,i,n){let o=await z().catch(()=>null),a=[];try{a=await (await Y(e)).findMany({model:i,where:t})}catch{}for(let e of a)for(let t of r||[]){let r=t[i]?.delete?.before;if(r&&await r(e,o)===!1)return null}let s=n?await n.fn(t):null,c=!n||n.executeMainFn?await (await Y(e)).deleteMany({model:i,where:t}):s;for(let e of a)for(let t of r||[]){let r=t[i]?.delete?.after;r&&await r(e,o)}return c}}}function of(e,t){if(t.advanced?.ipAddress?.disableIpTracking)return null;let r="headers"in e?e.headers:e;for(let e of t.advanced?.ipAddress?.ipAddressHeaders||["x-forwarded-for"]){let t="get"in r?r.get(e):r[e];if("string"==typeof t){var i;let e=t.split(",")[0].trim();if(i=e,iS.ipv4().safeParse(i).success||iS.ipv6().safeParse(i).success)return e}}return(0,nD.isTest)()||(0,nD.isDevelopment)()?"127.0.0.1":null}var om=e.i(56667);let og=(e,t)=>{let r=t.logger,i=t.options,n=i.secondaryStorage,o=i.session?.expiresIn||604800,{createWithHooks:a,updateWithHooks:s,updateManyWithHooks:c,deleteWithHooks:d,deleteManyWithHooks:l}=oh(e,t);async function u(e){if(!n)return;let t=await n.get(`active-sessions-${e.id}`);if(!t)return;let r=Date.now(),i=((0,nw.safeJSONParse)(t)||[]).filter(e=>e.expiresAt>r);await Promise.all(i.map(async({token:t})=>{let i=await n.get(t);if(!i)return;let o=(0,nw.safeJSONParse)(i);if(!o)return;let a=Math.max(Math.floor(new Date(o.session.expiresAt).getTime()-r)/1e3,0);await n.set(t,JSON.stringify({session:o.session,user:e}),Math.floor(a))}))}return{createOAuthUser:async(t,r)=>X(e,async()=>{let e=await a({createdAt:new Date,updatedAt:new Date,...t},"user",void 0);return{user:e,account:await a({...r,userId:e.id,createdAt:new Date,updatedAt:new Date},"account",void 0)}}),createUser:async e=>await a({createdAt:new Date,updatedAt:new Date,...e,email:e.email?.toLowerCase()},"user",void 0),createAccount:async e=>await a({createdAt:new Date,updatedAt:new Date,...e},"account",void 0),listSessions:async r=>{if(n){let e=await n.get(`active-sessions-${r}`);if(!e)return[];let i=(0,nw.safeJSONParse)(e)||[],o=Date.now(),a=new Set,s=[];for(let{token:e,expiresAt:r}of i){if(r<=o||a.has(e))continue;a.add(e);let i=await n.get(e);if(!i)continue;let c=(0,nw.safeJSONParse)(i);c&&s.push(nl(t.options,{...c.session,expiresAt:new Date(c.session.expiresAt)}))}return s}return await (await Y(e)).findMany({model:"session",where:[{field:"userId",value:r}]})},listUsers:async(t,r,i,n)=>await (await Y(e)).findMany({model:"user",limit:t,offset:r,sortBy:i,where:n}),countTotalUsers:async t=>{let r=await (await Y(e)).count({model:"user",where:t});return"string"==typeof r?parseInt(r):r},deleteUser:async e=>{(!n||i.session?.storeSessionInDatabase)&&await l([{field:"userId",value:e}],"session",void 0),await l([{field:"userId",value:e}],"account",void 0),await d([{field:"id",value:e}],"user",void 0)},createSession:async(t,r,s,c)=>{let d=await z().catch(()=>null),l=d?.headers||d?.request?.headers,{id:u,...p}=s||{},h=ng(d?.context.options??i,{}),f={ipAddress:(d?.request||d?.headers)&&of(d?.request||d?.headers,d?.context.options)||"",userAgent:l?.get("user-agent")||"",...p,expiresAt:r?iR(86400,"sec"):iR(o,"sec"),userId:t,token:(0,om.generateId)(32),createdAt:new Date,updatedAt:new Date,...h,...c?p:{}};return await a(f,"session",n?{fn:async r=>{let i=await n.get(`active-sessions-${t}`),o=[],a=Date.now();i&&(o=(o=(0,nw.safeJSONParse)(i)||[]).filter(e=>e.expiresAt>a&&e.token!==f.token));let s=[...o,{token:f.token,expiresAt:f.expiresAt.getTime()}].sort((e,t)=>e.expiresAt-t.expiresAt),c=Math.max(Math.floor(((s.at(-1)?.expiresAt??f.expiresAt.getTime())-a)/1e3),0);c>0&&await n.set(`active-sessions-${t}`,JSON.stringify(s),c);let d=await e.findOne({model:"user",where:[{field:"id",value:t}]}),l=Math.max(Math.floor((f.expiresAt.getTime()-a)/1e3),0);return l>0&&await n.set(f.token,JSON.stringify({session:r,user:d}),l),r},executeMainFn:i.session?.storeSessionInDatabase}:void 0)},findSession:async r=>{if(n){let e=await n.get(r);if(!e&&!i.session?.storeSessionInDatabase)return null;if(e){let r=(0,nw.safeJSONParse)(e);return r?{session:nl(t.options,{...r.session,expiresAt:new Date(r.session.expiresAt),createdAt:new Date(r.session.createdAt),updatedAt:new Date(r.session.updatedAt)}),user:nd(t.options,{...r.user,createdAt:new Date(r.user.createdAt),updatedAt:new Date(r.user.updatedAt)})}:null}}let o=await (await Y(e)).findOne({model:"session",where:[{value:r,field:"token"}],join:{user:!0}});if(!o)return null;let{user:a,...s}=o;return a?{session:nl(t.options,s),user:nd(t.options,a)}:null},findSessions:async t=>{if(n){let e=[];for(let r of t){let t=await n.get(r);if(t){let r=(0,nw.safeJSONParse)(t);if(!r)return[];let i={session:{...r.session,expiresAt:new Date(r.session.expiresAt)},user:{...r.user,createdAt:new Date(r.user.createdAt),updatedAt:new Date(r.user.updatedAt)}};e.push(i)}}return e}let r=await (await Y(e)).findMany({model:"session",where:[{field:"token",value:t,operator:"in"}],join:{user:!0}});return!r.length||r.some(e=>!e.user)?[]:r.map(e=>{let{user:t,...r}=e;return{session:r,user:t}})},updateSession:async(e,r)=>await s(r,[{field:"token",value:e}],"session",n?{async fn(r){let i=await n.get(e);if(!i)return null;let o=(0,nw.safeJSONParse)(i);if(!o)return null;let a={...o.session,...r,expiresAt:new Date(r.expiresAt??o.session.expiresAt),createdAt:new Date(o.session.createdAt),updatedAt:new Date(r.updatedAt??o.session.updatedAt)},s=nl(t.options,a),c=Date.now(),d=new Date(s.expiresAt).getTime(),l=Math.max(Math.floor((d-c)/1e3),0);if(l>0){await n.set(e,JSON.stringify({session:s,user:o.user}),l);let t=`active-sessions-${s.userId}`,r=await n.get(t),i=(r&&(0,nw.safeJSONParse)(r)||[]).filter(t=>t.token!==e&&t.expiresAt>c).concat([{token:e,expiresAt:d}]).sort((e,t)=>e.expiresAt-t.expiresAt),a=i.at(-1)?.expiresAt;a&&a>c?await n.set(t,JSON.stringify(i),Math.floor((a-c)/1e3)):await n.delete(t)}return s},executeMainFn:i.session?.storeSessionInDatabase}:void 0),deleteSession:async e=>{if(n){let o=await n.get(e);if(o){let{session:t}=(0,nw.safeJSONParse)(o)??{};if(!t)return void r.error("Session not found in secondary storage");let i=t.userId,a=await n.get(`active-sessions-${i}`);if(a){let t=(0,nw.safeJSONParse)(a)||[],r=Date.now(),o=t.filter(t=>t.expiresAt>r&&t.token!==e),s=o.sort((e,t)=>e.expiresAt-t.expiresAt).at(-1)?.expiresAt;o.length>0&&s&&s>Date.now()?await n.set(`active-sessions-${i}`,JSON.stringify(o),Math.floor((s-r)/1e3)):await n.delete(`active-sessions-${i}`)}else r.error("Active sessions list not found in secondary storage")}if(await n.delete(e),!i.session?.storeSessionInDatabase||t.options.session?.preserveSessionInDatabase)return}await d([{field:"token",value:e}],"session",void 0)},deleteAccounts:async e=>{await l([{field:"userId",value:e}],"account",void 0)},deleteAccount:async e=>{await d([{field:"id",value:e}],"account",void 0)},deleteSessions:async e=>{if(n){if("string"==typeof e){let t=await n.get(`active-sessions-${e}`),r=t?(0,nw.safeJSONParse)(t):[];if(!r)return;for(let e of r)await n.delete(e.token);await n.delete(`active-sessions-${e}`)}else for(let t of e)await n.get(t)&&await n.delete(t);if(!i.session?.storeSessionInDatabase||t.options.session?.preserveSessionInDatabase)return}await l([{field:Array.isArray(e)?"token":"userId",value:e,operator:Array.isArray(e)?"in":void 0}],"session",void 0)},findOAuthUser:async(t,r,i)=>{let n=await (await Y(e)).findMany({model:"account",where:[{value:r,field:"accountId"}],join:{user:!0}}).then(e=>e.find(e=>e.providerId===i));if(n)if(n.user)return{user:n.user,accounts:[n]};else{let r=await (await Y(e)).findOne({model:"user",where:[{value:t.toLowerCase(),field:"email"}]});return r?{user:r,accounts:[n]}:null}{let r=await (await Y(e)).findOne({model:"user",where:[{value:t.toLowerCase(),field:"email"}]});return r?{user:r,accounts:await (await Y(e)).findMany({model:"account",where:[{value:r.id,field:"userId"}]})||[]}:null}},findUserByEmail:async(t,r)=>{let i=await (await Y(e)).findOne({model:"user",where:[{value:t.toLowerCase(),field:"email"}],join:{...r?.includeAccounts?{account:!0}:{}}});if(!i)return null;let{account:n,...o}=i;return{user:o,accounts:n??[]}},findUserById:async t=>t?await (await Y(e)).findOne({model:"user",where:[{field:"id",value:t}]}):null,linkAccount:async e=>await a({createdAt:new Date,updatedAt:new Date,...e},"account",void 0),updateUser:async(e,t)=>{let r=await s(t,[{field:"id",value:e}],"user",void 0);return await u(r),r},updateUserByEmail:async(e,t)=>{let r=await s(t,[{field:"email",value:e.toLowerCase()}],"user",void 0);return await u(r),r},updatePassword:async(e,t)=>{await c({password:t},[{field:"userId",value:e},{field:"providerId",value:"credential"}],"account",void 0)},findAccounts:async t=>await (await Y(e)).findMany({model:"account",where:[{field:"userId",value:t}]}),findAccount:async t=>await (await Y(e)).findOne({model:"account",where:[{field:"accountId",value:t}]}),findAccountByProviderId:async(t,r)=>await (await Y(e)).findOne({model:"account",where:[{field:"accountId",value:t},{field:"providerId",value:r}]}),findAccountByUserId:async t=>await (await Y(e)).findMany({model:"account",where:[{field:"userId",value:t}]}),updateAccount:async(e,t)=>await s(t,[{field:"id",value:e}],"account",void 0),createVerificationValue:async e=>await a({createdAt:new Date,updatedAt:new Date,...e},"verification",void 0),findVerificationValue:async t=>{let r=await (await Y(e)).findMany({model:"verification",where:[{field:"identifier",value:t}],sortBy:{field:"createdAt",direction:"desc"},limit:1});return i.verification?.disableCleanup||await l([{field:"expiresAt",value:new Date,operator:"lt"}],"verification",void 0),r[0]},deleteVerificationValue:async e=>{await d([{field:"id",value:e}],"verification",void 0)},deleteVerificationByIdentifier:async e=>{await d([{field:"identifier",value:e}],"verification",void 0)},updateVerificationValue:async(e,t)=>await s(t,[{field:"id",value:e}],"verification",void 0)}};e.i(75303),e.s(["default",0,iU],95038),e.i(95038),e.s(["$brand",()=>iU.$brand,"$input",()=>iU.$input,"$output",()=>iU.$output,"NEVER",()=>iU.NEVER,"TimePrecision",()=>iU.TimePrecision,"ZodAny",()=>iU.ZodAny,"ZodArray",()=>iU.ZodArray,"ZodBase64",()=>iU.ZodBase64,"ZodBase64URL",()=>iU.ZodBase64URL,"ZodBigInt",()=>iU.ZodBigInt,"ZodBigIntFormat",()=>iU.ZodBigIntFormat,"ZodBoolean",()=>iU.ZodBoolean,"ZodCIDRv4",()=>iU.ZodCIDRv4,"ZodCIDRv6",()=>iU.ZodCIDRv6,"ZodCUID",()=>iU.ZodCUID,"ZodCUID2",()=>iU.ZodCUID2,"ZodCatch",()=>iU.ZodCatch,"ZodCodec",()=>iU.ZodCodec,"ZodCustom",()=>iU.ZodCustom,"ZodCustomStringFormat",()=>iU.ZodCustomStringFormat,"ZodDate",()=>iU.ZodDate,"ZodDefault",()=>iU.ZodDefault,"ZodDiscriminatedUnion",()=>iU.ZodDiscriminatedUnion,"ZodE164",()=>iU.ZodE164,"ZodEmail",()=>iU.ZodEmail,"ZodEmoji",()=>iU.ZodEmoji,"ZodEnum",()=>iU.ZodEnum,"ZodError",()=>iU.ZodError,"ZodExactOptional",()=>iU.ZodExactOptional,"ZodFile",()=>iU.ZodFile,"ZodFirstPartyTypeKind",()=>iU.ZodFirstPartyTypeKind,"ZodFunction",()=>iU.ZodFunction,"ZodGUID",()=>iU.ZodGUID,"ZodIPv4",()=>iU.ZodIPv4,"ZodIPv6",()=>iU.ZodIPv6,"ZodISODate",()=>iU.ZodISODate,"ZodISODateTime",()=>iU.ZodISODateTime,"ZodISODuration",()=>iU.ZodISODuration,"ZodISOTime",()=>iU.ZodISOTime,"ZodIntersection",()=>iU.ZodIntersection,"ZodIssueCode",()=>iU.ZodIssueCode,"ZodJWT",()=>iU.ZodJWT,"ZodKSUID",()=>iU.ZodKSUID,"ZodLazy",()=>iU.ZodLazy,"ZodLiteral",()=>iU.ZodLiteral,"ZodMAC",()=>iU.ZodMAC,"ZodMap",()=>iU.ZodMap,"ZodNaN",()=>iU.ZodNaN,"ZodNanoID",()=>iU.ZodNanoID,"ZodNever",()=>iU.ZodNever,"ZodNonOptional",()=>iU.ZodNonOptional,"ZodNull",()=>iU.ZodNull,"ZodNullable",()=>iU.ZodNullable,"ZodNumber",()=>iU.ZodNumber,"ZodNumberFormat",()=>iU.ZodNumberFormat,"ZodObject",()=>iU.ZodObject,"ZodOptional",()=>iU.ZodOptional,"ZodPipe",()=>iU.ZodPipe,"ZodPrefault",()=>iU.ZodPrefault,"ZodPromise",()=>iU.ZodPromise,"ZodReadonly",()=>iU.ZodReadonly,"ZodRealError",()=>iU.ZodRealError,"ZodRecord",()=>iU.ZodRecord,"ZodSet",()=>iU.ZodSet,"ZodString",()=>iU.ZodString,"ZodStringFormat",()=>iU.ZodStringFormat,"ZodSuccess",()=>iU.ZodSuccess,"ZodSymbol",()=>iU.ZodSymbol,"ZodTemplateLiteral",()=>iU.ZodTemplateLiteral,"ZodTransform",()=>iU.ZodTransform,"ZodTuple",()=>iU.ZodTuple,"ZodType",()=>iU.ZodType,"ZodULID",()=>iU.ZodULID,"ZodURL",()=>iU.ZodURL,"ZodUUID",()=>iU.ZodUUID,"ZodUndefined",()=>iU.ZodUndefined,"ZodUnion",()=>iU.ZodUnion,"ZodUnknown",()=>iU.ZodUnknown,"ZodVoid",()=>iU.ZodVoid,"ZodXID",()=>iU.ZodXID,"ZodXor",()=>iU.ZodXor,"_ZodString",()=>iU._ZodString,"_default",()=>iU._default,"_function",()=>iU._function,"any",()=>iU.any,"array",()=>iU.array,"base64",()=>iU.base64,"base64url",()=>iU.base64url,"bigint",()=>iU.bigint,"boolean",()=>iU.boolean,"catch",()=>iU.catch,"check",()=>iU.check,"cidrv4",()=>iU.cidrv4,"cidrv6",()=>iU.cidrv6,"clone",()=>iU.clone,"codec",()=>iU.codec,"coerce",()=>iU.coerce,"config",()=>iU.config,"core",()=>iU.core,"cuid",()=>iU.cuid,"cuid2",()=>iU.cuid2,"custom",()=>iU.custom,"date",()=>iU.date,"decode",()=>iU.decode,"decodeAsync",()=>iU.decodeAsync,"default",0,iU,"describe",()=>iU.describe,"discriminatedUnion",()=>iU.discriminatedUnion,"e164",()=>iU.e164,"email",()=>iU.email,"emoji",()=>iU.emoji,"encode",()=>iU.encode,"encodeAsync",()=>iU.encodeAsync,"endsWith",()=>iU.endsWith,"enum",()=>iU.enum,"exactOptional",()=>iU.exactOptional,"file",()=>iU.file,"flattenError",()=>iU.flattenError,"float32",()=>iU.float32,"float64",()=>iU.float64,"formatError",()=>iU.formatError,"fromJSONSchema",()=>iU.fromJSONSchema,"function",()=>iU.function,"getErrorMap",()=>iU.getErrorMap,"globalRegistry",()=>iU.globalRegistry,"gt",()=>iU.gt,"gte",()=>iU.gte,"guid",()=>iU.guid,"hash",()=>iU.hash,"hex",()=>iU.hex,"hostname",()=>iU.hostname,"httpUrl",()=>iU.httpUrl,"includes",()=>iU.includes,"instanceof",()=>iU.instanceof,"int",()=>iU.int,"int32",()=>iU.int32,"int64",()=>iU.int64,"intersection",()=>iU.intersection,"ipv4",()=>iU.ipv4,"ipv6",()=>iU.ipv6,"iso",()=>iU.iso,"json",()=>iU.json,"jwt",()=>iU.jwt,"keyof",()=>iU.keyof,"ksuid",()=>iU.ksuid,"lazy",()=>iU.lazy,"length",()=>iU.length,"literal",()=>iU.literal,"locales",()=>iU.locales,"looseObject",()=>iU.looseObject,"looseRecord",()=>iU.looseRecord,"lowercase",()=>iU.lowercase,"lt",()=>iU.lt,"lte",()=>iU.lte,"mac",()=>iU.mac,"map",()=>iU.map,"maxLength",()=>iU.maxLength,"maxSize",()=>iU.maxSize,"meta",()=>iU.meta,"mime",()=>iU.mime,"minLength",()=>iU.minLength,"minSize",()=>iU.minSize,"multipleOf",()=>iU.multipleOf,"nan",()=>iU.nan,"nanoid",()=>iU.nanoid,"nativeEnum",()=>iU.nativeEnum,"negative",()=>iU.negative,"never",()=>iU.never,"nonnegative",()=>iU.nonnegative,"nonoptional",()=>iU.nonoptional,"nonpositive",()=>iU.nonpositive,"normalize",()=>iU.normalize,"null",()=>iU.null,"nullable",()=>iU.nullable,"nullish",()=>iU.nullish,"number",()=>iU.number,"object",()=>iU.object,"optional",()=>iU.optional,"overwrite",()=>iU.overwrite,"parse",()=>iU.parse,"parseAsync",()=>iU.parseAsync,"partialRecord",()=>iU.partialRecord,"pipe",()=>iU.pipe,"positive",()=>iU.positive,"prefault",()=>iU.prefault,"preprocess",()=>iU.preprocess,"prettifyError",()=>iU.prettifyError,"promise",()=>iU.promise,"property",()=>iU.property,"readonly",()=>iU.readonly,"record",()=>iU.record,"refine",()=>iU.refine,"regex",()=>iU.regex,"regexes",()=>iU.regexes,"registry",()=>iU.registry,"safeDecode",()=>iU.safeDecode,"safeDecodeAsync",()=>iU.safeDecodeAsync,"safeEncode",()=>iU.safeEncode,"safeEncodeAsync",()=>iU.safeEncodeAsync,"safeParse",()=>iU.safeParse,"safeParseAsync",()=>iU.safeParseAsync,"set",()=>iU.set,"setErrorMap",()=>iU.setErrorMap,"size",()=>iU.size,"slugify",()=>iU.slugify,"startsWith",()=>iU.startsWith,"strictObject",()=>iU.strictObject,"string",()=>iU.string,"stringFormat",()=>iU.stringFormat,"stringbool",()=>iU.stringbool,"success",()=>iU.success,"superRefine",()=>iU.superRefine,"symbol",()=>iU.symbol,"templateLiteral",()=>iU.templateLiteral,"toJSONSchema",()=>iU.toJSONSchema,"toLowerCase",()=>iU.toLowerCase,"toUpperCase",()=>iU.toUpperCase,"transform",()=>iU.transform,"treeifyError",()=>iU.treeifyError,"trim",()=>iU.trim,"tuple",()=>iU.tuple,"uint32",()=>iU.uint32,"uint64",()=>iU.uint64,"ulid",()=>iU.ulid,"undefined",()=>iU.undefined,"union",()=>iU.union,"unknown",()=>iU.unknown,"uppercase",()=>iU.uppercase,"url",()=>iU.url,"util",()=>iU.util,"uuid",()=>iU.uuid,"uuidv4",()=>iU.uuidv4,"uuidv6",()=>iU.uuidv6,"uuidv7",()=>iU.uuidv7,"void",()=>iU.void,"xid",()=>iU.xid,"xor",()=>iU.xor,"z",0,iU],70666);var oy=e.i(70666);function ow({fields:e,isClientSide:t}){let r=Object.keys(e).reduce((r,i)=>{let n,o=e[i];return!o||t&&!1===o.input||(n="json"===o.type?oy.json?oy.json():oy.any():"string[]"===o.type||"number[]"===o.type?oy.array("string[]"===o.type?oy.string():oy.number()):Array.isArray(o.type)?oy.any():oy[o.type](),o?.required===!1&&(n=n.optional()),o?.returned===!1)?r:{...r,[i]:n}},{});return oy.object(r)}function ob(e){let t=(0,ox.getAuthTables)(e),r={};for(let e in t){let i=t[e],n=i.fields,o={};if(Object.entries(n).forEach(([e,r])=>{if(o[r.fieldName||e]=r,r.references){let i=t[r.references.model];i&&(o[r.fieldName||e].references={...r.references,model:i.modelName,field:r.references.field})}}),r[i.modelName]){r[i.modelName].fields={...r[i.modelName].fields,...o};continue}r[i.modelName]={fields:o,order:i.order||1/0}}return r}var oE=e.i(22115),o_=e.i(740);e.i(69138);var oA=e.i(64349),oT=e.i(45508);let ov={postgres:{string:["character varying","varchar","text","uuid"],number:["int4","integer","bigint","smallint","numeric","real","double precision"],boolean:["bool","boolean"],date:["timestamptz","timestamp","date"],json:["json","jsonb"]},mysql:{string:["varchar","text","uuid"],number:["integer","int","bigint","smallint","decimal","float","double"],boolean:["boolean","tinyint"],date:["timestamp","datetime","date"],json:["json"]},sqlite:{string:["TEXT"],number:["INTEGER","REAL"],boolean:["INTEGER","BOOLEAN"],date:["DATE","INTEGER"],json:["TEXT"]},mssql:{string:["varchar","nvarchar","uniqueidentifier"],number:["int","bigint","smallint","decimal","float","double"],boolean:["bit","smallint"],date:["datetime2","date","datetime"],json:["varchar","nvarchar"]}};function ok(e,t,r){if("string[]"===t||"number[]"===t)return e.toLowerCase().includes("json");let i=ov[r];return(Array.isArray(t)?i.string.map(e=>e.toLowerCase()):i[t].map(e=>e.toLowerCase())).includes(e.toLowerCase().split("(")[0].trim())}async function oR(e){try{let t=await o_.sql`SHOW search_path`.execute(e);if(t.rows[0]?.search_path)return t.rows[0].search_path.split(",").map(e=>e.trim()).map(e=>e.replace(/^["']|["']$/g,"")).filter(e=>!e.startsWith("$"))[0]||"public"}catch{}return"public"}async function oI(e){let t=ob(e),r=(0,os.createLogger)(e.logger),{kysely:i,databaseType:n}=await (0,oE.createKyselyAdapter)(e);n||(r.warn("Could not determine database type, defaulting to sqlite. Please provide a type in the database options to avoid this."),n="sqlite"),i||(r.error("Only kysely adapter is supported for migrations. You can use `generate` command to generate the schema, if you're using a different adapter."),process.exit(1));let o="public";if("postgres"===n){o=await oR(i),r.debug(`PostgreSQL migration: Using schema '${o}' (from search_path)`);try{(await o_.sql`
				SELECT schema_name 
				FROM information_schema.schemata 
				WHERE schema_name = ${o}
			`.execute(i)).rows[0]||r.warn(`Schema '${o}' does not exist. Tables will be inspected from available schemas. Consider creating the schema first or checking your database configuration.`)}catch(e){r.debug(`Could not verify schema existence: ${e instanceof Error?e.message:String(e)}`)}}let a=await i.introspection.getTables(),s=a;if("postgres"===n)try{let e=await o_.sql`
				SELECT table_name 
				FROM information_schema.tables 
				WHERE table_schema = ${o}
				AND table_type = 'BASE TABLE'
			`.execute(i),t=new Set(e.rows.map(e=>e.table_name));s=a.filter(e=>e.schema===o&&t.has(e.name)),r.debug(`Found ${s.length} table(s) in schema '${o}': ${s.map(e=>e.name).join(", ")||"(none)"}`)}catch(e){r.warn(`Could not filter tables by schema. Using all discovered tables. Error: ${e instanceof Error?e.message:String(e)}`)}let c=[],d=[];for(let[e,i]of Object.entries(t)){let t=s.find(t=>t.name===e);if(!t){let t=c.findIndex(t=>t.table===e),r={table:e,fields:i.fields,order:i.order||1/0},n=c.findIndex(e=>(e.order||1/0)>r.order);-1===n?-1===t?c.push(r):c[t].fields={...c[t].fields,...i.fields}:c.splice(n,0,r);continue}let o={};for(let[a,s]of Object.entries(i.fields)){let i=t.columns.find(e=>e.name===a);if(!i){o[a]=s;continue}ok(i.dataType,s.type,n)||r.warn(`Field ${a} in table ${e} has a different type in the database. Expected ${s.type} but got ${i.dataType}.`)}Object.keys(o).length>0&&d.push({table:e,fields:o,order:i.order||1/0})}let l=[],u=e.advanced?.database?.generateId==="uuid",p=e.advanced?.database?.useNumberId||e.advanced?.database?.generateId==="serial";function h(e,t){let r=e.type,i=n||"sqlite",o={string:{sqlite:"text",postgres:"text",mysql:e.unique?"varchar(255)":e.references?"varchar(36)":e.sortable||e.index?"varchar(255)":"text",mssql:e.unique||e.sortable?"varchar(255)":e.references?"varchar(36)":"varchar(8000)"},boolean:{sqlite:"integer",postgres:"boolean",mysql:"boolean",mssql:"smallint"},number:{sqlite:e.bigint?"bigint":"integer",postgres:e.bigint?"bigint":"integer",mysql:e.bigint?"bigint":"integer",mssql:e.bigint?"bigint":"integer"},date:{sqlite:"date",postgres:"timestamptz",mysql:"timestamp(3)",mssql:o_.sql`datetime2(3)`},json:{sqlite:"text",postgres:"jsonb",mysql:"json",mssql:"varchar(8000)"},id:{postgres:p?o_.sql`integer GENERATED BY DEFAULT AS IDENTITY`:u?"uuid":"text",mysql:p?"integer":"varchar(36)",mssql:p?"integer":"varchar(36)",sqlite:p?"integer":"text"},foreignKeyId:{postgres:p?"integer":u?"uuid":"text",mysql:p?"integer":"varchar(36)",mssql:p?"integer":"varchar(36)",sqlite:p?"integer":"text"},"string[]":{sqlite:"text",postgres:"jsonb",mysql:"json",mssql:"varchar(8000)"},"number[]":{sqlite:"text",postgres:"jsonb",mysql:"json",mssql:"varchar(8000)"}};if("id"===t||e.references?.field==="id")return"id"===t?o.id[i]:o.foreignKeyId[i];if(Array.isArray(r))return"text";if(!(r in o))throw Error(`Unsupported field type '${String(r)}' for field '${t}'. Allowed types are: string, number, boolean, date, string[], number[]. If you need to store structured data, store it as a JSON string (type: "string") or split it into primitive fields. See https://better-auth.com/docs/advanced/schema#additional-fields`);return o[r][i]}let f=(0,oT.initGetModelName)({schema:(0,iI.getAuthTables)(e),usePlural:!1}),m=(0,oA.initGetFieldName)({schema:(0,iI.getAuthTables)(e),usePlural:!1});function g(e,t){try{return`${f(e)}.${m({model:e,field:t})}`}catch{return`${e}.${t}`}}if(d.length)for(let e of d)for(let[t,r]of Object.entries(e.fields)){let o=h(r,t),a=i.schema.alterTable(e.table);if(r.index){let r=i.schema.alterTable(e.table).addIndex(`${e.table}_${t}_idx`);l.push(r)}let s=a.addColumn(t,o,e=>(e=!1!==r.required?e.notNull():e,r.references&&(e=e.references(g(r.references.model,r.references.field)).onDelete(r.references.onDelete||"cascade")),r.unique&&(e=e.unique()),"date"===r.type&&"function"==typeof r.defaultValue&&("postgres"===n||"mysql"===n||"mssql"===n)&&(e="mysql"===n?e.defaultTo(o_.sql`CURRENT_TIMESTAMP(3)`):e.defaultTo(o_.sql`CURRENT_TIMESTAMP`)),e));l.push(s)}let y=[];if(e.advanced?.database?.useNumberId&&r.warn("`useNumberId` is deprecated. Please use `generateId` with `serial` instead."),c.length)for(let e of c){let t=h({type:p?"number":"string"},"id"),r=i.schema.createTable(e.table).addColumn("id",t,e=>{if(p)return"postgres"===n?e.primaryKey().notNull():"sqlite"===n?e.primaryKey().notNull():"mssql"===n?e.identity().primaryKey().notNull():e.autoIncrement().primaryKey().notNull();return u&&"postgres"===n?e.primaryKey().defaultTo(o_.sql`pg_catalog.gen_random_uuid()`).notNull():e.primaryKey().notNull()});for(let[t,o]of Object.entries(e.fields)){let a=h(o,t);if(r=r.addColumn(t,a,e=>(e=!1!==o.required?e.notNull():e,o.references&&(e=e.references(g(o.references.model,o.references.field)).onDelete(o.references.onDelete||"cascade")),o.unique&&(e=e.unique()),"date"===o.type&&"function"==typeof o.defaultValue&&("postgres"===n||"mysql"===n||"mssql"===n)&&(e="mysql"===n?e.defaultTo(o_.sql`CURRENT_TIMESTAMP(3)`):e.defaultTo(o_.sql`CURRENT_TIMESTAMP`)),e)),o.index){let r=i.schema.createIndex(`${e.table}_${t}_${o.unique?"uidx":"idx"}`).on(e.table).columns([t]);y.push(o.unique?r.unique():r)}}l.push(r)}if(y.length)for(let e of y)l.push(e);return{toBeCreated:c,toBeAdded:d,runMigrations:async function(){for(let e of l)await e.execute()},compileMigrations:async function(){return l.map(e=>e.compile().sql).join(";\n\n")+";"}}}e.i(35546),e.s(["accountSchema",()=>iO,"coreSchema",()=>ix,"getAuthTables",()=>iI.getAuthTables,"rateLimitSchema",()=>iD,"sessionSchema",()=>iC,"userSchema",()=>iN,"verificationSchema",()=>iP],35043);var oS=e.i(35043),ox=((e,t)=>{let r={};for(var i in e)or(r,i,{get:e[i],enumerable:!0});return t&&or(r,Symbol.toStringTag,{value:"Module"}),r})({convertFromDB:()=>op,convertToDB:()=>ou,createFieldAttribute:()=>ol,createInternalAdapter:()=>og,getAdapter:()=>od,getBaseAdapter:()=>oc,getMigrations:()=>oI,getSchema:()=>ob,getWithHooks:()=>oh,matchType:()=>ok,mergeSchema:()=>ny,parseAccountInput:()=>nm,parseAccountOutput:()=>nu,parseAdditionalUserInput:()=>nf,parseInputData:()=>np,parseSessionInput:()=>ng,parseSessionOutput:()=>nl,parseUserInput:()=>nh,parseUserOutput:()=>nd,toZodSchema:()=>ow});g&&(or(ox,Symbol.toStringTag,{value:"Module"}),m&&or(m,Symbol.toStringTag,{value:"Module"})),oa(ox,oS,"default"),m&&oa(m,oS,"default");let oU=()=>n6("/get-session",{method:"GET",operationId:"getSession",query:nI,requireHeaders:!0,metadata:{openapi:{operationId:"getSession",description:"Get the current session",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",nullable:!0,properties:{session:{$ref:"#/components/schemas/Session"},user:{$ref:"#/components/schemas/User"}},required:["session","user"]}}}}}}}},async e=>{try{let t=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(!t)return null;let r=nv(e,e.context.authCookies.sessionData.name),i=null;if(r){let t=e.context.options.session?.cookieCache?.strategy||"compact";if("jwe"===t){let t=await rU(r,e.context.secret,"better-auth-session");if(!t||!t.session||!t.user)return nB(e,e.context.authCookies.sessionData),e.json(null);i={session:{session:t.session,user:t.user,updatedAt:t.updatedAt,version:t.version},expiresAt:t.exp?1e3*t.exp:Date.now()}}else if("jwt"===t){let t=await rR(r,e.context.secret);if(!t||!t.session||!t.user)return nB(e,e.context.authCookies.sessionData),e.json(null);i={session:{session:t.session,user:t.user,updatedAt:t.updatedAt,version:t.version},expiresAt:t.exp?1e3*t.exp:Date.now()}}else{let t=(0,nw.safeJSONParse)(nN.decode(rK.decode(r)));if(t)if(!await nP("SHA-256","base64urlnopad").verify(e.context.secret,JSON.stringify({...t.session,expiresAt:t.expiresAt}),t.signature))return nB(e,e.context.authCookies.sessionData),e.json(null);else i=t}}let n=await e.getSignedCookie(e.context.authCookies.dontRememberToken.name,e.context.secret);if(i?.session&&e.context.options.session?.cookieCache?.enabled&&!e.query?.disableCookieCache){let t=i.session,r=e.context.options.session?.cookieCache?.version,n="1";if(r){if("string"==typeof r)n=r;else if("function"==typeof r){let e=r(t.session,t.user);n=e instanceof Promise?await e:e}}if((t.version||"1")!==n)nB(e,e.context.authCookies.sessionData);else{let r=new Date(t.session.expiresAt);if(i.expiresAt<Date.now()||r<new Date)nB(e,e.context.authCookies.sessionData);else{let r=e.context.sessionConfig.cookieRefreshCache;if(!1===r){e.context.session=t;let r=nl(e.context.options,{...t.session,expiresAt:new Date(t.session.expiresAt),createdAt:new Date(t.session.createdAt),updatedAt:new Date(t.session.updatedAt)}),i=nd(e.context.options,{...t.user,createdAt:new Date(t.user.createdAt),updatedAt:new Date(t.user.updatedAt)});return e.json({session:r,user:i})}if(i.expiresAt-Date.now()<1e3*r.updateAge){let r=iR(e.context.options.session?.cookieCache?.maxAge||300,"sec"),i={session:{...t.session,expiresAt:r},user:t.user,updatedAt:Date.now()};await nj(e,i,!1);let n=nl(e.context.options,{...i.session,expiresAt:new Date(i.session.expiresAt),createdAt:new Date(i.session.createdAt),updatedAt:new Date(i.session.updatedAt)}),o=nd(e.context.options,{...i.user,createdAt:new Date(i.user.createdAt),updatedAt:new Date(i.user.updatedAt)});return e.context.session={session:n,user:o},e.json({session:n,user:o})}let n=nl(e.context.options,{...t.session,expiresAt:new Date(t.session.expiresAt),createdAt:new Date(t.session.createdAt),updatedAt:new Date(t.session.updatedAt)}),o=nd(e.context.options,{...t.user,createdAt:new Date(t.user.createdAt),updatedAt:new Date(t.user.updatedAt)});return e.context.session={session:n,user:o},e.json({session:n,user:o})}}}let o=await e.context.internalAdapter.findSession(t);if(e.context.session=o,!o||o.session.expiresAt<new Date)return nH(e),o&&await e.context.internalAdapter.deleteSession(o.session.token),e.json(null);if(n||e.query?.disableRefresh){let t=nl(e.context.options,o.session),r=nd(e.context.options,o.user);return e.json({session:t,user:r})}let a=e.context.sessionConfig.expiresIn,s=e.context.sessionConfig.updateAge;if(o.session.expiresAt.valueOf()-1e3*a+1e3*s<=Date.now()&&(!e.query?.disableRefresh||!e.context.options.session?.disableSessionRefresh)){let t=await e.context.internalAdapter.updateSession(o.session.token,{expiresAt:iR(e.context.sessionConfig.expiresIn,"sec"),updatedAt:new Date});if(!t)return nH(e),e.json(null,{status:401});let r=(t.expiresAt.valueOf()-Date.now())/1e3;await nq(e,{session:t,user:o.user},!1,{maxAge:r});let i=nl(e.context.options,t),n=nd(e.context.options,o.user);return e.json({session:i,user:n})}await nj(e,o,!!n);let c=nl(e.context.options,o.session),d=nd(e.context.options,o.user);return e.json({session:c,user:d})}catch(t){throw e.context.logger.error("INTERNAL_SERVER_ERROR",t),new iH("INTERNAL_SERVER_ERROR",{message:nX.BASE_ERROR_CODES.FAILED_TO_GET_SESSION})}}),oO=async(e,t)=>{if(e.context.session)return e.context.session;let r=await oU()({...e,asResponse:!1,headers:e.headers,returnHeaders:!1,returnStatus:!1,query:{...t,...e.query}}).catch(e=>null);return e.context.session=r,r},oD=n2(async e=>{let t=await oO(e);if(!t?.session)throw new iH("UNAUTHORIZED");return{session:t}}),oC=n2(async e=>{let t=await oO(e,{disableCookieCache:!0});if(!t?.session)throw new iH("UNAUTHORIZED");return{session:t}});n2(async e=>{let t=await oO(e);if(!t?.session&&(e.request||e.headers))throw new iH("UNAUTHORIZED");return{session:t}});let oN=n2(async e=>{let t=await oO(e);if(!t?.session)throw new iH("UNAUTHORIZED");if(0===e.context.sessionConfig.freshAge)return{session:t};let r=e.context.sessionConfig.freshAge,i=new Date(t.session.updatedAt||t.session.createdAt).getTime();if(!(Date.now()-i<1e3*r))throw new iH("FORBIDDEN",{message:"Session is not fresh"});return{session:t}}),oP=n6("/revoke-session",{method:"POST",body:iS.object({token:iS.string().meta({description:"The token to revoke"})}),use:[oC],requireHeaders:!0,metadata:{openapi:{description:"Revoke a single session",requestBody:{content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",description:"The token to revoke"}},required:["token"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the session was revoked successfully"}},required:["status"]}}}}}}}},async e=>{let t=e.body.token;if((await e.context.internalAdapter.findSession(t))?.session.userId===e.context.session.user.id)try{await e.context.internalAdapter.deleteSession(t)}catch(t){throw e.context.logger.error(t&&"object"==typeof t&&"name"in t?t.name:"",t),new iH("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),oL=n6("/revoke-sessions",{method:"POST",use:[oC],requireHeaders:!0,metadata:{openapi:{description:"Revoke all sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if all sessions were revoked successfully"}},required:["status"]}}}}}}}},async e=>{try{await e.context.internalAdapter.deleteSessions(e.context.session.user.id)}catch(t){throw e.context.logger.error(t&&"object"==typeof t&&"name"in t?t.name:"",t),new iH("INTERNAL_SERVER_ERROR")}return e.json({status:!0})}),oj=n6("/revoke-other-sessions",{method:"POST",requireHeaders:!0,use:[oC],metadata:{openapi:{description:"Revoke all other sessions for the user except the current one",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if all other sessions were revoked successfully"}},required:["status"]}}}}}}}},async e=>{let t=e.context.session;if(!t.user)throw new iH("UNAUTHORIZED");let r=(await e.context.internalAdapter.listSessions(t.user.id)).filter(e=>e.expiresAt>new Date).filter(t=>t.token!==e.context.session.session.token);return await Promise.all(r.map(t=>e.context.internalAdapter.deleteSession(t.token))),e.json({status:!0})});async function oq(e,t,r,i=3600,n){return await rk({email:t.toLowerCase(),updateTo:r,...n},e,i)}async function oB(e,t){if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new iH("BAD_REQUEST",{message:"Verification email isn't enabled"});let r=await oq(e.context.secret,t.email,void 0,e.context.options.emailVerification?.expiresIn),i=e.body.callbackURL?encodeURIComponent(e.body.callbackURL):encodeURIComponent("/"),n=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${i}`;await e.context.runInBackgroundOrAwait(e.context.options.emailVerification.sendVerificationEmail({user:t,url:n,token:r},e.request))}let oH=n6("/send-verification-email",{method:"POST",operationId:"sendVerificationEmail",body:iS.object({email:iS.email().meta({description:"The email to send the verification email to"}),callbackURL:iS.string().meta({description:"The URL to use for email verification callback"}).optional()}),metadata:{openapi:{operationId:"sendVerificationEmail",description:"Send a verification email to the user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{email:{type:"string",description:"The email to send the verification email to",example:"user@example.com"},callbackURL:{type:"string",description:"The URL to use for email verification callback",example:"https://example.com/callback",nullable:!0}},required:["email"]}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean",description:"Indicates if the email was sent successfully",example:!0}}}}}},400:{description:"Bad Request",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string",description:"Error message",example:"Verification email isn't enabled"}}}}}}}}}},async e=>{if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new iH("BAD_REQUEST",{message:"Verification email isn't enabled"});let{email:t}=e.body,r=await oO(e);if(!r){let r=await e.context.internalAdapter.findUserByEmail(t);return r?await oB(e,r.user):await oq(e.context.secret,t,void 0,e.context.options.emailVerification?.expiresIn),e.json({status:!0})}if(r?.user.email!==t)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.EMAIL_MISMATCH});if(r?.user.emailVerified)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.EMAIL_ALREADY_VERIFIED});return await oB(e,r.user),e.json({status:!0})}),o$=n6("/verify-email",{method:"GET",operationId:"verifyEmail",query:iS.object({token:iS.string().meta({description:"The token to verify the email"}),callbackURL:iS.string().meta({description:"The URL to redirect to after email verification"}).optional()}),use:[n9(e=>e.query.callbackURL)],metadata:{openapi:{description:"Verify the email of the user",parameters:[{name:"token",in:"query",description:"The token to verify the email",required:!0,schema:{type:"string"}},{name:"callbackURL",in:"query",description:"The URL to redirect to after email verification",required:!1,schema:{type:"string"}}],responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",$ref:"#/components/schemas/User"},status:{type:"boolean",description:"Indicates if the email was verified successfully"}},required:["user","status"]}}}}}}}},async e=>{let t;function r(t){if(e.query.callbackURL){if(e.query.callbackURL.includes("?"))throw e.redirect(`${e.query.callbackURL}&error=${t}`);throw e.redirect(`${e.query.callbackURL}?error=${t}`)}throw new iH("UNAUTHORIZED",{message:t})}let{token:i}=e.query;try{t=await rv(i,new TextEncoder().encode(e.context.secret),{algorithms:["HS256"]})}catch(e){if(e instanceof e5)return r("token_expired");return r("invalid_token")}let n=iS.object({email:iS.email(),updateTo:iS.string().optional(),requestType:iS.string().optional()}).parse(t.payload),o=await e.context.internalAdapter.findUserByEmail(n.email);if(!o)return r("user_not_found");if(n.updateTo){let t=await oO(e);if(t&&t.user.email!==n.email)return r("unauthorized");switch(n.requestType){case"change-email-confirmation":{let t=await oq(e.context.secret,n.email,n.updateTo,e.context.options.emailVerification?.expiresIn,{requestType:"change-email-verification"}),r=e.query.callbackURL?encodeURIComponent(e.query.callbackURL):encodeURIComponent("/"),i=`${e.context.baseURL}/verify-email?token=${t}&callbackURL=${r}`;if(e.context.options.emailVerification?.sendVerificationEmail&&await e.context.runInBackgroundOrAwait(e.context.options.emailVerification.sendVerificationEmail({user:{...o.user,email:n.updateTo},url:i,token:t},e.request)),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0})}case"change-email-verification":{let r=t;if(!r){let t=await e.context.internalAdapter.createSession(o.user.id);if(!t)throw new iH("INTERNAL_SERVER_ERROR",{message:nX.BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION});r={session:t,user:o.user}}e.context.options.emailVerification?.onEmailVerification&&await e.context.options.emailVerification.onEmailVerification(o.user,e.request);let i=await e.context.internalAdapter.updateUserByEmail(n.email,{email:n.updateTo,emailVerified:!0});if(e.context.options.emailVerification?.afterEmailVerification&&await e.context.options.emailVerification.afterEmailVerification(i,e.request),await nq(e,{session:r.session,user:{...r.user,email:n.updateTo,emailVerified:!0}}),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:nd(e.context.options,i)})}default:{let r=t;if(!r){let t=await e.context.internalAdapter.createSession(o.user.id);if(!t)throw new iH("INTERNAL_SERVER_ERROR",{message:nX.BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION});r={session:t,user:o.user}}let i=await e.context.internalAdapter.updateUserByEmail(n.email,{email:n.updateTo,emailVerified:!1}),a=await oq(e.context.secret,n.updateTo),s=e.query.callbackURL?encodeURIComponent(e.query.callbackURL):encodeURIComponent("/");if(e.context.options.emailVerification?.sendVerificationEmail&&await e.context.runInBackgroundOrAwait(e.context.options.emailVerification.sendVerificationEmail({user:i,url:`${e.context.baseURL}/verify-email?token=${a}&callbackURL=${s}`,token:a},e.request)),await nq(e,{session:r.session,user:{...r.user,email:n.updateTo,emailVerified:!1}}),e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:nd(e.context.options,i)})}}}if(o.user.emailVerified){if(e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:null})}e.context.options.emailVerification?.beforeEmailVerification&&await e.context.options.emailVerification.beforeEmailVerification(o.user,e.request),e.context.options.emailVerification?.onEmailVerification&&await e.context.options.emailVerification.onEmailVerification(o.user,e.request);let a=await e.context.internalAdapter.updateUserByEmail(n.email,{emailVerified:!0});if(e.context.options.emailVerification?.afterEmailVerification&&await e.context.options.emailVerification.afterEmailVerification(a,e.request),e.context.options.emailVerification?.autoSignInAfterVerification){let t=await oO(e);if(t&&t.user.email===n.email)await nq(e,{session:t.session,user:{...t.user,emailVerified:!0}});else{let t=await e.context.internalAdapter.createSession(o.user.id);if(!t)throw new iH("INTERNAL_SERVER_ERROR",{message:"Failed to create session"});await nq(e,{session:t,user:{...o.user,emailVerified:!0}})}}if(e.query.callbackURL)throw e.redirect(e.query.callbackURL);return e.json({status:!0,user:null})}),oM=new Map;async function oz(e,t){if(!t.rateLimit.enabled)return;let r=new URL(e.url).pathname.replace(t.options.basePath||"/api/auth","").replace(/\/+$/,""),i=t.rateLimit.window,n=t.rateLimit.max,o=of(e,t.options);if(!o)return;let a=o+r,s=[{pathMatcher:e=>e.startsWith("/sign-in")||e.startsWith("/sign-up")||e.startsWith("/change-password")||e.startsWith("/change-email"),window:10,max:3}].find(e=>e.pathMatcher(r));for(let e of(s&&(i=s.window,n=s.max),t.options.plugins||[]))if(e.rateLimit){let t=e.rateLimit.find(e=>e.pathMatcher(r));if(t){i=t.window,n=t.max;break}}if(t.rateLimit.customRules){let o=Object.keys(t.rateLimit.customRules).find(e=>e.includes("*")?nY(e)(r):e===r);if(o){let r=t.rateLimit.customRules[o],a="function"==typeof r?await r(e):r;if(a&&(i=a.window,n=a.max),!1===a)return}}let c=function(e,t){let r,i;if(e.options.rateLimit?.customStorage)return e.options.rateLimit.customStorage;let n=e.rateLimit.storage;return"secondary-storage"===n?{get:async t=>{let r=await e.options.secondaryStorage?.get(t);return r?(0,nw.safeJSONParse)(r):void 0},set:async(r,i,n)=>{let o=t?.window??e.options.rateLimit?.window??10;await e.options.secondaryStorage?.set?.(r,JSON.stringify(i),o)}}:"memory"===n?{async get(e){let t=oM.get(e);if(t)return Date.now()>=t.expiresAt?void oM.delete(e):t.data},async set(r,i,n){let o=t?.window??e.options.rateLimit?.window??10,a=Date.now()+1e3*o;oM.set(r,{data:i,expiresAt:a})}}:(r="rateLimit",i=e.adapter,{get:async e=>{let t=(await i.findMany({model:r,where:[{field:"key",value:e}]}))[0];return"bigint"==typeof t?.lastRequest&&(t.lastRequest=Number(t.lastRequest)),t},set:async(t,n,o)=>{try{o?await i.updateMany({model:r,where:[{field:"key",value:t}],update:{count:n.count,lastRequest:n.lastRequest}}):await i.create({model:r,data:{key:t,count:n.count,lastRequest:n.lastRequest}})}catch(t){e.logger.error("Error setting rate limit",t)}}})}(t,{window:i}),d=await c.get(a),l=Date.now();if(d){var u,p,h;let e=l-d.lastRequest;if(u=n,p=i,Date.now()-d.lastRequest<1e3*p&&d.count>=u)return h=Math.ceil((d.lastRequest+1e3*i-Date.now())/1e3),new Response(JSON.stringify({message:"Too many requests. Please try again later."}),{status:429,statusText:"Too Many Requests",headers:{"X-Retry-After":h.toString()}});e>1e3*i?await c.set(a,{...d,count:1,lastRequest:l},!0):await c.set(a,{...d,count:d.count+1,lastRequest:l},!0)}else await c.set(a,{key:a,count:1,lastRequest:l})}function oV(e){let t=e=>new Date(new Date().getTime()+1e3*e);return{tokenType:e.token_type,accessToken:e.access_token,refreshToken:e.refresh_token,accessTokenExpiresAt:e.expires_in?t(e.expires_in):void 0,refreshTokenExpiresAt:e.refresh_token_expires_in?t(e.refresh_token_expires_in):void 0,scopes:e?.scope?"string"==typeof e.scope?e.scope.split(" "):e.scope:[],idToken:e.id_token,raw:e}}async function oK(e){let t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t);return rK.encode(new Uint8Array(r),{padding:!1})}async function oW({id:e,options:t,authorizationEndpoint:r,state:i,codeVerifier:n,scopes:o,claims:a,redirectURI:s,duration:c,prompt:d,accessType:l,responseType:u,display:p,loginHint:h,hd:f,responseMode:m,additionalParams:g,scopeJoiner:y}){let w=new URL(t.authorizationEndpoint||r);w.searchParams.set("response_type",u||"code");let b=Array.isArray(t.clientId)?t.clientId[0]:t.clientId;if(w.searchParams.set("client_id",b),w.searchParams.set("state",i),o&&w.searchParams.set("scope",o.join(y||" ")),w.searchParams.set("redirect_uri",t.redirectURI||s),c&&w.searchParams.set("duration",c),p&&w.searchParams.set("display",p),h&&w.searchParams.set("login_hint",h),d&&w.searchParams.set("prompt",d),f&&w.searchParams.set("hd",f),l&&w.searchParams.set("access_type",l),m&&w.searchParams.set("response_mode",m),n){let e=await oK(n);w.searchParams.set("code_challenge_method","S256"),w.searchParams.set("code_challenge",e)}if(a){let e=a.reduce((e,t)=>(e[t]=null,e),{});w.searchParams.set("claims",JSON.stringify({id_token:{email:null,email_verified:null,...e}}))}return g&&Object.entries(g).forEach(([e,t])=>{w.searchParams.set(e,t)}),w}var oF=Object.defineProperty,oZ=Object.defineProperties,oJ=Object.getOwnPropertyDescriptors,oG=Object.getOwnPropertySymbols,oY=Object.prototype.hasOwnProperty,oQ=Object.prototype.propertyIsEnumerable,oX=(e,t,r)=>t in e?oF(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,o0=(e,t)=>{for(var r in t||(t={}))oY.call(t,r)&&oX(e,r,t[r]);if(oG)for(var r of oG(t))oQ.call(t,r)&&oX(e,r,t[r]);return e},o1=(e,t)=>oZ(e,oJ(t)),o2=class extends Error{constructor(e,t,r){super(t||e.toString(),{cause:r}),this.status=e,this.statusText=t,this.error=r,Error.captureStackTrace(this,this.constructor)}},o5=async(e,t)=>{var r,i,n,o,a,s;let c=t||{},d={onRequest:[null==t?void 0:t.onRequest],onResponse:[null==t?void 0:t.onResponse],onSuccess:[null==t?void 0:t.onSuccess],onError:[null==t?void 0:t.onError],onRetry:[null==t?void 0:t.onRetry]};if(!t||!(null==t?void 0:t.plugins))return{url:e,options:c,hooks:d};for(let l of(null==t?void 0:t.plugins)||[]){if(l.init){let i=await (null==(r=l.init)?void 0:r.call(l,e.toString(),t));c=i.options||c,e=i.url}d.onRequest.push(null==(i=l.hooks)?void 0:i.onRequest),d.onResponse.push(null==(n=l.hooks)?void 0:n.onResponse),d.onSuccess.push(null==(o=l.hooks)?void 0:o.onSuccess),d.onError.push(null==(a=l.hooks)?void 0:a.onError),d.onRetry.push(null==(s=l.hooks)?void 0:s.onRetry)}return{url:e,options:c,hooks:d}},o6=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(){return this.options.delay}},o3=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(e){return Math.min(this.options.maxDelay,this.options.baseDelay*2**e)}},o8=async e=>{let t={},r=async e=>"function"==typeof e?await e():e;if(null==e?void 0:e.auth){if("Bearer"===e.auth.type){let i=await r(e.auth.token);if(!i)return t;t.authorization=`Bearer ${i}`}else if("Basic"===e.auth.type){let[i,n]=await Promise.all([r(e.auth.username),r(e.auth.password)]);if(!i||!n)return t;t.authorization=`Basic ${btoa(`${i}:${n}`)}`}else if("Custom"===e.auth.type){let[i,n]=await Promise.all([r(e.auth.prefix),r(e.auth.value)]);if(!n)return t;t.authorization=`${null!=i?i:""} ${n}`}}return t},o4=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function o9(e){if(void 0===e)return!1;let t=typeof e;return"string"===t||"number"===t||"boolean"===t||null===t||"object"===t&&(!!Array.isArray(e)||!e.buffer&&(e.constructor&&"Object"===e.constructor.name||"function"==typeof e.toJSON))}function o7(e){try{return JSON.parse(e)}catch(t){return e}}async function ae(e){let t=new Headers(null==e?void 0:e.headers);for(let[r,i]of Object.entries(await o8(e)||{}))t.set(r,i);if(!t.has("content-type")){let r=o9(null==e?void 0:e.body)?"application/json":null;r&&t.set("content-type",r)}return t}var at=class e extends Error{constructor(t,r){super(r||JSON.stringify(t,null,2)),this.issues=t,Object.setPrototypeOf(this,e.prototype)}};async function ar(e,t){let r=await e["~standard"].validate(t);if(r.issues)throw new at(r.issues);return r.value}var ai=["get","post","put","patch","delete"],an=async(e,t)=>{var r,i,n,o,a,s,c,d;let l,{hooks:u,url:p,options:h}=await o5(e,t),f=function(e){if(null==e?void 0:e.customFetchImpl)return e.customFetchImpl;if("u">typeof globalThis&&"function"==typeof globalThis.fetch)return globalThis.fetch;throw Error("No fetch implementation found")}(h),m=new AbortController,g=null!=(r=h.signal)?r:m.signal,y=function(e,t){let{baseURL:r,params:i,query:n}=t||{query:{},params:{},baseURL:""},o=e.startsWith("http")?e.split("/").slice(0,3).join("/"):r||"";if(e.startsWith("@")){let t=e.toString().split("@")[1].split("/")[0];ai.includes(t)&&(e=e.replace(`@${t}/`,"/"))}o.endsWith("/")||(o+="/");let[a,s]=e.replace(o,"").split("?"),c=new URLSearchParams(s);for(let[e,t]of Object.entries(n||{})){let r;if(null!=t){if("string"==typeof t)r=t;else if(Array.isArray(t)){for(let r of t)c.append(e,r);continue}else r=JSON.stringify(t);c.set(e,r)}}if(i)if(Array.isArray(i))for(let[e,t]of a.split("/").filter(e=>e.startsWith(":")).entries()){let r=i[e];a=a.replace(t,r)}else for(let[e,t]of Object.entries(i))a=a.replace(`:${e}`,String(t));(a=a.split("/").map(encodeURIComponent).join("/")).startsWith("/")&&(a=a.slice(1));let d=c.toString();return(d=d.length>0?`?${d}`.replace(/\+/g,"%20"):"",o.startsWith("http"))?new URL(`${a}${d}`,o):`${o}${a}${d}`}(p,h),w=function(e){if(!(null==e?void 0:e.body))return null;let t=new Headers(null==e?void 0:e.headers);if(o9(e.body)&&!t.has("content-type")){for(let[t,r]of Object.entries(null==e?void 0:e.body))r instanceof Date&&(e.body[t]=r.toISOString());return JSON.stringify(e.body)}return t.has("content-type")&&"application/x-www-form-urlencoded"===t.get("content-type")&&o9(e.body)?new URLSearchParams(e.body).toString():e.body}(h),b=await ae(h),E=function(e,t){var r;if(null==t?void 0:t.method)return t.method.toUpperCase();if(e.startsWith("@")){let i=null==(r=e.split("@")[1])?void 0:r.split("/")[0];return ai.includes(i)?i.toUpperCase():(null==t?void 0:t.body)?"POST":"GET"}return(null==t?void 0:t.body)?"POST":"GET"}(p,h),_=o1(o0({},h),{url:y,headers:b,body:w,method:E,signal:g});for(let e of u.onRequest)if(e){let t=await e(_);"object"==typeof t&&null!==t&&(_=t)}("pipeTo"in _&&"function"==typeof _.pipeTo||"function"==typeof(null==(i=null==t?void 0:t.body)?void 0:i.pipe))&&!("duplex"in _)&&(_.duplex="half");let{clearTimeout:A}=(!(null==h?void 0:h.signal)&&(null==h?void 0:h.timeout)&&(l=setTimeout(()=>null==m?void 0:m.abort(),null==h?void 0:h.timeout)),{abortTimeout:l,clearTimeout:()=>{l&&clearTimeout(l)}}),T=await f(_.url,_);A();let v={response:T,request:_};for(let e of u.onResponse)if(e){let r=await e(o1(o0({},v),{response:(null==(n=null==t?void 0:t.hookOptions)?void 0:n.cloneResponse)?T.clone():T}));r instanceof Response?T=r:"object"==typeof r&&null!==r&&(T=r.response)}if(T.ok){if("HEAD"===_.method)return{data:"",error:null};let e=function(e){let t=e.headers.get("content-type"),r=new Set(["image/svg","application/xml","application/xhtml","application/html"]);if(!t)return"json";let i=t.split(";").shift()||"";return o4.test(i)?"json":r.has(i)||i.startsWith("text/")?"text":"blob"}(T),r={data:null,response:T,request:_};if("json"===e||"text"===e){let e=await T.text(),t=null!=(o=_.jsonParser)?o:o7;r.data=await t(e)}else r.data=await T[e]();for(let e of((null==_?void 0:_.output)&&_.output&&!_.disableValidation&&(r.data=await ar(_.output,r.data)),u.onSuccess))e&&await e(o1(o0({},r),{response:(null==(a=null==t?void 0:t.hookOptions)?void 0:a.cloneResponse)?T.clone():T}));return(null==t?void 0:t.throw)?r.data:{data:r.data,error:null}}let k=null!=(s=null==t?void 0:t.jsonParser)?s:o7,R=await T.text(),I=function(e){try{return JSON.parse(e),!0}catch(e){return!1}}(R),S=I?await k(R):null,x={response:T,responseText:R,request:_,error:o1(o0({},S),{status:T.status,statusText:T.statusText})};for(let e of u.onError)e&&await e(o1(o0({},x),{response:(null==(c=null==t?void 0:t.hookOptions)?void 0:c.cloneResponse)?T.clone():T}));if(null==t?void 0:t.retry){let r=function(e){if("number"==typeof e)return new o6({type:"linear",attempts:e,delay:1e3});switch(e.type){case"linear":return new o6(e);case"exponential":return new o3(e);default:throw Error("Invalid retry strategy")}}(t.retry),i=null!=(d=t.retryAttempt)?d:0;if(await r.shouldAttemptRetry(i,T)){for(let e of u.onRetry)e&&await e(v);let n=r.getDelay(i);return await new Promise(e=>setTimeout(e,n)),await an(e,o1(o0({},t),{retryAttempt:i+1}))}}if(null==t?void 0:t.throw)throw new o2(T.status,T.statusText,I?S:R);return{data:null,error:o1(o0({},S),{status:T.status,statusText:T.statusText})}};async function ao({refreshToken:e,options:t,tokenEndpoint:r,authentication:i,extraParams:n}){let{body:o,headers:a}=function({refreshToken:e,options:t,authentication:r,extraParams:i,resource:n}){let o=new URLSearchParams,a={"content-type":"application/x-www-form-urlencoded",accept:"application/json"};if(o.set("grant_type","refresh_token"),o.set("refresh_token",e),"basic"===r){let e=Array.isArray(t.clientId)?t.clientId[0]:t.clientId;e?a.authorization="Basic "+rV.encode(`${e}:${t.clientSecret??""}`):a.authorization="Basic "+rV.encode(`:${t.clientSecret??""}`)}else{let e=Array.isArray(t.clientId)?t.clientId[0]:t.clientId;o.set("client_id",e),t.clientSecret&&o.set("client_secret",t.clientSecret)}if(n)if("string"==typeof n)o.append("resource",n);else for(let e of n)o.append("resource",e);if(i)for(let[e,t]of Object.entries(i))o.set(e,t);return{body:o,headers:a}}({refreshToken:e,options:t,authentication:i,extraParams:n}),{data:s,error:c}=await an(r,{method:"POST",body:o,headers:a});if(c)throw c;let d={accessToken:s.access_token,refreshToken:s.refresh_token,tokenType:s.token_type,scopes:s.scope?.split(" "),idToken:s.id_token};return s.expires_in&&(d.accessTokenExpiresAt=new Date(new Date().getTime()+1e3*s.expires_in)),d}function aa(e){return tB(e)}e.s([],90698);class as{#m;#g=new WeakMap;constructor(e){if(!function(e){return e&&"object"==typeof e&&Array.isArray(e.keys)&&e.keys.every(aa)}(e))throw new tt("JSON Web Key Set malformed");this.#m=structuredClone(e)}jwks(){return this.#m}async getKey(e,t){let{alg:r,kid:i}={...e,...t?.header},n=function(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";case"ML":return"AKP";default:throw new e3('Unsupported "alg" value for a JSON Web Key Set')}}(r),o=this.#m.keys.filter(e=>{let t=n===e.kty;if(t&&"string"==typeof i&&(t=i===e.kid),t&&("string"==typeof e.alg||"AKP"===n)&&(t=r===e.alg),t&&"string"==typeof e.use&&(t="sig"===e.use),t&&Array.isArray(e.key_ops)&&(t=e.key_ops.includes("verify")),t)switch(r){case"ES256":t="P-256"===e.crv;break;case"ES384":t="P-384"===e.crv;break;case"ES512":t="P-521"===e.crv;break;case"Ed25519":case"EdDSA":t="Ed25519"===e.crv}return t}),{0:a,length:s}=o;if(0===s)throw new tr;if(1!==s){let e=new ti,t=this.#g;throw e[Symbol.asyncIterator]=async function*(){for(let e of o)try{yield await ac(t,e,r)}catch{}},e}return ac(this.#g,a,r)}}async function ac(e,t,r){let i=e.get(t)||e.set(t,{}).get(t);if(void 0===i[r]){let e=await rm({...t,ext:!0},r);if(e instanceof Uint8Array||"public"!==e.type)throw new tt("JSON Web Key Set members must be public keys");i[r]=e}return i[r]}function ad(e){let t=new as(e),r=async(e,r)=>t.getKey(e,r);return Object.defineProperties(r,{jwks:{value:()=>structuredClone(t.jwks()),enumerable:!1,configurable:!1,writable:!1}}),r}function al(e){let t;if("string"==typeof e){let r=e.split(".");(3===r.length||5===r.length)&&([t]=r)}else if("object"==typeof e&&e)if("protected"in e)t=e.protected;else throw TypeError("Token does not contain a Protected Header");try{if("string"!=typeof t||!t)throw Error();let e=JSON.parse(eW.decode(eQ(t)));if(!tB(e))throw Error();return e}catch{throw TypeError("Invalid Token or Protected Header formatting")}}async function au(e,t){try{let r=await rv(e,ad(await ap(e,t)),t.verifyOptions);return r.payload.azp&&(r.payload.client_id=r.payload.azp),r.payload}catch(e){if(e instanceof Error)throw e;throw Error(e)}}async function ap(e,t){let i;try{i=al(e)}catch(e){if(e instanceof Error)throw e;throw Error(e)}if(!i.kid)throw Error("Missing jwt kid");if((!r||!r.keys.find(e=>e.kid===i.kid))&&!(r="string"==typeof t.jwksFetch?await an(t.jwksFetch,{headers:{Accept:"application/json"}}).then(async e=>{if(e.error)throw Error(`Jwks failed: ${e.error.message??e.error.statusText}`);return e.data}):await t.jwksFetch()))throw Error("No jwks found");return r}async function ah({code:e,codeVerifier:t,redirectURI:r,options:i,tokenEndpoint:n,authentication:o,deviceId:a,headers:s,additionalParams:c={},resource:d}){let{body:l,headers:u}=function({code:e,codeVerifier:t,redirectURI:r,options:i,authentication:n,deviceId:o,headers:a,additionalParams:s={},resource:c}){let d=new URLSearchParams,l={"content-type":"application/x-www-form-urlencoded",accept:"application/json",...a};if(d.set("grant_type","authorization_code"),d.set("code",e),t&&d.set("code_verifier",t),i.clientKey&&d.set("client_key",i.clientKey),o&&d.set("device_id",o),d.set("redirect_uri",i.redirectURI||r),c)if("string"==typeof c)d.append("resource",c);else for(let e of c)d.append("resource",e);if("basic"===n){let e=Array.isArray(i.clientId)?i.clientId[0]:i.clientId;l.authorization=`Basic ${rV.encode(`${e}:${i.clientSecret??""}`)}`}else{let e=Array.isArray(i.clientId)?i.clientId[0]:i.clientId;d.set("client_id",e),i.clientSecret&&d.set("client_secret",i.clientSecret)}for(let[e,t]of Object.entries(s))d.has(e)||d.append(e,t);return{body:d,headers:l}}({code:e,codeVerifier:t,redirectURI:r,options:i,authentication:o,deviceId:a,headers:s,additionalParams:c,resource:d}),{data:p,error:h}=await an(n,{method:"POST",body:l,headers:u});if(h)throw h;return oV(p)}function af(e){let t,r;if("string"!=typeof e)throw new e7("JWTs must use Compact JWS serialization, JWT must be a string");let{1:i,length:n}=e.split(".");if(5===n)throw new e7("Only JWTs using Compact JWS serialization can be decoded");if(3!==n)throw new e7("Invalid JWT");if(!i)throw new e7("JWTs must contain a payload");try{t=eQ(i)}catch{throw new e7("Failed to base64url decode the payload")}try{r=JSON.parse(eW.decode(t))}catch{throw new e7("Failed to parse the decoded payload as JSON")}if(!tB(r))throw new e7("Invalid JWT Claims Set");return r}let am=async e=>{let{data:t}=await an("https://appleid.apple.com/auth/keys");if(!t?.keys)throw new iH("BAD_REQUEST",{message:"Keys not found"});let r=t.keys.find(t=>t.kid===e);if(!r)throw Error(`JWK with kid ${e} not found`);return await rm(r,r.alg)},ag=async(e,t,r)=>{let i=`https://cognito-idp.${t}.amazonaws.com/${r}/.well-known/jwks.json`;try{let{data:t}=await an(i);if(!t?.keys)throw new iH("BAD_REQUEST",{message:"Keys not found"});let r=t.keys.find(t=>t.kid===e);if(!r)throw Error(`JWK with kid ${e} not found`);return await rm(r,r.alg)}catch(e){throw os.logger.error("Failed to fetch Cognito public key:",e),e}};("u"<typeof navigator||!navigator.userAgent?.startsWith?.("Mozilla/5.0 "))&&(i="jose/v6.1.3");let ay=Symbol();async function aw(e,t,r,i=fetch){let n=await i(e,{method:"GET",signal:r,redirect:"manual",headers:t}).catch(e=>{if("TimeoutError"===e.name)throw new tn;throw e});if(200!==n.status)throw new e1("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await n.json()}catch{throw new e1("Failed to parse the JSON Web Key Set HTTP response as JSON")}}let ab=Symbol();class aE{#y;#w;#b;#E;#_;#A;#T;#v;#k;#R;constructor(e,t){if(!(e instanceof URL))throw TypeError("url must be an instance of URL");this.#y=new URL(e.href),this.#w="number"==typeof t?.timeoutDuration?t?.timeoutDuration:5e3,this.#b="number"==typeof t?.cooldownDuration?t?.cooldownDuration:3e4,this.#E="number"==typeof t?.cacheMaxAge?t?.cacheMaxAge:6e5,this.#T=new Headers(t?.headers),i&&!this.#T.has("User-Agent")&&this.#T.set("User-Agent",i),this.#T.has("accept")||(this.#T.set("accept","application/json"),this.#T.append("accept","application/jwk-set+json")),this.#v=t?.[ay],t?.[ab]!==void 0&&(this.#R=t?.[ab],function(e,t){return!("object"!=typeof e||null===e||!("uat"in e)||"number"!=typeof e.uat||Date.now()-e.uat>=t)&&"jwks"in e&&!!tB(e.jwks)&&!!Array.isArray(e.jwks.keys)&&!!Array.prototype.every.call(e.jwks.keys,tB)}(t?.[ab],this.#E)&&(this.#_=this.#R.uat,this.#k=ad(this.#R.jwks)))}pendingFetch(){return!!this.#A}coolingDown(){return"number"==typeof this.#_&&Date.now()<this.#_+this.#b}fresh(){return"number"==typeof this.#_&&Date.now()<this.#_+this.#E}jwks(){return this.#k?.jwks()}async getKey(e,t){this.#k&&this.fresh()||await this.reload();try{return await this.#k(e,t)}catch(r){if(r instanceof tr&&!1===this.coolingDown())return await this.reload(),this.#k(e,t);throw r}}async reload(){this.#A&&("u">typeof WebSocketPair||"u">typeof navigator&&"Cloudflare-Workers"===navigator.userAgent||"u">typeof EdgeRuntime&&"vercel"===EdgeRuntime)&&(this.#A=void 0),this.#A||=aw(this.#y.href,this.#T,AbortSignal.timeout(this.#w),this.#v).then(e=>{this.#k=ad(e),this.#R&&(this.#R.uat=Date.now(),this.#R.jwks=e),this.#_=Date.now(),this.#A=void 0}).catch(e=>{throw this.#A=void 0,e}),await this.#A}}let a_=(e="")=>e.split("://").map(e=>e.replace(/\/{2,}/g,"/")).join("://"),aA=async e=>{let{data:t}=await an("https://www.googleapis.com/oauth2/v3/certs");if(!t?.keys)throw new iH("BAD_REQUEST",{message:"Keys not found"});let r=t.keys.find(t=>t.kid===e);if(!r)throw Error(`JWK with kid ${e} not found`);return await rm(r,r.alg)},aT={apple:e=>({id:"apple",name:"Apple",async createAuthorizationURL({state:t,scopes:r,redirectURI:i}){let n=e.disableDefaultScope?[]:["email","name"];return e.scope&&n.push(...e.scope),r&&n.push(...r),await oW({id:"apple",options:e,authorizationEndpoint:"https://appleid.apple.com/auth/authorize",scopes:n,state:t,redirectURI:i,responseMode:"form_post",responseType:"code id_token"})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>ah({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:"https://appleid.apple.com/auth/token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);let{kid:i,alg:n}=al(t);if(!i||!n)return!1;let{payload:o}=await rv(t,await am(i),{algorithms:[n],issuer:"https://appleid.apple.com",audience:e.audience&&e.audience.length?e.audience:e.appBundleIdentifier?e.appBundleIdentifier:e.clientId,maxTokenAge:"1h"});return["email_verified","is_private_email"].forEach(e=>{void 0!==o[e]&&(o[e]=!!o[e])}),(!r||o.nonce===r)&&!!o},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://appleid.apple.com/auth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;let r=af(t.idToken);if(!r)return null;let i=t.user?`${t.user.name?.firstName} ${t.user.name?.lastName}`:r.name||r.email,n="boolean"==typeof r.email_verified?r.email_verified:"true"===r.email_verified,o={...r,name:i},a=await e.mapProfileToUser?.(o);return{user:{id:r.sub,name:o.name,emailVerified:n,email:r.email,...a},data:o}},options:e}),atlassian:e=>({id:"atlassian",name:"Atlassian",async createAuthorizationURL({state:t,scopes:r,codeVerifier:i,redirectURI:n}){if(!e.clientId||!e.clientSecret)throw os.logger.error("Client Id and Secret are required for Atlassian"),new rO.BetterAuthError("CLIENT_ID_AND_SECRET_REQUIRED");if(!i)throw new rO.BetterAuthError("codeVerifier is required for Atlassian");let o=e.disableDefaultScope?[]:["read:jira-user","offline_access"];return e.scope&&o.push(...e.scope),r&&o.push(...r),oW({id:"atlassian",options:e,authorizationEndpoint:"https://auth.atlassian.com/authorize",scopes:o,state:t,codeVerifier:i,redirectURI:n,additionalParams:{audience:"api.atlassian.com"},prompt:e.prompt})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>ah({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:"https://auth.atlassian.com/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientSecret:e.clientSecret},tokenEndpoint:"https://auth.atlassian.com/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.accessToken)return null;try{let{data:r}=await an("https://api.atlassian.com/me",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(!r)return null;let i=await e.mapProfileToUser?.(r);return{user:{id:r.account_id,name:r.name,email:r.email,image:r.picture,emailVerified:!1,...i},data:r}}catch(e){return os.logger.error("Failed to fetch user info from Figma:",e),null}},options:e}),cognito:e=>{if(!e.domain||!e.region||!e.userPoolId)throw os.logger.error("Domain, region and userPoolId are required for Amazon Cognito. Make sure to provide them in the options."),new rO.BetterAuthError("DOMAIN_AND_REGION_REQUIRED");let t=e.domain.replace(/^https?:\/\//,""),r=`https://${t}/oauth2/authorize`,i=`https://${t}/oauth2/token`,n=`https://${t}/oauth2/userinfo`;return{id:"cognito",name:"Cognito",async createAuthorizationURL({state:t,scopes:i,codeVerifier:n,redirectURI:o}){if(!e.clientId)throw os.logger.error("ClientId is required for Amazon Cognito. Make sure to provide them in the options."),new rO.BetterAuthError("CLIENT_ID_AND_SECRET_REQUIRED");if(e.requireClientSecret&&!e.clientSecret)throw os.logger.error("Client Secret is required when requireClientSecret is true. Make sure to provide it in the options."),new rO.BetterAuthError("CLIENT_SECRET_REQUIRED");let a=e.disableDefaultScope?[]:["openid","profile","email"];e.scope&&a.push(...e.scope),i&&a.push(...i);let s=await oW({id:"cognito",options:{...e},authorizationEndpoint:r,scopes:a,state:t,codeVerifier:n,redirectURI:o,prompt:e.prompt}),c=s.searchParams.get("scope");if(c){s.searchParams.delete("scope");let e=encodeURIComponent(c),t=s.toString(),r=t.includes("?")?"&":"?";return new URL(`${t}${r}scope=${e}`)}return s},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>ah({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:i}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:i}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);try{let{kid:i,alg:n}=al(t);if(!i||!n)return!1;let o=await ag(i,e.region,e.userPoolId),a=`https://cognito-idp.${e.region}.amazonaws.com/${e.userPoolId}`,{payload:s}=await rv(t,o,{algorithms:[n],issuer:a,audience:e.clientId,maxTokenAge:"1h"});if(r&&s.nonce!==r)return!1;return!0}catch(e){return os.logger.error("Failed to verify ID token:",e),!1}},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(t.idToken)try{let r=af(t.idToken);if(!r)return null;let i=r.name||r.given_name||r.username||r.email,n={...r,name:i},o=await e.mapProfileToUser?.(n);return{user:{id:r.sub,name:n.name,email:r.email,image:r.picture,emailVerified:r.email_verified,...o},data:n}}catch(e){os.logger.error("Failed to decode ID token:",e)}if(t.accessToken)try{let{data:r}=await an(n,{headers:{Authorization:`Bearer ${t.accessToken}`}});if(r){let t=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name||r.given_name||r.username,email:r.email,image:r.picture,emailVerified:r.email_verified,...t},data:r}}}catch(e){os.logger.error("Failed to fetch user info from Cognito:",e)}return null},options:e}},discord:e=>({id:"discord",name:"Discord",createAuthorizationURL({state:t,scopes:r,redirectURI:i}){let n=e.disableDefaultScope?[]:["identify","email"];r&&n.push(...r),e.scope&&n.push(...e.scope);let o=n.includes("bot")&&void 0!==e.permissions?`&permissions=${e.permissions}`:"";return new URL(`https://discord.com/api/oauth2/authorize?scope=${n.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||i)}&state=${t}&prompt=${e.prompt||"none"}${o}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>ah({code:t,redirectURI:r,options:e,tokenEndpoint:"https://discord.com/api/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://discord.com/api/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://discord.com/api/users/@me",{headers:{authorization:`Bearer ${t.accessToken}`}});if(i)return null;if(null===r.avatar)r.image_url=`https://cdn.discordapp.com/embed/avatars/${"0"===r.discriminator?Number(BigInt(r.id)>>BigInt(22))%6:parseInt(r.discriminator)%5}.png`;else{let e=r.avatar.startsWith("a_")?"gif":"png";r.image_url=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.${e}`}let n=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.global_name||r.username||"",email:r.email,emailVerified:r.verified,image:r.image_url,...n},data:r}},options:e}),facebook:e=>({id:"facebook",name:"Facebook",async createAuthorizationURL({state:t,scopes:r,redirectURI:i,loginHint:n}){let o=e.disableDefaultScope?[]:["email","public_profile"];return e.scope&&o.push(...e.scope),r&&o.push(...r),await oW({id:"facebook",options:e,authorizationEndpoint:"https://www.facebook.com/v21.0/dialog/oauth",scopes:o,state:t,redirectURI:i,loginHint:n,additionalParams:e.configId?{config_id:e.configId}:{}})},validateAuthorizationCode:async({code:t,redirectURI:r})=>ah({code:t,redirectURI:r,options:e,tokenEndpoint:"https://graph.facebook.com/oauth/access_token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);if(3===t.split(".").length)try{var i;let n,o,{payload:a}=await rv(t,(i=new URL("https://limited.facebook.com/.well-known/oauth/openid/jwks/"),n=new aE(i,void 0),o=async(e,t)=>n.getKey(e,t),Object.defineProperties(o,{coolingDown:{get:()=>n.coolingDown(),enumerable:!0,configurable:!1},fresh:{get:()=>n.fresh(),enumerable:!0,configurable:!1},reload:{value:()=>n.reload(),enumerable:!0,configurable:!1,writable:!1},reloading:{get:()=>n.pendingFetch(),enumerable:!0,configurable:!1},jwks:{value:()=>n.jwks(),enumerable:!0,configurable:!1,writable:!1}}),o),{algorithms:["RS256"],audience:e.clientId,issuer:"https://www.facebook.com"});if(r&&a.nonce!==r)return!1;return!!a}catch{return!1}return!0},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://graph.facebook.com/v18.0/oauth/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(t.idToken&&3===t.idToken.split(".").length){let r=af(t.idToken),i={id:r.sub,name:r.name,email:r.email,picture:{data:{url:r.picture,height:100,width:100,is_silhouette:!1}}},n=await e.mapProfileToUser?.({...i,email_verified:!1});return{user:{...i,emailVerified:!1,...n},data:r}}let{data:r,error:i}=await an("https://graph.facebook.com/me?fields="+["id","name","email","picture",...e?.fields||[]].join(","),{auth:{type:"Bearer",token:t.accessToken}});if(i)return null;let n=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name,email:r.email,image:r.picture.data.url,emailVerified:r.email_verified,...n},data:r}},options:e}),figma:e=>({id:"figma",name:"Figma",async createAuthorizationURL({state:t,scopes:r,codeVerifier:i,redirectURI:n}){if(!e.clientId||!e.clientSecret)throw os.logger.error("Client Id and Client Secret are required for Figma. Make sure to provide them in the options."),new rO.BetterAuthError("CLIENT_ID_AND_SECRET_REQUIRED");if(!i)throw new rO.BetterAuthError("codeVerifier is required for Figma");let o=e.disableDefaultScope?[]:["current_user:read"];return e.scope&&o.push(...e.scope),r&&o.push(...r),await oW({id:"figma",options:e,authorizationEndpoint:"https://www.figma.com/oauth",scopes:o,state:t,codeVerifier:i,redirectURI:n})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>ah({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:"https://api.figma.com/v1/oauth/token",authentication:"basic"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://api.figma.com/v1/oauth/token",authentication:"basic"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);try{let{data:r}=await an("https://api.figma.com/v1/me",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(!r)return os.logger.error("Failed to fetch user from Figma"),null;let i=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.handle,email:r.email,image:r.img_url,emailVerified:!1,...i},data:r}}catch(e){return os.logger.error("Failed to fetch user info from Figma:",e),null}},options:e}),github:e=>({id:"github",name:"GitHub",createAuthorizationURL({state:t,scopes:r,loginHint:i,codeVerifier:n,redirectURI:o}){let a=e.disableDefaultScope?[]:["read:user","user:email"];return e.scope&&a.push(...e.scope),r&&a.push(...r),oW({id:"github",options:e,authorizationEndpoint:"https://github.com/login/oauth/authorize",scopes:a,state:t,codeVerifier:n,redirectURI:o,loginHint:i,prompt:e.prompt})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>ah({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:"https://github.com/login/oauth/access_token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://github.com/login/oauth/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://api.github.com/user",{headers:{"User-Agent":"better-auth",authorization:`Bearer ${t.accessToken}`}});if(i)return null;let{data:n}=await an("https://api.github.com/user/emails",{headers:{Authorization:`Bearer ${t.accessToken}`,"User-Agent":"better-auth"}});!r.email&&n&&(r.email=(n.find(e=>e.primary)??n[0])?.email);let o=n?.find(e=>e.email===r.email)?.verified??!1,a=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name||r.login,email:r.email,image:r.avatar_url,emailVerified:o,...a},data:r}},options:e}),microsoft:e=>{let t=e.tenantId||"common",r=e.authority||"https://login.microsoftonline.com",i=`${r}/${t}/oauth2/v2.0/authorize`,n=`${r}/${t}/oauth2/v2.0/token`;return{id:"microsoft",name:"Microsoft EntraID",createAuthorizationURL(t){let r=e.disableDefaultScope?[]:["openid","profile","email","User.Read","offline_access"];return e.scope&&r.push(...e.scope),t.scopes&&r.push(...t.scopes),oW({id:"microsoft",options:e,authorizationEndpoint:i,state:t.state,codeVerifier:t.codeVerifier,scopes:r,redirectURI:t.redirectURI,prompt:e.prompt,loginHint:t.loginHint})},validateAuthorizationCode:({code:t,codeVerifier:r,redirectURI:i})=>ah({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:n}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;let r=af(t.idToken),i=e.profilePhotoSize||48;await an(`https://graph.microsoft.com/v1.0/me/photos/${i}x${i}/$value`,{headers:{Authorization:`Bearer ${t.accessToken}`},async onResponse(t){if(!e.disableProfilePhoto&&t.response.ok)try{let e=await t.response.clone().arrayBuffer();r.picture=`data:image/jpeg;base64, ${rV.encode(e)}`}catch(e){os.logger.error(e&&"object"==typeof e&&"name"in e?e.name:"",e)}}});let n=await e.mapProfileToUser?.(r),o=void 0!==r.email_verified?r.email_verified:!!(r.email&&(r.verified_primary_email?.includes(r.email)||r.verified_secondary_email?.includes(r.email)));return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:o,...n},data:r}},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>{let r=e.disableDefaultScope?[]:["openid","profile","email","User.Read","offline_access"];return e.scope&&r.push(...e.scope),ao({refreshToken:t,options:{clientId:e.clientId,clientSecret:e.clientSecret},extraParams:{scope:r.join(" ")},tokenEndpoint:n})},options:e}},google:e=>({id:"google",name:"Google",async createAuthorizationURL({state:t,scopes:r,codeVerifier:i,redirectURI:n,loginHint:o,display:a}){if(!e.clientId||!e.clientSecret)throw os.logger.error("Client Id and Client Secret is required for Google. Make sure to provide them in the options."),new rO.BetterAuthError("CLIENT_ID_AND_SECRET_REQUIRED");if(!i)throw new rO.BetterAuthError("codeVerifier is required for Google");let s=e.disableDefaultScope?[]:["email","profile","openid"];return e.scope&&s.push(...e.scope),r&&s.push(...r),await oW({id:"google",options:e,authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",scopes:s,state:t,codeVerifier:i,redirectURI:n,prompt:e.prompt,accessType:e.accessType,display:a||e.display,loginHint:o,hd:e.hd,additionalParams:{include_granted_scopes:"true"}})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>ah({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:"https://oauth2.googleapis.com/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token"}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);let{kid:i,alg:n}=al(t);if(!i||!n)return!1;let{payload:o}=await rv(t,await aA(i),{algorithms:[n],issuer:["https://accounts.google.com","accounts.google.com"],audience:e.clientId,maxTokenAge:"1h"});return!r||o.nonce===r},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;let r=af(t.idToken),i=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name,email:r.email,image:r.picture,emailVerified:r.email_verified,...i},data:r}},options:e}),huggingface:e=>({id:"huggingface",name:"Hugging Face",createAuthorizationURL({state:t,scopes:r,codeVerifier:i,redirectURI:n}){let o=e.disableDefaultScope?[]:["openid","profile","email"];return e.scope&&o.push(...e.scope),r&&o.push(...r),oW({id:"huggingface",options:e,authorizationEndpoint:"https://huggingface.co/oauth/authorize",scopes:o,state:t,codeVerifier:i,redirectURI:n})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>ah({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:"https://huggingface.co/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://huggingface.co/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://huggingface.co/oauth/userinfo",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(i)return null;let n=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name||r.preferred_username,email:r.email,image:r.picture,emailVerified:r.email_verified??!1,...n},data:r}},options:e}),slack:e=>({id:"slack",name:"Slack",createAuthorizationURL({state:t,scopes:r,redirectURI:i}){let n=e.disableDefaultScope?[]:["openid","profile","email"];r&&n.push(...r),e.scope&&n.push(...e.scope);let o=new URL("https://slack.com/openid/connect/authorize");return o.searchParams.set("scope",n.join(" ")),o.searchParams.set("response_type","code"),o.searchParams.set("client_id",e.clientId),o.searchParams.set("redirect_uri",e.redirectURI||i),o.searchParams.set("state",t),o},validateAuthorizationCode:async({code:t,redirectURI:r})=>ah({code:t,redirectURI:r,options:e,tokenEndpoint:"https://slack.com/api/openid.connect.token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://slack.com/api/openid.connect.token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://slack.com/api/openid.connect.userInfo",{headers:{authorization:`Bearer ${t.accessToken}`}});if(i)return null;let n=await e.mapProfileToUser?.(r);return{user:{id:r["https://slack.com/user_id"],name:r.name||"",email:r.email,emailVerified:r.email_verified,image:r.picture||r["https://slack.com/user_image_512"],...n},data:r}},options:e}),spotify:e=>({id:"spotify",name:"Spotify",createAuthorizationURL({state:t,scopes:r,codeVerifier:i,redirectURI:n}){let o=e.disableDefaultScope?[]:["user-read-email"];return e.scope&&o.push(...e.scope),r&&o.push(...r),oW({id:"spotify",options:e,authorizationEndpoint:"https://accounts.spotify.com/authorize",scopes:o,state:t,codeVerifier:i,redirectURI:n})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>ah({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:"https://accounts.spotify.com/api/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://accounts.spotify.com/api/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://api.spotify.com/v1/me",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(i)return null;let n=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.display_name,email:r.email,image:r.images[0]?.url,emailVerified:!1,...n},data:r}},options:e}),twitch:e=>({id:"twitch",name:"Twitch",createAuthorizationURL({state:t,scopes:r,redirectURI:i}){let n=e.disableDefaultScope?[]:["user:read:email","openid"];return e.scope&&n.push(...e.scope),r&&n.push(...r),oW({id:"twitch",redirectURI:i,options:e,authorizationEndpoint:"https://id.twitch.tv/oauth2/authorize",scopes:n,state:t,claims:e.claims||["email","email_verified","preferred_username","picture"]})},validateAuthorizationCode:async({code:t,redirectURI:r})=>ah({code:t,redirectURI:r,options:e,tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://id.twitch.tv/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let r=t.idToken;if(!r)return os.logger.error("No idToken found in token"),null;let i=af(r),n=await e.mapProfileToUser?.(i);return{user:{id:i.sub,name:i.preferred_username,email:i.email,image:i.picture,emailVerified:i.email_verified,...n},data:i}},options:e}),twitter:e=>({id:"twitter",name:"Twitter",createAuthorizationURL(t){let r=e.disableDefaultScope?[]:["users.read","tweet.read","offline.access","users.email"];return e.scope&&r.push(...e.scope),t.scopes&&r.push(...t.scopes),oW({id:"twitter",options:e,authorizationEndpoint:"https://x.com/i/oauth2/authorize",scopes:r,state:t.state,codeVerifier:t.codeVerifier,redirectURI:t.redirectURI})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>ah({code:t,codeVerifier:r,authentication:"basic",redirectURI:i,options:e,tokenEndpoint:"https://api.x.com/2/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},authentication:"basic",tokenEndpoint:"https://api.x.com/2/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://api.x.com/2/users/me?user.fields=profile_image_url",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(i)return null;let{data:n,error:o}=await an("https://api.x.com/2/users/me?user.fields=confirmed_email",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}}),a=!1;!o&&n?.data?.confirmed_email&&(r.data.email=n.data.confirmed_email,a=!0);let s=await e.mapProfileToUser?.(r);return{user:{id:r.data.id,name:r.data.name,email:r.data.email||r.data.username||null,image:r.data.profile_image_url,emailVerified:a,...s},data:r}},options:e}),dropbox:e=>({id:"dropbox",name:"Dropbox",createAuthorizationURL:async({state:t,scopes:r,codeVerifier:i,redirectURI:n})=>{let o=e.disableDefaultScope?[]:["account_info.read"];e.scope&&o.push(...e.scope),r&&o.push(...r);let a={};return e.accessType&&(a.token_access_type=e.accessType),await oW({id:"dropbox",options:e,authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",scopes:o,state:t,redirectURI:n,codeVerifier:i,additionalParams:a})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>await ah({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:"https://api.dropboxapi.com/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://api.dropbox.com/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://api.dropboxapi.com/2/users/get_current_account",{method:"POST",headers:{Authorization:`Bearer ${t.accessToken}`}});if(i)return null;let n=await e.mapProfileToUser?.(r);return{user:{id:r.account_id,name:r.name?.display_name,email:r.email,emailVerified:r.email_verified||!1,image:r.profile_photo_url,...n},data:r}},options:e}),kick:e=>({id:"kick",name:"Kick",createAuthorizationURL({state:t,scopes:r,redirectURI:i,codeVerifier:n}){let o=e.disableDefaultScope?[]:["user:read"];return e.scope&&o.push(...e.scope),r&&o.push(...r),oW({id:"kick",redirectURI:i,options:e,authorizationEndpoint:"https://id.kick.com/oauth/authorize",scopes:o,codeVerifier:n,state:t})},validateAuthorizationCode:async({code:t,redirectURI:r,codeVerifier:i})=>ah({code:t,redirectURI:r,options:e,tokenEndpoint:"https://id.kick.com/oauth/token",codeVerifier:i}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientSecret:e.clientSecret},tokenEndpoint:"https://id.kick.com/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://api.kick.com/public/v1/users",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(i)return null;let n=r.data[0],o=await e.mapProfileToUser?.(n);return{user:{id:n.user_id,name:n.name,email:n.email,image:n.profile_picture,emailVerified:!1,...o},data:n}},options:e}),linear:e=>{let t="https://api.linear.app/oauth/token";return{id:"linear",name:"Linear",createAuthorizationURL({state:t,scopes:r,loginHint:i,redirectURI:n}){let o=e.disableDefaultScope?[]:["read"];return e.scope&&o.push(...e.scope),r&&o.push(...r),oW({id:"linear",options:e,authorizationEndpoint:"https://linear.app/oauth/authorize",scopes:o,state:t,redirectURI:n,loginHint:i})},validateAuthorizationCode:async({code:r,redirectURI:i})=>ah({code:r,redirectURI:i,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>ao({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:t}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://api.linear.app/graphql",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.accessToken}`},body:JSON.stringify({query:`
							query {
								viewer {
									id
									name
									email
									avatarUrl
									active
									createdAt
									updatedAt
								}
							}
						`})});if(i||!r?.data?.viewer)return null;let n=r.data.viewer,o=await e.mapProfileToUser?.(n);return{user:{id:r.data.viewer.id,name:r.data.viewer.name,email:r.data.viewer.email,image:r.data.viewer.avatarUrl,emailVerified:!1,...o},data:n}},options:e}},linkedin:e=>{let t="https://www.linkedin.com/oauth/v2/accessToken";return{id:"linkedin",name:"Linkedin",createAuthorizationURL:async({state:t,scopes:r,redirectURI:i,loginHint:n})=>{let o=e.disableDefaultScope?[]:["profile","email","openid"];return e.scope&&o.push(...e.scope),r&&o.push(...r),await oW({id:"linkedin",options:e,authorizationEndpoint:"https://www.linkedin.com/oauth/v2/authorization",scopes:o,state:t,loginHint:n,redirectURI:i})},validateAuthorizationCode:async({code:r,redirectURI:i})=>await ah({code:r,redirectURI:i,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>ao({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:t}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://api.linkedin.com/v2/userinfo",{method:"GET",headers:{Authorization:`Bearer ${t.accessToken}`}});if(i)return null;let n=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name,email:r.email,emailVerified:r.email_verified||!1,image:r.picture,...n},data:r}},options:e}},gitlab:e=>{let t,{authorizationEndpoint:r,tokenEndpoint:i,userinfoEndpoint:n}=(t=e.issuer||"https://gitlab.com",{authorizationEndpoint:a_(`${t}/oauth/authorize`),tokenEndpoint:a_(`${t}/oauth/token`),userinfoEndpoint:a_(`${t}/api/v4/user`)}),o="gitlab";return{id:o,name:"Gitlab",createAuthorizationURL:async({state:t,scopes:i,codeVerifier:n,loginHint:a,redirectURI:s})=>{let c=e.disableDefaultScope?[]:["read_user"];return e.scope&&c.push(...e.scope),i&&c.push(...i),await oW({id:o,options:e,authorizationEndpoint:r,scopes:c,state:t,redirectURI:s,codeVerifier:n,loginHint:a})},validateAuthorizationCode:async({code:t,redirectURI:r,codeVerifier:n})=>ah({code:t,redirectURI:r,options:e,codeVerifier:n,tokenEndpoint:i}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:i}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an(n,{headers:{authorization:`Bearer ${t.accessToken}`}});if(i||"active"!==r.state||r.locked)return null;let o=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name??r.username,email:r.email,image:r.avatar_url,emailVerified:r.email_verified??!1,...o},data:r}},options:e}},tiktok:e=>({id:"tiktok",name:"TikTok",createAuthorizationURL({state:t,scopes:r,redirectURI:i}){let n=e.disableDefaultScope?[]:["user.info.profile"];return e.scope&&n.push(...e.scope),r&&n.push(...r),new URL(`https://www.tiktok.com/v2/auth/authorize?scope=${n.join(",")}&response_type=code&client_key=${e.clientKey}&redirect_uri=${encodeURIComponent(e.redirectURI||i)}&state=${t}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>ah({code:t,redirectURI:e.redirectURI||r,options:{clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://open.tiktokapis.com/v2/oauth/token/"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientSecret:e.clientSecret},tokenEndpoint:"https://open.tiktokapis.com/v2/oauth/token/",authentication:"post",extraParams:{client_key:e.clientKey}}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://open.tiktokapis.com/v2/user/info/?fields=open_id,avatar_large_url,display_name,username",{headers:{authorization:`Bearer ${t.accessToken}`}});return i?null:{user:{email:r.data.user.email||r.data.user.username,id:r.data.user.open_id,name:r.data.user.display_name||r.data.user.username,image:r.data.user.avatar_large_url,emailVerified:!1},data:r}},options:e}),reddit:e=>({id:"reddit",name:"Reddit",createAuthorizationURL({state:t,scopes:r,redirectURI:i}){let n=e.disableDefaultScope?[]:["identity"];return e.scope&&n.push(...e.scope),r&&n.push(...r),oW({id:"reddit",options:e,authorizationEndpoint:"https://www.reddit.com/api/v1/authorize",scopes:n,state:t,redirectURI:i,duration:e.duration})},validateAuthorizationCode:async({code:t,redirectURI:r})=>{let i=new URLSearchParams({grant_type:"authorization_code",code:t,redirect_uri:e.redirectURI||r}),{data:n,error:o}=await an("https://www.reddit.com/api/v1/access_token",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded",accept:"text/plain","user-agent":"better-auth",Authorization:`Basic ${rV.encode(`${e.clientId}:${e.clientSecret}`)}`},body:i.toString()});if(o)throw o;return oV(n)},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},authentication:"basic",tokenEndpoint:"https://www.reddit.com/api/v1/access_token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://oauth.reddit.com/api/v1/me",{headers:{Authorization:`Bearer ${t.accessToken}`,"User-Agent":"better-auth"}});if(i)return null;let n=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.name,email:r.oauth_client_id,emailVerified:r.has_verified_email,image:r.icon_img?.split("?")[0],...n},data:r}},options:e}),roblox:e=>({id:"roblox",name:"Roblox",createAuthorizationURL({state:t,scopes:r,redirectURI:i}){let n=e.disableDefaultScope?[]:["openid","profile"];return e.scope&&n.push(...e.scope),r&&n.push(...r),new URL(`https://apis.roblox.com/oauth/v1/authorize?scope=${n.join("+")}&response_type=code&client_id=${e.clientId}&redirect_uri=${encodeURIComponent(e.redirectURI||i)}&state=${t}&prompt=${e.prompt||"select_account consent"}`)},validateAuthorizationCode:async({code:t,redirectURI:r})=>ah({code:t,redirectURI:e.redirectURI||r,options:e,tokenEndpoint:"https://apis.roblox.com/oauth/v1/token",authentication:"post"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://apis.roblox.com/oauth/v1/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://apis.roblox.com/oauth/v1/userinfo",{headers:{authorization:`Bearer ${t.accessToken}`}});if(i)return null;let n=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.nickname||r.preferred_username||"",image:r.picture,email:r.preferred_username||null,emailVerified:!1,...n},data:{...r}}},options:e}),salesforce:e=>{let t=(e.environment??"production")==="sandbox",r=e.loginUrl?`https://${e.loginUrl}/services/oauth2/authorize`:t?"https://test.salesforce.com/services/oauth2/authorize":"https://login.salesforce.com/services/oauth2/authorize",i=e.loginUrl?`https://${e.loginUrl}/services/oauth2/token`:t?"https://test.salesforce.com/services/oauth2/token":"https://login.salesforce.com/services/oauth2/token",n=e.loginUrl?`https://${e.loginUrl}/services/oauth2/userinfo`:t?"https://test.salesforce.com/services/oauth2/userinfo":"https://login.salesforce.com/services/oauth2/userinfo";return{id:"salesforce",name:"Salesforce",async createAuthorizationURL({state:t,scopes:i,codeVerifier:n,redirectURI:o}){if(!e.clientId||!e.clientSecret)throw os.logger.error("Client Id and Client Secret are required for Salesforce. Make sure to provide them in the options."),new rO.BetterAuthError("CLIENT_ID_AND_SECRET_REQUIRED");if(!n)throw new rO.BetterAuthError("codeVerifier is required for Salesforce");let a=e.disableDefaultScope?[]:["openid","email","profile"];return e.scope&&a.push(...e.scope),i&&a.push(...i),oW({id:"salesforce",options:e,authorizationEndpoint:r,scopes:a,state:t,codeVerifier:n,redirectURI:e.redirectURI||o})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>ah({code:t,codeVerifier:r,redirectURI:e.redirectURI||n,options:e,tokenEndpoint:i}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientSecret:e.clientSecret},tokenEndpoint:i}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);try{let{data:r}=await an(n,{headers:{Authorization:`Bearer ${t.accessToken}`}});if(!r)return os.logger.error("Failed to fetch user info from Salesforce"),null;let i=await e.mapProfileToUser?.(r);return{user:{id:r.user_id,name:r.name,email:r.email,image:r.photos?.picture||r.photos?.thumbnail,emailVerified:r.email_verified??!1,...i},data:r}}catch(e){return os.logger.error("Failed to fetch user info from Salesforce:",e),null}},options:e}},vk:e=>({id:"vk",name:"VK",async createAuthorizationURL({state:t,scopes:r,codeVerifier:i,redirectURI:n}){let o=e.disableDefaultScope?[]:["email","phone"];return e.scope&&o.push(...e.scope),r&&o.push(...r),oW({id:"vk",options:e,authorizationEndpoint:"https://id.vk.com/authorize",scopes:o,state:t,redirectURI:n,codeVerifier:i})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i,deviceId:n})=>ah({code:t,codeVerifier:r,redirectURI:e.redirectURI||i,options:e,deviceId:n,tokenEndpoint:"https://id.vk.com/oauth2/auth"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://id.vk.com/oauth2/auth"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.accessToken)return null;let r=new URLSearchParams({access_token:t.accessToken,client_id:e.clientId}).toString(),{data:i,error:n}=await an("https://id.vk.com/oauth2/user_info",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r});if(n)return null;let o=await e.mapProfileToUser?.(i);return i.user.email||o?.email?{user:{id:i.user.user_id,first_name:i.user.first_name,last_name:i.user.last_name,email:i.user.email,image:i.user.avatar,emailVerified:!1,birthday:i.user.birthday,sex:i.user.sex,name:`${i.user.first_name} ${i.user.last_name}`,...o},data:i}:null},options:e}),zoom:e=>{let t={pkce:!0,...e};return{id:"zoom",name:"Zoom",createAuthorizationURL:async({state:e,redirectURI:r,codeVerifier:i})=>{let n=new URLSearchParams({response_type:"code",redirect_uri:t.redirectURI?t.redirectURI:r,client_id:t.clientId,state:e});if(t.pkce){let e=await oK(i);n.set("code_challenge_method","S256"),n.set("code_challenge",e)}let o=new URL("https://zoom.us/oauth/authorize");return o.search=n.toString(),o},validateAuthorizationCode:async({code:e,redirectURI:r,codeVerifier:i})=>ah({code:e,redirectURI:t.redirectURI||r,codeVerifier:i,options:t,tokenEndpoint:"https://zoom.us/oauth/token",authentication:"post"}),refreshAccessToken:t.refreshAccessToken?t.refreshAccessToken:async e=>ao({refreshToken:e,options:{clientId:t.clientId,clientKey:t.clientKey,clientSecret:t.clientSecret},tokenEndpoint:"https://zoom.us/oauth/token"}),async getUserInfo(e){if(t.getUserInfo)return t.getUserInfo(e);let{data:r,error:i}=await an("https://api.zoom.us/v2/users/me",{headers:{authorization:`Bearer ${e.accessToken}`}});if(i)return null;let n=await t.mapProfileToUser?.(r);return{user:{id:r.id,name:r.display_name,image:r.pic_url,email:r.email,emailVerified:!!r.verified,...n},data:{...r}}}}},notion:e=>{let t="https://api.notion.com/v1/oauth/token";return{id:"notion",name:"Notion",createAuthorizationURL({state:t,scopes:r,loginHint:i,redirectURI:n}){let o=(e.disableDefaultScope,[]);return e.scope&&o.push(...e.scope),r&&o.push(...r),oW({id:"notion",options:e,authorizationEndpoint:"https://api.notion.com/v1/oauth/authorize",scopes:o,state:t,redirectURI:n,loginHint:i,additionalParams:{owner:"user"}})},validateAuthorizationCode:async({code:r,redirectURI:i})=>ah({code:r,redirectURI:i,options:e,tokenEndpoint:t,authentication:"basic"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>ao({refreshToken:r,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:t}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://api.notion.com/v1/users/me",{headers:{Authorization:`Bearer ${t.accessToken}`,"Notion-Version":"2022-06-28"}});if(i||!r)return null;let n=r.bot?.owner?.user;if(!n)return null;let o=await e.mapProfileToUser?.(n);return{user:{id:n.id,name:n.name||"Notion User",email:n.person?.email||null,image:n.avatar_url,emailVerified:!1,...o},data:n}},options:e}},kakao:e=>({id:"kakao",name:"Kakao",createAuthorizationURL({state:t,scopes:r,redirectURI:i}){let n=e.disableDefaultScope?[]:["account_email","profile_image","profile_nickname"];return e.scope&&n.push(...e.scope),r&&n.push(...r),oW({id:"kakao",options:e,authorizationEndpoint:"https://kauth.kakao.com/oauth/authorize",scopes:n,state:t,redirectURI:i})},validateAuthorizationCode:async({code:t,redirectURI:r})=>ah({code:t,redirectURI:r,options:e,tokenEndpoint:"https://kauth.kakao.com/oauth/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://kauth.kakao.com/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://kapi.kakao.com/v2/user/me",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(i||!r)return null;let n=await e.mapProfileToUser?.(r),o=r.kakao_account||{},a=o.profile||{};return{user:{id:String(r.id),name:a.nickname||o.name||void 0,email:o.email,image:a.profile_image_url||a.thumbnail_image_url,emailVerified:!!o.is_email_valid&&!!o.is_email_verified,...n},data:r}},options:e}),naver:e=>({id:"naver",name:"Naver",createAuthorizationURL({state:t,scopes:r,redirectURI:i}){let n=e.disableDefaultScope?[]:["profile","email"];return e.scope&&n.push(...e.scope),r&&n.push(...r),oW({id:"naver",options:e,authorizationEndpoint:"https://nid.naver.com/oauth2.0/authorize",scopes:n,state:t,redirectURI:i})},validateAuthorizationCode:async({code:t,redirectURI:r})=>ah({code:t,redirectURI:r,options:e,tokenEndpoint:"https://nid.naver.com/oauth2.0/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://nid.naver.com/oauth2.0/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://openapi.naver.com/v1/nid/me",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(i||!r||"00"!==r.resultcode)return null;let n=await e.mapProfileToUser?.(r),o=r.response||{};return{user:{id:o.id,name:o.name||o.nickname,email:o.email,image:o.profile_image,emailVerified:!1,...n},data:r}},options:e}),line:e=>{let t="https://api.line.me/oauth2/v2.1/token";return{id:"line",name:"LINE",async createAuthorizationURL({state:t,scopes:r,codeVerifier:i,redirectURI:n,loginHint:o}){let a=e.disableDefaultScope?[]:["openid","profile","email"];return e.scope&&a.push(...e.scope),r&&a.push(...r),await oW({id:"line",options:e,authorizationEndpoint:"https://access.line.me/oauth2/v2.1/authorize",scopes:a,state:t,codeVerifier:i,redirectURI:n,loginHint:o})},validateAuthorizationCode:async({code:r,codeVerifier:i,redirectURI:n})=>ah({code:r,codeVerifier:i,redirectURI:n,options:e,tokenEndpoint:t}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async r=>ao({refreshToken:r,options:{clientId:e.clientId,clientSecret:e.clientSecret},tokenEndpoint:t}),async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);let i=new URLSearchParams;i.set("id_token",t),i.set("client_id",e.clientId),r&&i.set("nonce",r);let{data:n,error:o}=await an("https://api.line.me/oauth2/v2.1/verify",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:i});return!o&&!!n&&n.aud===e.clientId&&(!n.nonce||n.nonce===r)},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let r=null;if(t.idToken)try{r=af(t.idToken)}catch{}if(!r){let{data:e}=await an("https://api.line.me/oauth2/v2.1/userinfo",{headers:{authorization:`Bearer ${t.accessToken}`}});r=e||null}if(!r)return null;let i=await e.mapProfileToUser?.(r),n=r.sub||r.userId,o=r.name||r.displayName,a=r.picture||r.pictureUrl||void 0;return{user:{id:n,name:o,email:r.email,image:a,emailVerified:!1,...i},data:r}},options:e}},paybin:e=>{let t=e.issuer||"https://idp.paybin.io",r=`${t}/oauth2/authorize`,i=`${t}/oauth2/token`;return{id:"paybin",name:"Paybin",async createAuthorizationURL({state:t,scopes:i,codeVerifier:n,redirectURI:o,loginHint:a}){if(!e.clientId||!e.clientSecret)throw os.logger.error("Client Id and Client Secret is required for Paybin. Make sure to provide them in the options."),new rO.BetterAuthError("CLIENT_ID_AND_SECRET_REQUIRED");if(!n)throw new rO.BetterAuthError("codeVerifier is required for Paybin");let s=e.disableDefaultScope?[]:["openid","email","profile"];return e.scope&&s.push(...e.scope),i&&s.push(...i),await oW({id:"paybin",options:e,authorizationEndpoint:r,scopes:s,state:t,codeVerifier:n,redirectURI:o,prompt:e.prompt,loginHint:a})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:n})=>ah({code:t,codeVerifier:r,redirectURI:n,options:e,tokenEndpoint:i}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:i}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.idToken)return null;let r=af(t.idToken),i=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name||r.preferred_username||(r.email?r.email.split("@")[0]:"User")||"User",email:r.email,image:r.picture,emailVerified:r.email_verified||!1,...i},data:r}},options:e}},paypal:e=>{let t="sandbox"===(e.environment||"sandbox"),r=t?"https://www.sandbox.paypal.com/signin/authorize":"https://www.paypal.com/signin/authorize",i=t?"https://api-m.sandbox.paypal.com/v1/oauth2/token":"https://api-m.paypal.com/v1/oauth2/token",n=t?"https://api-m.sandbox.paypal.com/v1/identity/oauth2/userinfo":"https://api-m.paypal.com/v1/identity/oauth2/userinfo";return{id:"paypal",name:"PayPal",async createAuthorizationURL({state:t,codeVerifier:i,redirectURI:n}){if(!e.clientId||!e.clientSecret)throw os.logger.error("Client Id and Client Secret is required for PayPal. Make sure to provide them in the options."),new rO.BetterAuthError("CLIENT_ID_AND_SECRET_REQUIRED");return await oW({id:"paypal",options:e,authorizationEndpoint:r,scopes:[],state:t,codeVerifier:i,redirectURI:n,prompt:e.prompt})},validateAuthorizationCode:async({code:t,redirectURI:r})=>{let n=rV.encode(`${e.clientId}:${e.clientSecret}`);try{let e=await an(i,{method:"POST",headers:{Authorization:`Basic ${n}`,Accept:"application/json","Accept-Language":"en_US","Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:t,redirect_uri:r}).toString()});if(!e.data)throw new rO.BetterAuthError("FAILED_TO_GET_ACCESS_TOKEN");let o=e.data;return{accessToken:o.access_token,refreshToken:o.refresh_token,accessTokenExpiresAt:o.expires_in?new Date(Date.now()+1e3*o.expires_in):void 0,idToken:o.id_token}}catch(e){throw os.logger.error("PayPal token exchange failed:",e),new rO.BetterAuthError("FAILED_TO_GET_ACCESS_TOKEN")}},refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>{let r=rV.encode(`${e.clientId}:${e.clientSecret}`);try{let e=await an(i,{method:"POST",headers:{Authorization:`Basic ${r}`,Accept:"application/json","Accept-Language":"en_US","Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:t}).toString()});if(!e.data)throw new rO.BetterAuthError("FAILED_TO_REFRESH_ACCESS_TOKEN");let n=e.data;return{accessToken:n.access_token,refreshToken:n.refresh_token,accessTokenExpiresAt:n.expires_in?new Date(Date.now()+1e3*n.expires_in):void 0}}catch(e){throw os.logger.error("PayPal token refresh failed:",e),new rO.BetterAuthError("FAILED_TO_REFRESH_ACCESS_TOKEN")}},async verifyIdToken(t,r){if(e.disableIdTokenSignIn)return!1;if(e.verifyIdToken)return e.verifyIdToken(t,r);try{return!!af(t).sub}catch(e){return os.logger.error("Failed to verify PayPal ID token:",e),!1}},async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);if(!t.accessToken)return os.logger.error("Access token is required to fetch PayPal user info"),null;try{let r=await an(`${n}?schema=paypalv1.1`,{headers:{Authorization:`Bearer ${t.accessToken}`,Accept:"application/json"}});if(!r.data)return os.logger.error("Failed to fetch user info from PayPal"),null;let i=r.data,o=await e.mapProfileToUser?.(i);return{user:{id:i.user_id,name:i.name,email:i.email,image:i.picture,emailVerified:i.email_verified,...o},data:i}}catch(e){return os.logger.error("Failed to fetch user info from PayPal:",e),null}},options:e}},polar:e=>({id:"polar",name:"Polar",createAuthorizationURL({state:t,scopes:r,codeVerifier:i,redirectURI:n}){let o=e.disableDefaultScope?[]:["openid","profile","email"];return e.scope&&o.push(...e.scope),r&&o.push(...r),oW({id:"polar",options:e,authorizationEndpoint:"https://polar.sh/oauth2/authorize",scopes:o,state:t,codeVerifier:i,redirectURI:n,prompt:e.prompt})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>ah({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:"https://api.polar.sh/v1/oauth2/token"}),refreshAccessToken:e.refreshAccessToken?e.refreshAccessToken:async t=>ao({refreshToken:t,options:{clientId:e.clientId,clientKey:e.clientKey,clientSecret:e.clientSecret},tokenEndpoint:"https://api.polar.sh/v1/oauth2/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://api.polar.sh/v1/oauth2/userinfo",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(i)return null;let n=await e.mapProfileToUser?.(r);return{user:{id:r.id,name:r.public_name||r.username,email:r.email,image:r.avatar_url,emailVerified:r.email_verified??!1,...n},data:r}},options:e}),vercel:e=>({id:"vercel",name:"Vercel",createAuthorizationURL({state:t,scopes:r,codeVerifier:i,redirectURI:n}){let o;if(!i)throw new rO.BetterAuthError("codeVerifier is required for Vercel");return(void 0!==e.scope||void 0!==r)&&(o=[],e.scope&&o.push(...e.scope),r&&o.push(...r)),oW({id:"vercel",options:e,authorizationEndpoint:"https://vercel.com/oauth/authorize",scopes:o,state:t,codeVerifier:i,redirectURI:n})},validateAuthorizationCode:async({code:t,codeVerifier:r,redirectURI:i})=>ah({code:t,codeVerifier:r,redirectURI:i,options:e,tokenEndpoint:"https://api.vercel.com/login/oauth/token"}),async getUserInfo(t){if(e.getUserInfo)return e.getUserInfo(t);let{data:r,error:i}=await an("https://api.vercel.com/login/oauth/userinfo",{headers:{Authorization:`Bearer ${t.accessToken}`}});if(i||!r)return null;let n=await e.mapProfileToUser?.(r);return{user:{id:r.sub,name:r.name??r.preferred_username,email:r.email,image:r.picture,emailVerified:r.email_verified??!1,...n},data:r}},options:e})},av=Object.keys(aT),ak=iS.enum(av).or(iS.string()),aR=n6("/list-accounts",{method:"GET",use:[oD],metadata:{openapi:{operationId:"listUserAccounts",description:"List all accounts linked to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{type:"object",properties:{id:{type:"string"},providerId:{type:"string"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"},accountId:{type:"string"},userId:{type:"string"},scopes:{type:"array",items:{type:"string"}}},required:["id","providerId","createdAt","updatedAt","accountId","userId","scopes"]}}}}}}}}},async e=>{let t=e.context.session,r=await e.context.internalAdapter.findAccounts(t.user.id);return e.json(r.map(t=>{let{scope:r,...i}=nu(e.context.options,t);return{...i,scopes:r?.split(",")||[]}}))}),aI=n6("/link-social",{method:"POST",requireHeaders:!0,body:iS.object({callbackURL:iS.string().meta({description:"The URL to redirect to after the user has signed in"}).optional(),provider:ak,idToken:iS.object({token:iS.string(),nonce:iS.string().optional(),accessToken:iS.string().optional(),refreshToken:iS.string().optional(),scopes:iS.array(iS.string()).optional()}).optional(),requestSignUp:iS.boolean().optional(),scopes:iS.array(iS.string()).meta({description:"Additional scopes to request from the provider"}).optional(),errorCallbackURL:iS.string().meta({description:"The URL to redirect to if there is an error during the link process"}).optional(),disableRedirect:iS.boolean().meta({description:"Disable automatic redirection to the provider. Useful for handling the redirection yourself"}).optional(),additionalData:iS.record(iS.string(),iS.any()).optional()}),use:[oD],metadata:{openapi:{description:"Link a social account to the user",operationId:"linkSocialAccount",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{url:{type:"string",description:"The authorization URL to redirect the user to"},redirect:{type:"boolean",description:"Indicates if the user should be redirected to the authorization URL"},status:{type:"boolean"}},required:["redirect"]}}}}}}}},async e=>{let t=e.context.session,r=e.context.socialProviders.find(t=>t.id===e.body.provider);if(!r)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new iH("NOT_FOUND",{message:nX.BASE_ERROR_CODES.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!r.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new iH("NOT_FOUND",{message:nX.BASE_ERROR_CODES.ID_TOKEN_NOT_SUPPORTED});let{token:i,nonce:n}=e.body.idToken;if(!await r.verifyIdToken(i,n))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new iH("UNAUTHORIZED",{message:nX.BASE_ERROR_CODES.INVALID_TOKEN});let o=await r.getUserInfo({idToken:i,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!o||!o?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new iH("UNAUTHORIZED",{message:nX.BASE_ERROR_CODES.FAILED_TO_GET_USER_INFO});let a=String(o.user.id);if(!o.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new iH("UNAUTHORIZED",{message:nX.BASE_ERROR_CODES.USER_EMAIL_NOT_FOUND});if((await e.context.internalAdapter.findAccounts(t.user.id)).find(e=>e.providerId===r.id&&e.accountId===a))return e.json({url:"",status:!0,redirect:!1});if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(r.id)&&!o.user.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)throw new iH("UNAUTHORIZED",{message:"Account not linked - linking not allowed"});if(o.user.email!==t.user.email&&e.context.options.account?.accountLinking?.allowDifferentEmails!==!0)throw new iH("UNAUTHORIZED",{message:"Account not linked - different emails not allowed"});try{await e.context.internalAdapter.createAccount({userId:t.user.id,providerId:r.id,accountId:a,accessToken:e.body.idToken.accessToken,idToken:i,refreshToken:e.body.idToken.refreshToken,scope:e.body.idToken.scopes?.join(",")})}catch{throw new iH("EXPECTATION_FAILED",{message:"Account not linked - unable to create account"})}if(e.context.options.account?.accountLinking?.updateUserInfoOnLink===!0)try{await e.context.internalAdapter.updateUser(t.user.id,{name:o.user?.name,image:o.user?.image})}catch(e){console.warn("Could not update user - "+e.toString())}return e.json({url:"",status:!0,redirect:!1})}let i=await n$(e,{userId:t.user.id,email:t.user.email},e.body.additionalData),n=await r.createAuthorizationURL({state:i.state,codeVerifier:i.codeVerifier,redirectURI:`${e.context.baseURL}/callback/${r.id}`,scopes:e.body.scopes});return e.body.disableRedirect||e.setHeader("Location",n.toString()),e.json({url:n.toString(),redirect:!e.body.disableRedirect})}),aS=n6("/unlink-account",{method:"POST",body:iS.object({providerId:iS.string(),accountId:iS.string().optional()}),use:[oN],metadata:{openapi:{description:"Unlink an account",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{let{providerId:t,accountId:r}=e.body,i=await e.context.internalAdapter.findAccounts(e.context.session.user.id);if(1===i.length&&!e.context.options.account?.accountLinking?.allowUnlinkingAll)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.FAILED_TO_UNLINK_LAST_ACCOUNT});let n=i.find(e=>r?e.accountId===r&&e.providerId===t:e.providerId===t);if(!n)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.ACCOUNT_NOT_FOUND});return await e.context.internalAdapter.deleteAccount(n.id),e.json({status:!0})}),ax=n6("/get-access-token",{method:"POST",body:iS.object({providerId:iS.string().meta({description:"The provider ID for the OAuth provider"}),accountId:iS.string().meta({description:"The account ID associated with the refresh token"}).optional(),userId:iS.string().meta({description:"The user ID associated with the account"}).optional()}),metadata:{openapi:{description:"Get a valid access token, doing a refresh if needed",responses:{200:{description:"A Valid access token",content:{"application/json":{schema:{type:"object",properties:{tokenType:{type:"string"},idToken:{type:"string"},accessToken:{type:"string"},accessTokenExpiresAt:{type:"string",format:"date-time"}}}}}},400:{description:"Invalid refresh token or provider configuration"}}}}},async e=>{let t,{providerId:r,accountId:i,userId:n}=e.body||{},o=e.request,a=await oO(e);if(o&&!a)throw e.error("UNAUTHORIZED");let s=a?.user?.id||n;if(!s)throw e.error("UNAUTHORIZED");if(!e.context.socialProviders.find(e=>e.id===r))throw new iH("BAD_REQUEST",{message:`Provider ${r} is not supported.`});let c=await nR(e);if(!(t=c&&r===c.providerId&&(!i||c.id===i)?c:(await e.context.internalAdapter.findAccounts(s)).find(e=>i?e.id===i&&e.providerId===r:e.providerId===r)))throw new iH("BAD_REQUEST",{message:"Account not found"});let d=e.context.socialProviders.find(e=>e.id===r);if(!d)throw new iH("BAD_REQUEST",{message:`Provider ${r} not found.`});try{let r=null,i=t.accessTokenExpiresAt&&new Date(t.accessTokenExpiresAt).getTime()-Date.now()<5e3;if(t.refreshToken&&i&&d.refreshAccessToken){let i=await nz(t.refreshToken,e.context);r=await d.refreshAccessToken(i);let n={accessToken:await nV(r.accessToken,e.context),accessTokenExpiresAt:r.accessTokenExpiresAt,refreshToken:await nV(r.refreshToken,e.context),refreshTokenExpiresAt:r.refreshTokenExpiresAt},o=null;t.id&&(o=await e.context.internalAdapter.updateAccount(t.id,n)),e.context.options.account?.storeAccountCookie&&await nk(e,{...t,...o??n})}let n=r?.accessTokenExpiresAt?"string"==typeof r.accessTokenExpiresAt?new Date(r.accessTokenExpiresAt):r.accessTokenExpiresAt:t.accessTokenExpiresAt?"string"==typeof t.accessTokenExpiresAt?new Date(t.accessTokenExpiresAt):t.accessTokenExpiresAt:void 0,o={accessToken:r?.accessToken??await nz(t.accessToken??"",e.context),accessTokenExpiresAt:n,scopes:t.scope?.split(",")??[],idToken:r?.idToken??t.idToken??void 0};return e.json(o)}catch(e){throw new iH("BAD_REQUEST",{message:"Failed to get a valid access token",cause:e})}}),aU=n6("/refresh-token",{method:"POST",body:iS.object({providerId:iS.string().meta({description:"The provider ID for the OAuth provider"}),accountId:iS.string().meta({description:"The account ID associated with the refresh token"}).optional(),userId:iS.string().meta({description:"The user ID associated with the account"}).optional()}),metadata:{openapi:{description:"Refresh the access token using a refresh token",responses:{200:{description:"Access token refreshed successfully",content:{"application/json":{schema:{type:"object",properties:{tokenType:{type:"string"},idToken:{type:"string"},accessToken:{type:"string"},refreshToken:{type:"string"},accessTokenExpiresAt:{type:"string",format:"date-time"},refreshTokenExpiresAt:{type:"string",format:"date-time"}}}}}},400:{description:"Invalid refresh token or provider configuration"}}}}},async e=>{let t,r,{providerId:i,accountId:n,userId:o}=e.body,a=e.request,s=await oO(e);if(a&&!s)throw e.error("UNAUTHORIZED");let c=s?.user?.id||o;if(!c)throw new iH("BAD_REQUEST",{message:"Either userId or session is required"});let d=e.context.socialProviders.find(e=>e.id===i);if(!d)throw new iH("BAD_REQUEST",{message:`Provider ${i} not found.`});if(!d.refreshAccessToken)throw new iH("BAD_REQUEST",{message:`Provider ${i} does not support token refreshing.`});let l=await nR(e);if(!(t=l&&(!i||i===l?.providerId)?l:(await e.context.internalAdapter.findAccounts(c)).find(e=>n?e.id===n&&e.providerId===i:e.providerId===i)))throw new iH("BAD_REQUEST",{message:"Account not found"});if(!(r=l&&i===l.providerId?l.refreshToken??void 0:t.refreshToken??void 0))throw new iH("BAD_REQUEST",{message:"Refresh token not found"});try{let n=await nz(r,e.context),o=await d.refreshAccessToken(n);if(t.id){let r={...t||{},accessToken:await nV(o.accessToken,e.context),refreshToken:await nV(o.refreshToken,e.context),accessTokenExpiresAt:o.accessTokenExpiresAt,refreshTokenExpiresAt:o.refreshTokenExpiresAt,scope:o.scopes?.join(",")||t.scope,idToken:o.idToken||t.idToken};await e.context.internalAdapter.updateAccount(t.id,r)}return l&&i===l.providerId&&e.context.options.account?.storeAccountCookie&&await nk(e,{...l,accessToken:await nV(o.accessToken,e.context),refreshToken:await nV(o.refreshToken,e.context),accessTokenExpiresAt:o.accessTokenExpiresAt,refreshTokenExpiresAt:o.refreshTokenExpiresAt,scope:o.scopes?.join(",")||l.scope,idToken:o.idToken||l.idToken}),e.json({accessToken:o.accessToken,refreshToken:o.refreshToken,accessTokenExpiresAt:o.accessTokenExpiresAt,refreshTokenExpiresAt:o.refreshTokenExpiresAt,scope:o.scopes?.join(",")||t.scope,idToken:o.idToken||t.idToken,providerId:t.providerId,accountId:t.accountId})}catch(e){throw new iH("BAD_REQUEST",{message:"Failed to refresh access token",cause:e})}}),aO=n6("/account-info",{method:"GET",use:[oD],metadata:{openapi:{description:"Get the account info provided by the provider",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",properties:{id:{type:"string"},name:{type:"string"},email:{type:"string"},image:{type:"string"},emailVerified:{type:"boolean"}},required:["id","emailVerified"]},data:{type:"object",properties:{},additionalProperties:!0}},required:["user","data"],additionalProperties:!1}}}}}}},query:iS.optional(iS.object({accountId:iS.string().meta({description:"The provider given account id for which to get the account info"}).optional()}))},async e=>{let t,r=e.query?.accountId;if(r){let i=await e.context.internalAdapter.findAccount(r);i&&(t=i)}else if(e.context.options.account?.storeAccountCookie){let r=await nR(e);r&&(t=r)}if(!t||t.userId!==e.context.session.user.id)throw new iH("BAD_REQUEST",{message:"Account not found"});let i=e.context.socialProviders.find(e=>e.id===t.providerId);if(!i)throw new iH("INTERNAL_SERVER_ERROR",{message:`Provider account provider is ${t.providerId} but it is not configured`});let n=await ax({...e,method:"POST",body:{accountId:t.id,providerId:t.providerId},returnHeaders:!1,returnStatus:!1});if(!n.accessToken)throw new iH("BAD_REQUEST",{message:"Access token not found"});let o=await i.getUserInfo({...n,accessToken:n.accessToken});return e.json(o)}),aD={scope:"server"},aC=iS.object({code:iS.string().optional(),error:iS.string().optional(),device_id:iS.string().optional(),error_description:iS.string().optional(),state:iS.string().optional(),user:iS.string().optional()}),aN=n6("/callback/:id",{method:["GET","POST"],operationId:"handleOAuthCallback",body:aC.optional(),query:aC.optional(),metadata:{...aD,allowedMediaTypes:["application/x-www-form-urlencoded","application/json"]}},async e=>{let t,r,i,n=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;if("POST"===e.method){let t=e.body?aC.parse(e.body):{},r=e.query?aC.parse(e.query):{},i=aC.parse({...t,...r}),n=new URLSearchParams;for(let[e,t]of Object.entries(i))null!=t&&n.set(e,String(t));let o=`${e.context.baseURL}/callback/${e.params.id}?${n.toString()}`;throw e.redirect(o)}try{if("GET"===e.method)t=aC.parse(e.query);else if("POST"===e.method)t=aC.parse(e.body);else throw Error("Unsupported method")}catch(t){throw e.context.logger.error("INVALID_CALLBACK_REQUEST",t),e.redirect(`${n}?error=invalid_callback_request`)}let{code:o,error:a,state:s,error_description:c,device_id:d}=t;if(!s){e.context.logger.error("State not found",a);let t=`${n}${n.includes("?")?"&":"?"}state=state_not_found`;throw e.redirect(t)}let{codeVerifier:l,callbackURL:u,link:p,errorURL:h,newUserURL:f,requestSignUp:m}=await nM(e);function g(t,r){let i=h??n,o=new URLSearchParams({error:t});r&&o.set("error_description",r);let a=`${i}${i.includes("?")?"&":"?"}${o.toString()}`;throw e.redirect(a)}if(a&&g(a,c),!o)throw e.context.logger.error("Code not found"),g("no_code");let y=e.context.socialProviders.find(t=>t.id===e.params.id);if(!y)throw e.context.logger.error("Oauth provider with id",e.params.id,"not found"),g("oauth_provider_not_found");try{r=await y.validateAuthorizationCode({code:o,codeVerifier:l,deviceId:d,redirectURI:`${e.context.baseURL}/callback/${y.id}`})}catch(t){throw e.context.logger.error("",t),g("invalid_code")}let w=await y.getUserInfo({...r,user:e.body?.user?(0,nw.safeJSONParse)(e.body.user):void 0}).then(e=>e?.user);if(!w)return e.context.logger.error("Unable to get user info"),g("unable_to_get_user_info");if(!u)throw e.context.logger.error("No callback URL found"),g("no_callback_url");if(p){let t;if(!e.context.options.account?.accountLinking?.trustedProviders?.includes(y.id)&&!w.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return e.context.logger.error("Unable to link account - untrusted provider"),g("unable_to_link_account");if(w.email!==p.email&&e.context.options.account?.accountLinking?.allowDifferentEmails!==!0)return g("email_doesn't_match");let i=await e.context.internalAdapter.findAccount(String(w.id));if(i){if(i.userId.toString()!==p.userId.toString())return g("account_already_linked_to_different_user");let t=Object.fromEntries(Object.entries({accessToken:await nV(r.accessToken,e.context),refreshToken:await nV(r.refreshToken,e.context),idToken:r.idToken,accessTokenExpiresAt:r.accessTokenExpiresAt,refreshTokenExpiresAt:r.refreshTokenExpiresAt,scope:r.scopes?.join(",")}).filter(([e,t])=>void 0!==t));await e.context.internalAdapter.updateAccount(i.id,t)}else if(!await e.context.internalAdapter.createAccount({userId:p.userId,providerId:y.id,accountId:String(w.id),...r,accessToken:await nV(r.accessToken,e.context),refreshToken:await nV(r.refreshToken,e.context),scope:r.scopes?.join(",")}))return g("unable_to_link_account");try{t=u.toString()}catch{t=u}throw e.redirect(t)}if(!w.email)return e.context.logger.error("Provider did not return email. This could be due to misconfiguration in the provider settings."),g("email_not_found");let b={providerId:y.id,accountId:String(w.id),...r,scope:r.scopes?.join(",")},E=await a9(e,{userInfo:{...w,id:String(w.id),email:w.email,name:w.name||w.email},account:b,callbackURL:u,disableSignUp:y.disableImplicitSignUp&&!m||y.options?.disableSignUp,overrideUserInfo:y.options?.overrideUserInfoOnSignIn});if(E.error)return e.context.logger.error(E.error.split(" ").join("_")),g(E.error.split(" ").join("_"));let{session:_,user:A}=E.data;await nq(e,{session:_,user:A});try{i=(E.isRegister&&f||u).toString()}catch{i=E.isRegister&&f||u}throw e.redirect(i)});function aP(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/&(?!amp;|lt;|gt;|quot;|#39;|#x[0-9a-fA-F]+;|#[0-9]+;)/g,"&amp;")}let aL=n6("/error",{method:"GET",metadata:{...aD,openapi:{description:"Displays an error page",responses:{200:{description:"Success",content:{"text/html":{schema:{type:"string",description:"The HTML content of the error page"}}}}}}}},async e=>{let t=new URL(e.request?.url||""),r=t.searchParams.get("error")||"UNKNOWN",i=t.searchParams.get("error_description")||null,n=/^[\'A-Za-z0-9_-]+$/.test(r||"")?r:"UNKNOWN",o=i?aP(i):null,a=new URLSearchParams;a.set("error",n),i&&a.set("error_description",i);let s=e.context.options,c=s.onAPIError?.errorURL;return c?new Response(null,{status:302,headers:{Location:`${c}${c.includes("?")?"&":"?"}${a.toString()}`}}):nD.isProduction&&!s.onAPIError?.customizeDefaultErrorPage?new Response(null,{status:302,headers:{Location:`/?${a.toString()}`}}):new Response(((e,t="Unknown",r=null)=>{let i=e.onAPIError?.customizeDefaultErrorPage;return`<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Error</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: ${i?.font?.defaultFamily||"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif"};
        background: ${i?.colors?.background||"var(--background)"};
        color: var(--foreground);
        margin: 0;
      }
      :root,
      :host {
        --spacing: 0.25rem;
        --container-md: 28rem;
        --text-sm: ${i?.size?.textSm||"0.875rem"};
        --text-sm--line-height: calc(1.25 / 0.875);
        --text-2xl: ${i?.size?.text2xl||"1.5rem"};
        --text-2xl--line-height: calc(2 / 1.5);
        --text-4xl: ${i?.size?.text4xl||"2.25rem"};
        --text-4xl--line-height: calc(2.5 / 2.25);
        --text-6xl: ${i?.size?.text6xl||"3rem"};
        --text-6xl--line-height: 1;
        --font-weight-medium: 500;
        --font-weight-semibold: 600;
        --font-weight-bold: 700;
        --default-transition-duration: 150ms;
        --default-transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        --radius: ${i?.size?.radiusSm||"0.625rem"};
        --default-mono-font-family: ${i?.font?.monoFamily||"var(--font-geist-mono)"};
        --primary: ${i?.colors?.primary||"black"};
        --primary-foreground: ${i?.colors?.primaryForeground||"white"};
        --background: ${i?.colors?.background||"white"};
        --foreground: ${i?.colors?.foreground||"oklch(0.271 0 0)"};
        --border: ${i?.colors?.border||"oklch(0.89 0 0)"};
        --destructive: ${i?.colors?.destructive||"oklch(0.55 0.15 25.723)"};
        --muted-foreground: ${i?.colors?.mutedForeground||"oklch(0.545 0 0)"};
        --corner-border: ${i?.colors?.cornerBorder||"#404040"};
      }

      button, .btn {
        cursor: pointer;
        background: none;
        border: none;
        color: inherit;
        font: inherit;
        transition: all var(--default-transition-duration)
          var(--default-transition-timing-function);
      }
      button:hover, .btn:hover {
        opacity: 0.8;
      }

      @media (prefers-color-scheme: dark) {
        :root,
        :host {
          --primary: ${i?.colors?.primary||"white"};
          --primary-foreground: ${i?.colors?.primaryForeground||"black"};
          --background: ${i?.colors?.background||"oklch(0.15 0 0)"};
          --foreground: ${i?.colors?.foreground||"oklch(0.98 0 0)"};
          --border: ${i?.colors?.border||"oklch(0.27 0 0)"};
          --destructive: ${i?.colors?.destructive||"oklch(0.65 0.15 25.723)"};
          --muted-foreground: ${i?.colors?.mutedForeground||"oklch(0.65 0 0)"};
          --corner-border: ${i?.colors?.cornerBorder||"#a0a0a0"};
        }
      }
      @media (max-width: 640px) {
        :root, :host {
          --text-6xl: 2.5rem;
          --text-2xl: 1.25rem;
          --text-sm: 0.8125rem;
        }
      }
      @media (max-width: 480px) {
        :root, :host {
          --text-6xl: 2rem;
          --text-2xl: 1.125rem;
        }
      }
    </style>
  </head>
  <body style="width: 100vw; min-height: 100vh; overflow-x: hidden; overflow-y: auto;">
    <div
        style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            position: relative;
            width: 100%;
            min-height: 100vh;
            padding: 1rem;
        "
        >
${i?.disableBackgroundGrid?"":`
      <div
        style="
          position: absolute;
          inset: 0;
          background-image: linear-gradient(to right, ${i?.colors?.gridColor||"var(--border)"} 1px, transparent 1px),
            linear-gradient(to bottom, ${i?.colors?.gridColor||"var(--border)"} 1px, transparent 1px);
          background-size: 40px 40px;
          opacity: 0.6;
          pointer-events: none;
          width: 100vw;
          height: 100vh;
        "
      ></div>
      <div
        style="
          position: absolute;
          inset: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          background: ${i?.colors?.background||"var(--background)"};
          mask-image: radial-gradient(ellipse at center, transparent 20%, black);
          -webkit-mask-image: radial-gradient(ellipse at center, transparent 20%, black);
          pointer-events: none;
        "
      ></div>
`}

<div
  style="
    position: relative;
    z-index: 10;
    border: 2px solid var(--border);
    background: ${i?.colors?.cardBackground||"var(--background)"};
    padding: 1.5rem;
    max-width: 42rem;
    width: 100%;
  "
>
    ${i?.disableCornerDecorations?"":`
        <!-- Corner decorations -->
        <div
          style="
            position: absolute;
            top: -2px;
            left: -2px;
            width: 2rem;
            height: 2rem;
            border-top: 4px solid var(--corner-border);
            border-left: 4px solid var(--corner-border);
          "
        ></div>
        <div
          style="
            position: absolute;
            top: -2px;
            right: -2px;
            width: 2rem;
            height: 2rem;
            border-top: 4px solid var(--corner-border);
            border-right: 4px solid var(--corner-border);
          "
        ></div>
  
        <div
          style="
            position: absolute;
            bottom: -2px;
            left: -2px;
            width: 2rem;
            height: 2rem;
            border-bottom: 4px solid var(--corner-border);
            border-left: 4px solid var(--corner-border);
          "
        ></div>
        <div
          style="
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 2rem;
            height: 2rem;
            border-bottom: 4px solid var(--corner-border);
            border-right: 4px solid var(--corner-border);
          "
        ></div>`}

        <div style="text-align: center; margin-bottom: 1.5rem;">
          <div style="margin-bottom: 1.5rem;">
            <div
              style="
                display: inline-block;
                border: 2px solid ${i?.disableTitleBorder?"transparent":i?.colors?.titleBorder||"var(--destructive)"};
                padding: 0.375rem 1rem;
              "
            >
              <h1
                style="
                  font-size: var(--text-6xl);
                  font-weight: var(--font-weight-semibold);
                  color: ${i?.colors?.titleColor||"var(--foreground)"};
                  letter-spacing: -0.02em;
                  margin: 0;
                "
              >
                ERROR
              </h1>
            </div>
            <div
              style="
                height: 2px;
                background-color: var(--border);
                width: calc(100% + 3rem);
                margin-left: -1.5rem;
                margin-top: 1.5rem;
              "
            ></div>
          </div>

          <h2
            style="
              font-size: var(--text-2xl);
              font-weight: var(--font-weight-semibold);
              color: var(--foreground);
              margin: 0 0 1rem;
            "
          >
            Something went wrong
          </h2>

          <div
            style="
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                border: 2px solid var(--border);
                background-color: var(--muted);
                padding: 0.375rem 0.75rem;
                margin: 0 0 1rem;
                flex-wrap: wrap;
                justify-content: center;
            "
            >
            <span
                style="
                font-size: 0.75rem;
                color: var(--muted-foreground);
                font-weight: var(--font-weight-semibold);
                "
            >
                CODE:
            </span>
            <span
                style="
                font-size: var(--text-sm);
                font-family: var(--default-mono-font-family, monospace);
                color: var(--foreground);
                word-break: break-all;
                "
            >
                ${aP(t)}
            </span>
            </div>

          <p
            style="
              color: var(--muted-foreground);
              max-width: 28rem;
              margin: 0 auto;
              font-size: var(--text-sm);
              line-height: 1.5;
              text-wrap: pretty;
            "
          >
            ${!r?`We encountered an unexpected error. Please try again or return to the home page. If you're a developer, you can find more information about the error <a href='https://better-auth.com/docs/errors/${encodeURIComponent(t)}' target='_blank' rel="noopener noreferrer" style='color: var(--foreground); text-decoration: underline;'>here</a>.`:r}
          </p>
        </div>

        <div
          style="
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
          "
        >
          <a
            href="/"
            style="
              text-decoration: none;
            "
          >
            <div
              style="
                border: 2px solid var(--border);
                background: var(--primary);
                color: var(--primary-foreground);
                padding: 0.5rem 1rem;
                border-radius: 0;
                white-space: nowrap;
              "
              class="btn"
            >
              Go Home
            </div>
          </a>
          <a
            href="https://better-auth.com/docs/errors/${encodeURIComponent(t)}?askai=${encodeURIComponent(`What does the error code ${t} mean?`)}"
            target="_blank"
            rel="noopener noreferrer"
            style="
              text-decoration: none;
            "
          >
            <div
              style="
                border: 2px solid var(--border);
                background: transparent;
                color: var(--foreground);
                padding: 0.5rem 1rem;
                border-radius: 0;
                white-space: nowrap;
              "
              class="btn"
            >
              Ask AI
            </div>
          </a>
        </div>
      </div>
    </div>
  </body>
</html>`})(e.context.options,n,o),{headers:{"Content-Type":"text/html"}})}),aj=n6("/ok",{method:"GET",metadata:{...aD,openapi:{description:"Check if the API is working",responses:{200:{description:"API is working",content:{"application/json":{schema:{type:"object",properties:{ok:{type:"boolean",description:"Indicates if the API is working"}},required:["ok"]}}}}}}}},async e=>e.json({ok:!0}));async function aq(e,t){let r=(await e.context.internalAdapter.findAccounts(t.userId))?.find(e=>"credential"===e.providerId),i=r?.password;return!!r&&!!i&&await e.context.password.verify({hash:i,password:t.password})}async function aB(e,t){let r=(await t.context.internalAdapter.findAccounts(e))?.find(e=>"credential"===e.providerId),i=r?.password;if(!r||!i||!t.body.password)throw new iH("BAD_REQUEST",{message:"No password credential found"});if(!await t.context.password.verify({hash:i,password:t.body.password}))throw new iH("BAD_REQUEST",{message:"Invalid password"});return!0}function aH(e,t,r){let i=t?new URL(t,e.baseURL):new URL(`${e.baseURL}/error`);return r&&Object.entries(r).forEach(([e,t])=>i.searchParams.set(e,t)),i.href}let a$=n6("/request-password-reset",{method:"POST",body:iS.object({email:iS.email().meta({description:"The email address of the user to send a password reset email to"}),redirectTo:iS.string().meta({description:"The URL to redirect the user to reset their password. If the token isn't valid or expired, it'll be redirected with a query parameter `?error=INVALID_TOKEN`. If the token is valid, it'll be redirected with a query parameter `?token=VALID_TOKEN"}).optional()}),metadata:{openapi:{operationId:"requestPasswordReset",description:"Send a password reset email to the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"},message:{type:"string"}}}}}}}}}},async e=>{if(!e.context.options.emailAndPassword?.sendResetPassword)throw e.context.logger.error("Reset password isn't enabled.Please pass an emailAndPassword.sendResetPassword function in your auth config!"),new iH("BAD_REQUEST",{message:"Reset password isn't enabled"});let{email:t,redirectTo:r}=e.body,i=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!i)return(0,om.generateId)(24),await e.context.internalAdapter.findVerificationValue("dummy-verification-token"),e.context.logger.error("Reset Password: User not found",{email:t}),e.json({status:!0,message:"If this email exists in our system, check your email for the reset link"});let n=iR(e.context.options.emailAndPassword.resetPasswordTokenExpiresIn||3600,"sec"),o=(0,om.generateId)(24);await e.context.internalAdapter.createVerificationValue({value:i.user.id,identifier:`reset-password:${o}`,expiresAt:n});let a=r?encodeURIComponent(r):"",s=`${e.context.baseURL}/reset-password/${o}?callbackURL=${a}`;return await e.context.runInBackgroundOrAwait(e.context.options.emailAndPassword.sendResetPassword({user:i.user,url:s,token:o},e.request)),e.json({status:!0,message:"If this email exists in our system, check your email for the reset link"})}),aM=n6("/reset-password/:token",{method:"GET",operationId:"forgetPasswordCallback",query:iS.object({callbackURL:iS.string().meta({description:"The URL to redirect the user to reset their password"})}),use:[n9(e=>e.query.callbackURL)],metadata:{openapi:{operationId:"resetPasswordCallback",description:"Redirects the user to the callback URL with the token",parameters:[{name:"token",in:"path",required:!0,description:"The token to reset the password",schema:{type:"string"}},{name:"callbackURL",in:"query",required:!0,description:"The URL to redirect the user to reset their password",schema:{type:"string"}}],responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string"}}}}}}}}}},async e=>{var t,r;let i,{token:n}=e.params,{callbackURL:o}=e.query;if(!n||!o)throw e.redirect(aH(e.context,o,{error:"INVALID_TOKEN"}));let a=await e.context.internalAdapter.findVerificationValue(`reset-password:${n}`);if(!a||a.expiresAt<new Date)throw e.redirect(aH(e.context,o,{error:"INVALID_TOKEN"}));throw e.redirect((t=e.context,r={token:n},i=new URL(o,t.baseURL),r&&Object.entries(r).forEach(([e,t])=>i.searchParams.set(e,t)),i.href))}),az=n6("/reset-password",{method:"POST",operationId:"resetPassword",query:iS.object({token:iS.string().optional()}).optional(),body:iS.object({newPassword:iS.string().meta({description:"The new password to set"}),token:iS.string().meta({description:"The token to reset the password"}).optional()}),metadata:{openapi:{operationId:"resetPassword",description:"Reset the password for a user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}}},async e=>{let t=e.body.token||e.query?.token;if(!t)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.INVALID_TOKEN});let{newPassword:r}=e.body,i=e.context.password?.config.minPasswordLength,n=e.context.password?.config.maxPasswordLength;if(r.length<i)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.PASSWORD_TOO_SHORT});if(r.length>n)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.PASSWORD_TOO_LONG});let o=`reset-password:${t}`,a=await e.context.internalAdapter.findVerificationValue(o);if(!a||a.expiresAt<new Date)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.INVALID_TOKEN});let s=a.value,c=await e.context.password.hash(r);if((await e.context.internalAdapter.findAccounts(s)).find(e=>"credential"===e.providerId)?await e.context.internalAdapter.updatePassword(s,c):await e.context.internalAdapter.createAccount({userId:s,providerId:"credential",password:c,accountId:s}),await e.context.internalAdapter.deleteVerificationValue(a.id),e.context.options.emailAndPassword?.onPasswordReset){let t=await e.context.internalAdapter.findUserById(s);t&&await e.context.options.emailAndPassword.onPasswordReset({user:t},e.request)}return e.context.options.emailAndPassword?.revokeSessionsOnPasswordReset&&await e.context.internalAdapter.deleteSessions(s),e.json({status:!0})}),aV=n6("/verify-password",{method:"POST",body:iS.object({password:iS.string().meta({description:"The password to verify"})}),metadata:{scope:"server",openapi:{operationId:"verifyPassword",description:"Verify the current user's password",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{status:{type:"boolean"}}}}}}}}},use:[oC]},async e=>{let{password:t}=e.body,r=e.context.session;if(!await aq(e,{password:t,userId:r.user.id}))throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.INVALID_PASSWORD});return e.json({status:!0})}),aK=iS.object({callbackURL:iS.string().meta({description:"Callback URL to redirect to after the user has signed in"}).optional(),newUserCallbackURL:iS.string().optional(),errorCallbackURL:iS.string().meta({description:"Callback URL to redirect to if an error happens"}).optional(),provider:ak,disableRedirect:iS.boolean().meta({description:"Disable automatic redirection to the provider. Useful for handling the redirection yourself"}).optional(),idToken:iS.optional(iS.object({token:iS.string().meta({description:"ID token from the provider"}),nonce:iS.string().meta({description:"Nonce used to generate the token"}).optional(),accessToken:iS.string().meta({description:"Access token from the provider"}).optional(),refreshToken:iS.string().meta({description:"Refresh token from the provider"}).optional(),expiresAt:iS.number().meta({description:"Expiry date of the token"}).optional()})),scopes:iS.array(iS.string()).meta({description:"Array of scopes to request from the provider. This will override the default scopes passed."}).optional(),requestSignUp:iS.boolean().meta({description:"Explicitly request sign-up. Useful when disableImplicitSignUp is true for this provider"}).optional(),loginHint:iS.string().meta({description:"The login hint to use for the authorization code request"}).optional(),additionalData:iS.record(iS.string(),iS.any()).optional().meta({description:"Additional data to be passed through the OAuth flow"})}),aW=n6("/sign-out",{method:"POST",operationId:"signOut",requireHeaders:!0,metadata:{openapi:{operationId:"signOut",description:"Sign out the current user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async e=>{let t=await e.getSignedCookie(e.context.authCookies.sessionToken.name,e.context.secret);if(t)try{await e.context.internalAdapter.deleteSession(t)}catch(t){e.context.logger.error("Failed to delete session from database",t)}return nH(e),e.json({success:!0})}),aF=iS.object({name:iS.string(),email:iS.email(),password:iS.string().nonempty(),image:iS.string().optional(),callbackURL:iS.string().optional(),rememberMe:iS.boolean().optional()}).and(iS.record(iS.string(),iS.any())),aZ=iS.record(iS.string().meta({description:"Field name must be a string"}),iS.any()),aJ=n6("/change-password",{method:"POST",operationId:"changePassword",body:iS.object({newPassword:iS.string().meta({description:"The new password to set"}),currentPassword:iS.string().meta({description:"The current password is required"}),revokeOtherSessions:iS.boolean().meta({description:"Must be a boolean value"}).optional()}),use:[oC],metadata:{openapi:{operationId:"changePassword",description:"Change the password of the user",responses:{200:{description:"Password successfully changed",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",nullable:!0,description:"New session token if other sessions were revoked"},user:{type:"object",properties:{id:{type:"string",description:"The unique identifier of the user"},email:{type:"string",format:"email",description:"The email address of the user"},name:{type:"string",description:"The name of the user"},image:{type:"string",format:"uri",nullable:!0,description:"The profile image URL of the user"},emailVerified:{type:"boolean",description:"Whether the email has been verified"},createdAt:{type:"string",format:"date-time",description:"When the user was created"},updatedAt:{type:"string",format:"date-time",description:"When the user was last updated"}},required:["id","email","name","emailVerified","createdAt","updatedAt"]}},required:["user"]}}}}}}}},async e=>{let{newPassword:t,currentPassword:r,revokeOtherSessions:i}=e.body,n=e.context.session,o=e.context.password.config.minPasswordLength;if(t.length<o)throw e.context.logger.error("Password is too short"),new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.PASSWORD_TOO_SHORT});let a=e.context.password.config.maxPasswordLength;if(t.length>a)throw e.context.logger.error("Password is too long"),new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.PASSWORD_TOO_LONG});let s=(await e.context.internalAdapter.findAccounts(n.user.id)).find(e=>"credential"===e.providerId&&e.password);if(!s||!s.password)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.CREDENTIAL_ACCOUNT_NOT_FOUND});let c=await e.context.password.hash(t);if(!await e.context.password.verify({hash:s.password,password:r}))throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.INVALID_PASSWORD});await e.context.internalAdapter.updateAccount(s.id,{password:c});let d=null;if(i){await e.context.internalAdapter.deleteSessions(n.user.id);let t=await e.context.internalAdapter.createSession(n.user.id);if(!t)throw new iH("INTERNAL_SERVER_ERROR",{message:nX.BASE_ERROR_CODES.FAILED_TO_GET_SESSION});await nq(e,{session:t,user:n.user}),d=t.token}return e.json({token:d,user:nd(e.context.options,n.user)})}),aG=n6({method:"POST",body:iS.object({newPassword:iS.string().meta({description:"The new password to set is required"})}),use:[oC]},async e=>{let{newPassword:t}=e.body,r=e.context.session,i=e.context.password.config.minPasswordLength;if(t.length<i)throw e.context.logger.error("Password is too short"),new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.PASSWORD_TOO_SHORT});let n=e.context.password.config.maxPasswordLength;if(t.length>n)throw e.context.logger.error("Password is too long"),new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.PASSWORD_TOO_LONG});let o=(await e.context.internalAdapter.findAccounts(r.user.id)).find(e=>"credential"===e.providerId&&e.password),a=await e.context.password.hash(t);if(!o)return await e.context.internalAdapter.linkAccount({userId:r.user.id,providerId:"credential",accountId:r.user.id,password:a}),e.json({status:!0});throw new iH("BAD_REQUEST",{message:"user already has a password"})}),aY=n6("/delete-user",{method:"POST",use:[oC],body:iS.object({callbackURL:iS.string().meta({description:"The callback URL to redirect to after the user is deleted"}).optional(),password:iS.string().meta({description:"The password of the user is required to delete the user"}).optional(),token:iS.string().meta({description:"The token to delete the user is required"}).optional()}),metadata:{openapi:{operationId:"deleteUser",description:"Delete the user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{callbackURL:{type:"string",description:"The callback URL to redirect to after the user is deleted"},password:{type:"string",description:"The user's password. Required if session is not fresh"},token:{type:"string",description:"The deletion verification token"}}}}}},responses:{200:{description:"User deletion processed successfully",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean",description:"Indicates if the operation was successful"},message:{type:"string",enum:["User deleted","Verification email sent"],description:"Status message of the deletion process"}},required:["success","message"]}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options"),new iH("NOT_FOUND");let t=e.context.session;if(e.body.password){let r=(await e.context.internalAdapter.findAccounts(t.user.id)).find(e=>"credential"===e.providerId&&e.password);if(!r||!r.password)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.CREDENTIAL_ACCOUNT_NOT_FOUND});if(!await e.context.password.verify({hash:r.password,password:e.body.password}))throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.INVALID_PASSWORD})}if(e.body.token)return await aQ({...e,query:{token:e.body.token}}),e.json({success:!0,message:"User deleted"});if(e.context.options.user.deleteUser?.sendDeleteAccountVerification){let r=ei(32,"0-9","a-z");await e.context.internalAdapter.createVerificationValue({value:t.user.id,identifier:`delete-account-${r}`,expiresAt:new Date(Date.now()+1e3*(e.context.options.user.deleteUser?.deleteTokenExpiresIn||86400))});let i=`${e.context.baseURL}/delete-user/callback?token=${r}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.runInBackgroundOrAwait(e.context.options.user.deleteUser.sendDeleteAccountVerification({user:t.user,url:i,token:r},e.request)),e.json({success:!0,message:"Verification email sent"})}if(!e.body.password&&0!==e.context.sessionConfig.freshAge){let r=new Date(t.session.createdAt).getTime(),i=1e3*e.context.sessionConfig.freshAge;if(Date.now()-r>1e3*i)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.SESSION_EXPIRED})}let r=e.context.options.user.deleteUser?.beforeDelete;r&&await r(t.user,e.request),await e.context.internalAdapter.deleteUser(t.user.id),await e.context.internalAdapter.deleteSessions(t.user.id),nH(e);let i=e.context.options.user.deleteUser?.afterDelete;return i&&await i(t.user,e.request),e.json({success:!0,message:"User deleted"})}),aQ=n6("/delete-user/callback",{method:"GET",query:iS.object({token:iS.string().meta({description:"The token to verify the deletion request"}),callbackURL:iS.string().meta({description:"The URL to redirect to after deletion"}).optional()}),use:[n9(e=>e.query.callbackURL)],metadata:{openapi:{description:"Callback to complete user deletion with verification token",responses:{200:{description:"User successfully deleted",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean",description:"Indicates if the deletion was successful"},message:{type:"string",enum:["User deleted"],description:"Confirmation message"}},required:["success","message"]}}}}}}}},async e=>{if(!e.context.options.user?.deleteUser?.enabled)throw e.context.logger.error("Delete user is disabled. Enable it in the options"),new iH("NOT_FOUND");let t=await oO(e);if(!t)throw new iH("NOT_FOUND",{message:nX.BASE_ERROR_CODES.FAILED_TO_GET_USER_INFO});let r=await e.context.internalAdapter.findVerificationValue(`delete-account-${e.query.token}`);if(!r||r.expiresAt<new Date||r.value!==t.user.id)throw new iH("NOT_FOUND",{message:nX.BASE_ERROR_CODES.INVALID_TOKEN});let i=e.context.options.user.deleteUser?.beforeDelete;i&&await i(t.user,e.request),await e.context.internalAdapter.deleteUser(t.user.id),await e.context.internalAdapter.deleteSessions(t.user.id),await e.context.internalAdapter.deleteAccounts(t.user.id),await e.context.internalAdapter.deleteVerificationValue(r.id),nH(e);let n=e.context.options.user.deleteUser?.afterDelete;if(n&&await n(t.user,e.request),e.query.callbackURL)throw e.redirect(e.query.callbackURL||"/");return e.json({success:!0,message:"User deleted"})}),aX=n6("/change-email",{method:"POST",body:iS.object({newEmail:iS.email().meta({description:"The new email address to set must be a valid email address"}),callbackURL:iS.string().meta({description:"The URL to redirect to after email verification"}).optional()}),use:[oC],metadata:{openapi:{operationId:"changeEmail",responses:{200:{description:"Email change request processed successfully",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",$ref:"#/components/schemas/User"},status:{type:"boolean",description:"Indicates if the request was successful"},message:{type:"string",enum:["Email updated","Verification email sent"],description:"Status message of the email change process",nullable:!0}},required:["status"]}}}},422:{description:"Unprocessable Entity. Email already exists",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}}}}}}},async e=>{if(!e.context.options.user?.changeEmail?.enabled)throw e.context.logger.error("Change email is disabled."),new iH("BAD_REQUEST",{message:"Change email is disabled"});let t=e.body.newEmail.toLowerCase();if(t===e.context.session.user.email)throw e.context.logger.error("Email is the same"),new iH("BAD_REQUEST",{message:"Email is the same"});if(await e.context.internalAdapter.findUserByEmail(t))throw e.context.logger.error("Email already exists"),new iH("UNPROCESSABLE_ENTITY",{message:nX.BASE_ERROR_CODES.USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL});if(!0!==e.context.session.user.emailVerified&&e.context.options.user.changeEmail.updateEmailWithoutVerification){if(await e.context.internalAdapter.updateUserByEmail(e.context.session.user.email,{email:t}),await nq(e,{session:e.context.session.session,user:{...e.context.session.user,email:t}}),e.context.options.emailVerification?.sendVerificationEmail){let r=await oq(e.context.secret,t,void 0,e.context.options.emailVerification?.expiresIn),i=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||"/"}`;await e.context.runInBackgroundOrAwait(e.context.options.emailVerification.sendVerificationEmail({user:{...e.context.session.user,email:t},url:i,token:r},e.request))}return e.json({status:!0})}if(e.context.session.user.emailVerified&&(e.context.options.user.changeEmail.sendChangeEmailConfirmation||e.context.options.user.changeEmail.sendChangeEmailVerification)){let r=await oq(e.context.secret,e.context.session.user.email,t,e.context.options.emailVerification?.expiresIn,{requestType:"change-email-confirmation"}),i=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||"/"}`,n=e.context.options.user.changeEmail.sendChangeEmailConfirmation||e.context.options.user.changeEmail.sendChangeEmailVerification;return n&&await e.context.runInBackgroundOrAwait(n({user:e.context.session.user,newEmail:t,url:i,token:r},e.request)),e.json({status:!0})}if(!e.context.options.emailVerification?.sendVerificationEmail)throw e.context.logger.error("Verification email isn't enabled."),new iH("BAD_REQUEST",{message:"Verification email isn't enabled"});let r=await oq(e.context.secret,e.context.session.user.email,t,e.context.options.emailVerification?.expiresIn,{requestType:"change-email-verification"}),i=`${e.context.baseURL}/verify-email?token=${r}&callbackURL=${e.body.callbackURL||"/"}`;return await e.context.runInBackgroundOrAwait(e.context.options.emailVerification.sendVerificationEmail({user:{...e.context.session.user,email:t},url:i,token:r},e.request)),e.json({status:!0})});function a0(e){if(null===e||"object"!=typeof e)return!1;let t=Object.getPrototypeOf(e);return(null===t||t===Object.prototype||null===Object.getPrototypeOf(t))&&!(Symbol.iterator in e)&&(!(Symbol.toStringTag in e)||"[object Module]"===Object.prototype.toString.call(e))}function a1(e){return(...t)=>t.reduce((t,r)=>(function e(t,r,i=".",n){if(!a0(r))return e(t,{},i,n);let o=Object.assign({},r);for(let r in t){if("__proto__"===r||"constructor"===r)continue;let a=t[r];null!=a&&(n&&n(o,r,a,i)||(Array.isArray(a)&&Array.isArray(o[r])?o[r]=[...a,...o[r]]:a0(a)&&a0(o[r])?o[r]=e(a,o[r],(i?`${i}.`:"")+r.toString(),n):o[r]=a))}return o})(t,r,"",e),{})}let a2=a1();a1((e,t,r)=>{if(void 0!==e[t]&&"function"==typeof r)return e[t]=r(e[t]),!0}),a1((e,t,r)=>{if(Array.isArray(e[t])&&"function"==typeof r)return e[t]=r(e[t]),!0});let a5=a1((e,t,r)=>{if(Array.isArray(e[t])&&Array.isArray(r))return e[t]=r,!0}),a6=new WeakMap;async function a3(e,t){let r={};for(let i of t){let t=!1;try{t=i.matcher(e)}catch(r){let t=a6.get(i.handler)??"unknown";throw e.context.logger.error(`An error occurred during ${t} hook matcher execution:`,r),new iH("INTERNAL_SERVER_ERROR",{message:"An error occurred during hook matcher execution. Check the logs for more details."})}if(t){let t=await i.handler({...e,returnHeaders:!1}).catch(t=>{throw t instanceof iH&&(0,os.shouldPublishLog)(e.context.logger.level,"debug")&&(t.stack=t.errorStack),t});if(t&&"object"==typeof t){if("context"in t&&"object"==typeof t.context){let{headers:e,...i}=t.context;e instanceof Headers&&(r.headers?e.forEach((e,t)=>{r.headers?.set(t,e)}):r.headers=e),r=a5(i,r);continue}return t}}}return{context:r}}async function a8(e,t){for(let r of t)if(r.matcher(e)){let t=await r.handler(e).catch(t=>{if(t instanceof iH)return(0,os.shouldPublishLog)(e.context.logger.level,"debug")&&(t.stack=t.errorStack),{response:t,headers:t.headers?new Headers(t.headers):null};throw t});t.headers&&t.headers.forEach((t,r)=>{e.context.responseHeaders?"set-cookie"===r.toLowerCase()?e.context.responseHeaders.append(r,t):e.context.responseHeaders.set(r,t):e.context.responseHeaders=new Headers({[r]:t})}),t.response&&(e.context.returned=t.response)}return{response:e.context.returned,headers:e.context.responseHeaders}}function a4(e,t){let r=t.plugins?.reduce((e,t)=>({...e,...t.endpoints}),{})??{},i=t.plugins?.map(t=>t.middlewares?.map(t=>{let r=async r=>{let i=await e;return t.middleware({...r,context:{...i,...r.context}})};return r.options=t.middleware.options,{path:t.path,middleware:r}})).filter(e=>void 0!==e).flat()||[];return{api:function(e,t){let r={};for(let[i,n]of Object.entries(e))r[i]=async e=>{let r=async()=>{let r=await t,i={...e,context:{...r,returned:void 0,responseHeaders:void 0,session:null},path:n.path,headers:e?.headers?new Headers(e?.headers):void 0};return V(i,async()=>{let{beforeHooks:t,afterHooks:o}=function(e){let t=e.options.plugins||[],r=[],i=[],n=e.options.hooks?.before;n&&(a6.set(n,"user"),r.push({matcher:()=>!0,handler:n}));let o=e.options.hooks?.after;o&&(a6.set(o,"user"),i.push({matcher:()=>!0,handler:o}));let a=t.filter(e=>e.hooks?.before).map(e=>e.hooks?.before).flat(),s=t.filter(e=>e.hooks?.after).map(e=>e.hooks?.after).flat();return a.length&&r.push(...a),s.length&&i.push(...s),{beforeHooks:r,afterHooks:i}}(r),a=await a3(i,t);if("context"in a&&a.context&&"object"==typeof a.context){let{headers:e,...t}=a.context;e&&e.forEach((e,t)=>{i.headers.set(t,e)}),i=a5(t,i)}else if(a)return e?.asResponse?iW(a,{headers:e?.headers}):e?.returnHeaders?{headers:e?.headers,response:a}:a;i.asResponse=!1,i.returnHeaders=!0,i.returnStatus=!0;let s=await V(i,()=>n(i)).catch(e=>{if(e instanceof iH)return{response:e,status:e.statusCode,headers:e.headers?new Headers(e.headers):null};throw e});if(s&&s instanceof Response)return s;i.context.returned=s.response,i.context.responseHeaders=s.headers;let c=await a8(i,o);if(c.response&&(s.response=c.response),s.response instanceof iH&&(0,os.shouldPublishLog)(r.logger.level,"debug")&&(s.response.stack=s.response.errorStack),s.response instanceof iH&&!e?.asResponse)throw s.response;return e?.asResponse?iW(s.response,{headers:s.headers,status:s.status}):e?.returnHeaders?e?.returnStatus?{headers:s.headers,response:s.response,status:s.status}:{headers:s.headers,response:s.response}:e?.returnStatus?{response:s.response,status:s.status}:s.response})};return await W()?r():Z(new WeakMap,r)},r[i].path=n.path,r[i].options=n.options;return r}({signInSocial:n6("/sign-in/social",{method:"POST",operationId:"socialSignIn",body:aK,metadata:{$Infer:{body:{},returned:{}},openapi:{description:"Sign in with a social provider",operationId:"socialSignIn",responses:{200:{description:"Success - Returns either session details or redirect URL",content:{"application/json":{schema:{type:"object",description:"Session response when idToken is provided",properties:{token:{type:"string"},user:{type:"object",$ref:"#/components/schemas/User"},url:{type:"string"},redirect:{type:"boolean",enum:[!1]}},required:["redirect","token","user"]}}}}}}}},async e=>{let t=e.context.socialProviders.find(t=>t.id===e.body.provider);if(!t)throw e.context.logger.error("Provider not found. Make sure to add the provider in your auth config",{provider:e.body.provider}),new iH("NOT_FOUND",{message:nX.BASE_ERROR_CODES.PROVIDER_NOT_FOUND});if(e.body.idToken){if(!t.verifyIdToken)throw e.context.logger.error("Provider does not support id token verification",{provider:e.body.provider}),new iH("NOT_FOUND",{message:nX.BASE_ERROR_CODES.ID_TOKEN_NOT_SUPPORTED});let{token:r,nonce:i}=e.body.idToken;if(!await t.verifyIdToken(r,i))throw e.context.logger.error("Invalid id token",{provider:e.body.provider}),new iH("UNAUTHORIZED",{message:nX.BASE_ERROR_CODES.INVALID_TOKEN});let n=await t.getUserInfo({idToken:r,accessToken:e.body.idToken.accessToken,refreshToken:e.body.idToken.refreshToken});if(!n||!n?.user)throw e.context.logger.error("Failed to get user info",{provider:e.body.provider}),new iH("UNAUTHORIZED",{message:nX.BASE_ERROR_CODES.FAILED_TO_GET_USER_INFO});if(!n.user.email)throw e.context.logger.error("User email not found",{provider:e.body.provider}),new iH("UNAUTHORIZED",{message:nX.BASE_ERROR_CODES.USER_EMAIL_NOT_FOUND});let o=await a9(e,{userInfo:{...n.user,email:n.user.email,id:String(n.user.id),name:n.user.name||"",image:n.user.image,emailVerified:n.user.emailVerified||!1},account:{providerId:t.id,accountId:String(n.user.id),accessToken:e.body.idToken.accessToken},callbackURL:e.body.callbackURL,disableSignUp:t.disableImplicitSignUp&&!e.body.requestSignUp||t.disableSignUp});if(o.error)throw new iH("UNAUTHORIZED",{message:o.error});return await nq(e,o.data),e.json({redirect:!1,token:o.data.session.token,url:void 0,user:nd(e.context.options,o.data.user)})}let{codeVerifier:r,state:i}=await n$(e,void 0,e.body.additionalData),n=await t.createAuthorizationURL({state:i,codeVerifier:r,redirectURI:`${e.context.baseURL}/callback/${t.id}`,scopes:e.body.scopes,loginHint:e.body.loginHint});return e.body.disableRedirect||e.setHeader("Location",n.toString()),e.json({url:n.toString(),redirect:!e.body.disableRedirect})}),callbackOAuth:aN,getSession:oU(),signOut:aW,signUpEmail:n6("/sign-up/email",{method:"POST",operationId:"signUpWithEmailAndPassword",use:[oe],body:aF,metadata:{allowedMediaTypes:["application/x-www-form-urlencoded","application/json"],$Infer:{body:{},returned:{}},openapi:{operationId:"signUpWithEmailAndPassword",description:"Sign up a user using email and password",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},email:{type:"string",description:"The email of the user"},password:{type:"string",description:"The password of the user"},image:{type:"string",description:"The profile image URL of the user"},callbackURL:{type:"string",description:"The URL to use for email verification callback"},rememberMe:{type:"boolean",description:"If this is false, the session will not be remembered. Default is `true`."}},required:["name","email","password"]}}}},responses:{200:{description:"Successfully created user",content:{"application/json":{schema:{type:"object",properties:{token:{type:"string",nullable:!0,description:"Authentication token for the session"},user:{type:"object",properties:{id:{type:"string",description:"The unique identifier of the user"},email:{type:"string",format:"email",description:"The email address of the user"},name:{type:"string",description:"The name of the user"},image:{type:"string",format:"uri",nullable:!0,description:"The profile image URL of the user"},emailVerified:{type:"boolean",description:"Whether the email has been verified"},createdAt:{type:"string",format:"date-time",description:"When the user was created"},updatedAt:{type:"string",format:"date-time",description:"When the user was last updated"}},required:["id","email","name","emailVerified","createdAt","updatedAt"]}},required:["user"]}}}},422:{description:"Unprocessable Entity. User already exists or failed to create user.",content:{"application/json":{schema:{type:"object",properties:{message:{type:"string"}}}}}}}}}},async e=>X(e.context.adapter,async()=>{let t;if(!e.context.options.emailAndPassword?.enabled||e.context.options.emailAndPassword?.disableSignUp)throw new iH("BAD_REQUEST",{message:"Email and password sign up is not enabled"});let r=e.body,{name:i,email:n,password:o,image:a,callbackURL:s,rememberMe:c,...d}=r;if(!iS.email().safeParse(n).success)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.INVALID_EMAIL});if(!o||"string"!=typeof o)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.INVALID_PASSWORD});let l=e.context.password.config.minPasswordLength;if(o.length<l)throw e.context.logger.error("Password is too short"),new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.PASSWORD_TOO_SHORT});let u=e.context.password.config.maxPasswordLength;if(o.length>u)throw e.context.logger.error("Password is too long"),new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.PASSWORD_TOO_LONG});if((await e.context.internalAdapter.findUserByEmail(n))?.user)throw e.context.logger.info(`Sign-up attempt for existing email: ${n}`),new iH("UNPROCESSABLE_ENTITY",{message:nX.BASE_ERROR_CODES.USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL});let p=await e.context.password.hash(o);try{let r=nh(e.context.options,d,"create");if(!(t=await e.context.internalAdapter.createUser({email:n.toLowerCase(),name:i,image:a,...r,emailVerified:!1})))throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.FAILED_TO_CREATE_USER})}catch(t){if((0,nD.isDevelopment)()&&e.context.logger.error("Failed to create user",t),t instanceof iH)throw t;throw e.context.logger?.error("Failed to create user",t),new iH("UNPROCESSABLE_ENTITY",{message:nX.BASE_ERROR_CODES.FAILED_TO_CREATE_USER})}if(!t)throw new iH("UNPROCESSABLE_ENTITY",{message:nX.BASE_ERROR_CODES.FAILED_TO_CREATE_USER});if(await e.context.internalAdapter.linkAccount({userId:t.id,providerId:"credential",accountId:t.id,password:p}),e.context.options.emailVerification?.sendOnSignUp||e.context.options.emailAndPassword.requireEmailVerification){let i=await oq(e.context.secret,t.email,void 0,e.context.options.emailVerification?.expiresIn),n=r.callbackURL?encodeURIComponent(r.callbackURL):encodeURIComponent("/"),o=`${e.context.baseURL}/verify-email?token=${i}&callbackURL=${n}`;e.context.options.emailVerification?.sendVerificationEmail&&await e.context.runInBackgroundOrAwait(e.context.options.emailVerification.sendVerificationEmail({user:t,url:o,token:i},e.request))}if(!1===e.context.options.emailAndPassword.autoSignIn||e.context.options.emailAndPassword.requireEmailVerification)return e.json({token:null,user:nd(e.context.options,t)});let h=await e.context.internalAdapter.createSession(t.id,!1===c);if(!h)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION});return await nq(e,{session:h,user:t},!1===c),e.json({token:h.token,user:nd(e.context.options,t)})})),signInEmail:n6("/sign-in/email",{method:"POST",operationId:"signInEmail",use:[oe],body:iS.object({email:iS.string().meta({description:"Email of the user"}),password:iS.string().meta({description:"Password of the user"}),callbackURL:iS.string().meta({description:"Callback URL to use as a redirect for email verification"}).optional(),rememberMe:iS.boolean().meta({description:"If this is false, the session will not be remembered. Default is `true`."}).default(!0).optional()}),metadata:{allowedMediaTypes:["application/x-www-form-urlencoded","application/json"],$Infer:{body:{},returned:{}},openapi:{operationId:"signInEmail",description:"Sign in with email and password",responses:{200:{description:"Success - Returns either session details or redirect URL",content:{"application/json":{schema:{type:"object",description:"Session response when idToken is provided",properties:{redirect:{type:"boolean",enum:[!1]},token:{type:"string",description:"Session token"},url:{type:"string",nullable:!0},user:{type:"object",$ref:"#/components/schemas/User"}},required:["redirect","token","user"]}}}}}}}},async e=>{if(!e.context.options?.emailAndPassword?.enabled)throw e.context.logger.error("Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!"),new iH("BAD_REQUEST",{message:"Email and password is not enabled"});let{email:t,password:r}=e.body;if(!iS.email().safeParse(t).success)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.INVALID_EMAIL});let i=await e.context.internalAdapter.findUserByEmail(t,{includeAccounts:!0});if(!i)throw await e.context.password.hash(r),e.context.logger.error("User not found",{email:t}),new iH("UNAUTHORIZED",{message:nX.BASE_ERROR_CODES.INVALID_EMAIL_OR_PASSWORD});let n=i.accounts.find(e=>"credential"===e.providerId);if(!n)throw await e.context.password.hash(r),e.context.logger.error("Credential account not found",{email:t}),new iH("UNAUTHORIZED",{message:nX.BASE_ERROR_CODES.INVALID_EMAIL_OR_PASSWORD});let o=n?.password;if(!o)throw await e.context.password.hash(r),e.context.logger.error("Password not found",{email:t}),new iH("UNAUTHORIZED",{message:nX.BASE_ERROR_CODES.INVALID_EMAIL_OR_PASSWORD});if(!await e.context.password.verify({hash:o,password:r}))throw e.context.logger.error("Invalid password"),new iH("UNAUTHORIZED",{message:nX.BASE_ERROR_CODES.INVALID_EMAIL_OR_PASSWORD});if(e.context.options?.emailAndPassword?.requireEmailVerification&&!i.user.emailVerified){if(!e.context.options?.emailVerification?.sendVerificationEmail)throw new iH("FORBIDDEN",{message:nX.BASE_ERROR_CODES.EMAIL_NOT_VERIFIED});if(e.context.options?.emailVerification?.sendOnSignIn){let t=await oq(e.context.secret,i.user.email,void 0,e.context.options.emailVerification?.expiresIn),r=e.body.callbackURL?encodeURIComponent(e.body.callbackURL):encodeURIComponent("/"),n=`${e.context.baseURL}/verify-email?token=${t}&callbackURL=${r}`;await e.context.runInBackgroundOrAwait(e.context.options.emailVerification.sendVerificationEmail({user:i.user,url:n,token:t},e.request))}throw new iH("FORBIDDEN",{message:nX.BASE_ERROR_CODES.EMAIL_NOT_VERIFIED})}let a=await e.context.internalAdapter.createSession(i.user.id,!1===e.body.rememberMe);if(!a)throw e.context.logger.error("Failed to create session"),new iH("UNAUTHORIZED",{message:nX.BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION});return await nq(e,{session:a,user:i.user},!1===e.body.rememberMe),e.body.callbackURL&&e.setHeader("Location",e.body.callbackURL),e.json({redirect:!!e.body.callbackURL,token:a.token,url:e.body.callbackURL,user:nd(e.context.options,i.user)})}),resetPassword:az,verifyPassword:aV,verifyEmail:o$,sendVerificationEmail:oH,changeEmail:aX,changePassword:aJ,setPassword:aG,updateUser:n6("/update-user",{method:"POST",operationId:"updateUser",body:aZ,use:[oD],metadata:{$Infer:{body:{}},openapi:{operationId:"updateUser",description:"Update the current user",requestBody:{content:{"application/json":{schema:{type:"object",properties:{name:{type:"string",description:"The name of the user"},image:{type:"string",description:"The image of the user",nullable:!0}}}}}},responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{user:{type:"object",$ref:"#/components/schemas/User"}}}}}}}}}},async e=>{let t=e.body;if("object"!=typeof t||Array.isArray(t))throw new iH("BAD_REQUEST",{message:"Body must be an object"});if(t.email)throw new iH("BAD_REQUEST",{message:nX.BASE_ERROR_CODES.EMAIL_CAN_NOT_BE_UPDATED});let{name:r,image:i,...n}=t,o=e.context.session,a=nh(e.context.options,n,"update");if(void 0===i&&void 0===r&&0===Object.keys(a).length)throw new iH("BAD_REQUEST",{message:"No fields to update"});let s=await e.context.internalAdapter.updateUser(o.user.id,{name:r,image:i,...a})??{...o.user,...void 0!==r&&{name:r},...void 0!==i&&{image:i},...a};return await nq(e,{session:o.session,user:s}),e.json({status:!0})}),deleteUser:aY,requestPasswordReset:a$,requestPasswordResetCallback:aM,listSessions:n6("/list-sessions",{method:"GET",operationId:"listUserSessions",use:[oD],requireHeaders:!0,metadata:{openapi:{operationId:"listUserSessions",description:"List all active sessions for the user",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"array",items:{$ref:"#/components/schemas/Session"}}}}}}}}},async e=>{try{let t=(await e.context.internalAdapter.listSessions(e.context.session.user.id)).filter(e=>e.expiresAt>new Date);return e.json(t.map(t=>nl(e.context.options,t)))}catch(t){throw e.context.logger.error(t),e.error("INTERNAL_SERVER_ERROR")}}),revokeSession:oP,revokeSessions:oL,revokeOtherSessions:oj,linkSocialAccount:aI,listUserAccounts:aR,deleteUserCallback:aQ,unlinkAccount:aS,refreshToken:aU,getAccessToken:ax,accountInfo:aO,...r,ok:aj,error:aL},e),middlewares:i}}async function a9(e,t){let{userInfo:r,account:i,callbackURL:n,disableSignUp:o,overrideUserInfo:a}=t,s=await e.context.internalAdapter.findOAuthUser(r.email.toLowerCase(),i.accountId,i.providerId).catch(t=>{os.logger.error("Better auth was unable to query your database.\nError: ",t);let r=e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`;throw e.redirect(`${r}?error=internal_server_error`)}),c=s?.user,d=!c;if(s){let n=s.accounts.find(e=>e.providerId===i.providerId&&e.accountId===i.accountId);if(n){if(e.context.options.account?.updateAccountOnSignIn!==!1){let t=Object.fromEntries(Object.entries({idToken:i.idToken,accessToken:await nV(i.accessToken,e.context),refreshToken:await nV(i.refreshToken,e.context),accessTokenExpiresAt:i.accessTokenExpiresAt,refreshTokenExpiresAt:i.refreshTokenExpiresAt,scope:i.scope}).filter(([e,t])=>void 0!==t));e.context.options.account?.storeAccountCookie&&await nk(e,{...i,...t}),Object.keys(t).length>0&&await e.context.internalAdapter.updateAccount(n.id,t)}r.emailVerified&&!s.user.emailVerified&&r.email.toLowerCase()===s.user.email&&await e.context.internalAdapter.updateUser(s.user.id,{emailVerified:!0})}else{let n=e.context.options.account?.accountLinking?.trustedProviders;if(!(t.isTrustedProvider||n?.includes(i.providerId))&&!r.emailVerified||e.context.options.account?.accountLinking?.enabled===!1)return(0,nD.isDevelopment)()&&os.logger.warn(`User already exist but account isn't linked to ${i.providerId}. To read more about how account linking works in Better Auth see https://www.better-auth.com/docs/concepts/users-accounts#account-linking.`),{error:"account not linked",data:null};try{await e.context.internalAdapter.linkAccount({providerId:i.providerId,accountId:r.id.toString(),userId:s.user.id,accessToken:await nV(i.accessToken,e.context),refreshToken:await nV(i.refreshToken,e.context),idToken:i.idToken,accessTokenExpiresAt:i.accessTokenExpiresAt,refreshTokenExpiresAt:i.refreshTokenExpiresAt,scope:i.scope})}catch(e){return os.logger.error("Unable to link account",e),{error:"unable to link account",data:null}}r.emailVerified&&!s.user.emailVerified&&r.email.toLowerCase()===s.user.email&&await e.context.internalAdapter.updateUser(s.user.id,{emailVerified:!0})}if(a){let{id:t,...i}=r;c=await e.context.internalAdapter.updateUser(s.user.id,{...i,email:r.email.toLowerCase(),emailVerified:r.email.toLowerCase()===s.user.email&&s.user.emailVerified||r.emailVerified})}}else{if(o)return{error:"signup disabled",data:null,isRegister:!1};try{let{id:t,...o}=r,a={accessToken:await nV(i.accessToken,e.context),refreshToken:await nV(i.refreshToken,e.context),idToken:i.idToken,accessTokenExpiresAt:i.accessTokenExpiresAt,refreshTokenExpiresAt:i.refreshTokenExpiresAt,scope:i.scope,providerId:i.providerId,accountId:r.id.toString()},{user:s,account:d}=await e.context.internalAdapter.createOAuthUser({...o,email:r.email.toLowerCase()},a);if(c=s,e.context.options.account?.storeAccountCookie&&await nk(e,d),!r.emailVerified&&c&&e.context.options.emailVerification?.sendOnSignUp&&e.context.options.emailVerification?.sendVerificationEmail){let t=await oq(e.context.secret,c.email,void 0,e.context.options.emailVerification?.expiresIn),r=`${e.context.baseURL}/verify-email?token=${t}&callbackURL=${n}`;await e.context.runInBackgroundOrAwait(e.context.options.emailVerification.sendVerificationEmail({user:c,url:r,token:t},e.request))}}catch(e){if(os.logger.error(e),e instanceof iH)return{error:e.message,data:null,isRegister:!1};return{error:"unable to create user",data:null,isRegister:!1}}}if(!c)return{error:"unable to create user",data:null,isRegister:!1};let l=await e.context.internalAdapter.createSession(c.id);return l?{data:{session:l,user:c},error:null,isRegister:d}:{error:"unable to create session",data:null,isRegister:!1}}e.i(90698);let a7=e=>{let t=e.getPlugin("jwt");if(!t)throw new rO.BetterAuthError("jwt_config","jwt plugin not found");return t},se=new class{cache=new Map;set(e,t){this.cache.set(e,t)}get(e){let t=this.cache.get(e);if(t)return t.expiresAt&&t.expiresAt<new Date?void this.cache.delete(e):t}};async function st(e,t,r){let i=se.get(r);if(i)return Object.assign({},i);let n=await e.context.adapter.findOne({model:t.schema?.oauthClient?.modelName??"oauthClient",where:[{field:"clientId",value:r}]});return n&&t.cachedTrustedClients?.has(r)&&se.set(r,Object.assign({},n)),n}let sr=async e=>{let t=await rW("SHA-256").digest(new TextEncoder().encode(e));return rK.encode(new Uint8Array(t),{padding:!1})};async function si(e,t,r){if("encrypted"===t)return await iT({key:e.context.secret,data:r});if("object"==typeof t&&"decrypt"in t)return await t.decrypt(r);throw new rO.BetterAuthError(`Unsupported decryption storageMethod type '${t}'`)}async function sn(e,t,r,i){let n=t.storeClientSecret??(t.disableJwtPlugin?"encrypted":"hashed");if(i&&t.prefix?.clientSecret)if(i.startsWith(t.prefix?.clientSecret))i=i.replace(t.prefix.clientSecret,"");else throw new iH("UNAUTHORIZED",{error_description:"invalid client_secret",error:"invalid_client"});if("hashed"===n){let e=i?await sr(i):void 0;return!!e&&en(e,r)}if("object"==typeof n&&"hash"in n)if(n.verify)return!!i&&await n.verify(i,r);else{let e=i?await n.hash(i):void 0;return!!e&&en(e,r)}if("encrypted"===n||"object"==typeof n&&"decrypt"in n){let t=await si(e,n,r);return!!i&&en(t,i)}throw new rO.BetterAuthError(`Unsupported verify storageMethod type '${n}'`)}async function so(e,t,r){let i=t.storeClientSecret??(t.disableJwtPlugin?"encrypted":"hashed");if("encrypted"===i)return await iA({key:e.context.secret,data:r});if("hashed"===i)return await sr(r);if("object"==typeof i&&"hash"in i)return await i.hash(r);if("object"==typeof i&&"encrypt"in i)return await i.encrypt(r);throw new rO.BetterAuthError(`Unsupported storeClientSecret type '${i}'`)}async function sa(e="hashed",t,r){if("hashed"===e)return await sr(t);if("object"==typeof e&&"hash"in e)return await e.hash(t,r);throw new rO.BetterAuthError(`storeToken: unsupported storageMethod type '${e}'`)}async function ss(e="hashed",t,r){if("hashed"===e)return await sr(t);if("object"==typeof e&&"hash"in e)return await e.hash(t,r);throw new rO.BetterAuthError(`getStoredToken: unsupported storageMethod type '${e}'`)}function sc(e){if(e.startsWith("Basic ")){let t=e.replace("Basic ",""),r=new TextDecoder().decode(rV.decode(t));if(!r.includes(":"))throw new iH("BAD_REQUEST",{error_description:"invalid authorization header format",error:"invalid_client"});let[i,n]=r.split(":",2);if(!i||!n)throw new iH("BAD_REQUEST",{error_description:"invalid authorization header format",error:"invalid_client"});return{client_id:i,client_secret:n}}}async function sd(e,t,r,i,n){let o=await st(e,t,r);if(!o)throw new iH("BAD_REQUEST",{error_description:"missing client",error:"invalid_client"});if(o.disabled)throw new iH("BAD_REQUEST",{error_description:"client is disabled",error:"invalid_client"});if(!o.public&&!i)throw new iH("BAD_REQUEST",{error_description:"client secret must be provided",error:"invalid_client"});if(i&&!o.clientSecret)throw new iH("BAD_REQUEST",{error_description:"public client, client secret should not be received",error:"invalid_client"});if(i&&!await sn(e,t,o.clientSecret,i))throw new iH("UNAUTHORIZED",{error_description:"invalid client_secret",error:"invalid_client"});if(n&&o.scopes){let e=new Set(o.scopes);for(let t of n)if(!e.has(t))throw new iH("BAD_REQUEST",{error_description:`client does not allow scope ${t}`,error:"invalid_scope"})}return o}function sl(e,t){let r=e.get("prompt")?.split(" "),i=r?.findIndex(e=>e===t)??-1;return i>=0&&(r?.splice(i,1),r?.length?e.set("prompt",r.join(" ")):e.delete("prompt")),Object.fromEntries(e)}function su(e){return{newRole:e=>{var t;return{authorize(e,r="AND"){let i=!1;for(let[n,o]of Object.entries(e)){let e=t[n];if(!e)return{success:!1,error:`You are not allowed to access resource: ${n}`};if(Array.isArray(o))i=o.every(t=>e.includes(t));else if("object"==typeof o)i="OR"===o.connector?o.actions.some(t=>e.includes(t)):o.actions.every(t=>e.includes(t));else throw new rO.BetterAuthError("Invalid access control request");if(i&&"OR"===r)return{success:i};if(!i&&"AND"===r)return{success:!1,error:`unauthorized to access resource "${n}"`}}return i?{success:i}:{success:!1,error:"Not authorized"}},statements:t=e}},statements:e}}let sp=su({user:["create","list","set-role","ban","impersonate","delete","set-password","get","update"],session:["list","revoke","delete"]});sp.newRole({user:["create","list","set-role","ban","impersonate","delete","set-password","get","update"],session:["list","revoke","delete"]}),sp.newRole({user:[],session:[]});var sh=e.i(20399);(0,sh.defineErrorCodes)({FAILED_TO_CREATE_USER:"Failed to create user",USER_ALREADY_EXISTS:"User already exists.",USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL:"User already exists. Use another email.",YOU_CANNOT_BAN_YOURSELF:"You cannot ban yourself",YOU_ARE_NOT_ALLOWED_TO_CHANGE_USERS_ROLE:"You are not allowed to change users role",YOU_ARE_NOT_ALLOWED_TO_CREATE_USERS:"You are not allowed to create users",YOU_ARE_NOT_ALLOWED_TO_LIST_USERS:"You are not allowed to list users",YOU_ARE_NOT_ALLOWED_TO_LIST_USERS_SESSIONS:"You are not allowed to list users sessions",YOU_ARE_NOT_ALLOWED_TO_BAN_USERS:"You are not allowed to ban users",YOU_ARE_NOT_ALLOWED_TO_IMPERSONATE_USERS:"You are not allowed to impersonate users",YOU_ARE_NOT_ALLOWED_TO_REVOKE_USERS_SESSIONS:"You are not allowed to revoke users sessions",YOU_ARE_NOT_ALLOWED_TO_DELETE_USERS:"You are not allowed to delete users",YOU_ARE_NOT_ALLOWED_TO_SET_USERS_PASSWORD:"You are not allowed to set users password",BANNED_USER:"You have been banned from this application",YOU_ARE_NOT_ALLOWED_TO_GET_USER:"You are not allowed to get user",NO_DATA_TO_UPDATE:"No data to update",YOU_ARE_NOT_ALLOWED_TO_UPDATE_USERS:"You are not allowed to update users",YOU_CANNOT_REMOVE_YOURSELF:"You cannot remove yourself",YOU_ARE_NOT_ALLOWED_TO_SET_NON_EXISTENT_VALUE:"You are not allowed to set a non-existent role value",YOU_CANNOT_IMPERSONATE_ADMINS:"You cannot impersonate admins",INVALID_ROLE_TYPE:"Invalid role type"}),n2(async e=>{let t=await oO(e);if(!t)throw new iH("UNAUTHORIZED");return{session:t}}),iS.object({userId:iU.coerce.string().meta({description:"The user id"}),role:iS.union([iS.string().meta({description:"The role to set. `admin` or `user` by default"}),iS.array(iS.string().meta({description:"The roles to set. `admin` or `user` by default"}))]).meta({description:"The role to set, this can be a string or an array of strings. Eg: `admin` or `[admin, user]`"})}),iS.object({id:iS.string().meta({description:"The id of the User"})}),iS.object({email:iS.string().meta({description:"The email of the user"}),password:iS.string().meta({description:"The password of the user"}),name:iS.string().meta({description:"The name of the user"}),role:iS.union([iS.string().meta({description:"The role of the user"}),iS.array(iS.string().meta({description:"The roles of user"}))]).optional().meta({description:'A string or array of strings representing the roles to apply to the new user. Eg: "user"'}),data:iS.record(iS.string(),iS.any()).optional().meta({description:"Extra fields for the user. Including custom additional fields."})}),iS.object({userId:iU.coerce.string().meta({description:"The user id"}),data:iS.record(iS.any(),iS.any()).meta({description:"The user data to update"})}),iS.object({searchValue:iS.string().optional().meta({description:'The value to search for. Eg: "some name"'}),searchField:iS.enum(["email","name"]).meta({description:'The field to search in, defaults to email. Can be `email` or `name`. Eg: "name"'}).optional(),searchOperator:iS.enum(["contains","starts_with","ends_with"]).meta({description:'The operator to use for the search. Can be `contains`, `starts_with` or `ends_with`. Eg: "contains"'}).optional(),limit:iS.string().meta({description:"The number of users to return"}).or(iS.number()).optional(),offset:iS.string().meta({description:"The offset to start from"}).or(iS.number()).optional(),sortBy:iS.string().meta({description:"The field to sort by"}).optional(),sortDirection:iS.enum(["asc","desc"]).meta({description:"The direction to sort by"}).optional(),filterField:iS.string().meta({description:"The field to filter by"}).optional(),filterValue:iS.string().meta({description:"The value to filter by"}).or(iS.number()).or(iS.boolean()).optional(),filterOperator:iS.enum(["eq","ne","lt","lte","gt","gte","contains"]).meta({description:"The operator to use for the filter"}).optional()}),iS.object({userId:iU.coerce.string().meta({description:"The user id"})}),iS.object({userId:iU.coerce.string().meta({description:"The user id"})}),iS.object({userId:iU.coerce.string().meta({description:"The user id"}),banReason:iS.string().meta({description:"The reason for the ban"}).optional(),banExpiresIn:iS.number().meta({description:"The number of seconds until the ban expires"}).optional()}),iS.object({userId:iU.coerce.string().meta({description:"The user id"})}),iS.object({sessionToken:iS.string().meta({description:"The session token"})}),iS.object({userId:iU.coerce.string().meta({description:"The user id"})}),iS.object({userId:iU.coerce.string().meta({description:"The user id"})}),iS.object({newPassword:iS.string().nonempty("newPassword cannot be empty").meta({description:"The new password"}),userId:iU.coerce.string().nonempty("userId cannot be empty").meta({description:"The user id"})}),iS.object({userId:iU.coerce.string().optional().meta({description:'The user id. Eg: "user-id"'}),role:iS.string().optional().meta({description:'The role to check permission for. Eg: "admin"'})}).and(iS.union([iS.object({permission:iS.record(iS.string(),iS.array(iS.string())),permissions:iS.undefined()}),iS.object({permission:iS.undefined(),permissions:iS.record(iS.string(),iS.array(iS.string()))})])),(0,sh.defineErrorCodes)({INVALID_EMAIL_FORMAT:"Email was not generated in a valid format",FAILED_TO_CREATE_USER:"Failed to create user",COULD_NOT_CREATE_SESSION:"Could not create session",ANONYMOUS_USERS_CANNOT_SIGN_IN_AGAIN_ANONYMOUSLY:"Anonymous users cannot sign in again anonymously",FAILED_TO_DELETE_ANONYMOUS_USER:"Failed to delete anonymous user",USER_IS_NOT_ANONYMOUS:"User is not anonymous",DELETE_ANONYMOUS_USER_DISABLED:"Deleting anonymous users is disabled"}),iS.object({key:iS.string().meta({description:"The key to verify"}),permissions:iS.record(iS.string(),iS.array(iS.string())).meta({description:"The permissions to verify."}).optional()}),iS.object({name:iS.string().meta({description:"Name of the Api Key"}).optional(),expiresIn:iS.number().meta({description:"Expiration time of the Api Key in seconds"}).min(1).optional().nullable().default(null),userId:iU.coerce.string().meta({description:'User Id of the user that the Api Key belongs to. server-only. Eg: "user-id"'}).optional(),prefix:iS.string().meta({description:"Prefix of the Api Key"}).regex(/^[a-zA-Z0-9_-]+$/,{message:"Invalid prefix format, must be alphanumeric and contain only underscores and hyphens."}).optional(),remaining:iS.number().meta({description:"Remaining number of requests. Server side only"}).min(0).optional().nullable().default(null),metadata:iS.any().optional(),refillAmount:iS.number().meta({description:"Amount to refill the remaining count of the Api Key. server-only. Eg: 100"}).min(1).optional(),refillInterval:iS.number().meta({description:"Interval to refill the Api Key in milliseconds. server-only. Eg: 1000"}).optional(),rateLimitTimeWindow:iS.number().meta({description:"The duration in milliseconds where each request is counted. Once the `maxRequests` is reached, the request will be rejected until the `timeWindow` has passed, at which point the `timeWindow` will be reset. server-only. Eg: 1000"}).optional(),rateLimitMax:iS.number().meta({description:"Maximum amount of requests allowed within a window. Once the `maxRequests` is reached, the request will be rejected until the `timeWindow` has passed, at which point the `timeWindow` will be reset. server-only. Eg: 100"}).optional(),rateLimitEnabled:iS.boolean().meta({description:"Whether the key has rate limiting enabled. server-only. Eg: true"}).optional(),permissions:iS.record(iS.string(),iS.array(iS.string())).meta({description:"Permissions of the Api Key."}).optional()}),iS.object({keyId:iS.string().meta({description:"The id of the Api Key"})}),iS.object({id:iS.string().meta({description:"The id of the Api Key"})}),iS.object({keyId:iS.string().meta({description:"The id of the Api Key"}),userId:iU.coerce.string().meta({description:'The id of the user which the api key belongs to. server-only. Eg: "some-user-id"'}).optional(),name:iS.string().meta({description:"The name of the key"}).optional(),enabled:iS.boolean().meta({description:"Whether the Api Key is enabled or not"}).optional(),remaining:iS.number().meta({description:"The number of remaining requests"}).min(1).optional(),refillAmount:iS.number().meta({description:"The refill amount"}).optional(),refillInterval:iS.number().meta({description:"The refill interval"}).optional(),metadata:iS.any().optional(),expiresIn:iS.number().meta({description:"Expiration time of the Api Key in seconds"}).min(1).optional().nullable(),rateLimitEnabled:iS.boolean().meta({description:"Whether the key has rate limiting enabled."}).optional(),rateLimitTimeWindow:iS.number().meta({description:"The duration in milliseconds where each request is counted. server-only. Eg: 1000"}).optional(),rateLimitMax:iS.number().meta({description:"Maximum amount of requests allowed within a window. Once the `maxRequests` is reached, the request will be rejected until the `timeWindow` has passed, at which point the `timeWindow` will be reset. server-only. Eg: 100"}).optional(),permissions:iS.record(iS.string(),iS.array(iS.string())).meta({description:"Update the permissions on the API Key. server-only."}).optional().nullable()});(0,sh.defineErrorCodes)({INVALID_METADATA_TYPE:"metadata must be an object or undefined",REFILL_AMOUNT_AND_INTERVAL_REQUIRED:"refillAmount is required when refillInterval is provided",REFILL_INTERVAL_AND_AMOUNT_REQUIRED:"refillInterval is required when refillAmount is provided",USER_BANNED:"User is banned",UNAUTHORIZED_SESSION:"Unauthorized or invalid session",KEY_NOT_FOUND:"API Key not found",KEY_DISABLED:"API Key is disabled",KEY_EXPIRED:"API Key has expired",USAGE_EXCEEDED:"API Key has reached its usage limit",KEY_NOT_RECOVERABLE:"API Key is not recoverable",EXPIRES_IN_IS_TOO_SMALL:"The expiresIn is smaller than the predefined minimum value.",EXPIRES_IN_IS_TOO_LARGE:"The expiresIn is larger than the predefined maximum value.",INVALID_REMAINING:"The remaining count is either too large or too small.",INVALID_PREFIX_LENGTH:"The prefix length is either too large or too small.",INVALID_NAME_LENGTH:"The name length is either too large or too small.",METADATA_DISABLED:"Metadata is disabled.",RATE_LIMIT_EXCEEDED:"Rate limit exceeded.",NO_VALUES_TO_UPDATE:"No values to update.",KEY_DISABLED_EXPIRATION:"Custom key expiration values are disabled.",INVALID_API_KEY:"Invalid API key.",INVALID_USER_ID_FROM_API_KEY:"The user id from the API key is invalid.",INVALID_API_KEY_GETTER_RETURN_TYPE:"API Key getter returned an invalid key type. Expected string.",SERVER_ONLY_PROPERTY:"The property you're trying to set can only be set from the server auth instance only.",FAILED_TO_UPDATE_API_KEY:"Failed to update API key",NAME_REQUIRED:"API Key name is required."});(0,sh.defineErrorCodes)({VERIFICATION_FAILED:"Captcha verification failed",MISSING_RESPONSE:"Missing CAPTCHA response",UNKNOWN_ERROR:"Something went wrong"}),(0,sh.defineErrorCodes)({MISSING_SECRET_KEY:"Missing secret key",SERVICE_UNAVAILABLE:"CAPTCHA service unavailable"}),iS.optional(iS.object({disableCookieCache:iS.boolean().meta({description:"Disable cookie cache and fetch session from database"}).or(iS.string().transform(e=>"true"===e)).optional(),disableRefresh:iS.boolean().meta({description:"Disable session refresh. Useful for checking session status, without updating the session"}).optional()}));let sf=(0,sh.defineErrorCodes)({INVALID_DEVICE_CODE:"Invalid device code",EXPIRED_DEVICE_CODE:"Device code has expired",EXPIRED_USER_CODE:"User code has expired",AUTHORIZATION_PENDING:"Authorization pending",ACCESS_DENIED:"Access denied",INVALID_USER_CODE:"Invalid user code",DEVICE_CODE_ALREADY_PROCESSED:"Device code already processed",POLLING_TOO_FREQUENTLY:"Polling too frequently",USER_NOT_FOUND:"User not found",FAILED_TO_CREATE_SESSION:"Failed to create session",INVALID_DEVICE_CODE_STATUS:"Invalid device code status",AUTHENTICATION_REQUIRED:"Authentication required"});iS.object({client_id:iS.string().meta({description:"The client ID of the application"}),scope:iS.string().meta({description:"Space-separated list of scopes"}).optional()}),iS.object({error:iS.enum(["invalid_request","invalid_client"]).meta({description:"Error code"}),error_description:iS.string().meta({description:"Detailed error description"})}),iS.object({grant_type:iS.literal("urn:ietf:params:oauth:grant-type:device_code").meta({description:"The grant type for device flow"}),device_code:iS.string().meta({description:"The device verification code"}),client_id:iS.string().meta({description:"The client ID of the application"})}),iS.object({error:iS.enum(["authorization_pending","slow_down","expired_token","access_denied","invalid_request","invalid_grant"]).meta({description:"Error code"}),error_description:iS.string().meta({description:"Detailed error description"})}),n6("/device",{method:"GET",query:iS.object({user_code:iS.string().meta({description:"The user code to verify"})}),error:iS.object({error:iS.enum(["invalid_request"]).meta({description:"Error code"}),error_description:iS.string().meta({description:"Detailed error description"})}),metadata:{openapi:{description:"Verify user code and get device authorization status",responses:{200:{description:"Device authorization status",content:{"application/json":{schema:{type:"object",properties:{user_code:{type:"string",description:"The user code to verify"},status:{type:"string",enum:["pending","approved","denied"],description:"Current status of the device authorization"}}}}}}}}}},async e=>{let{user_code:t}=e.query,r=t.replace(/-/g,""),i=await e.context.adapter.findOne({model:"deviceCode",where:[{field:"userCode",value:r}]});if(!i)throw new iH("BAD_REQUEST",{error:"invalid_request",error_description:sf.INVALID_USER_CODE});if(i.expiresAt<new Date)throw new iH("BAD_REQUEST",{error:"expired_token",error_description:sf.EXPIRED_USER_CODE});return e.json({user_code:t,status:i.status})}),n6("/device/approve",{method:"POST",body:iS.object({userCode:iS.string().meta({description:"The user code to approve"})}),error:iS.object({error:iS.enum(["invalid_request","expired_token","device_code_already_processed"]).meta({description:"Error code"}),error_description:iS.string().meta({description:"Detailed error description"})}),requireHeaders:!0,metadata:{openapi:{description:"Approve device authorization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async e=>{let t=await oO(e);if(!t)throw new iH("UNAUTHORIZED",{error:"unauthorized",error_description:sf.AUTHENTICATION_REQUIRED});let{userCode:r}=e.body,i=r.replace(/-/g,""),n=await e.context.adapter.findOne({model:"deviceCode",where:[{field:"userCode",value:i}]});if(!n)throw new iH("BAD_REQUEST",{error:"invalid_request",error_description:sf.INVALID_USER_CODE});if(n.expiresAt<new Date)throw new iH("BAD_REQUEST",{error:"expired_token",error_description:sf.EXPIRED_USER_CODE});if("pending"!==n.status)throw new iH("BAD_REQUEST",{error:"invalid_request",error_description:sf.DEVICE_CODE_ALREADY_PROCESSED});return await e.context.adapter.update({model:"deviceCode",where:[{field:"id",value:n.id}],update:{status:"approved",userId:t.user.id}}),e.json({success:!0})}),n6("/device/deny",{method:"POST",body:iS.object({userCode:iS.string().meta({description:"The user code to deny"})}),error:iS.object({error:iS.enum(["invalid_request","expired_token"]).meta({description:"Error code"}),error_description:iS.string().meta({description:"Detailed error description"})}),metadata:{openapi:{description:"Deny device authorization",responses:{200:{description:"Success",content:{"application/json":{schema:{type:"object",properties:{success:{type:"boolean"}}}}}}}}}},async e=>{let{userCode:t}=e.body,r=t.replace(/-/g,""),i=await e.context.adapter.findOne({model:"deviceCode",where:[{field:"userCode",value:r}]});if(!i)throw new iH("BAD_REQUEST",{error:"invalid_request",error_description:sf.INVALID_USER_CODE});if(i.expiresAt<new Date)throw new iH("BAD_REQUEST",{error:"expired_token",error_description:sf.EXPIRED_USER_CODE});if("pending"!==i.status)throw new iH("BAD_REQUEST",{error:"invalid_request",error_description:sf.DEVICE_CODE_ALREADY_PROCESSED});return await e.context.adapter.update({model:"deviceCode",where:[{field:"id",value:i.id}],update:{status:"denied"}}),e.json({success:!0})}),iS.object({id:iS.string(),deviceCode:iS.string(),userCode:iS.string(),userId:iS.string().optional(),expiresAt:iS.date(),status:iS.string(),lastPolledAt:iS.date().optional(),pollingInterval:iS.number().optional(),clientId:iS.string().optional(),scope:iS.string().optional()});let sm=iS.custom(e=>{if("string"!=typeof e)return!1;try{return nx(e),!0}catch{return!1}},{message:"Invalid time string format. Use formats like '30m', '5s', '1h', etc."});iS.object({expiresIn:sm.default("30m").describe("Time in seconds until the device code expires. Use formats like '30m', '5s', '1h', etc."),interval:sm.default("5s").describe("Time in seconds between polling attempts. Use formats like '30m', '5s', '1h', etc."),deviceCodeLength:iS.number().int().positive().default(40).describe("Length of the device code to be generated. Default is 40 characters."),userCodeLength:iS.number().int().positive().default(8).describe("Length of the user code to be generated. Default is 8 characters."),generateDeviceCode:iS.custom(e=>"function"==typeof e,{message:"generateDeviceCode must be a function that returns a string or a promise that resolves to a string."}).optional().describe("Function to generate a device code. If not provided, a default random string generator will be used."),generateUserCode:iS.custom(e=>"function"==typeof e,{message:"generateUserCode must be a function that returns a string or a promise that resolves to a string."}).optional().describe("Function to generate a user code. If not provided, a default random string generator will be used."),validateClient:iS.custom(e=>"function"==typeof e,{message:"validateClient must be a function that returns a boolean or a promise that resolves to a boolean."}).optional().describe("Function to validate the client ID. If not provided, no validation will be performed."),onDeviceAuthRequest:iS.custom(e=>"function"==typeof e,{message:"onDeviceAuthRequest must be a function that returns void or a promise that resolves to void."}).optional().describe("Function to handle device authorization requests. If not provided, no additional actions will be taken."),verificationUri:iS.string().optional().describe("The URI where users verify their device code. Can be an absolute URL (https://example.com/device) or relative path (/custom-path). This will be returned as verification_uri in the device code response. If not provided, defaults to /device."),schema:iS.custom(()=>!0)});let sg=["email-verification","sign-in","forget-password"];(0,sh.defineErrorCodes)({OTP_EXPIRED:"OTP expired",INVALID_OTP:"Invalid OTP",TOO_MANY_ATTEMPTS:"Too many attempts"}),iS.object({email:iS.string({}).meta({description:"Email address to send the OTP"}),type:iS.enum(sg).meta({description:"Type of the OTP"})}),iS.object({email:iS.string({}).meta({description:"Email address to send the OTP"}),type:iS.enum(sg).meta({required:!0,description:"Type of the OTP"})}),iS.object({email:iS.string({}).meta({description:"Email address the OTP was sent to"}),type:iS.enum(sg).meta({required:!0,description:"Type of the OTP"})}),iS.object({email:iS.string().meta({description:"Email address the OTP was sent to"}),type:iS.enum(sg).meta({required:!0,description:"Type of the OTP"}),otp:iS.string().meta({required:!0,description:"OTP to verify"})}),iS.object({email:iS.string({}).meta({description:"Email address to verify"}),otp:iS.string().meta({required:!0,description:"OTP to verify"})}),iS.object({email:iS.string({}).meta({description:"Email address to sign in"}),otp:iS.string().meta({required:!0,description:"OTP sent to the email"})}),iS.object({email:iS.string().meta({description:"Email address to send the OTP"})}),iS.object({email:iS.string().meta({description:"Email address to reset the password"}),otp:iS.string().meta({description:"OTP sent to the email"}),password:iS.string().meta({description:"New password"})}),(0,sh.defineErrorCodes)({INVALID_OAUTH_CONFIGURATION:"Invalid OAuth configuration",TOKEN_URL_NOT_FOUND:"Invalid OAuth configuration. Token URL not found.",PROVIDER_CONFIG_NOT_FOUND:"No config found for provider",PROVIDER_ID_REQUIRED:"Provider ID is required",INVALID_OAUTH_CONFIG:"Invalid OAuth configuration.",SESSION_REQUIRED:"Session is required"}),iS.object({providerId:iS.string().meta({description:"The provider ID for the OAuth provider"}),callbackURL:iS.string().meta({description:"The URL to redirect to after sign in"}).optional(),errorCallbackURL:iS.string().meta({description:"The URL to redirect to if an error occurs"}).optional(),newUserCallbackURL:iS.string().meta({description:'The URL to redirect to after login if the user is new. Eg: "/welcome"'}).optional(),disableRedirect:iS.boolean().meta({description:"Disable redirect"}).optional(),scopes:iS.array(iS.string()).meta({description:"Scopes to be passed to the provider authorization request."}).optional(),requestSignUp:iS.boolean().meta({description:"Explicitly request sign-up. Useful when disableImplicitSignUp is true for this provider. Eg: false"}).optional(),additionalData:iS.record(iS.string(),iS.any()).optional()}),iS.object({code:iS.string().meta({description:"The OAuth2 code"}).optional(),error:iS.string().meta({description:"The error message, if any"}).optional(),error_description:iS.string().meta({description:"The error description, if any"}).optional(),state:iS.string().meta({description:"The state parameter from the OAuth2 request"}).optional()}),iS.object({providerId:iS.string(),callbackURL:iS.string(),scopes:iS.array(iS.string()).meta({description:"Additional scopes to request when linking the account"}).optional(),errorCallbackURL:iS.string().meta({description:"The URL to redirect to if there is an error during the link process"}).optional()}),(0,sh.defineErrorCodes)({PASSWORD_COMPROMISED:"The password you entered has been compromised. Please choose a different password."});let sy=(e,t)=>({getAllKeys:async r=>t?.adapter?.getJwks?await t.adapter.getJwks(r):await e.findMany({model:"jwks"}),getLatestKey:async r=>t?.adapter?.getJwks?(await t.adapter.getJwks(r))?.sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime())[0]:(await e.findMany({model:"jwks"}))?.sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime())[0],createJwk:async(r,i)=>t?.adapter?.createJwk?await t.adapter.createJwk(i,r):await e.create({model:"jwks",data:{...i,createdAt:new Date}})});function sw(e){let t=e?.modulusLength??2048;if("number"!=typeof t||t<2048)throw new e3("Invalid or unsupported modulusLength option provided, 2048 bits or larger keys must be used");return t}async function sb(e,t){let r,i;switch(e){case"PS256":case"PS384":case"PS512":r={name:"RSA-PSS",hash:`SHA-${e.slice(-3)}`,publicExponent:Uint8Array.of(1,0,1),modulusLength:sw(t)},i=["sign","verify"];break;case"RS256":case"RS384":case"RS512":r={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.slice(-3)}`,publicExponent:Uint8Array.of(1,0,1),modulusLength:sw(t)},i=["sign","verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":r={name:"RSA-OAEP",hash:`SHA-${parseInt(e.slice(-3),10)||1}`,publicExponent:Uint8Array.of(1,0,1),modulusLength:sw(t)},i=["decrypt","unwrapKey","encrypt","wrapKey"];break;case"ES256":r={name:"ECDSA",namedCurve:"P-256"},i=["sign","verify"];break;case"ES384":r={name:"ECDSA",namedCurve:"P-384"},i=["sign","verify"];break;case"ES512":r={name:"ECDSA",namedCurve:"P-521"},i=["sign","verify"];break;case"Ed25519":case"EdDSA":i=["sign","verify"],r={name:"Ed25519"};break;case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":i=["sign","verify"],r={name:e};break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{i=["deriveBits"];let e=t?.crv??"P-256";switch(e){case"P-256":case"P-384":case"P-521":r={name:"ECDH",namedCurve:e};break;case"X25519":r={name:"X25519"};break;default:throw new e3("Invalid or unsupported crv option provided, supported values are P-256, P-384, P-521, and X25519")}break}default:throw new e3('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}return crypto.subtle.generateKey(r,t?.extractable??!1,i)}function sE(e,t){return"number"==typeof e?e:e instanceof Date?Math.floor(e.getTime()/1e3):t+nU(e)}async function s_(e){let{alg:t,...r}=e?.jwks?.keyPairConfig??{alg:"EdDSA",crv:"Ed25519"},{publicKey:i,privateKey:n}=await sb(t,{...r,extractable:!0});return{publicWebKey:await tF(i),privateWebKey:await tF(n),alg:t,cfg:r}}async function sA(e,t){let{publicWebKey:r,privateWebKey:i,alg:n,cfg:o}=await s_(t),a=JSON.stringify(i),s=!t?.jwks?.disablePrivateKeyEncryption,c={alg:n,...o&&"crv"in o?{crv:o.crv}:{},publicKey:JSON.stringify(r),privateKey:s?JSON.stringify(await iA({key:e.context.secret,data:a})):a,createdAt:new Date,...t?.jwks?.rotationInterval?{expiresAt:new Date(Date.now()+1e3*t.jwks.rotationInterval)}:{}};return await sy(e.context.adapter,t).createJwk(e,c)}async function sT(e,t){let{options:r}=t,i=t.payload,n=Math.floor(Date.now()/1e3),o=i.iat,a=i.exp,s=sE(r?.jwt?.expirationTime??"15m",o??n);a=a??s;let c=i.nbf,d=i.iss,l=r?.jwt?.issuer??e.context.options.baseURL,u=i.aud,p=r?.jwt?.audience??e.context.options.baseURL;if(r?.jwt?.sign){let e={...i,iat:o,exp:a,nbf:c,iss:d??l,aud:u??p};return r.jwt.sign(e)}let h=await sy(e.context.adapter,r).getLatestKey(e);(!h||h.expiresAt&&h.expiresAt<new Date)&&(h=await sA(e,r));let f=r?.jwks?.disablePrivateKeyEncryption?h.privateKey:await iT({key:e.context.secret,data:JSON.parse(h.privateKey)}).catch(()=>{throw new rO.BetterAuthError("Failed to decrypt private key. Make sure the secret currently in use is the same as the one used to encrypt the private key. If you are using a different secret, either clean up your JWKS or disable private key encryption.")}),m=h.alg??r?.jwks?.keyPairConfig?.alg??"EdDSA",g=await rm(JSON.parse(f),m),y=new ru(i).setProtectedHeader({alg:m,kid:h.id}).setExpirationTime(a).setIssuer(d??l).setAudience(u??p);return o&&y.setIssuedAt(o),i.sub&&y.setSubject(i.sub),i.nbf&&y.setNotBefore(i.nbf),i.jti&&y.setJti(i.jti),await y.sign(g)}iS.object({payload:iS.record(iS.string(),iS.any()),overrideOptions:iS.record(iS.string(),iS.any()).optional()}),iS.object({token:iS.string(),issuer:iS.string().optional()}),iS.object({email:iS.email().meta({description:"Email address to send the magic link"}),name:iS.string().meta({description:'User display name. Only used if the user is registering for the first time. Eg: "my-name"'}).optional(),callbackURL:iS.string().meta({description:"URL to redirect after magic link verification"}).optional(),newUserCallbackURL:iS.string().meta({description:"URL to redirect after new user signup. Only used if the user is registering for the first time."}).optional(),errorCallbackURL:iS.string().meta({description:"URL to redirect after error."}).optional()}),iS.object({token:iS.string().meta({description:"Verification token"}),callbackURL:iS.string().meta({description:'URL to redirect after magic link verification, if not provided the user will be redirected to the root URL. Eg: "/dashboard"'}).optional(),errorCallbackURL:iS.string().meta({description:"URL to redirect after error."}).optional(),newUserCallbackURL:iS.string().meta({description:"URL to redirect after new user signup. Only used if the user is registering for the first time."}).optional()}),iS.object({clientId:iS.string(),clientSecret:iS.string().optional(),type:iS.enum(["web","native","user-agent-based","public"]),name:iS.string(),icon:iS.string().optional(),metadata:iS.string().optional(),disabled:iS.boolean().optional().default(!1),redirectUrls:iS.string(),userId:iS.string().optional(),createdAt:iS.date(),updatedAt:iS.date()}),iS.object({accept:iS.boolean(),consent_code:iS.string().optional().nullish()}),iS.record(iS.any(),iS.any()),iS.object({redirect_uris:iS.array(iS.string()).meta({description:'A list of redirect URIs. Eg: ["https://client.example.com/callback"]'}),token_endpoint_auth_method:iS.enum(["none","client_secret_basic","client_secret_post"]).meta({description:'The authentication method for the token endpoint. Eg: "client_secret_basic"'}).default("client_secret_basic").optional(),grant_types:iS.array(iS.enum(["authorization_code","implicit","password","client_credentials","refresh_token","urn:ietf:params:oauth:grant-type:jwt-bearer","urn:ietf:params:oauth:grant-type:saml2-bearer"])).meta({description:'The grant types supported by the application. Eg: ["authorization_code"]'}).default(["authorization_code"]).optional(),response_types:iS.array(iS.enum(["code","token"])).meta({description:'The response types supported by the application. Eg: ["code"]'}).default(["code"]).optional(),client_name:iS.string().meta({description:'The name of the application. Eg: "My App"'}).optional(),client_uri:iS.string().meta({description:'The URI of the application. Eg: "https://client.example.com"'}).optional(),logo_uri:iS.string().meta({description:'The URI of the application logo. Eg: "https://client.example.com/logo.png"'}).optional(),scope:iS.string().meta({description:'The scopes supported by the application. Separated by spaces. Eg: "profile email"'}).optional(),contacts:iS.array(iS.string()).meta({description:'The contact information for the application. Eg: ["admin@example.com"]'}).optional(),tos_uri:iS.string().meta({description:'The URI of the application terms of service. Eg: "https://client.example.com/tos"'}).optional(),policy_uri:iS.string().meta({description:'The URI of the application privacy policy. Eg: "https://client.example.com/policy"'}).optional(),jwks_uri:iS.string().meta({description:'The URI of the application JWKS. Eg: "https://client.example.com/jwks"'}).optional(),jwks:iS.record(iS.any(),iS.any()).meta({description:'The JWKS of the application. Eg: {"keys": [{"kty": "RSA", "alg": "RS256", "use": "sig", "n": "...", "e": "..."}]}'}).optional(),metadata:iS.record(iS.any(),iS.any()).meta({description:'The metadata of the application. Eg: {"key": "value"}'}).optional(),software_id:iS.string().meta({description:'The software ID of the application. Eg: "my-software"'}).optional(),software_version:iS.string().meta({description:'The software version of the application. Eg: "1.0.0"'}).optional(),software_statement:iS.string().meta({description:"The software statement of the application."}).optional()}),iS.object({redirect_uris:iS.array(iS.string()),token_endpoint_auth_method:iS.enum(["none","client_secret_basic","client_secret_post"]).default("client_secret_basic").optional(),grant_types:iS.array(iS.enum(["authorization_code","implicit","password","client_credentials","refresh_token","urn:ietf:params:oauth:grant-type:jwt-bearer","urn:ietf:params:oauth:grant-type:saml2-bearer"])).default(["authorization_code"]).optional(),response_types:iS.array(iS.enum(["code","token"])).default(["code"]).optional(),client_name:iS.string().optional(),client_uri:iS.string().optional(),logo_uri:iS.string().optional(),scope:iS.string().optional(),contacts:iS.array(iS.string()).optional(),tos_uri:iS.string().optional(),policy_uri:iS.string().optional(),jwks_uri:iS.string().optional(),jwks:iS.record(iS.string(),iS.any()).optional(),metadata:iS.record(iS.any(),iS.any()).optional(),software_id:iS.string().optional(),software_version:iS.string().optional(),software_statement:iS.string().optional()}),iS.record(iS.any(),iS.any()),(0,sh.defineErrorCodes)({INVALID_SESSION_TOKEN:"Invalid session token"}),iS.object({sessionToken:iS.string().meta({description:"The session token to set as active"})}),iS.object({sessionToken:iS.string().meta({description:"The session token to revoke"})}),iS.object({callbackURL:iS.string().meta({description:"The URL to redirect to after the proxy"}),cookies:iS.string().meta({description:"The cookies to set after the proxy"})}),iS.object({idToken:iS.string().meta({description:"Google ID token, which the client obtains from the One Tap API"})}),iS.object({token:iS.string().meta({description:'The token to verify. Eg: "some-token"'})});let sv=su({organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"],team:["create","update","delete"],ac:["create","read","update","delete"]});sv.newRole({organization:["update"],invitation:["create","cancel"],member:["create","update","delete"],team:["create","update","delete"],ac:["create","read","update","delete"]}),sv.newRole({organization:["update","delete"],member:["create","update","delete"],invitation:["create","cancel"],team:["create","update","delete"],ac:["create","read","update","delete"]}),sv.newRole({organization:[],member:[],invitation:[],team:[],ac:["read"]}),n2(async()=>({})),n2({use:[oD]},async e=>({session:e.context.session})),(0,sh.defineErrorCodes)({YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_ORGANIZATION:"You are not allowed to create a new organization",YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_ORGANIZATIONS:"You have reached the maximum number of organizations",ORGANIZATION_ALREADY_EXISTS:"Organization already exists",ORGANIZATION_SLUG_ALREADY_TAKEN:"Organization slug already taken",ORGANIZATION_NOT_FOUND:"Organization not found",USER_IS_NOT_A_MEMBER_OF_THE_ORGANIZATION:"User is not a member of the organization",YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_ORGANIZATION:"You are not allowed to update this organization",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_ORGANIZATION:"You are not allowed to delete this organization",NO_ACTIVE_ORGANIZATION:"No active organization",USER_IS_ALREADY_A_MEMBER_OF_THIS_ORGANIZATION:"User is already a member of this organization",MEMBER_NOT_FOUND:"Member not found",ROLE_NOT_FOUND:"Role not found",YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_TEAM:"You are not allowed to create a new team",TEAM_ALREADY_EXISTS:"Team already exists",TEAM_NOT_FOUND:"Team not found",YOU_CANNOT_LEAVE_THE_ORGANIZATION_AS_THE_ONLY_OWNER:"You cannot leave the organization as the only owner",YOU_CANNOT_LEAVE_THE_ORGANIZATION_WITHOUT_AN_OWNER:"You cannot leave the organization without an owner",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_MEMBER:"You are not allowed to delete this member",YOU_ARE_NOT_ALLOWED_TO_INVITE_USERS_TO_THIS_ORGANIZATION:"You are not allowed to invite users to this organization",USER_IS_ALREADY_INVITED_TO_THIS_ORGANIZATION:"User is already invited to this organization",INVITATION_NOT_FOUND:"Invitation not found",YOU_ARE_NOT_THE_RECIPIENT_OF_THE_INVITATION:"You are not the recipient of the invitation",EMAIL_VERIFICATION_REQUIRED_BEFORE_ACCEPTING_OR_REJECTING_INVITATION:"Email verification required before accepting or rejecting invitation",YOU_ARE_NOT_ALLOWED_TO_CANCEL_THIS_INVITATION:"You are not allowed to cancel this invitation",INVITER_IS_NO_LONGER_A_MEMBER_OF_THE_ORGANIZATION:"Inviter is no longer a member of the organization",YOU_ARE_NOT_ALLOWED_TO_INVITE_USER_WITH_THIS_ROLE:"You are not allowed to invite a user with this role",FAILED_TO_RETRIEVE_INVITATION:"Failed to retrieve invitation",YOU_HAVE_REACHED_THE_MAXIMUM_NUMBER_OF_TEAMS:"You have reached the maximum number of teams",UNABLE_TO_REMOVE_LAST_TEAM:"Unable to remove last team",YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_MEMBER:"You are not allowed to update this member",ORGANIZATION_MEMBERSHIP_LIMIT_REACHED:"Organization membership limit reached",YOU_ARE_NOT_ALLOWED_TO_CREATE_TEAMS_IN_THIS_ORGANIZATION:"You are not allowed to create teams in this organization",YOU_ARE_NOT_ALLOWED_TO_DELETE_TEAMS_IN_THIS_ORGANIZATION:"You are not allowed to delete teams in this organization",YOU_ARE_NOT_ALLOWED_TO_UPDATE_THIS_TEAM:"You are not allowed to update this team",YOU_ARE_NOT_ALLOWED_TO_DELETE_THIS_TEAM:"You are not allowed to delete this team",INVITATION_LIMIT_REACHED:"Invitation limit reached",TEAM_MEMBER_LIMIT_REACHED:"Team member limit reached",USER_IS_NOT_A_MEMBER_OF_THE_TEAM:"User is not a member of the team",YOU_CAN_NOT_ACCESS_THE_MEMBERS_OF_THIS_TEAM:"You are not allowed to list the members of this team",YOU_DO_NOT_HAVE_AN_ACTIVE_TEAM:"You do not have an active team",YOU_ARE_NOT_ALLOWED_TO_CREATE_A_NEW_TEAM_MEMBER:"You are not allowed to create a new member",YOU_ARE_NOT_ALLOWED_TO_REMOVE_A_TEAM_MEMBER:"You are not allowed to remove a team member",YOU_ARE_NOT_ALLOWED_TO_ACCESS_THIS_ORGANIZATION:"You are not allowed to access this organization as an owner",YOU_ARE_NOT_A_MEMBER_OF_THIS_ORGANIZATION:"You are not a member of this organization",MISSING_AC_INSTANCE:"Dynamic Access Control requires a pre-defined ac instance on the server auth plugin. Read server logs for more information",YOU_MUST_BE_IN_AN_ORGANIZATION_TO_CREATE_A_ROLE:"You must be in an organization to create a role",YOU_ARE_NOT_ALLOWED_TO_CREATE_A_ROLE:"You are not allowed to create a role",YOU_ARE_NOT_ALLOWED_TO_UPDATE_A_ROLE:"You are not allowed to update a role",YOU_ARE_NOT_ALLOWED_TO_DELETE_A_ROLE:"You are not allowed to delete a role",YOU_ARE_NOT_ALLOWED_TO_READ_A_ROLE:"You are not allowed to read a role",YOU_ARE_NOT_ALLOWED_TO_LIST_A_ROLE:"You are not allowed to list a role",YOU_ARE_NOT_ALLOWED_TO_GET_A_ROLE:"You are not allowed to get a role",TOO_MANY_ROLES:"This organization has too many roles",INVALID_RESOURCE:"The provided permission includes an invalid resource",ROLE_NAME_IS_ALREADY_TAKEN:"That role name is already taken",CANNOT_DELETE_A_PRE_DEFINED_ROLE:"Cannot delete a pre-defined role"}),iS.object({organizationId:iS.string().optional().meta({description:"The id of the organization to create the role in. If not provided, the user's active organization will be used."}),role:iS.string().meta({description:"The name of the role to create"}),permission:iS.record(iS.string(),iS.array(iS.string())).meta({description:"The permission to assign to the role"})}),iS.object({organizationId:iS.string().optional().meta({description:"The id of the organization to create the role in. If not provided, the user's active organization will be used."})}).and(iS.union([iS.object({roleName:iS.string().nonempty().meta({description:"The name of the role to delete"})}),iS.object({roleId:iS.string().nonempty().meta({description:"The id of the role to delete"})})])),iS.object({organizationId:iS.string().optional().meta({description:"The id of the organization to list roles for. If not provided, the user's active organization will be used."})}).optional(),iS.object({organizationId:iS.string().optional().meta({description:"The id of the organization to read a role for. If not provided, the user's active organization will be used."})}).and(iS.union([iS.object({roleName:iS.string().nonempty().meta({description:"The name of the role to read"})}),iS.object({roleId:iS.string().nonempty().meta({description:"The id of the role to read"})})])).optional(),iS.union([iS.object({roleName:iS.string().nonempty().meta({description:"The name of the role to update"})}),iS.object({roleId:iS.string().nonempty().meta({description:"The id of the role to update"})})]),iS.object({email:iS.string().meta({description:"The email address of the user to invite"}),role:iS.union([iS.string().meta({description:"The role to assign to the user"}),iS.array(iS.string().meta({description:"The roles to assign to the user"}))]).meta({description:'The role(s) to assign to the user. It can be `admin`, `member`, owner. Eg: "member"'}),organizationId:iS.string().meta({description:"The organization ID to invite the user to"}).optional(),resend:iS.boolean().meta({description:"Resend the invitation email, if the user is already invited. Eg: true"}).optional(),teamId:iS.union([iS.string().meta({description:"The team ID to invite the user to"}).optional(),iS.array(iS.string()).meta({description:"The team IDs to invite the user to"}).optional()])}),iS.object({invitationId:iS.string().meta({description:"The ID of the invitation to accept"})}),iS.object({invitationId:iS.string().meta({description:"The ID of the invitation to reject"})}),iS.object({invitationId:iS.string().meta({description:"The ID of the invitation to cancel"})}),iS.object({id:iS.string().meta({description:"The ID of the invitation to get"})}),iS.object({organizationId:iS.string().meta({description:"The ID of the organization to list invitations for"}).optional()}).optional(),iS.object({userId:iU.coerce.string().meta({description:'The user Id which represents the user to be added as a member. If `null` is provided, then it\'s expected to provide session headers. Eg: "user-id"'}),role:iS.union([iS.string(),iS.array(iS.string())]).meta({description:'The role(s) to assign to the new member. Eg: ["admin", "sale"]'}),organizationId:iS.string().meta({description:'An optional organization ID to pass. If not provided, will default to the user\'s active organization. Eg: "org-id"'}).optional(),teamId:iS.string().meta({description:'An optional team ID to add the member to. Eg: "team-id"'}).optional()}),iS.object({memberIdOrEmail:iS.string().meta({description:"The ID or email of the member to remove"}),organizationId:iS.string().meta({description:'The ID of the organization to remove the member from. If not provided, the active organization will be used. Eg: "org-id"'}).optional()}),iS.object({role:iS.union([iS.string(),iS.array(iS.string())]).meta({description:'The new role to be applied. This can be a string or array of strings representing the roles. Eg: ["admin", "sale"]'}),memberId:iS.string().meta({description:'The member id to apply the role update to. Eg: "member-id"'}),organizationId:iS.string().meta({description:'An optional organization ID which the member is a part of to apply the role update. If not provided, you must provide session headers to get the active organization. Eg: "organization-id"'}).optional()}),iS.object({organizationId:iS.string().meta({description:'The organization Id for the member to leave. Eg: "organization-id"'})}),iS.object({userId:iS.string().meta({description:"The user ID to get the role for. If not provided, will default to the current user's"}).optional(),organizationId:iS.string().meta({description:'The organization ID to list members for. If not provided, will default to the user\'s active organization. Eg: "organization-id"'}).optional(),organizationSlug:iS.string().meta({description:'The organization slug to list members for. If not provided, will default to the user\'s active organization. Eg: "organization-slug"'}).optional()}).optional(),iS.object({name:iS.string().min(1).meta({description:"The name of the organization"}),slug:iS.string().min(1).meta({description:"The slug of the organization"}),userId:iU.coerce.string().meta({description:'The user id of the organization creator. If not provided, the current user will be used. Should only be used by admins or when called by the server. server-only. Eg: "user-id"'}).optional(),logo:iS.string().meta({description:"The logo of the organization"}).optional(),metadata:iS.record(iS.string(),iS.any()).meta({description:"The metadata of the organization"}).optional(),keepCurrentActiveOrganization:iS.boolean().meta({description:"Whether to keep the current active organization active after creating a new one. Eg: true"}).optional()}),iS.object({slug:iS.string().meta({description:'The organization slug to check. Eg: "my-org"'})}),iS.object({name:iS.string().min(1).meta({description:"The name of the organization"}).optional(),slug:iS.string().min(1).meta({description:"The slug of the organization"}).optional(),logo:iS.string().meta({description:"The logo of the organization"}).optional(),metadata:iS.record(iS.string(),iS.any()).meta({description:"The metadata of the organization"}).optional()}),iS.object({organizationId:iS.string().meta({description:"The organization id to delete"})}),iS.optional(iS.object({organizationId:iS.string().meta({description:"The organization id to get"}).optional(),organizationSlug:iS.string().meta({description:"The organization slug to get"}).optional(),membersLimit:iS.number().or(iS.string().transform(e=>parseInt(e))).meta({description:"The limit of members to get. By default, it uses the membershipLimit option which defaults to 100."}).optional()})),iS.object({organizationId:iS.string().meta({description:'The organization id to set as active. It can be null to unset the active organization. Eg: "org-id"'}).nullable().optional(),organizationSlug:iS.string().meta({description:'The organization slug to set as active. It can be null to unset the active organization if organizationId is not provided. Eg: "org-slug"'}).optional()});let sk=iS.string(),sR=iS.enum(["pending","accepted","rejected","canceled"]).default("pending");iS.object({id:iS.string().default(om.generateId),name:iS.string(),slug:iS.string(),logo:iS.string().nullish().optional(),metadata:iS.record(iS.string(),iS.unknown()).or(iS.string().transform(e=>JSON.parse(e))).optional(),createdAt:iS.date()}),iS.object({id:iS.string().default(om.generateId),organizationId:iS.string(),userId:iU.coerce.string(),role:sk,createdAt:iS.date().default(()=>new Date)}),iS.object({id:iS.string().default(om.generateId),organizationId:iS.string(),email:iS.string(),role:sk,status:sR,teamId:iS.string().nullish(),inviterId:iS.string(),expiresAt:iS.date(),createdAt:iS.date().default(()=>new Date)}),iS.object({id:iS.string().default(om.generateId),name:iS.string().min(1),organizationId:iS.string(),createdAt:iS.date(),updatedAt:iS.date().optional()}),iS.object({id:iS.string().default(om.generateId),teamId:iS.string(),userId:iS.string(),createdAt:iS.date().default(()=>new Date)}),iS.object({id:iS.string().default(om.generateId),organizationId:iS.string(),role:iS.string(),permission:iS.record(iS.string(),iS.array(iS.string())),createdAt:iS.date().default(()=>new Date),updatedAt:iS.date().optional()});let sI=["admin","member","owner"];iS.union([iS.enum(sI),iS.array(iS.enum(sI))]),iS.object({name:iS.string().meta({description:'The name of the team. Eg: "my-team"'}),organizationId:iS.string().meta({description:'The organization ID which the team will be created in. Defaults to the active organization. Eg: "organization-id"'}).optional()}),iS.object({teamId:iS.string().meta({description:'The team ID of the team to remove. Eg: "team-id"'}),organizationId:iS.string().meta({description:'The organization ID which the team falls under. If not provided, it will default to the user\'s active organization. Eg: "organization-id"'}).optional()}),iS.optional(iS.object({organizationId:iS.string().meta({description:'The organization ID which the teams are under to list. Defaults to the users active organization. Eg: "organization-id"'}).optional()})),iS.object({teamId:iS.string().meta({description:"The team id to set as active. It can be null to unset the active team"}).nullable().optional()}),iS.optional(iS.object({teamId:iS.string().optional().meta({description:"The team whose members we should return. If this is not provided the members of the current active team get returned."})})),iS.object({teamId:iS.string().meta({description:"The team the user should be a member of."}),userId:iU.coerce.string().meta({description:"The user Id which represents the user to be added as a member."})}),iS.object({teamId:iS.string().meta({description:"The team the user should be removed from."}),userId:iU.coerce.string().meta({description:"The user which should be removed from the team."})}),iS.object({organizationId:iS.string().optional()}).and(iS.union([iS.object({permission:iS.record(iS.string(),iS.array(iS.string())),permissions:iS.undefined()}),iS.object({permission:iS.undefined(),permissions:iS.record(iS.string(),iS.array(iS.string()))})])),(0,sh.defineErrorCodes)({INVALID_PHONE_NUMBER:"Invalid phone number",PHONE_NUMBER_EXIST:"Phone number already exists",PHONE_NUMBER_NOT_EXIST:"phone number isn't registered",INVALID_PHONE_NUMBER_OR_PASSWORD:"Invalid phone number or password",UNEXPECTED_ERROR:"Unexpected error",OTP_NOT_FOUND:"OTP not found",OTP_EXPIRED:"OTP expired",INVALID_OTP:"Invalid OTP",PHONE_NUMBER_NOT_VERIFIED:"Phone number not verified",PHONE_NUMBER_CANNOT_BE_UPDATED:"Phone number cannot be updated",SEND_OTP_NOT_IMPLEMENTED:"sendOTP not implemented",TOO_MANY_ATTEMPTS:"Too many attempts"}),iS.object({phoneNumber:iS.string().meta({description:'Phone number to sign in. Eg: "+1234567890"'}),password:iS.string().meta({description:"Password to use for sign in."}),rememberMe:iS.boolean().meta({description:"Remember the session. Eg: true"}).optional()}),iS.object({phoneNumber:iS.string().meta({description:'Phone number to send OTP. Eg: "+1234567890"'})}),iS.object({phoneNumber:iS.string().meta({description:'Phone number to verify. Eg: "+1234567890"'}),code:iS.string().meta({description:'OTP code. Eg: "123456"'}),disableSession:iS.boolean().meta({description:"Disable session creation after verification. Eg: false"}).optional(),updatePhoneNumber:iS.boolean().meta({description:"Check if there is a session and update the phone number. Eg: true"}).optional()}),iS.object({phoneNumber:iS.string()}),iS.object({otp:iS.string().meta({description:'The one time password to reset the password. Eg: "123456"'}),phoneNumber:iS.string().meta({description:'The phone number to the account which intends to reset the password for. Eg: "+1234567890"'}),newPassword:iS.string().meta({description:'The new password. Eg: "new-and-secure-password"'})});let sS=BigInt(0),sx=BigInt(1),sU=BigInt(2),sO=BigInt(7),sD=BigInt(256),sC=BigInt(113),sN=[],sP=[],sL=[];for(let e=0,t=sx,r=1,i=0;e<24;e++){[r,i]=[i,(2*r+3*i)%5],sN.push(2*(5*i+r)),sP.push((e+1)*(e+2)/2%64);let n=sS;for(let e=0;e<7;e++)(t=(t<<sx^(t>>sO)*sC)%sD)&sU&&(n^=sx<<(sx<<BigInt(e))-sx);sL.push(n)}let sj=eN(sL,!0),sq=sj[0],sB=sj[1];function sH(e,t,r){let i=e.context.baseURL;return{scopes_supported:r?.scopes_supported,issuer:t?.jwt?.issuer??i,authorization_endpoint:`${i}/oauth2/authorize`,token_endpoint:`${i}/oauth2/token`,jwks_uri:r?.jwt_disabled?void 0:t?.jwks?.remoteUrl??`${i}${t?.jwks?.jwksPath??"/jwks"}`,registration_endpoint:`${i}/oauth2/register`,introspection_endpoint:`${i}/oauth2/introspect`,revocation_endpoint:`${i}/oauth2/revoke`,response_types_supported:r?.grant_types_supported&&!r.grant_types_supported.includes("authorization_code")?[]:["code"],response_modes_supported:["query"],grant_types_supported:r?.grant_types_supported??["authorization_code","client_credentials","refresh_token"],token_endpoint_auth_methods_supported:[...r?.public_client_supported?["none"]:[],"client_secret_basic","client_secret_post"],introspection_endpoint_auth_methods_supported:["client_secret_basic","client_secret_post"],revocation_endpoint_auth_methods_supported:["client_secret_basic","client_secret_post"],code_challenge_methods_supported:["S256"]}}function s$(e,t){let r=e.context.baseURL,i=t.disableJwtPlugin?void 0:a7(e.context).options;return{...sH(e,i,{scopes_supported:t.advertisedMetadata?.scopes_supported??t.scopes,public_client_supported:t.allowUnauthenticatedClientRegistration,grant_types_supported:t.grantTypes,jwt_disabled:t.disableJwtPlugin}),claims_supported:t?.advertisedMetadata?.claims_supported??t?.claims??[],userinfo_endpoint:`${r}/oauth2/userinfo`,subject_types_supported:["public"],id_token_signing_alg_values_supported:i?.jwks?.keyPairConfig?.alg?[i?.jwks?.keyPairConfig?.alg]:t.disableJwtPlugin?["HS256"]:["EdDSA"],end_session_endpoint:`${r}/oauth2/end-session`,acr_values_supported:["urn:mace:incommon:iap:bronze"],prompt_values_supported:["login","consent","create","select_account"]}}function sM(e,t,r,i){let n=new URLSearchParams({error:t,error_description:r});return i&&n.append("state",i),`${e}${e.includes("?")?"&":"?"}${n.toString()}`}iS.object({walletAddress:iS.string().regex(/^0[xX][a-fA-F0-9]{40}$/i).length(42),chainId:iS.number().int().positive().max(0x7fffffff).optional().default(1)}),(0,sh.defineErrorCodes)({OTP_NOT_ENABLED:"OTP not enabled",OTP_HAS_EXPIRED:"OTP has expired",TOTP_NOT_ENABLED:"TOTP not enabled",TWO_FACTOR_NOT_ENABLED:"Two factor isn't enabled",BACKUP_CODES_NOT_ENABLED:"Backup codes aren't enabled",INVALID_BACKUP_CODE:"Invalid backup code",INVALID_CODE:"Invalid code",TOO_MANY_ATTEMPTS_REQUEST_NEW_CODE:"Too many attempts. Please request a new code.",INVALID_TWO_FACTOR_COOKIE:"Invalid two factor cookie"}),iS.object({code:iS.string().meta({description:'A backup code to verify. Eg: "123456"'}),disableSession:iS.boolean().meta({description:"If true, the session cookie will not be set."}).optional(),trustDevice:iS.boolean().meta({description:"If true, the device will be trusted for 30 days. It'll be refreshed on every sign in request within this time. Eg: true"}).optional()}),iS.object({userId:iU.coerce.string().meta({description:'The user ID to view all backup codes. Eg: "user-id"'})}),iS.object({password:iS.string().meta({description:"The users password."})}),iS.object({code:iS.string().meta({description:'The otp code to verify. Eg: "012345"'}),trustDevice:iS.boolean().optional().meta({description:"If true, the device will be trusted for 30 days. It'll be refreshed on every sign in request within this time. Eg: true"})}),iS.object({trustDevice:iS.boolean().optional().meta({description:"If true, the device will be trusted for 30 days. It'll be refreshed on every sign in request within this time. Eg: true"})}).optional(),iS.object({secret:iS.string().meta({description:"The secret to generate the TOTP code"})}),iS.object({password:iS.string().meta({description:"User password"})}),iS.object({code:iS.string().meta({description:'The otp code to verify. Eg: "012345"'}),trustDevice:iS.boolean().meta({description:"If true, the device will be trusted for 30 days. It'll be refreshed on every sign in request within this time. Eg: true"}).optional()}),iS.object({password:iS.string().meta({description:"User password"}),issuer:iS.string().meta({description:"Custom issuer for the TOTP URI"}).optional()}),iS.object({password:iS.string().meta({description:"User password"})}),(0,sh.defineErrorCodes)({INVALID_USERNAME_OR_PASSWORD:"Invalid username or password",EMAIL_NOT_VERIFIED:"Email not verified",UNEXPECTED_ERROR:"Unexpected error",USERNAME_IS_ALREADY_TAKEN:"Username is already taken. Please try another.",USERNAME_TOO_SHORT:"Username is too short",USERNAME_TOO_LONG:"Username is too long",INVALID_USERNAME:"Username is invalid",INVALID_DISPLAY_USERNAME:"Display username is invalid"}),iS.object({username:iS.string().meta({description:"The username of the user"}),password:iS.string().meta({description:"The password of the user"}),rememberMe:iS.boolean().meta({description:"Remember the user session"}).optional(),callbackURL:iS.string().meta({description:"The URL to redirect to after email verification"}).optional()}),iS.object({username:iS.string().meta({description:"The username to check"})});let sz=(e,t)=>{if(e.headers?.get("accept")?.includes("application/json"))return{redirect:!0,url:t.toString()};throw e.redirect(t)};function sV(e,t,r){return sM(e.context.options.onAPIError?.errorURL||`${e.context.baseURL}/error`,t,r)}async function sK(e,t,r){if(t.grantTypes&&!t.grantTypes.includes("authorization_code"))throw new iH("NOT_FOUND");if(!e.request)throw new iH("UNAUTHORIZED",{error_description:"request not found",error:"invalid_request"});let i=e.query;if(!i.client_id)throw e.redirect(sV(e,"invalid_client","client_id is required"));if(!i.response_type)throw e.redirect(sV(e,"invalid_request","response_type is required"));let n=e.query?.prompt?function(e){let t=e.split(" ").map(e=>e.trim()),r=new Set;for(let e of t)("login"===e||"consent"===e||"create"===e||"select_account"===e||"none"===e)&&r.add(e);return new Set(r)}(e.query?.prompt):void 0;if(n?.has("select_account")&&!t.selectAccount?.page)throw e.redirect(sV(e,"unsupported_prompt_select_account","unsupported prompt type"));if("code"!==i.response_type)throw e.redirect(sV(e,"unsupported_response_type","unsupported response type"));let o=await st(e,t,i.client_id);if(!o)throw e.redirect(sV(e,"invalid_client","client_id is required"));if(o.disabled)throw e.redirect(sV(e,"client_disabled","client is disabled"));if(!o.redirectUris?.find(e=>e===i.redirect_uri)||!i.redirect_uri)throw e.redirect(sV(e,"invalid_redirect","invalid redirect uri"));let a=i.scope?.split(" ").filter(e=>e);if(a){let r=new Set(o.scopes??t.scopes),n=a.filter(e=>!r?.has(e)||"offline_access"===e&&("S256"!==i.code_challenge_method||!i.code_challenge));if(n.length)throw e.redirect(sM(i.redirect_uri,"invalid_scope",`The following scopes are invalid: ${n.join(", ")}`,i.state))}if(a||(i.scope=(a=o.scopes??t.scopes??[]).join(" ")),!i.code_challenge||!i.code_challenge_method)throw e.redirect(sM(i.redirect_uri,"invalid_request","pkce is required",i.state));if(!["S256"].includes(i.code_challenge_method))throw e.redirect(sM(i.redirect_uri,"invalid_request","invalid code_challenge method",i.state));let s=await oO(e);if(!s||n?.has("login")||n?.has("create"))return sF(e,t,n?.has("create")?"create":"login");if(r?.isAuthorize&&n?.has("select_account")||r?.isAuthorize&&t.selectAccount&&await t.selectAccount.shouldRedirect({headers:e.request.headers,user:s.user,session:s.session,scopes:a}))return sF(e,t,"select_account");if(t.signup?.shouldRedirect){let r=await t.signup.shouldRedirect({headers:e.request.headers,user:s.user,session:s.session,scopes:a});if(r)return sF(e,t,"create","string"==typeof r?r:void 0)}if(!r?.postLogin&&t.postLogin&&await t.postLogin.shouldRedirect({headers:e.request.headers,user:s.user,session:s.session,scopes:a}))return sF(e,t,"post_login");if(n?.has("consent"))return sF(e,t,"consent");let c=await t.postLogin?.consentReferenceId?.({user:s.user,session:s.session,scopes:a});if(o.skipConsent)return sW(e,t,{query:i,clientId:o.clientId,userId:s.user.id,sessionId:s.session.id,referenceId:c});let d=await e.context.adapter.findOne({model:"oauthConsent",where:[{field:"clientId",value:o.clientId},{field:"userId",value:s.user.id},...c?[{field:"referenceId",value:c}]:[]]});return d&&a.every(e=>d.scopes.includes(e))?sW(e,t,{query:i,clientId:o.clientId,userId:s.user.id,sessionId:s.session.id,referenceId:c}):sF(e,t,"consent")}async function sW(e,t,r){let i=ei(32,"a-z","A-Z","0-9"),n=Math.floor(Date.now()/1e3),o=n+(t.codeExpiresIn??600),a={identifier:await sa(t.storeTokens,i,"authorization_code"),updatedAt:new Date(1e3*n),expiresAt:new Date(1e3*o),value:JSON.stringify({type:"authorization_code",query:e.query,userId:r.userId,sessionId:r?.sessionId,referenceId:r.referenceId})};e.context.verification_id?await e.context.internalAdapter.updateVerificationValue(e.context.verification_id,a):await e.context.internalAdapter.createVerificationValue({...a,createdAt:new Date(1e3*n)});let s=new URL(r.query.redirect_uri);return s.searchParams.set("code",i),r.query.state&&s.searchParams.set("state",r.query.state),sz(e,s.toString())}async function sF(e,t,r,i){let n=await sZ(e,t),o=t.loginPage;if("select_account"===r)o=t.selectAccount?.page??t.loginPage;else if("post_login"===r){if(!t.postLogin?.page)throw new iH("INTERNAL_SERVER_ERROR",{error_description:"postLogin should have been defined"});o=t.postLogin?.page}else"consent"===r?o=t.consentPage:"create"===r&&(o=t.signup?.page??t.loginPage);return sz(e,`${i??o}?${n}`)}async function sZ(e,t){let r=Math.floor(Date.now()/1e3)+(t.codeExpiresIn??600),i=new URLSearchParams(e.query);i.set("exp",String(r));let n=await ik(i.toString(),e.context.secret);return i.append("sig",n),i.toString()}async function sJ(e,t){let r=(await cN.get())?.query;if(!r)throw new iH("BAD_REQUEST",{error_description:"missing oauth query",error:"invalid_request"});let i=new URLSearchParams(r),n=i.get("scope")?.split(" ")??[],o=i.get("client_id");if(!o)throw new iH("BAD_REQUEST",{error_description:"client_id is required",error:"invalid_client"});let a=e.body.scope?.split(" ");if(a&&!a.every(e=>n?.includes(e)))throw new iH("BAD_REQUEST",{error_description:"Scope not originally requested",error:"invalid_request"});if(!0!==e.body.accept)return{redirect:!0,uri:sM(i.get("redirect_uri")??"","access_denied","User denied access",i.get("state")??void 0)};let s=await oO(e),c=await t.postLogin?.consentReferenceId?.({user:s?.user,session:s?.session,scopes:a??n}),d=await e.context.adapter.findOne({model:"oauthConsent",where:[{field:"clientId",value:o},{field:"userId",value:s?.user.id},...c?[{field:"referenceId",value:c}]:[]]}),l=Math.floor(Date.now()/1e3),u={clientId:o,userId:s?.user.id,scopes:a??n,createdAt:new Date(1e3*l),updatedAt:new Date(1e3*l),referenceId:c};d?.id?await e.context.adapter.update({model:"oauthConsent",where:[{field:"id",value:d.id}],update:{scopes:u.scopes,updatedAt:new Date(1e3*l)}}):await e.context.adapter.create({model:"oauthConsent",data:{...u,scopes:u.scopes}}),e?.headers?.set("accept","application/json"),e.query=sl(i,"consent"),e.context.postLogin=!0;let{url:p}=await sK(e,t);return{redirect:!0,uri:p}}async function sG(e,t){if(!0===e.body.selected)return await sY(e,t);if(!0===e.body.created)return await sQ(e,t);if(!0===e.body.postLogin)return await sX(e,t);throw new iH("BAD_REQUEST",{error_description:"Missing parameters",error:"invalid_request"})}async function sY(e,t){let r=(await cN.get())?.query;if(!r)throw new iH("BAD_REQUEST",{error_description:"missing oauth query",error:"invalid_request"});e.headers?.set("accept","application/json"),e.query=sl(new URLSearchParams(r),"select_account");let{url:i}=await sK(e,t);return{redirect:!0,uri:i}}async function sQ(e,t){let r=(await cN.get())?.query;if(!r)throw new iH("BAD_REQUEST",{error_description:"missing oauth query",error:"invalid_request"});e.query=sl(new URLSearchParams(r),"create");let{url:i}=await sK(e,t);return{redirect:!0,uri:i}}async function sX(e,t){let r=(await cN.get())?.query;if(!r)throw new iH("BAD_REQUEST",{error_description:"missing oauth query",error:"invalid_request"});let i=new URLSearchParams(r);e.headers?.set("accept","application/json"),e.query=Object.fromEntries(i);let{url:n}=await sK(e,t,{postLogin:!0});return{redirect:!0,uri:n}}function s0(e,t){let r=e.name.split(" ").filter(e=>""!==e),i={name:e.name??void 0,picture:e.image??void 0,given_name:r.length>1?r.slice(0,-1).join(" "):void 0,family_name:r.length>1?r.at(-1):void 0},n={email:e.email??void 0,email_verified:e.emailVerified??!1};return{sub:e.id??void 0,...t.includes("profile")?i:{},...t.includes("email")?n:{}}}async function s1(e,t){if(!e.request)throw new iH("UNAUTHORIZED",{error_description:"request not found",error:"invalid_request"});let r=e.request.headers.get("authorization"),i="string"==typeof r&&r?.startsWith("Bearer ")?r?.replace("Bearer ",""):r;if(!i?.length)throw new iH("UNAUTHORIZED",{error_description:"authorization header not found",error:"invalid_request"});let n=await cc(e,t,i),o=n.scope?.split(" ");if(!o?.includes("openid"))throw new iH("BAD_REQUEST",{error_description:"Missing required scope",error:"invalid_scope"});if(!n.sub)throw new iH("BAD_REQUEST",{error_description:"user not found",error:"invalid_request"});let a=await e.context.internalAdapter.findUserById(n.sub);if(!a)throw new iH("BAD_REQUEST",{error_description:"user not found",error:"invalid_request"});let s=s0(a,o??[]),c=t.customUserInfoClaims&&o?.length?await t.customUserInfoClaims({user:a,scopes:o,jwt:n}):{};return{...s,...c}}async function s2(e,t){let r=e.body?.grant_type;if(t.grantTypes&&r&&!t.grantTypes.includes(r))throw new iH("BAD_REQUEST",{error_description:`unsupported grant_type ${r}`,error:"unsupported_grant_type"});switch(r){case"authorization_code":return cr(e,t);case"client_credentials":return ci(e,t);case"refresh_token":return cn(e,t);case void 0:throw new iH("BAD_REQUEST",{error_description:"missing required grant_type",error:"unsupported_grant_type"});default:throw new iH("BAD_REQUEST",{error_description:`unsupported grant_type ${r}`,error:"unsupported_grant_type"})}}async function s5(e,t,r,i,n,o,a,s){let c=s?.iat??Math.floor(Date.now()/1e3),d=s?.exp??c+(t.accessTokenExpiresIn??3600),l=t.customAccessTokenClaims?await t.customAccessTokenClaims({user:r,scopes:o,resource:e.body.resource,referenceId:a,metadata:i.metadata?JSON.parse(i.metadata):void 0}):{},u=a7(e.context).options;return sT(e,{options:u,payload:{...l,sub:r.id,aud:"string"==typeof n?n:n?.length===1?n.at(0):n,azp:i.clientId,scope:o.join(" "),sid:s?.sid,iss:u?.jwt?.issuer??e.context.baseURL,iat:c,exp:d}})}async function s6(e,t,r,i,n,o,a){let s=Math.floor(Date.now()/1e3),c=s+(t.idTokenExpiresIn??36e3),d=s0(r,n),l=Math.floor((e.context.session?.session.createdAt??new Date(1e3*s)).getTime()/1e3),u=t.customIdTokenClaims?await t.customIdTokenClaims({user:r,scopes:n,metadata:i.metadata?JSON.parse(i.metadata):void 0}):{},p=t.disableJwtPlugin?void 0:a7(e.context).options,h={...u,...d,auth_time:l,acr:"urn:mace:incommon:iap:bronze",iss:p?.jwt?.issuer??e.context.baseURL,sub:r.id,aud:i.clientId,nonce:o,iat:s,exp:c,sid:i.enableEndSession?a:void 0};if(!t.disableJwtPlugin||i.clientSecret)return t.disableJwtPlugin?new ru(h).setProtectedHeader({alg:"HS256"}).sign(new TextEncoder().encode(await si(e,t.storeClientSecret,i.clientSecret))):sT(e,{options:p,payload:h})}async function s3(e,t,r){return(e.prefix?.refreshToken??"")+(e.formatRefreshToken?.encrypt?e.formatRefreshToken.encrypt(t,r):t)}async function s8(e,t){if(e.prefix?.refreshToken)if(t.startsWith(e.prefix.refreshToken))t=t.replace(e.prefix.refreshToken,"");else throw new iH("BAD_REQUEST",{error_description:"refresh token not found",error:"invalid_token"});return e.formatRefreshToken?.decrypt?e.formatRefreshToken?.decrypt(t):{token:t}}async function s4(e,t,r,i,n,o,a,s){let c=o.iat??Math.floor(Date.now()/1e3),d=o?.exp??c+(t.accessTokenExpiresIn??3600),l=t.generateOpaqueAccessToken?await t.generateOpaqueAccessToken():ei(32,"A-Z","a-z");return await e.context.adapter.create({model:"oauthAccessToken",data:{token:await sa(t.storeTokens,l,"access_token"),clientId:i.clientId,sessionId:o?.sid,userId:r?.id,referenceId:a,refreshId:s,scopes:n,createdAt:new Date(1e3*c),expiresAt:new Date(1e3*d)}}),(t.prefix?.opaqueAccessToken??"")+l}async function s9(e,t,r,i,n,o,a,s){let c=a.iat??Math.floor(Date.now()/1e3),d=a?.exp??c+(t.refreshTokenExpiresIn??2592e3),l=t.generateRefreshToken?await t.generateRefreshToken():ei(32,"A-Z","a-z"),u=a?.sid;return s?.id&&await e.context.adapter.update({model:"oauthRefreshToken",where:[{field:"id",value:s.id}],update:{revoked:new Date(1e3*c)}}),{id:(await e.context.adapter.create({model:"oauthRefreshToken",data:{token:await sa(t.storeTokens,l,"refresh_token"),clientId:n.clientId,sessionId:u,userId:r.id,referenceId:i,scopes:o,createdAt:new Date(1e3*c),expiresAt:new Date(1e3*d)}})).id,token:await s3(t,l,u)}}async function s7(e,t,r){let i=e.body.resource,n="string"==typeof i?[i]:i?[...i]:void 0;if(n){r.includes("openid")&&n.push(`${e.context.baseURL}/oauth2/userinfo`);let i=new Set([...t.validAudiences??[e.context.baseURL],r?.includes("openid")?`${e.context.baseURL}/oauth2/userinfo`:void 0].flat().filter(e=>e?.length));for(let e of n)if(!i.has(e))throw new iH("BAD_REQUEST",{error_description:"requested resource invalid",error:"invalid_request"})}return n?.length===1?n.at(0):n}async function ce(e,t,r,i,n,o,a,s,c){let d=Math.floor(Date.now()/1e3),l=d+(t.accessTokenExpiresIn??3600),u=t.scopeExpirations?i.map(e=>t.scopeExpirations?.[e]?sE(t.scopeExpirations[e],d):l).reduce((e,t)=>e<t?e:t,l):l,p=await s7(e,t,i),h=c?.refreshToken?.scopes?.includes("offline_access")||i.includes("offline_access"),f=p&&!t.disableJwtPlugin,m=i.includes("openid"),g=h&&!f?await s9(e,t,n,o,r,i,{iat:d,exp:d+(t.refreshTokenExpiresIn??2592e3),sid:a},c?.refreshToken):void 0,[y,w,b]=await Promise.all([f?s5(e,t,n,r,p,i,o,{iat:d,exp:u,sid:a}):s4(e,t,n,r,i,{iat:d,exp:u,sid:a},o,g?.id),g||(h?s9(e,t,n,o,r,i,{iat:d,exp:d+(t.refreshTokenExpiresIn??2592e3),sid:a},c?.refreshToken):void 0),m?s6(e,t,n,r,i,s,a):void 0]);return e.json({access_token:y,expires_in:u-d,expires_at:u,token_type:"Bearer",refresh_token:w?.token,scope:i.join(" "),id_token:b},{headers:{"Cache-Control":"no-store",Pragma:"no-cache"}})}async function ct(e,t,r,i,n){let o=await e.context.internalAdapter.findVerificationValue(await sa(t.storeTokens,r,"authorization_code")),a=o?JSON.parse(o?.value):void 0;if(!o)throw new iH("UNAUTHORIZED",{error_description:"Invalid code",error:"invalid_verification"});if(o?.id&&await e.context.internalAdapter.deleteVerificationValue(o.id),!o.expiresAt||o.expiresAt<new Date)throw new iH("UNAUTHORIZED",{error_description:"code expired",error:"invalid_verification"});if(!a)throw new iH("UNAUTHORIZED",{error_description:"missing verification value content",error:"invalid_verification"});if("authorization_code"!==a.type)throw new iH("UNAUTHORIZED",{error_description:"incorrect verification type",error:"invalid_verification"});if(a.query.client_id!==i)throw new iH("UNAUTHORIZED",{error_description:"invalid client_id",error:"invalid_client"});if(!a.userId)throw new iH("BAD_REQUEST",{error_description:"missing user_id on challenge",error:"invalid_user"});if(a.query?.redirect_uri&&a.query?.redirect_uri!==n)throw new iH("BAD_REQUEST",{error_description:"missing verification redirect_uri",error:"invalid_request"});return a}async function cr(e,t){let{client_id:r,client_secret:i,code:n,code_verifier:o,redirect_uri:a}=e.body,s=e.request?.headers.get("authorization")||null;if(s?.startsWith("Basic ")){let e=sc(s);r=e?.client_id,i=e?.client_secret}if(!r)throw new iH("BAD_REQUEST",{error_description:"client_id is required",error:"invalid_request"});if(!n)throw new iH("BAD_REQUEST",{error_description:"code is required",error:"invalid_request"});if(!a)throw new iH("BAD_REQUEST",{error_description:"redirect_uri is required",error:"invalid_request"});let c=r&&i,d=r&&n&&o;if(!(d||c))throw new iH("BAD_REQUEST",{error_description:"Missing a required credential value for authorization_code grant",error:"invalid_request"});let l=await ct(e,t,n,r,a),u=l.query.scope?.split(" ");if(!u)throw new iH("INTERNAL_SERVER_ERROR",{error_description:"verification scope unset",error:"invalid_scope"});let p=await sd(e,t,r,i,u),h=o&&l.query?.code_challenge_method==="S256"?await oK(o):void 0;if(c&&(h||l?.query?.code_challenge)&&h!==l.query?.code_challenge||d&&h!==l.query?.code_challenge)throw new iH("UNAUTHORIZED",{error_description:"code verification failed",error:"invalid_request"});if(!l.userId)throw new iH("BAD_REQUEST",{error_description:"missing user, user may have been deleted",error:"invalid_user"});let f=await e.context.internalAdapter.findUserById(l.userId);if(!f)throw new iH("BAD_REQUEST",{error_description:"missing user, user may have been deleted",error:"invalid_user"});let m=await e.context.adapter.findOne({model:"session",where:[{field:"id",value:l.sessionId}]});if(!m||m.expiresAt<new Date)throw new iH("BAD_REQUEST",{error_description:"session no longer exists",error:"invalid_request"});return ce(e,t,p,l.query.scope?.split(" ")??[],f,l.referenceId,m.id,l.query?.nonce)}async function ci(e,t){let{client_id:r,client_secret:i,scope:n}=e.body,o=e.request?.headers.get("authorization")||null;if(o?.startsWith("Basic ")){let e=sc(o);r=e?.client_id,i=e?.client_secret}if(!r)throw new iH("BAD_REQUEST",{error_description:"Missing required client_id",error:"invalid_grant"});if(!i)throw new iH("BAD_REQUEST",{error_description:"Missing a required client_secret",error:"invalid_grant"});let a=await sd(e,t,r,i),s=n?.split(" ");if(s){let e=new Set(a.scopes??t.scopes),r=new Set(["openid","profile","email","offline_access"]),i=s.filter(t=>!e?.has(t)||r.has(t));if(i.length)throw new iH("BAD_REQUEST",{error_description:`The following scopes are invalid: ${i.join(", ")}`,error:"invalid_scope"})}s||(s=a.scopes??t.clientCredentialGrantDefaultScopes??t.scopes??[]);let c=t.disableJwtPlugin?void 0:a7(e.context).options,d=await s7(e,t,s),l=Math.floor(Date.now()/1e3),u=l+(t.m2mAccessTokenExpiresIn??3600),p=t.scopeExpirations&&s?s.map(e=>t.scopeExpirations?.[e]?sE(t.scopeExpirations[e],l):u).reduce((e,t)=>e<t?e:t,u):u,h=t.customAccessTokenClaims?await t.customAccessTokenClaims({scopes:s,resource:e.body.resource,metadata:a.metadata?JSON.parse(a.metadata):void 0}):{},f=d&&!t.disableJwtPlugin?await sT(e,{options:c,payload:{...h,aud:d,azp:a.clientId,scope:s.join(" "),iss:c?.jwt?.issuer??e.context.baseURL,iat:l,exp:p}}):await s4(e,t,void 0,a,s,{iat:l,exp:p});return e.json({access_token:f,expires_in:p-l,expires_at:p,token_type:"Bearer",scope:s.join(" ")},{headers:{"Cache-Control":"no-store",Pragma:"no-cache"}})}async function cn(e,t){let{client_id:r,client_secret:i,refresh_token:n,scope:o}=e.body,a=e.request?.headers.get("authorization")||null;if(a?.startsWith("Basic ")){let e=sc(a);r=e?.client_id,i=e?.client_secret}if(!r)throw new iH("BAD_REQUEST",{error_description:"Missing required client_id",error:"invalid_grant"});if(!n)throw new iH("BAD_REQUEST",{error_description:"Missing a required refresh_token for refresh_token grant",error:"invalid_grant"});let s=await s8(t,n),c=await e.context.adapter.findOne({model:"oauthRefreshToken",where:[{field:"token",value:await ss(t.storeTokens,s.token,"refresh_token")}]});if(!c)throw new iH("BAD_REQUEST",{error_description:"session not found",error:"invalid_request"});if(c.clientId!==r)throw new iH("BAD_REQUEST",{error_description:"invalid client_id",error:"invalid_client"});if(c.expiresAt<new Date)throw new iH("BAD_REQUEST",{error_description:"invalid refresh token",error:"invalid_request"});if(c.revoked)throw await e.context.adapter.deleteMany({model:"oauthRefreshToken",where:[{field:"clientId",value:r},{field:"userId",value:c.userId}]}),new iH("BAD_REQUEST",{error_description:"invalid refresh token",error:"invalid_request"});let d=c?.scopes,l=o?.split(" ");if(l){let e=new Set(d);for(let t of l)if(!e.has(t))throw new iH("BAD_REQUEST",{error_description:`unable to issue scope ${t}`,error:"invalid_scope"})}let u=await sd(e,t,r,i,l??d),p=await e.context.internalAdapter.findUserById(c.userId);if(!p)throw new iH("BAD_REQUEST",{error_description:"user not found",error:"invalid_request"});return ce(e,t,u,l??d,p,c.referenceId,c.sessionId,void 0,{refreshToken:c})}async function co(e,t,r,i){let n,o,a=t.disableJwtPlugin?void 0:a7(e.context),s=a?.options;try{n=await au(r,{jwksFetch:s?.jwks?.remoteUrl?s.jwks.remoteUrl:async()=>(await a?.endpoints.getJwks(e))?.response,verifyOptions:{audience:t.validAudiences??e.context.baseURL,issuer:s?.jwt?.issuer??e.context.baseURL}})}catch(e){if(e instanceof Error){if("TypeError"===e.name||"JWSInvalid"===e.name)throw new iH("BAD_REQUEST",{error_description:"invalid JWT signature",error:"invalid_request"});if("JWTExpired"===e.name)return{active:!1};if("JWTInvalid"===e.name)return{active:!1};throw e}throw Error(e)}if(n.azp&&(!(o=await st(e,t,n.azp))||o?.disabled||i&&n.azp!==i))return{active:!1};let c=n.sid;if(c){let t=await e.context.adapter.findOne({model:"session",where:[{field:"id",value:c}]});(!t||t.expiresAt<new Date)&&(n.sid=void 0)}return n.azp&&(n.client_id=n.azp),n.active=!0,n}async function ca(e,t,r,i){let n,o,a=r;if(t.prefix?.opaqueAccessToken)if(a.startsWith(t.prefix.opaqueAccessToken))a=a.replace(t.prefix.opaqueAccessToken,"");else throw new iH("BAD_REQUEST",{error_description:"opaque access token not found",error:"invalid_request"});let s=await e.context.adapter.findOne({model:"oauthAccessToken",where:[{field:"token",value:await ss(t.storeTokens,a,"access_token")}]});if(!s)throw new iH("BAD_REQUEST",{error_description:"opaque access token not found",error:"invalid_token"});if(!s.expiresAt||s.expiresAt<new Date||s.clientId&&(!(n=await st(e,t,s.clientId))||n?.disabled||i&&s.clientId!==i))return{active:!1};let c=s.sessionId??void 0;if(c){let t=await e.context.adapter.findOne({model:"session",where:[{field:"id",value:c}]});(!t||t.expiresAt<new Date)&&(c=void 0)}s.userId&&(o=await e.context.internalAdapter.findUserById(s?.userId));let d=t.customAccessTokenClaims?await t.customAccessTokenClaims({user:o,scopes:s.scopes,referenceId:s?.referenceId,metadata:n?.metadata?JSON.parse(n.metadata):void 0}):{},l=(t.disableJwtPlugin?void 0:a7(e.context))?.options;return{...d,active:!0,iss:l?.jwt?.issuer??e.context.baseURL,client_id:s.clientId,sub:o?.id,sid:c,exp:Math.floor(s.expiresAt.getTime()/1e3),iat:Math.floor(s.createdAt.getTime()/1e3),scope:s.scopes?.join(" ")}}async function cs(e,t,r,i){let n,o=await e.context.adapter.findOne({model:"oauthRefreshToken",where:[{field:"token",value:await ss(t.storeTokens,r,"refresh_token")}]});if(!o)throw new iH("BAD_REQUEST",{error_description:"token not found",error:"invalid_token"});if(!o.clientId||o.clientId!==i||!o.expiresAt||o.expiresAt<new Date||o.revoked)return{active:!1};let a=o.sessionId??void 0;if(a){let t=await e.context.adapter.findOne({model:"session",where:[{field:"id",value:o.sessionId}]});(!t||t.expiresAt<new Date)&&(a=void 0)}return o.userId&&(n=await e.context.internalAdapter.findUserById(o?.userId)??void 0),{active:!0,client_id:i,iss:(t.disableJwtPlugin?void 0:a7(e.context))?.options?.jwt?.issuer??e.context.baseURL,sub:n?.id,sid:a,exp:Math.floor(o.expiresAt.getTime()/1e3),iat:Math.floor(o.createdAt.getTime()/1e3),scope:o.scopes?.join(" ")}}async function cc(e,t,r,i){try{return await co(e,t,r,i)}catch(e){if(e instanceof iH);else if(e instanceof Error)throw e;else throw Error(e)}try{return await ca(e,t,r,i)}catch(e){if(e instanceof iH);else if(e instanceof Error)throw e;else throw Error("Unknown error validating access token")}throw new iH("BAD_REQUEST",{error_description:"Invalid access token",error:"invalid_request"})}async function cd(e,t){let{client_id:r,client_secret:i,token:n,token_type_hint:o}=e.body,a=e.request?.headers.get("authorization")||null;if(a?.startsWith("Basic ")){let e=sc(a);r=e?.client_id,i=e?.client_secret}if(!r||!i)throw new iH("UNAUTHORIZED",{error_description:"missing required credentials",error:"invalid_client"});if(n&&"string"==typeof n&&n.startsWith("Bearer ")&&(n=n.replace("Bearer ","")),!n?.length)throw new iH("BAD_REQUEST",{error_description:"missing a required token for introspection",error:"invalid_request"});let s=await sd(e,t,r,i);try{if(void 0===o||"access_token"===o)try{return await cc(e,t,n,s.clientId)}catch(e){if(e instanceof iH){if("access_token"===o)throw e}else if(e instanceof Error)throw e;else throw Error(e)}if(void 0===o||"refresh_token"===o)try{return await cs(e,t,(await s8(t,n)).token,s.clientId)}catch(e){if(e instanceof iH){if("refresh_token"===o)throw e}else if(e instanceof Error)throw e;else throw Error(e)}throw new iH("BAD_REQUEST",{error_description:"token not found",error:"invalid_request"})}catch(e){if(e instanceof iH){if("BAD_REQUEST"===e.name)return{active:!1};throw e}if(e instanceof Error)throw os.logger.error("Introspection error:",e.message,e.stack),new iH("INTERNAL_SERVER_ERROR");throw os.logger.error("Introspection error:",e),new iH("INTERNAL_SERVER_ERROR")}}async function cl(e,t){let r,{id_token_hint:i,client_id:n,post_logout_redirect_uri:o,state:a}=e.query,s=e.context.baseURL,c=(t.disableJwtPlugin?void 0:a7(e.context))?.options,d=c?.jwks?.remoteUrl??`${s}${c?.jwks?.jwksPath??"/jwks"}`,l=n;if(!l){let e;try{e=af(i)}catch(e){throw new iH("UNAUTHORIZED",{error_description:"invalid id token",error:"invalid_token"})}if(!(l=e?.aud))throw new iH("INTERNAL_SERVER_ERROR",{error_description:"id token missing audience",error:"invalid_request"})}let u=await st(e,t,l);if(!u)throw new iH("BAD_REQUEST",{error_description:"client doesn't exist",error:"invalid_client"});if(u.disabled)throw new iH("BAD_REQUEST",{error_description:"client is disabled",error:"invalid_client"});if(!u.enableEndSession)throw new iH("UNAUTHORIZED",{error_description:"client unable to logout",error:"invalid_client"});if(t.disableJwtPlugin){let n=u.clientSecret;if(!n)throw new iH("UNAUTHORIZED",{error_description:"missing required credentials",error:"invalid_client"});let o=await si(e,t.storeClientSecret,n),{payload:a}=await rT(i,new TextEncoder().encode(o));r=JSON.parse(new TextDecoder().decode(a))}else{let{payload:e}=await rT(i,ad(await ap(i,{jwksFetch:d})));r=JSON.parse(new TextDecoder().decode(e))}if(!r)throw new iH("INTERNAL_SERVER_ERROR",{error_description:"missing payload",error:"invalid_request"});if((c?.jwt?.issuer??e.context.baseURL)!==r.iss)throw new iH("INTERNAL_SERVER_ERROR",{error_description:"invalid issuer",error:"invalid_request"});let p="string"==typeof r.aud?[r.aud]:r.aud;if(!p)throw new iH("INTERNAL_SERVER_ERROR",{error_description:"id token missing audience",error:"invalid_request"});if(n&&!p.includes(n))throw new iH("BAD_REQUEST",{error_description:"audience mismatch",error:"invalid_request"});let h=r.sid;if(!h)throw new iH("INTERNAL_SERVER_ERROR",{error_description:"id token missing session",error:"invalid_request"});try{let t=await e.context.adapter.findOne({model:"session",where:[{field:"id",value:h}]});t?.token?await e.context.internalAdapter.deleteSession(t?.token):t?.id?await e.context.adapter.delete({model:"session",where:[{field:"id",value:t.id}]}):await e.context.adapter.delete({model:"session",where:[{field:"id",value:h}]})}catch{}if(o&&u.postLogoutRedirectUris?.includes(o)){let t=new URL(o);return a&&t.searchParams.set("state",a),sz(e,t.toString())}}async function cu(e,t){if(!t.allowDynamicClientRegistration)throw new iH("FORBIDDEN",{error:"access_denied",error_description:"Client registration is disabled"});let r=e.body,i=await oO(e);if(!(i||t.allowUnauthenticatedClientRegistration))throw new iH("UNAUTHORIZED",{error:"invalid_token",error_description:"Authentication required for client registration"});let n="none"===r.token_endpoint_auth_method;if(!i&&!n)throw new iH("UNAUTHORIZED",{error:"invalid_request",error_description:"Authentication required for confidential client registration"});return e.body.scope||(e.body.scope=(t.clientRegistrationDefaultScopes??t.scopes)?.join(" ")),ch(e,t,{isRegister:!0})}async function cp(e,t,r){let i="none"===e.token_endpoint_auth_method;if(e.type){if(i&&"native"!==e.type&&"user-agent-based"!==e.type)throw new iH("BAD_REQUEST",{error:"invalid_client_metadata",error_description:"Type must be 'native' or 'user-agent-based' for public applications"});else if(!i&&"web"!==e.type)throw new iH("BAD_REQUEST",{error:"invalid_client_metadata",error_description:"Type must be 'web' for confidential applications"})}if((!e.grant_types||e.grant_types.includes("authorization_code"))&&(!e.redirect_uris||0===e.redirect_uris.length))throw new iH("BAD_REQUEST",{error:"invalid_redirect_uri",error_description:"Redirect URIs are required for authorization_code and implicit grant types"});let n=e.grant_types??["authorization_code"],o=e.response_types??["code"];if(n.includes("authorization_code")&&!o.includes("code"))throw new iH("BAD_REQUEST",{error:"invalid_client_metadata",error_description:"When 'authorization_code' grant type is used, 'code' response type must be included"});let a=e?.scope?.split(" ").filter(e=>e.length),s=r?.isRegister?t.clientRegistrationAllowedScopes??t.scopes:t.scopes;if(s){let e=new Set(s);for(let t of a??[])if(!e?.has(t))throw new iH("BAD_REQUEST",{error:"invalid_scope",error_description:`cannot request scope ${t}`})}}async function ch(e,t,r){let i=e.body,n=await oO(e),o="none"===i.token_endpoint_auth_method;await cp(e.body,t,r);let a=t.generateClientId?.()||ei(32,"a-z","A-Z"),s=o?void 0:t.generateClientSecret?.()||ei(32,"a-z","A-Z"),c=s?await so(e,t,s):void 0,d=Math.floor(Date.now()/1e3),l=t.clientReference?await t.clientReference({user:n?.user,session:n?.session}):void 0,u=cf({...i??{},disabled:void 0,jwks:void 0,jwks_uri:void 0,client_secret_expires_at:c?r.isRegister&&t?.clientRegistrationClientSecretExpiration?sE(t.clientRegistrationClientSecretExpiration,d):0:void 0,client_id:a,client_secret:c,client_id_issued_at:d,public:o,user_id:l?void 0:n?.session.userId,reference_id:l}),p=await e.context.adapter.create({model:"oauthClient",data:u});return e.json(cm({...p,clientSecret:s?(t.prefix?.clientSecret??"")+s:void 0}),{status:201,headers:{"Cache-Control":"no-store",Pragma:"no-cache"}})}function cf(e){let{client_id:t,client_secret:r,client_secret_expires_at:i,scope:n,user_id:o,client_id_issued_at:a,client_name:s,client_uri:c,logo_uri:d,contacts:l,tos_uri:u,policy_uri:p,jwks:h,jwks_uri:f,software_id:m,software_version:g,software_statement:y,redirect_uris:w,post_logout_redirect_uris:b,token_endpoint_auth_method:E,grant_types:_,response_types:A,public:T,type:v,disabled:k,skip_consent:R,enable_end_session:I,reference_id:S,...x}=e,U=i?new Date(1e3*i):void 0,O=a?new Date(1e3*a):void 0;return{clientId:t,clientSecret:r,disabled:k,scopes:n?.split(" "),userId:o,createdAt:O,expiresAt:U,name:s,uri:c,icon:d,contacts:l,tos:u,policy:p,softwareId:m,softwareVersion:g,softwareStatement:y,redirectUris:w,postLogoutRedirectUris:b,tokenEndpointAuthMethod:E,grantTypes:_,responseTypes:A,public:T,type:v,skipConsent:R,enableEndSession:I,referenceId:S,metadata:x&&Object.keys(x).length?JSON.stringify(x):void 0}}function cm(e){let{clientId:t,clientSecret:r,disabled:i,scopes:n,userId:o,createdAt:a,updatedAt:s,expiresAt:c,name:d,uri:l,icon:u,contacts:p,tos:h,policy:f,softwareId:m,softwareVersion:g,softwareStatement:y,redirectUris:w,postLogoutRedirectUris:b,tokenEndpointAuthMethod:E,grantTypes:_,responseTypes:A,public:T,type:v,skipConsent:k,enableEndSession:R,referenceId:I,metadata:S}=e,x=c?Math.round(c.getTime()/1e3):void 0,U=a?Math.round(a.getTime()/1e3):void 0,O=n?.join(" ");return{...S?JSON.parse(S):void 0,client_id:t,client_secret:r??void 0,client_secret_expires_at:r?x??0:void 0,scope:O??void 0,user_id:o??void 0,client_id_issued_at:U??void 0,client_name:d??void 0,client_uri:l??void 0,logo_uri:u??void 0,contacts:p??void 0,tos_uri:h??void 0,policy_uri:f??void 0,software_id:m??void 0,software_version:g??void 0,software_statement:y??void 0,redirect_uris:w??void 0,post_logout_redirect_uris:b??void 0,token_endpoint_auth_method:E??void 0,grant_types:_??void 0,response_types:A??void 0,public:T??void 0,type:v??void 0,disabled:i??void 0,skip_consent:k??void 0,enable_end_session:R??void 0,reference_id:I??void 0}}let cg=iS.url().superRefine((e,t)=>{if(!URL.canParse(e))return t.addIssue({code:"custom",message:"URL must be parseable",fatal:!0}),iU.NEVER}).refine(e=>{let t=new URL(e);return"javascript:"!==t.protocol&&"data:"!==t.protocol&&"vbscript:"!==t.protocol},{message:"URL cannot use javascript:, data:, or vbscript: scheme"});async function cy(e,t){let r=await oO(e);if(!r)throw new iH("UNAUTHORIZED");if(!e.request)throw new iH("BAD_REQUEST");if(t.clientPrivileges&&!await t.clientPrivileges({headers:e.request.headers,action:"read",session:r.session,user:r.user}))throw new iH("UNAUTHORIZED");let i=await st(e,t,e.query.client_id);if(!i)throw new iH("NOT_FOUND",{error_description:"client not found",error:"not_found"});if(i.userId){if(i.userId!==r.user.id)throw new iH("UNAUTHORIZED")}else if(i.referenceId&&t.clientReference){if(i.referenceId!==await t.clientReference(r))throw new iH("UNAUTHORIZED")}else throw new iH("UNAUTHORIZED");let n=cm(i);return n.client_secret=void 0,n}async function cw(e,t){let r=await st(e,t,e.query.client_id);if(!r||r.disabled)throw new iH("NOT_FOUND",{error_description:"client not found",error:"not_found"});return cm({clientId:r.clientId,name:r.name,uri:r.uri,contacts:r.contacts,icon:r.icon,tos:r.tos,policy:r.policy})}async function cb(e,t){let r=await oO(e);if(!r)throw new iH("UNAUTHORIZED");if(!e.request)throw new iH("BAD_REQUEST");if(t.clientPrivileges&&!await t.clientPrivileges({headers:e.request.headers,action:"list",session:r.session,user:r.user}))throw new iH("UNAUTHORIZED");let i=await t.clientReference?.(r);if(i)return await e.context.adapter.findMany({model:"oauthClient",where:[{field:"referenceId",value:i}]}).then(e=>e?e.map(e=>{let t=cm(e);return t.client_secret=void 0,t}):null);if(r.user.id)return await e.context.adapter.findMany({model:"oauthClient",where:[{field:"userId",value:r.user.id}]}).then(e=>e?e.map(e=>{let t=cm(e);return t.client_secret=void 0,t}):null);throw new iH("BAD_REQUEST",{message:"either user_id or reference_id must be provided"})}async function cE(e,t){let r=await oO(e);if(!r)throw new iH("UNAUTHORIZED");if(!e.request)throw new iH("BAD_REQUEST");if(t.clientPrivileges&&!await t.clientPrivileges({headers:e.request.headers,action:"delete",session:r.session,user:r.user}))throw new iH("UNAUTHORIZED");let i=e.body.client_id;if(t.cachedTrustedClients?.has(i))throw new iH("INTERNAL_SERVER_ERROR",{error_description:"trusted clients must be updated manually",error:"invalid_client"});let n=await st(e,t,i);if(!n)throw new iH("NOT_FOUND",{error_description:"client not found",error:"not_found"});if(n.userId){if(n.userId!==r.user.id)throw new iH("UNAUTHORIZED")}else if(n.referenceId&&t.clientReference){if(n.referenceId!==await t.clientReference(r))throw new iH("UNAUTHORIZED")}else throw new iH("UNAUTHORIZED");await e.context.adapter.delete({model:"oauthClient",where:[{field:"clientId",value:i}]})}async function c_(e,t){let r=await oO(e);if(!r)throw new iH("UNAUTHORIZED");if(!e.request)throw new iH("BAD_REQUEST");if(t.clientPrivileges&&!await t.clientPrivileges({headers:e.request.headers,action:"update",session:r.session,user:r.user}))throw new iH("UNAUTHORIZED");let i=e.body.client_id;if(t.cachedTrustedClients?.has(i))throw new iH("INTERNAL_SERVER_ERROR",{error_description:"trusted clients must be updated manually",error:"invalid_client"});let n=await st(e,t,i);if(!n)throw new iH("NOT_FOUND",{error_description:"client not found",error:"not_found"});if(n.userId){if(n.userId!==r.user.id)throw new iH("UNAUTHORIZED")}else if(n.referenceId&&t.clientReference){if(n.referenceId!==await t.clientReference(r))throw new iH("UNAUTHORIZED")}else throw new iH("UNAUTHORIZED");let o=e.body.update;if(0===Object.keys(o).length){let e=cm(n);return e.client_secret=void 0,e}await cp({...cm(n),...o},t);let a=await e.context.adapter.update({model:"oauthClient",where:[{field:"clientId",value:i}],update:cf(o)});if(!a)throw new iH("INTERNAL_SERVER_ERROR",{error_description:"unable to update client",error:"invalid_client"});let s=cm(a);return s.client_secret=void 0,s}async function cA(e,t){let r=await oO(e);if(!r)throw new iH("UNAUTHORIZED");if(!e.request)throw new iH("BAD_REQUEST");if(t.clientPrivileges&&!await t.clientPrivileges({headers:e.request.headers,action:"rotate",session:r.session,user:r.user}))throw new iH("UNAUTHORIZED");let i=e.body.client_id;if(t.cachedTrustedClients?.has(i))throw new iH("INTERNAL_SERVER_ERROR",{error_description:"trusted clients must be updated manually",error:"invalid_client"});let n=await st(e,t,i);if(!n)throw new iH("NOT_FOUND",{error_description:"client not found",error:"not_found"});if(n.userId){if(n.userId!==r.user.id)throw new iH("UNAUTHORIZED")}else if(n.referenceId&&t.clientReference){if(n.referenceId!==await t.clientReference(r))throw new iH("UNAUTHORIZED")}else throw new iH("UNAUTHORIZED");if(n.public||!n.clientSecret)throw new iH("BAD_REQUEST",{error_description:"public clients cannot be updated",error:"invalid_client"});let o=t.generateClientSecret?.()||ei(32,"a-z","A-Z"),a=o?await so(e,t,o):void 0,s=await e.context.adapter.update({model:"oauthClient",where:[{field:"clientId",value:i}],update:{...cm(n),clientSecret:a}});if(!s)throw new iH("INTERNAL_SERVER_ERROR",{error_description:"unable to update client",error:"invalid_client"});return cm({...s,clientSecret:(t.prefix?.clientSecret??"")+o})}async function cT(e,t,r){return await e.context.adapter.findOne({model:"oauthConsent",where:[{field:"id",value:r}]})}async function cv(e,t){let r=await oO(e);if(!r)throw new iH("UNAUTHORIZED");let{id:i}=e.query;if(!i)throw new iH("NOT_FOUND",{error_description:"missing id parameter",error:"not_found"});let n=await cT(e,t,i);if(!n)throw new iH("NOT_FOUND",{error_description:"no consent",error:"not_found"});if(n.userId!==r.user.id)throw new iH("UNAUTHORIZED");return n}async function ck(e,t){let r=await oO(e);if(!r)throw new iH("UNAUTHORIZED");return await e.context.adapter.findMany({model:"oauthConsent",where:[{field:"userId",value:r.user.id}]})}async function cR(e,t){let r=await oO(e);if(!r)throw new iH("UNAUTHORIZED");let{id:i}=e.body;if(!i)throw new iH("NOT_FOUND",{error_description:"missing id parameter",error:"not_found"});let n=await cT(e,t,i);if(!n)throw new iH("NOT_FOUND",{error_description:"no consent",error:"not_found"});if(n.userId!==r.user.id)throw new iH("UNAUTHORIZED");await e.context.adapter.delete({model:"oauthConsent",where:[{field:"id",value:i}]})}async function cI(e,t){let r=await oO(e);if(!r)throw new iH("UNAUTHORIZED");let{id:i}=e.body;if(!i)throw new iH("NOT_FOUND",{error_description:"missing id parameter",error:"not_found"});let n=await cT(e,t,i);if(!n)throw new iH("NOT_FOUND",{error_description:"no consent",error:"not_found"});let o=await st(e,t,n.clientId);if(!n)throw new iH("NOT_FOUND",{error_description:"no consent",error:"not_found"});if(n.userId!==r.user.id)throw new iH("UNAUTHORIZED");let a=o?.scopes??t.scopes??[],s=e.body.update,c=s.scopes;if(c&&!c.every(e=>a?.includes(e)))throw new iH("BAD_REQUEST",{error_description:`unable to provide scopes to ${o?.referenceId??o?.userId}`,error:"invalid_request"});let d=Math.floor(Date.now()/1e3);return await e.context.adapter.update({model:"oauthConsent",where:[{field:"id",value:i}],update:{...s,updatedAt:new Date(1e3*d)}})}async function cS(e,t,r){let i=t.disableJwtPlugin?void 0:a7(e.context),n=i?.options;try{await au(r,{jwksFetch:n?.jwks?.remoteUrl?n.jwks.remoteUrl:async()=>(await i?.endpoints.getJwks(e))?.response,verifyOptions:{audience:t.validAudiences??e.context.baseURL,issuer:n?.jwt?.issuer??e.context.baseURL}})}catch(e){if(e instanceof Error){if("TypeError"===e.name||"JWSInvalid"===e.name)throw new iH("BAD_REQUEST",{error_description:"invalid JWT signature",error:"invalid_request"});if("JWTExpired"===e.name)return null;if("JWTInvalid"===e.name)return null;throw e}throw Error(e)}}async function cx(e,t,r,i){let n=r;if(t.prefix?.opaqueAccessToken)if(n.startsWith(t.prefix.opaqueAccessToken))n=n.replace(t.prefix.opaqueAccessToken,"");else throw new iH("BAD_REQUEST",{error_description:"opaque access token not found",error:"invalid_request"});let o=await e.context.adapter.findOne({model:"oauthAccessToken",where:[{field:"token",value:await ss(t.storeTokens,n,"access_token")}]});if(!o)throw new iH("BAD_REQUEST",{error_description:"opaque access token not found",error:"invalid_request"});if(!o.clientId||o.clientId!==i)return null;o.id?await e.context.adapter.delete({model:"oauthAccessToken",where:[{field:"id",value:o.id}]}):await e.context.adapter.delete({model:"oauthAccessToken",where:[{field:"token",value:o.token}]})}async function cU(e,t,r,i){let n=await e.context.adapter.findOne({model:"oauthRefreshToken",where:[{field:"token",value:await ss(t.storeTokens,r,"refresh_token")}]});if(!n)throw new iH("BAD_REQUEST",{error_description:"token not found",error:"invalid_request"});if(n.revoked)throw await e.context.adapter.deleteMany({model:"oauthRefreshToken",where:[{field:"clientId",value:i},{field:"userId",value:n.userId}]}),new iH("BAD_REQUEST",{error_description:"refresh token revoked",error:"invalid_request"});if(!n.clientId||n.clientId!==i)return null;let o=Math.floor(Date.now()/1e3);await Promise.allSettled([e.context.adapter.deleteMany({model:"oauthAccessToken",where:[{field:"refreshId",value:n.id}]}),e.context.adapter.update({model:"oauthRefreshToken",where:[{field:"id",value:n.id}],update:{revoked:new Date(1e3*o)}})])}async function cO(e,t,r,i){try{return await cS(e,t,i)}catch(e){if(e instanceof iH);else if(e instanceof Error)throw e;else throw Error(e)}try{return await cx(e,t,i,r)}catch(e){if(e instanceof iH);else if(e instanceof Error)throw e;else throw Error("Unknown error validating access token")}throw new iH("BAD_REQUEST",{error_description:"Invalid access token",error:"invalid_request"})}async function cD(e,t){let{client_id:r,client_secret:i,token:n,token_type_hint:o}=e.body,a=e.request?.headers.get("authorization")||null;if(a?.startsWith("Basic ")){let e=sc(a);r=e?.client_id,i=e?.client_secret}if(!r)throw new iH("UNAUTHORIZED",{error_description:"missing required credentials",error:"invalid_client"});if("string"==typeof n&&n.startsWith("Bearer ")&&(n=n.replace("Bearer ","")),!n?.length)throw new iH("BAD_REQUEST",{error_description:"missing a required token for introspection",error:"invalid_request"});let s=await sd(e,t,r,i);try{if(void 0===o||"access_token"===o)try{return await cO(e,t,s.clientId,n)}catch(e){if(e instanceof iH){if("access_token"===o)throw e}else if(e instanceof Error)throw e;else throw Error(e)}if(void 0===o||"refresh_token"===o)try{return await cU(e,t,(await s8(t,n)).token,s.clientId)}catch(e){if(e instanceof iH){if("refresh_token"===o)throw e}else if(e instanceof Error)throw e;else throw Error(e)}throw new iH("BAD_REQUEST",{error_description:"token not found",error:"invalid_request"})}catch(e){if(e instanceof iH){if("BAD_REQUEST"===e.name)return null;throw e}if(e instanceof Error)throw os.logger.error("Introspection error:",e.message,e.stack),new iH("INTERNAL_SERVER_ERROR");throw os.logger.error("Introspection error:",e),new iH("INTERNAL_SERVER_ERROR")}}let cC={oauthClient:{modelName:"oauthClient",fields:{clientId:{type:"string",unique:!0,required:!0},clientSecret:{type:"string",required:!1},disabled:{type:"boolean",defaultValue:!1,required:!1},skipConsent:{type:"boolean",required:!1},enableEndSession:{type:"boolean",required:!1},scopes:{type:"string[]",required:!1},userId:{type:"string",required:!1,references:{model:"user",field:"id"}},createdAt:{type:"date",required:!1},updatedAt:{type:"date",required:!1},name:{type:"string",required:!1},uri:{type:"string",required:!1},icon:{type:"string",required:!1},contacts:{type:"string[]",required:!1},tos:{type:"string",required:!1},policy:{type:"string",required:!1},softwareId:{type:"string",required:!1},softwareVersion:{type:"string",required:!1},softwareStatement:{type:"string",required:!1},redirectUris:{type:"string[]",required:!0},postLogoutRedirectUris:{type:"string[]",required:!1},tokenEndpointAuthMethod:{type:"string",required:!1},grantTypes:{type:"string[]",required:!1},responseTypes:{type:"string[]",required:!1},public:{type:"boolean",required:!1},type:{type:"string",required:!1},referenceId:{type:"string",required:!1},metadata:{type:"json",required:!1}}},oauthRefreshToken:{fields:{token:{type:"string",required:!0},clientId:{type:"string",required:!0,references:{model:"oauthClient",field:"clientId"}},sessionId:{type:"string",required:!1,references:{model:"session",field:"id",onDelete:"set null"}},userId:{type:"string",required:!0,references:{model:"user",field:"id"}},referenceId:{type:"string",required:!1},expiresAt:{type:"date"},createdAt:{type:"date"},revoked:{type:"date",required:!1},scopes:{type:"string[]",required:!0}}},oauthAccessToken:{modelName:"oauthAccessToken",fields:{token:{type:"string",unique:!0},clientId:{type:"string",required:!0,references:{model:"oauthClient",field:"clientId"}},sessionId:{type:"string",required:!1,references:{model:"session",field:"id",onDelete:"set null"}},userId:{type:"string",required:!1,references:{model:"user",field:"id"}},referenceId:{type:"string",required:!1},refreshId:{type:"string",required:!1,references:{model:"oauthRefreshToken",field:"id"}},expiresAt:{type:"date"},createdAt:{type:"date"},scopes:{type:"string[]",required:!0}}},oauthConsent:{modelName:"oauthConsent",fields:{clientId:{type:"string",required:!0,references:{model:"oauthClient",field:"clientId"}},userId:{type:"string",required:!1,references:{model:"user",field:"id"}},referenceId:{type:"string",required:!1},scopes:{type:"string[]",required:!0},createdAt:{type:"date"},updatedAt:{type:"date"}}}},cN=J(()=>null);e.i(79549);var cP=e.i(83745),cL=e.i(74592);let cj=async e=>{let t=await rW("SHA-256").digest(new TextEncoder().encode(e));return rK.encode(new Uint8Array(t),{padding:!1})},cq="better-auth-secret-12345678901234567890";function cB(e){return!!e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof e.then}async function cH(e){let t=e.options,r=t.plugins||[],i=e,n=[];for(let e of r)if(e.init){let r,o=e.init(i);if("object"==typeof(r=cB(o)?await o:o)){if(r.options){let{databaseHooks:e,...i}=r.options;e&&n.push(e),t=a2(t,i)}r.context&&(i={...i,...r.context})}}return n.push(t.databaseHooks),i.internalAdapter=og(i.adapter,{options:t,logger:i.logger,hooks:n.filter(e=>void 0!==e),generateId:i.generateId}),i.options=t,{context:i}}async function c$(e,t){let r=nF(e.baseURL,e.basePath),i=r?[new URL(r).origin]:[];if(e.trustedOrigins&&(Array.isArray(e.trustedOrigins)&&i.push(...e.trustedOrigins),"function"==typeof e.trustedOrigins)){let r=await e.trustedOrigins(t);i.push(...r)}let n=nD.env.BETTER_AUTH_TRUSTED_ORIGINS;return n&&i.push(...n.split(",")),i.filter(e=>!!e)}async function cM(){if(n)return n;try{let e="u">typeof process&&"function"==typeof process.cwd?process.cwd():"";if(!e)return;let[{default:t},{default:r}]=await Promise.all([Function("mm","return import(mm)")("fs/promises"),Function("mm","return import(mm)")("path")]),i=await t.readFile(r.join(e,"package.json"),"utf-8");return n=JSON.parse(i)}catch{}}async function cz(e){if(n)return n.dependencies?.[e]||n.devDependencies?.[e]||n.peerDependencies?.[e];try{let t="u">typeof process&&"function"==typeof process.cwd?process.cwd():"";if(!t)throw Error("no-cwd");let[{default:r},{default:i}]=await Promise.all([Function("mm","return import(mm)")("fs/promises"),Function("mm","return import(mm)")("path")]),n=i.join(t,"node_modules",e,"package.json"),o=await r.readFile(n,"utf-8");return JSON.parse(o).version||await cV(e)||void 0}catch{}return await cV(e)}async function cV(e){let t=await cM();if(t)return({...t.dependencies,...t.devDependencies,...t.peerDependencies})[e]}async function cK(){return(await cM())?.name}let cW={pg:"postgresql",mysql:"mysql",mariadb:"mariadb",sqlite3:"sqlite","better-sqlite3":"sqlite","@prisma/client":"prisma",mongoose:"mongodb",mongodb:"mongodb","drizzle-orm":"drizzle"};async function cF(){for(let[e,t]of Object.entries(cW)){let r=await cz(e);if(r)return{name:t,version:r}}}let cZ={next:"next",nuxt:"nuxt","@remix-run/server-runtime":"remix",astro:"astro","@sveltejs/kit":"sveltekit","solid-start":"solid-start","tanstack-start":"tanstack-start",hono:"hono",express:"express",elysia:"elysia",expo:"expo"};async function cJ(){for(let[e,t]of Object.entries(cZ)){let r=await cz(e);if(r)return{name:t,version:r}}}function cG(){let e=(...e)=>e.some(e=>!!nD.env[e]);return e("CF_PAGES","CF_PAGES_URL","CF_ACCOUNT_ID")||"u">typeof navigator&&"Cloudflare-Workers"===navigator.userAgent?"cloudflare":e("VERCEL","VERCEL_URL","VERCEL_ENV")?"vercel":e("NETLIFY","NETLIFY_URL")?"netlify":e("RENDER","RENDER_URL","RENDER_INTERNAL_HOSTNAME","RENDER_SERVICE_ID")?"render":e("AWS_LAMBDA_FUNCTION_NAME","AWS_EXECUTION_ENV","LAMBDA_TASK_ROOT")?"aws":e("GOOGLE_CLOUD_FUNCTION_NAME","GOOGLE_CLOUD_PROJECT","GCP_PROJECT","K_SERVICE")?"gcp":e("AZURE_FUNCTION_NAME","FUNCTIONS_WORKER_RUNTIME","WEBSITE_INSTANCE_ID","WEBSITE_SITE_NAME")?"azure":e("DENO_DEPLOYMENT_ID","DENO_REGION")?"deno-deploy":e("FLY_APP_NAME","FLY_REGION","FLY_ALLOC_ID")?"fly-io":e("RAILWAY_STATIC_URL","RAILWAY_ENVIRONMENT_NAME")?"railway":e("DYNO","HEROKU_APP_NAME")?"heroku":e("DO_DEPLOYMENT_ID","DO_APP_NAME","DIGITALOCEAN")?"digitalocean":e("KOYEB","KOYEB_DEPLOYMENT_ID","KOYEB_APP_NAME")?"koyeb":null}async function cY(){try{if("cloudflare"===cG())return"cloudflare";let e=await Function("mm","return import(mm)")("os"),t=e.cpus();return{deploymentVendor:cG(),systemPlatform:e.platform(),systemRelease:e.release(),systemArchitecture:e.arch(),cpuCount:t.length,cpuModel:t.length?t[0].model:null,cpuSpeed:t.length?t[0].speed:null,memory:e.totalmem(),isWSL:await c1(),isDocker:await c0(),isTTY:"u">typeof process&&process.stdout?process.stdout.isTTY:null}}catch{return{systemPlatform:null,systemRelease:null,systemArchitecture:null,cpuCount:null,cpuModel:null,cpuSpeed:null,memory:null,isWSL:null,isDocker:null,isTTY:null}}}async function cQ(){if("cloudflare"===cG())return!1;try{return(await Function("mm","return import(mm)")("fs")).statSync("/.dockerenv"),!0}catch{return!1}}async function cX(){if("cloudflare"===cG())return!1;try{return(await Function("mm","return import(mm)")("fs")).readFileSync("/proc/self/cgroup","utf8").includes("docker")}catch{return!1}}async function c0(){return"cloudflare"!==cG()&&(void 0===o&&(o=await cQ()||await cX()),o)}async function c1(){try{if("cloudflare"===cG()||"u"<typeof process||process?.platform!=="linux")return!1;let e=await Function("mm","return import(mm)")("fs");if((await Function("mm","return import(mm)")("os")).release().toLowerCase().includes("microsoft")){if(await c5())return!1;return!0}return!!e.readFileSync("/proc/version","utf8").toLowerCase().includes("microsoft")&&!await c5()}catch{return!1}}let c2=async()=>{if("cloudflare"===cG())return!1;try{return(await Function("mm","return import(mm)")("fs")).statSync("/run/.containerenv"),!0}catch{return!1}};async function c5(){return void 0===a&&(a=await c2()||await c0()),a}async function c6(e){let t=await rW("SHA-256").digest(e);return rV.encode(t)}let c3=null;async function c8(e){if(c3)return c3;let t=await cK();return t?c3=await c6(e?e+t:t):e?c3=await c6(e):c3=(0,er.createRandomStringGenerator)("a-z","A-Z","0-9")(32)}async function c4(e,t){let r,i=e.telemetry?.debug||(0,nD.getBooleanEnvVar)("BETTER_AUTH_TELEMETRY_DEBUG",!1),n=nD.ENV.BETTER_AUTH_TELEMETRY_ENDPOINT,o=async e=>{t?.customTrack?await t.customTrack(e).catch(os.logger.error):i?os.logger.info("telemetry event",JSON.stringify(e,null,2)):await an(n,{method:"POST",body:e}).catch(os.logger.error)},a=async()=>{let r=e.telemetry?.enabled!==void 0&&e.telemetry.enabled;return((0,nD.getBooleanEnvVar)("BETTER_AUTH_TELEMETRY",!1)||r)&&(t?.skipTestCheck||!(0,nD.isTest)())},s=await a();s&&(r=await c8(e.baseURL),o({type:"init",payload:{config:{database:t?.database,adapter:t?.adapter,emailVerification:{sendVerificationEmail:!!e.emailVerification?.sendVerificationEmail,sendOnSignUp:!!e.emailVerification?.sendOnSignUp,sendOnSignIn:!!e.emailVerification?.sendOnSignIn,autoSignInAfterVerification:!!e.emailVerification?.autoSignInAfterVerification,expiresIn:e.emailVerification?.expiresIn,onEmailVerification:!!e.emailVerification?.onEmailVerification,afterEmailVerification:!!e.emailVerification?.afterEmailVerification},emailAndPassword:{enabled:!!e.emailAndPassword?.enabled,disableSignUp:!!e.emailAndPassword?.disableSignUp,requireEmailVerification:!!e.emailAndPassword?.requireEmailVerification,maxPasswordLength:e.emailAndPassword?.maxPasswordLength,minPasswordLength:e.emailAndPassword?.minPasswordLength,sendResetPassword:!!e.emailAndPassword?.sendResetPassword,resetPasswordTokenExpiresIn:e.emailAndPassword?.resetPasswordTokenExpiresIn,onPasswordReset:!!e.emailAndPassword?.onPasswordReset,password:{hash:!!e.emailAndPassword?.password?.hash,verify:!!e.emailAndPassword?.password?.verify},autoSignIn:!!e.emailAndPassword?.autoSignIn,revokeSessionsOnPasswordReset:!!e.emailAndPassword?.revokeSessionsOnPasswordReset},socialProviders:Object.keys(e.socialProviders||{}).map(t=>{let r=e.socialProviders?.[t];return r?{id:t,mapProfileToUser:!!r.mapProfileToUser,disableDefaultScope:!!r.disableDefaultScope,disableIdTokenSignIn:!!r.disableIdTokenSignIn,disableImplicitSignUp:r.disableImplicitSignUp,disableSignUp:r.disableSignUp,getUserInfo:!!r.getUserInfo,overrideUserInfoOnSignIn:!!r.overrideUserInfoOnSignIn,prompt:r.prompt,verifyIdToken:!!r.verifyIdToken,scope:r.scope,refreshAccessToken:!!r.refreshAccessToken}:{}}),plugins:e.plugins?.map(e=>e.id.toString()),user:{modelName:e.user?.modelName,fields:e.user?.fields,additionalFields:e.user?.additionalFields,changeEmail:{enabled:e.user?.changeEmail?.enabled,sendChangeEmailVerification:!!e.user?.changeEmail?.sendChangeEmailVerification}},verification:{modelName:e.verification?.modelName,disableCleanup:e.verification?.disableCleanup,fields:e.verification?.fields},session:{modelName:e.session?.modelName,additionalFields:e.session?.additionalFields,cookieCache:{enabled:e.session?.cookieCache?.enabled,maxAge:e.session?.cookieCache?.maxAge,strategy:e.session?.cookieCache?.strategy},disableSessionRefresh:e.session?.disableSessionRefresh,expiresIn:e.session?.expiresIn,fields:e.session?.fields,freshAge:e.session?.freshAge,preserveSessionInDatabase:e.session?.preserveSessionInDatabase,storeSessionInDatabase:e.session?.storeSessionInDatabase,updateAge:e.session?.updateAge},account:{modelName:e.account?.modelName,fields:e.account?.fields,encryptOAuthTokens:e.account?.encryptOAuthTokens,updateAccountOnSignIn:e.account?.updateAccountOnSignIn,accountLinking:{enabled:e.account?.accountLinking?.enabled,trustedProviders:e.account?.accountLinking?.trustedProviders,updateUserInfoOnLink:e.account?.accountLinking?.updateUserInfoOnLink,allowUnlinkingAll:e.account?.accountLinking?.allowUnlinkingAll}},hooks:{after:!!e.hooks?.after,before:!!e.hooks?.before},secondaryStorage:!!e.secondaryStorage,advanced:{cookiePrefix:!!e.advanced?.cookiePrefix,cookies:!!e.advanced?.cookies,crossSubDomainCookies:{domain:!!e.advanced?.crossSubDomainCookies?.domain,enabled:e.advanced?.crossSubDomainCookies?.enabled,additionalCookies:e.advanced?.crossSubDomainCookies?.additionalCookies},database:{useNumberId:!!e.advanced?.database?.useNumberId||e.advanced?.database?.generateId==="serial",generateId:e.advanced?.database?.generateId,defaultFindManyLimit:e.advanced?.database?.defaultFindManyLimit},useSecureCookies:e.advanced?.useSecureCookies,ipAddress:{disableIpTracking:e.advanced?.ipAddress?.disableIpTracking,ipAddressHeaders:e.advanced?.ipAddress?.ipAddressHeaders},disableCSRFCheck:e.advanced?.disableCSRFCheck,cookieAttributes:{expires:e.advanced?.defaultCookieAttributes?.expires,secure:e.advanced?.defaultCookieAttributes?.secure,sameSite:e.advanced?.defaultCookieAttributes?.sameSite,domain:!!e.advanced?.defaultCookieAttributes?.domain,path:e.advanced?.defaultCookieAttributes?.path,httpOnly:e.advanced?.defaultCookieAttributes?.httpOnly}},trustedOrigins:e.trustedOrigins?.length,rateLimit:{storage:e.rateLimit?.storage,modelName:e.rateLimit?.modelName,window:e.rateLimit?.window,customStorage:!!e.rateLimit?.customStorage,enabled:e.rateLimit?.enabled,max:e.rateLimit?.max},onAPIError:{errorURL:e.onAPIError?.errorURL,onError:!!e.onAPIError?.onError,throw:e.onAPIError?.throw},logger:{disabled:e.logger?.disabled,level:e.logger?.level,log:!!e.logger?.log},databaseHooks:{user:{create:{after:!!e.databaseHooks?.user?.create?.after,before:!!e.databaseHooks?.user?.create?.before},update:{after:!!e.databaseHooks?.user?.update?.after,before:!!e.databaseHooks?.user?.update?.before}},session:{create:{after:!!e.databaseHooks?.session?.create?.after,before:!!e.databaseHooks?.session?.create?.before},update:{after:!!e.databaseHooks?.session?.update?.after,before:!!e.databaseHooks?.session?.update?.before}},account:{create:{after:!!e.databaseHooks?.account?.create?.after,before:!!e.databaseHooks?.account?.create?.before},update:{after:!!e.databaseHooks?.account?.update?.after,before:!!e.databaseHooks?.account?.update?.before}},verification:{create:{after:!!e.databaseHooks?.verification?.create?.after,before:!!e.databaseHooks?.verification?.create?.before},update:{after:!!e.databaseHooks?.verification?.update?.after,before:!!e.databaseHooks?.verification?.update?.before}}}},runtime:"u">typeof Deno?{name:"deno",version:Deno?.version?.deno??null}:"u">typeof Bun?{name:"bun",version:Bun?.version??null}:"u">typeof process&&process?.versions?.node?{name:"node",version:process.versions.node??null}:{name:"edge",version:null},database:await cF(),framework:await cJ(),environment:"production"===(0,nD.getEnvVar)("NODE_ENV")?"production":"false"!==nD.env.CI&&("BUILD_ID"in nD.env||"BUILD_NUMBER"in nD.env||"CI"in nD.env||"CI_APP_ID"in nD.env||"CI_BUILD_ID"in nD.env||"CI_BUILD_NUMBER"in nD.env||"CI_NAME"in nD.env||"CONTINUOUS_INTEGRATION"in nD.env||"RUN_ID"in nD.env)?"ci":(0,nD.isTest)()?"test":"development",systemInfo:await cY(),packageManager:function(){let e=nD.env.npm_config_user_agent;if(!e)return;let t=e.split(" ")[0],r=t.lastIndexOf("/"),i=t.substring(0,r);return{name:"npminstall"===i?"cnpm":i,version:t.substring(r+1)}}()},anonymousId:r}));return{publish:async t=>{s&&(r||(r=await c8(e.baseURL)),await o({type:t.type,payload:t.payload,anonymousId:r}))}}}async function c9(e,t,r){var i,n;let o,a,s,c,d,l,u,p;t.database||(t=a2(t,{session:{cookieCache:{enabled:!0,strategy:"jwe",refreshCache:!0}},account:{storeStateStrategy:"cookie",storeAccountCookie:!0}}));let h=t.plugins||[],f=(i=t,i.advanced?.crossSubDomainCookies?.enabled,[]),m=(0,os.createLogger)(t.logger),g=nF(t.baseURL,t.basePath);g||m.warn("[better-auth] Base URL could not be determined. Please set a valid base URL using the baseURL config option or the BETTER_AUTH_BASE_URL environment variable. Without this, callbacks and redirects may not work correctly.");let y=t.secret||nD.env.BETTER_AUTH_SECRET||nD.env.AUTH_SECRET||cq,w=y===cq;if(!(0,nD.isTest)()){let e;if(w&&nD.isProduction)throw new rO.BetterAuthError("You are using the default secret. Please set `BETTER_AUTH_SECRET` in your environment variables or pass `secret` in your auth config.");if(!y)throw new rO.BetterAuthError("BETTER_AUTH_SECRET is missing. Set it in your environment or pass `secret` to betterAuth({ secret }).");y.length<32&&m.warn("[better-auth] Warning: your BETTER_AUTH_SECRET should be at least 32 characters long for adequate security. Generate one with `npx @better-auth/cli secret` or `openssl rand -base64 32`."),120>(0===(e=new Set(y).size)?0:Math.log2(Math.pow(e,y.length)))&&m.warn("[better-auth] Warning: your BETTER_AUTH_SECRET appears low-entropy. Use a randomly generated secret for production.")}!function(e,t){let r=new Map;e.plugins?.forEach(e=>{if(e.endpoints){for(let[t,i]of Object.entries(e.endpoints))if(i&&"path"in i&&"string"==typeof i.path){let n=i.path,o=[];i.options&&"method"in i.options&&(Array.isArray(i.options.method)?o=i.options.method:"string"==typeof i.options.method&&(o=[i.options.method])),0===o.length&&(o=["*"]),r.has(n)||r.set(n,[]),r.get(n).push({pluginId:e.id,endpointKey:t,methods:o})}}});let i=[];for(let[e,t]of r.entries())if(t.length>1){let r=new Map,n=!1;for(let e of t)for(let i of e.methods)r.has(i)||r.set(i,[]),r.get(i).push(e.pluginId),r.get(i).length>1&&(n=!0),"*"===i&&t.length>1?n=!0:"*"!==i&&r.has("*")&&(n=!0);if(n){let n=[...new Set(t.map(e=>e.pluginId))],o=[];for(let[e,i]of r.entries())(i.length>1||"*"===e&&t.length>1||"*"!==e&&r.has("*"))&&o.push(e);i.push({path:e,plugins:n,conflictingMethods:o})}}if(i.length>0){let e=i.map(e=>`  - "${e.path}" [${e.conflictingMethods.join(", ")}] used by plugins: ${e.plugins.join(", ")}`).join("\n");t.error(`Endpoint path conflicts detected! Multiple plugins are trying to use the same endpoint paths with conflicting HTTP methods:
${e}

To resolve this, you can:
	1. Use only one of the conflicting plugins
	2. Configure the plugins to use different paths (if supported)
	3. Ensure plugins use different HTTP methods for the same path
`)}}(t={...t,secret:y,baseURL:g?new URL(g).origin:"",basePath:t.basePath||"/api/auth",plugins:h.concat(f)},m);let b=(s=(a=nL(n=t))("session_token",{maxAge:n.session?.expiresIn||nU("7d")}),c=a("session_data",{maxAge:n.session?.cookieCache?.maxAge||300}),d=a("account_data",{maxAge:n.session?.cookieCache?.maxAge||300}),l=a("dont_remember"),{sessionToken:{name:s.name,attributes:s.attributes},sessionData:{name:c.name,attributes:c.attributes},dontRememberToken:{name:l.name,attributes:l.attributes},accountData:{name:d.name,attributes:d.attributes}}),E=(0,iI.getAuthTables)(t),_=Object.entries(t.socialProviders||{}).map(([e,t])=>{if(null==t||!1===t.enabled)return null;t.clientId||m.warn(`Social provider ${e} is missing clientId or clientSecret`);let r=aT[e](t);return r.disableImplicitSignUp=t.disableImplicitSignUp,r}).filter(e=>null!==e),A=({model:e,size:r})=>"function"==typeof t.advanced?.generateId?t.advanced.generateId({model:e,size:r}):"function"==typeof t?.advanced?.database?.generateId?t.advanced.database.generateId({model:e,size:r}):(0,om.generateId)(r),{publish:T}=await c4(t,{adapter:e.id,database:"function"==typeof t.database?"adapter":r(t.database)}),v=cH({appName:t.appName||"Better Auth",baseURL:g||"",version:B().version,socialProviders:_,options:t,oauthConfig:{storeStateStrategy:t.account?.storeStateStrategy||(t.database?"database":"cookie"),skipStateCookieCheck:!!t.account?.skipStateCookieCheck},tables:E,trustedOrigins:await c$(t),isTrustedOrigin(e,t){return this.trustedOrigins.some(r=>nQ(e,r,t))},sessionConfig:{updateAge:t.session?.updateAge!==void 0?t.session.updateAge:86400,expiresIn:t.session?.expiresIn||604800,freshAge:t.session?.freshAge===void 0?86400:t.session.freshAge,cookieRefreshCache:(u=t.session?.cookieCache?.refreshCache,p=t.session?.cookieCache?.maxAge||300,(t.database||t.secondaryStorage)&&u?(m.warn("[better-auth] `session.cookieCache.refreshCache` is enabled while `database` or `secondaryStorage` is configured. `refreshCache` is meant for stateless (DB-less) setups. Disabling `refreshCache`  remove it from your config to silence this warning."),!1):!1!==u&&void 0!==u&&(!0===u?{enabled:!0,updateAge:Math.floor(.2*p)}:{enabled:!0,updateAge:void 0!==u.updateAge?u.updateAge:Math.floor(.2*p)}))},secret:y,rateLimit:{...t.rateLimit,enabled:t.rateLimit?.enabled??nD.isProduction,window:t.rateLimit?.window||10,max:t.rateLimit?.max||100,storage:t.rateLimit?.storage||(t.secondaryStorage?"secondary-storage":"memory")},authCookies:b,logger:m,generateId:A,session:null,secondaryStorage:t.secondaryStorage,password:{hash:t.emailAndPassword?.password?.hash||rq,verify:t.emailAndPassword?.password?.verify||rB,config:{minPasswordLength:t.emailAndPassword?.minPasswordLength||8,maxPasswordLength:t.emailAndPassword?.maxPasswordLength||128},checkPassword:aB},setNewSession(e){this.newSession=e},newSession:null,adapter:e,internalAdapter:og(e,{options:t,logger:m,hooks:t.databaseHooks?[t.databaseHooks]:[],generateId:A}),createAuthCookie:nL(t),async runMigrations(){throw new rO.BetterAuthError("runMigrations will be set by the specific init implementation")},publishTelemetry:T,skipCSRFCheck:!!t.advanced?.disableCSRFCheck,skipOriginCheck:t.advanced?.disableOriginCheck!==void 0?t.advanced.disableOriginCheck:!!(0,nD.isTest)(),runInBackground:t.advanced?.backgroundTasks?.handler??(e=>{e.catch(()=>{})}),async runInBackgroundOrAwait(e){try{t.advanced?.backgroundTasks?.handler?e instanceof Promise&&t.advanced.backgroundTasks.handler(e.catch(e=>{m.error("Failed to run background task:",e)})):await e}catch(e){m.error("Failed to run background task:",e)}},getPlugin:e=>t.plugins.find(t=>t.id===e)??null});return cB(v)?{context:o}=await v:{context:o}=v,"function"==typeof o.options.emailVerification?.onEmailVerification&&(o.options.emailVerification.onEmailVerification=(0,n0.deprecate)(o.options.emailVerification.onEmailVerification,"Use `afterEmailVerification` instead. This will be removed in 1.5",o.logger)),o}let c7=async e=>{let t=await od(e),r=await c9(t,e,e=>(0,oE.getKyselyDatabaseType)(e)||"unknown");return r.runMigrations=async function(){if(!e.database||"updateMany"in e.database)throw new rO.BetterAuthError("Database is not provided or it's an adapter. Migrations are only supported with a database instance.");let{runMigrations:t}=await oI(e);await t()},r};var de=e.i(46786),dt=e.i(22734);let dr=new Map,di=new Map,dn=Symbol("OriginError"),da={};class ds extends Promise{constructor(e,t,r,i,n={}){let o,a;super((e,t)=>{o=e,a=t}),this.tagged=Array.isArray(e.raw),this.strings=e,this.args=t,this.handler=r,this.canceller=i,this.options=n,this.state=null,this.statement=null,this.resolve=e=>(this.active=!1,o(e)),this.reject=e=>(this.active=!1,a(e)),this.active=!1,this.cancelled=null,this.executed=!1,this.signature="",this[dn]=this.handler.debug?Error():this.tagged&&function(e){if(dr.has(e))return dr.get(e);let t=Error.stackTraceLimit;return Error.stackTraceLimit=4,dr.set(e,Error()),Error.stackTraceLimit=t,dr.get(e)}(this.strings)}get origin(){return(this.handler.debug?this[dn].stack:this.tagged&&di.has(this.strings)?di.get(this.strings):di.set(this.strings,this[dn].stack).get(this.strings))||""}static get[Symbol.species](){return Promise}cancel(){return this.canceller&&(this.canceller(this),this.canceller=null)}simple(){return this.options.simple=!0,this.options.prepare=!1,this}async readable(){return this.simple(),this.streaming=!0,this}async writable(){return this.simple(),this.streaming=!0,this}cursor(e=1,t){let r;return(this.options.simple=!1,"function"==typeof e&&(t=e,e=1),this.cursorRows=e,"function"==typeof t)?(this.cursorFn=t,this):{[Symbol.asyncIterator]:()=>({next:()=>{if(this.executed&&!this.active)return{done:!0};r&&r();let e=new Promise((e,t)=>{this.cursorFn=t=>(e({value:t,done:!1}),new Promise(e=>r=e)),this.resolve=()=>(this.active=!1,e({done:!0})),this.reject=e=>(this.active=!1,t(e))});return this.execute(),e},return:()=>(r&&r(da),{done:!0})})}}describe(){return this.options.simple=!1,this.onlyDescribe=this.options.prepare=!0,this}stream(){throw Error(".stream has been renamed to .forEach")}forEach(e){return this.forEachFn=e,this.handle(),this}raw(){return this.isRaw=!0,this}values(){return this.isRaw="values",this}async handle(){!this.executed&&(this.executed=!0)&&await 1&&this.handler(this)}execute(){return this.handle(),this}then(){return this.handle(),super.then.apply(this,arguments)}catch(){return this.handle(),super.catch.apply(this,arguments)}finally(){return this.handle(),super.finally.apply(this,arguments)}}class dc extends Error{constructor(e){super(e.message),this.name=this.constructor.name,Object.assign(this,e)}}let dd=function e(t,r,i){let{host:n,port:o}=i||r,a=Object.assign(Error("write "+t+" "+(r.path||n+":"+o)),{code:t,errno:t,address:r.path||n},r.path?{}:{port:o});return Error.captureStackTrace(a,e),a},dl=function e(t){let r=new dc(t);return Error.captureStackTrace(r,e),r},du=function e(t,r){let i=Object.assign(Error(t+": "+r),{code:t});return Error.captureStackTrace(i,e),i},dp=function e(t){let r=Object.assign(Error(t+" (B) is not supported"),{code:"MESSAGE_NOT_SUPPORTED",name:t});return Error.captureStackTrace(r,e),r};class dh{then(){dR()}catch(){dR()}finally(){dR()}}class df extends dh{constructor(e){super(),this.value=dD(e)}}class dm extends dh{constructor(e,t,r){super(),this.value=e,this.type=t,this.array=r}}class dg extends dh{constructor(e,t){super(),this.first=e,this.rest=t}build(e,t,r,i){let n=dk.map(([t,r])=>({fn:r,i:e.search(t)})).sort((e,t)=>e.i-t.i).pop();return -1===n.i?dO(this.first,i):n.fn(this.first,this.rest,t,r,i)}}function dy(e,t,r,i){let n=e instanceof dm?e.value:e;if(void 0===n&&(e instanceof dm?e.value=i.transform.undefined:n=e=i.transform.undefined,void 0===n))throw du("UNDEFINED_VALUE","Undefined values are not allowed");return"$"+r.push(e instanceof dm?(t.push(e.value),e.array?e.array[e.type||dC(e.value)]||e.type||function e(t){return Array.isArray(t)?e(t[0]):1009*("string"==typeof t)}(e.value):e.type):(t.push(e),dC(e)))}let dw=dU({string:{to:25,from:null,serialize:e=>""+e},number:{to:0,from:[21,23,26,700,701],serialize:e=>""+e,parse:e=>+e},json:{to:114,from:[114,3802],serialize:e=>JSON.stringify(e),parse:e=>JSON.parse(e)},boolean:{to:16,from:16,serialize:e=>!0===e?"t":"f",parse:e=>"t"===e},date:{to:1184,from:[1082,1114,1184],serialize:e=>(e instanceof Date?e:new Date(e)).toISOString(),parse:e=>new Date(e)},bytea:{to:17,from:17,serialize:e=>"\\x"+Buffer.from(e).toString("hex"),parse:e=>Buffer.from(e.slice(2),"hex")}});function db(e,t,r,i,n,o){for(let a=1;a<e.strings.length;a++)t+=dE(t,r,i,n,o)+e.strings[a],r=e.args[a];return t}function dE(e,t,r,i,n){return t instanceof dg?t.build(e,r,i,n):t instanceof ds?d_(t,r,i,n):t instanceof df?t.value:t&&t[0]instanceof ds?t.reduce((e,t)=>e+" "+d_(t,r,i,n),""):dy(t,r,i,n)}function d_(e,t,r,i){return e.fragment=!0,db(e,e.strings[0],e.args[0],t,r,i)}function dA(e,t,r,i,n){return e.map(e=>"("+i.map(i=>dE("values",e[i],t,r,n)).join(",")+")").join(",")}function dT(e,t,r,i,n){let o=Array.isArray(e[0]),a=t.length?t.flat():Object.keys(o?e[0]:e);return dA(o?e:[e],r,i,a,n)}function dv(e,t,r,i,n){let o;return("string"==typeof e&&(e=[e].concat(t)),Array.isArray(e))?dO(e,n):(t.length?t.flat():Object.keys(e)).map(t=>((o=e[t])instanceof ds?d_(o,r,i,n):o instanceof df?o.value:dy(o,r,i,n))+" as "+dD(n.transform.column.to?n.transform.column.to(t):t)).join(",")}let dk=Object.entries({values:dT,in:(...e)=>{let t=dT(...e);return"()"===t?"(null)":t},select:dv,as:dv,returning:dv,"\\(":dv,update:(e,t,r,i,n)=>(t.length?t.flat():Object.keys(e)).map(t=>dD(n.transform.column.to?n.transform.column.to(t):t)+"="+dE("values",e[t],r,i,n)),insert(e,t,r,i,n){let o=t.length?t.flat():Object.keys(Array.isArray(e)?e[0]:e);return"("+dO(o,n)+")values"+dA(Array.isArray(e)?e:[e],r,i,o,n)}}).map(([e,t])=>[RegExp("((?:^|[\\s(])"+e+"(?:$|[\\s(]))(?![\\s\\S]*\\1)","i"),t]);function dR(){throw du("NOT_TAGGED_CALL","Query not called as a tagged template literal")}let dI=dw.serializers,dS=dw.parsers,dx=function(e){let t=dU(e||{});return{serializers:Object.assign({},dI,t.serializers),parsers:Object.assign({},dS,t.parsers)}};function dU(e){return Object.keys(e).reduce((t,r)=>(e[r].from&&[].concat(e[r].from).forEach(i=>t.parsers[i]=e[r].parse),e[r].serialize&&(t.serializers[e[r].to]=e[r].serialize,e[r].from&&[].concat(e[r].from).forEach(i=>t.serializers[i]=e[r].serialize)),t),{parsers:{},serializers:{}})}function dO(e,{transform:{column:t}}){return e.map(e=>dD(t.to?t.to(e):e)).join(",")}let dD=function(e){return'"'+e.replace(/"/g,'""').replace(/\./g,'"."')+'"'},dC=function e(t){return t instanceof dm?t.type:t instanceof Date?1184:t instanceof Uint8Array?17:!0===t||!1===t?16:"bigint"==typeof t?20:Array.isArray(t)?e(t[0]):0},dN=/\\/g,dP=/"/g,dL=function e(t,r,i,n){if(!1===Array.isArray(t))return t;if(!t.length)return"{}";let o=t[0],a=1020===n?";":",";return Array.isArray(o)&&!o.type?"{"+t.map(t=>e(t,r,i,n)).join(a)+"}":"{"+t.map(e=>{if(void 0===e&&void 0===(e=i.transform.undefined))throw du("UNDEFINED_VALUE","Undefined values are not allowed");return null===e?"null":'"'+(r?r(e.type?e.value:e):""+e).replace(dN,"\\\\").replace(dP,'\\"')+'"'}).join(a)+"}"},dj={i:0,char:null,str:"",quoted:!1,last:0},dq=e=>{let t=e[0];for(let r=1;r<e.length;r++)t+="_"===e[r]?e[++r].toUpperCase():e[r];return t},dB=e=>{let t=e[0].toUpperCase();for(let r=1;r<e.length;r++)t+="_"===e[r]?e[++r].toUpperCase():e[r];return t},dH=e=>e.replace(/_/g,"-"),d$=e=>e.replace(/([A-Z])/g,"_$1").toLowerCase(),dM=e=>(e.slice(0,1)+e.slice(1).replace(/([A-Z])/g,"_$1")).toLowerCase(),dz=e=>e.replace(/-/g,"_");function dV(e){return function t(r,i){return"object"==typeof r&&null!==r&&(114===i.type||3802===i.type)?Array.isArray(r)?r.map(e=>t(e,i)):Object.entries(r).reduce((r,[n,o])=>Object.assign(r,{[e(n)]:t(o,i)}),{}):r}}dq.column={from:dq},dq.value={from:dV(dq)},d$.column={to:d$};let dK={...dq};dK.column.to=d$,dB.column={from:dB},dB.value={from:dV(dB)},dM.column={to:dM};let dW={...dB};dW.column.to=dM,dH.column={from:dH},dH.value={from:dV(dH)},dz.column={to:dz};let dF={...dH};dF.column.to=dz;var dZ=e.i(4446),dJ=e.i(55004),dG=e.i(54799),dY=e.i(88947),dQ=e.i(60438);class dX extends Array{constructor(){super(),Object.defineProperties(this,{count:{value:null,writable:!0},state:{value:null,writable:!0},command:{value:null,writable:!0},columns:{value:null,writable:!0},statement:{value:null,writable:!0}})}static get[Symbol.species](){return Array}}let d0=function(e=[]){let t=e.slice(),r=0;return{get length(){return t.length-r},remove:e=>{let r=t.indexOf(e);return -1===r?null:(t.splice(r,1),e)},push:e=>(t.push(e),e),shift:()=>{let e=t[r++];return r===t.length?(r=0,t=[]):t[r-1]=void 0,e}}},d1=Buffer.allocUnsafe(256),d2=Object.assign(function(){return d2.i=0,d2},"BCcDdEFfHPpQSX".split("").reduce((e,t)=>{let r=t.charCodeAt(0);return e[t]=()=>(d1[0]=r,d2.i=5,d2),e},{}),{N:"\0",i:0,inc:e=>(d2.i+=e,d2),str(e){let t=Buffer.byteLength(e);return d5(t),d2.i+=d1.write(e,d2.i,t,"utf8"),d2},i16:e=>(d5(2),d1.writeUInt16BE(e,d2.i),d2.i+=2,d2),i32:(e,t)=>(t||0===t?d1.writeUInt32BE(e,t):(d5(4),d1.writeUInt32BE(e,d2.i),d2.i+=4),d2),z:e=>(d5(e),d1.fill(0,d2.i,d2.i+e),d2.i+=e,d2),raw:e=>(d1=Buffer.concat([d1.subarray(0,d2.i),e]),d2.i=d1.length,d2),end(e=1){d1.writeUInt32BE(d2.i-e,e);let t=d1.subarray(0,d2.i);return d2.i=0,d1=Buffer.allocUnsafe(256),t}});function d5(e){if(d1.length-d2.i<e){let t=d1,r=t.length;d1=Buffer.allocUnsafe(r+(r>>1)+e),t.copy(d1)}}let d6=function e(t,r={},{onopen:i=lt,onend:n=lt,onclose:o=lt}={}){let{sslnegotiation:a,ssl:s,max:c,user:d,host:l,port:u,database:p,parsers:h,transform:f,onnotice:m,onnotify:g,onparameter:y,max_pipeline:w,keep_alive:b,backoff:E,target_session_attrs:_}=t,A=d0(),T=d3++,v={pid:null,secret:null},k=ls(e_,t.idle_timeout),R=ls(e_,t.max_lifetime),I=ls(function(){eb(dd("CONNECT_TIMEOUT",t,S)),S.destroy()},t.connect_timeout),S=null,x,U=null,O=new dX,D=Buffer.alloc(0),C=t.fetch_types,N={},P={},L=Math.random().toString(36).slice(2),j=1,q=0,B=0,H=0,$=0,M=0,z=0,V=0,K=null,W=null,F=!1,Z=null,J=null,G=null,Y=null,Q=null,X=null,ee=null,et=null,er=null,ei=null,en={queue:r.closed,idleTimer:k,connect(e){G=e,eg()},terminate:eA,execute:es,cancel:ea,end:e_,count:0,id:T};return r.closed&&r.closed.push(en),en;async function eo(){let e;try{e=t.socket?await Promise.resolve(t.socket(t)):new dZ.default.Socket}catch(e){ew(e);return}return e.on("error",ew),e.on("close",eT),e.on("drain",eh),e}async function ea({pid:e,secret:t},r,i){try{x=d2().i32(16).i32(0x4d2162e).i32(e).i32(t).end(16),await em(),S.once("error",i),S.once("close",r)}catch(e){i(e)}}function es(e){if(F)return eE(e,dd("CONNECTION_DESTROYED",t));if(Q)return eE(e,du("COPY_IN_PROGRESS","You cannot execute queries during copy"));if(!e.cancelled)try{var r;let i,n,o;return e.state=v,er?A.push(e):(er=e).active=!0,r=e,i=[],n=[],o=db(r,r.strings[0],r.args[0],i,n,t),r.tagged||r.args.forEach(e=>dy(e,i,n,t)),r.prepare=t.prepare&&(!("prepare"in r.options)||r.options.prepare),r.string=o,r.signature=r.prepare&&n+o,r.onlyDescribe&&delete P[r.signature],r.parameters=r.parameters||i,r.prepared=r.prepare&&r.signature in P,r.describeFirst=r.onlyDescribe||i.length&&!r.prepared,r.statement=r.prepared?P[r.signature]:{string:o,types:n,name:r.prepare?L+j++:""},"function"==typeof t.debug&&t.debug(T,o,i,n),el(function(e){var t;if(e.parameters.length>=65534)throw du("MAX_PARAMETERS_EXCEEDED","Max number of parameters (65534) exceeded");return e.options.simple?d2().Q().str(e.statement.string+d2.N).end():e.describeFirst?Buffer.concat([ec(e),d4]):e.prepare?e.prepared?ed(e):Buffer.concat([ec(e),ed(e)]):(t=e,Buffer.concat([eC(t.statement.string,t.parameters,t.statement.types),le,ed(t)]))}(e))&&!e.describeFirst&&!e.cursorFn&&A.length<w&&(!e.options.onexecute||e.options.onexecute(en))}catch(e){return 0===A.length&&el(d8),eb(e),!0}}function ec(e){return Buffer.concat([eC(e.statement.string,e.parameters,e.statement.types,e.statement.name),function(e,t=""){return d2().D().str("S").str(t+d2.N).end()}("S",e.statement.name)])}function ed(e){return Buffer.concat([function(e,r,i="",n=""){let o,a;return d2().B().str(n+d2.N).str(i+d2.N).i16(0).i16(e.length),e.forEach((i,n)=>{if(null===i)return d2.i32(0xffffffff);a=r[n],e[n]=i=a in t.serializers?t.serializers[a](i):""+i,o=d2.i,d2.inc(4).str(i).i32(d2.i-o-4,o)}),d2.i16(0),d2.end()}(e.parameters,e.statement.types,e.statement.name,e.cursorName),e.cursorFn?eN("",e.cursorRows):d7])}function el(e,t){return(X=X?Buffer.concat([X,e]):Buffer.from(e),t||X.length>=1024)?eu(t):(null===W&&(W=setImmediate(eu)),!0)}function eu(e){let t=S.write(X,e);return null!==W&&clearImmediate(W),X=W=null,t}async function ep(){if("direct"!==a&&(el(d9),!await new Promise(e=>S.once("data",t=>e(83===t[0])))&&"prefer"===s))return ey();let e={socket:S,servername:dZ.default.isIP(S.host)?void 0:S.host};"direct"===a&&(e.ALPNProtocols=["postgresql"]),"require"===s||"allow"===s||"prefer"===s?e.rejectUnauthorized=!1:"object"==typeof s&&Object.assign(e,s),S.removeAllListeners(),(S=dJ.default.connect(e)).on("secureConnect",ey),S.on("error",ew),S.on("close",eT),S.on("drain",eh)}function eh(){er||i(en)}function ef(r){if(!Z||(Z.push(r),!((B-=r.length)>0)))for(D=Z?Buffer.concat(Z,M-B):0===D.length?r:Buffer.concat([D,r],D.length+r.length);D.length>4;){if((M=D.readUInt32BE(1))>=D.length){B=M-D.length,Z=[D];break}try{!function(r,n=r[0]){(68===n?function(e){let t,r,i,n=7,o=er.isRaw?Array(er.statement.columns.length):{};for(let a=0;a<er.statement.columns.length;a++)r=er.statement.columns[a],t=e.readInt32BE(n),n+=4,i=-1===t?null:!0===er.isRaw?e.subarray(n,n+=t):void 0===r.parser?e.toString("utf8",n,n+=t):!0===r.parser.array?r.parser(e.toString("utf8",n+1,n+=t)):r.parser(e.toString("utf8",n,n+=t)),er.isRaw?o[a]=!0===er.isRaw?i:f.value.from?f.value.from(i,r):i:o[r.name]=f.value.from?f.value.from(i,r):i;er.forEachFn?er.forEachFn(f.row.from?f.row.from(o):o,O):O[V++]=f.row.from?f.row.from(o):o}:100===n?function(e){Q&&(Q.push(e.subarray(5))||S.pause())}:65===n?function(e){if(!g)return;let t=9;for(;0!==e[t++];);g(e.toString("utf8",9,t-1),e.toString("utf8",t,e.length-1))}:83===n?function(e){let[r,i]=e.toString("utf8",5,e.length-1).split(d2.N);N[r]=i,t.parameters[r]!==i&&(t.parameters[r]=i,y&&y(r,i))}:90===n?function(r){var n,o,a,s;if(er?U?er.retried?eb(er.retried):er.prepared&&lr.has(U.routine)?(n=er,o=U,delete P[n.signature],n.retried=o,es(n)):eb(U):er.resolve(J||O):U&&eb(U),er=J=U=null,O=new dX,I.cancel(),G){if(_)if(!N.in_hot_standby||!N.default_transaction_read_only)return function(){let e=new ds([`
      show transaction_read_only;
      select pg_catalog.pg_is_in_recovery()
    `],[],es,null,{simple:!0});e.resolve=([[e],[t]])=>{N.default_transaction_read_only=e.transaction_read_only,N.in_hot_standby=t.pg_is_in_recovery?"on":"off"},e.execute()}();else{if(a=_,s=N,"read-write"===a&&"on"===s.default_transaction_read_only||"read-only"===a&&"off"===s.default_transaction_read_only||"primary"===a&&"on"===s.in_hot_standby||"standby"===a&&"off"===s.in_hot_standby||"prefer-standby"===a&&"off"===s.in_hot_standby&&t.host[$])return eA()}return C?(G.reserve&&(G=null),eO()):(G&&!G.reserve&&es(G),t.shared.retries=$=0,void(G=null))}for(;A.length&&(er=A.shift())&&(er.active=!0,er.cancelled);)e(t).cancel(er.state,er.cancelled.resolve,er.cancelled.reject);er||(en.reserved?en.reserved.release||73!==r[5]?en.reserved():Y?eA():(en.reserved=null,i(en)):Y?eA():i(en))}:67===n?function(e){V=0;for(let t=e.length-1;t>0;t--)if(32===e[t]&&e[t+1]<58&&null===O.count&&(O.count=+e.toString("utf8",t+1,e.length-1)),e[t-1]>=65){O.command=e.toString("utf8",5,t),O.state=v;break}return(ei&&(ei(),ei=null),"BEGIN"!==O.command||1===c||en.reserved)?er.options.simple?ev():void(er.cursorFn&&(O.count&&er.cursorFn(O),el(d8))):eb(du("UNSAFE_TRANSACTION","Only use sql.begin, sql.reserved or max: 1"))}:50===n?ev:49===n?function(){er.parsing=!1}:116===n?function(e){let t=e.readUInt16BE(5);for(let r=0;r<t;++r)er.statement.types[r]||(er.statement.types[r]=e.readUInt32BE(7+4*r));er.prepare&&(P[er.signature]=er.statement),er.describeFirst&&!er.onlyDescribe&&(el(ed(er)),er.describeFirst=!1)}:84===n?function(e){let t;O.command&&((J=J||[O]).push(O=new dX),O.count=null,er.statement.columns=null);let r=e.readUInt16BE(5),i=7;er.statement.columns=Array(r);for(let n=0;n<r;++n){for(t=i;0!==e[i++];);let r=e.readUInt32BE(i),o=e.readUInt16BE(i+4),a=e.readUInt32BE(i+6);er.statement.columns[n]={name:f.column.from?f.column.from(e.toString("utf8",t,i-1)):e.toString("utf8",t,i-1),parser:h[a],table:r,number:o,type:a},i+=18}if(O.statement=er.statement,er.onlyDescribe)return er.resolve(er.statement),el(d8)}:82===n?ek:110===n?function(){if(O.statement=er.statement,O.statement.columns=[],er.onlyDescribe)return er.resolve(er.statement),el(d8)}:75===n?function(e){v.pid=e.readUInt32BE(5),v.secret=e.readUInt32BE(9)}:69===n?function(e){er?((er.cursorFn||er.describeFirst)&&el(d8),U=dl(ln(e))):eb(dl(ln(e)))}:115===n?eD:51===n?function(){O.count&&er.cursorFn(O),er.resolve(O)}:71===n?function(){Q=new dY.default.Writable({autoDestroy:!0,write(e,t,r){S.write(d2().d().raw(e).end(),r)},destroy(e,t){t(e),S.write(d2().f().str(e+d2.N).end()),Q=null},final(e){S.write(d2().c().end()),ei=e,Q=null}}),er.resolve(Q)}:78===n?function(e){m?m(ln(e)):console.log(ln(e))}:72===n?function(){Q=new dY.default.Readable({read(){S.resume()}}),er.resolve(Q)}:99===n?function(){Q&&Q.push(null),Q=null}:73===n?function(){}:86===n?function(){eb(dp("FunctionCallResponse"))}:118===n?function(){eb(dp("NegotiateProtocolVersion"))}:87===n?function(){Q=new dY.default.Duplex({autoDestroy:!0,read(){S.resume()},write(e,t,r){S.write(d2().d().raw(e).end(),r)},destroy(e,t){t(e),S.write(d2().f().str(e+d2.N).end()),Q=null},final(e){S.write(d2().c().end()),ei=e}}),er.resolve(Q)}:function(e){console.error("Postgres.js : Unknown Message:",e[0])})(r)}(D.subarray(0,M+1))}catch(e){er&&(er.cursorFn||er.describeFirst)&&el(d8),eb(e)}D=D.subarray(M+1),B=0,Z=null}}async function em(){if(F=!1,N={},S||(S=await eo()),S){if(I.start(),t.socket)return s?ep():ey();if(S.on("connect",s?ep:ey),t.path)return S.connect(t.path);S.ssl=s,S.connect(u[H],l[H]),S.host=l[H],S.port=u[H],H=(H+1)%u.length}}function eg(){setTimeout(em,q?Math.max(0,q+z-dQ.performance.now()):0)}function ey(){try{P={},C=t.fetch_types,L=Math.random().toString(36).slice(2),j=1,R.start(),S.on("data",ef),b&&S.setKeepAlive&&S.setKeepAlive(!0,1e3*b);let e=x||d2().inc(4).i16(3).z(2).str(Object.entries(Object.assign({user:d,database:p,client_encoding:"UTF8"},t.connection)).filter(([,e])=>e).map(([e,t])=>e+d2.N+t).join(d2.N)).z(2).end(0);el(e)}catch(e){ew(e)}}function ew(e){if(en.queue!==r.connecting||!t.host[$+1])for(eb(e);A.length;)eE(A.shift(),e)}function eb(e){Q&&(Q.destroy(e),Q=null),er&&eE(er,e),G&&(eE(G,e),G=null)}function eE(e,r){if(e.reserve)return e.reject(r);r&&"object"==typeof r||(r=Error(r)),"query"in r||"parameters"in r||Object.defineProperties(r,{stack:{value:r.stack+e.origin.replace(/.*\n/,"\n"),enumerable:t.debug},query:{value:e.string,enumerable:t.debug},parameters:{value:e.parameters,enumerable:t.debug},args:{value:e.args,enumerable:t.debug},types:{value:e.statement&&e.statement.types,enumerable:t.debug}}),e.reject(r)}function e_(){return Y||(en.reserved||n(en),en.reserved||G||er||0!==A.length?Y=new Promise(e=>ee=e):(eA(),new Promise(e=>S&&"closed"!==S.readyState?S.once("close",e):e())))}function eA(){F=!0,(Q||er||G||A.length)&&ew(dd("CONNECTION_DESTROYED",t)),clearImmediate(W),S&&(S.removeListener("data",ef),S.removeListener("connect",ey),"open"===S.readyState&&S.end(d2().X().end())),ee&&(ee(),Y=ee=null)}async function eT(e){if(D=Buffer.alloc(0),B=0,Z=null,clearImmediate(W),S.removeListener("data",ef),S.removeListener("connect",ey),k.cancel(),R.cancel(),I.cancel(),S.removeAllListeners(),S=null,G)return eg();!e&&(er||A.length)&&ew(dd("CONNECTION_CLOSED",t,S)),q=dQ.performance.now(),e&&t.shared.retries++,z=("function"==typeof E?E(t.shared.retries):E)*1e3,o(en,dd("CONNECTION_CLOSED",t,S))}function ev(){O.statement||(O.statement=er.statement),O.columns=er.statement.columns}async function ek(e,t=e.readUInt32BE(5)){(3===t?eR:5===t?eI:10===t?eS:11===t?ex:12===t?function(e){e.toString("utf8",9).split(d2.N,1)[0].slice(2)!==K&&(eb(du("SASL_SIGNATURE_MISMATCH","The server did not return the correct signature")),S.destroy())}:0!==t?function(e,t){console.error("Postgres.js : Unknown Auth:",t)}:lt)(e,t)}async function eR(){let e=await eU();el(d2().p().str(e).z(1).end())}async function eI(e){let t="md5"+await lo(Buffer.concat([Buffer.from(await lo(await eU()+d)),e.subarray(9)]));el(d2().p().str(t).z(1).end())}async function eS(){et=(await dG.default.randomBytes(18)).toString("base64"),d2().p().str("SCRAM-SHA-256"+d2.N);let e=d2.i;el(d2.inc(4).str("n,,n=*,r="+et).i32(d2.i-e-4,e).end())}async function ex(e){var t;let r=e.toString("utf8",9).split(",").reduce((e,t)=>(e[t[0]]=t.slice(2),e),{}),i=await dG.default.pbkdf2Sync(await eU(),Buffer.from(r.s,"base64"),parseInt(r.i),32,"sha256"),n=await la(i,"Client Key"),o="n=*,r="+et+",r="+r.r+",s="+r.s+",i="+r.i+",c=biws,r="+r.r;K=(await la(await la(i,"Server Key"),o)).toString("base64");let a="c=biws,r="+r.r+",p="+(function(e,t){let r=Math.max(e.length,t.length),i=Buffer.allocUnsafe(r);for(let n=0;n<r;n++)i[n]=e[n]^t[n];return i})(n,Buffer.from(await la(await (t=n,dG.default.createHash("sha256").update(t).digest()),o))).toString("base64");el(d2().p().str(a).end())}function eU(){return Promise.resolve("function"==typeof t.pass?t.pass():t.pass)}async function eO(){C=!1,(await new ds([`
      select b.oid, b.typarray
      from pg_catalog.pg_type a
      left join pg_catalog.pg_type b on b.oid = a.typelem
      where a.typcategory = 'A'
      group by b.oid, b.typarray
      order by b.oid
    `],[],es)).forEach(({oid:e,typarray:r})=>(function(e,r){if(t.parsers[r]&&t.serializers[r])return;let i=t.parsers[e];t.shared.typeArrayMap[e]=r,t.parsers[r]=e=>(dj.i=dj.last=0,function e(t,r,i,n){let o=[],a=1020===n?";":",";for(;t.i<r.length;t.i++){if(t.char=r[t.i],t.quoted)"\\"===t.char?t.str+=r[++t.i]:'"'===t.char?(o.push(i?i(t.str):t.str),t.str="",t.quoted='"'===r[t.i+1],t.last=t.i+2):t.str+=t.char;else if('"'===t.char)t.quoted=!0;else if("{"===t.char)t.last=++t.i,o.push(e(t,r,i,n));else if("}"===t.char){t.quoted=!1,t.last<t.i&&o.push(i?i(r.slice(t.last,t.i)):r.slice(t.last,t.i)),t.last=t.i+1;break}else t.char===a&&"}"!==t.p&&'"'!==t.p&&(o.push(i?i(r.slice(t.last,t.i)):r.slice(t.last,t.i)),t.last=t.i+1);t.p=t.char}return t.last<t.i&&o.push(i?i(r.slice(t.last,t.i+1)):r.slice(t.last,t.i+1)),o}(dj,e,i,r)),t.parsers[r].array=!0,t.serializers[r]=i=>dL(i,t.serializers[e],t,r)})(e,r))}async function eD(){try{let e=await Promise.resolve(er.cursorFn(O));V=0,e===da?el(function(e=""){return Buffer.concat([d2().C().str("P").str(e+d2.N).end(),d2().S().end()])}(er.portal)):(O=new dX,el(eN("",er.cursorRows)))}catch(e){el(d8),er.reject(e)}}function eC(e,t,r,i=""){return d2().P().str(i+d2.N).str(e+d2.N).i16(t.length),t.forEach((e,t)=>d2.i32(r[t]||0)),d2.end()}function eN(e="",t=0){return Buffer.concat([d2().E().str(e+d2.N).i32(t).end(),d4])}},d3=1,d8=d2().S().end(),d4=d2().H().end(),d9=d2().i32(8).i32(0x4d2162f).end(8),d7=Buffer.concat([d2().E().str(d2.N).i32(0).end(),d8]),le=d2().D().str("S").str(d2.N).end(),lt=()=>{},lr=new Set(["FetchPreparedStatement","RevalidateCachedQuery","transformAssignedExpr"]),li={83:"severity_local",86:"severity",67:"code",77:"message",68:"detail",72:"hint",80:"position",112:"internal_position",113:"internal_query",87:"where",115:"schema_name",116:"table_name",99:"column_name",100:"data type_name",110:"constraint_name",70:"file",76:"line",82:"routine"};function ln(e){let t={},r=5;for(let i=5;i<e.length-1;i++)0===e[i]&&(t[li[e[r]]]=e.toString("utf8",r+1,i),r=i+1);return t}function lo(e){return dG.default.createHash("md5").update(e).digest("hex")}function la(e,t){return dG.default.createHmac("sha256",e).update(t).digest()}function ls(e,t){let r;if(!(t="function"==typeof t?t():t))return{cancel:lt,start:lt};return{cancel(){r&&(clearTimeout(r),r=null)},start(){r&&clearTimeout(r),r=setTimeout(i,1e3*t,arguments)}};function i(t){e.apply(null,t),r=null}}let lc=()=>{};function ld(e,t,r,i){let n,o,a,s=i.raw?Array(t.length):{};for(let c=0;c<t.length;c++)n=e[r++],o=t[c],a=110===n?null:117===n?void 0:void 0===o.parser?e.toString("utf8",r+4,r+=4+e.readUInt32BE(r)):!0===o.parser.array?o.parser(e.toString("utf8",r+5,r+=4+e.readUInt32BE(r))):o.parser(e.toString("utf8",r+4,r+=4+e.readUInt32BE(r))),i.raw?s[c]=!0===i.raw?a:i.value.from?i.value.from(a,o):a:s[o.name]=i.value.from?i.value.from(a,o):a;return{i:r,row:i.row.from?i.row.from(s):s}}function ll(e,t,r=393216){return new Promise(async(i,n)=>{await e.begin(async e=>{let n;t||([{oid:t}]=await e`select lo_creat(-1) as oid`);let[{fd:o}]=await e`select lo_open(${t}, ${r}) as fd`,a={writable:c,readable:s,close:()=>e`select lo_close(${o})`.then(n),tell:()=>e`select lo_tell64(${o})`,read:t=>e`select loread(${o}, ${t}) as data`,write:t=>e`select lowrite(${o}, ${t})`,truncate:t=>e`select lo_truncate64(${o}, ${t})`,seek:(t,r=0)=>e`select lo_lseek64(${o}, ${t}, ${r})`,size:()=>e`
          select
            lo_lseek64(${o}, location, 0) as position,
            seek.size
          from (
            select
              lo_lseek64($1, 0, 2) as size,
              tell.location
            from (select lo_tell64($1) as location) tell
          ) seek
        `};return i(a),new Promise(async e=>n=e);async function s({highWaterMark:e=16384,start:t=0,end:r=1/0}={}){let i=r-t;return t&&await a.seek(t),new dY.default.Readable({highWaterMark:e,async read(e){let t=e>i?e-i:e;i-=e;let[{data:r}]=await a.read(t);this.push(r),r.length<e&&this.push(null)}})}async function c({highWaterMark:e=16384,start:t=0}={}){return t&&await a.seek(t),new dY.default.Writable({highWaterMark:e,write(e,t,r){a.write(e).then(()=>r(),r)}})}}).catch(n)})}function lu(e,t){let r=function(e,t){var r;if(e&&e.shared)return e;let i=process.env,n=(e&&"string"!=typeof e?e:t)||{},{url:o,multihost:a}=function(e){if(!e||"string"!=typeof e)return{url:{searchParams:new Map}};let t=e;t=decodeURIComponent((t=t.slice(t.indexOf("://")+3).split(/[?/]/)[0]).slice(t.indexOf("@")+1));let r=new URL(e.replace(t,t.split(",")[0]));return{url:{username:decodeURIComponent(r.username),password:decodeURIComponent(r.password),host:r.host,hostname:r.hostname,port:r.port,pathname:r.pathname,searchParams:r.searchParams},multihost:t.indexOf(",")>-1&&t}}(e),s=[...o.searchParams].reduce((e,[t,r])=>(e[t]=r,e),{}),c=n.hostname||n.host||a||o.hostname||i.PGHOST||"localhost",d=n.port||o.port||i.PGPORT||5432,l=n.user||n.username||o.username||i.PGUSERNAME||i.PGUSER||function(){try{return de.default.userInfo().username}catch(e){return process.env.USERNAME||process.env.USER||process.env.LOGNAME}}();n.no_prepare&&(n.prepare=!1),s.sslmode&&(s.ssl=s.sslmode,delete s.sslmode),"timeout"in n&&(console.log("The timeout option is deprecated, use idle_timeout instead"),n.idle_timeout=n.timeout),"system"===s.sslrootcert&&(s.ssl="verify-full");let u=["idle_timeout","connect_timeout","max_lifetime","max_pipeline","backoff","keep_alive"],p={max:globalThis.Cloudflare?3:10,ssl:!1,sslnegotiation:null,idle_timeout:null,connect_timeout:30,max_lifetime:lh,max_pipeline:100,backoff:lp,keep_alive:60,prepare:!0,debug:!1,fetch_types:!0,publications:"alltables",target_session_attrs:null};return{host:Array.isArray(c)?c:c.split(",").map(e=>e.split(":")[0]),port:Array.isArray(d)?d:c.split(",").map(e=>parseInt(e.split(":")[1]||d)),path:n.path||c.indexOf("/")>-1&&c+"/.s.PGSQL."+d,database:n.database||n.db||(o.pathname||"").slice(1)||i.PGDATABASE||l,user:l,pass:n.pass||n.password||o.password||i.PGPASSWORD||"",...Object.entries(p).reduce((e,[t,r])=>{let o=t in n?n[t]:t in s?"disable"!==s[t]&&"false"!==s[t]&&s[t]:i["PG"+t.toUpperCase()]||r;return e[t]="string"==typeof o&&u.includes(t)?+o:o,e},{}),connection:{application_name:i.PGAPPNAME||"postgres.js",...n.connection,...Object.entries(s).reduce((e,[t,r])=>(t in p||(e[t]=r),e),{})},types:n.types||{},target_session_attrs:function(e,t,r){let i=e.target_session_attrs||t.searchParams.get("target_session_attrs")||r.PGTARGETSESSIONATTRS;if(!i||["read-write","read-only","primary","standby","prefer-standby"].includes(i))return i;throw Error("target_session_attrs "+i+" is not supported")}(n,o,i),onnotice:n.onnotice,onnotify:n.onnotify,onclose:n.onclose,onparameter:n.onparameter,socket:n.socket,transform:{undefined:(r=n.transform||{undefined:void 0}).undefined,column:{from:"function"==typeof r.column?r.column:r.column&&r.column.from,to:r.column&&r.column.to},value:{from:"function"==typeof r.value?r.value:r.value&&r.value.from,to:r.value&&r.value.to},row:{from:"function"==typeof r.row?r.row:r.row&&r.row.from,to:r.row&&r.row.to}},parameters:{},shared:{retries:0,typeArrayMap:{}},...dx(n.types)}}(e,t),i=r.no_subscribe||function(e,t){let r=new Map,i="postgresjs_"+Math.random().toString(36).slice(2),n={},o,a,s=!1,c=u.sql=e({...t,transform:{column:{},value:{},row:{}},max:1,fetch_types:!1,idle_timeout:null,max_lifetime:null,connection:{...t.connection,replication:"database"},onclose:async function(){s||(a=null,n.pid=n.secret=void 0,p(await h(c,i,t.publications)),r.forEach(e=>e.forEach(({onsubscribe:e})=>e())))},no_subscribe:!0}),d=c.end,l=c.close;return c.end=async()=>(s=!0,a&&await new Promise(e=>(a.once("close",e),a.end())),d()),c.close=async()=>(a&&await new Promise(e=>(a.once("close",e),a.end())),l()),u;async function u(e,s,d=lc,l=lc){e=function(e){let[,t,r,i]=e.match(/^(\*|insert|update|delete)?:?([^.]+?\.?[^=]+)?=?(.+)?/i)||[];return(t||"*")+(r?":"+(-1===r.indexOf(".")?"public."+r:r):"")+(i?"="+i:"")}(e),o||(o=h(c,i,t.publications));let f={fn:s,onsubscribe:d},m=r.has(e)?r.get(e).add(f):r.set(e,new Set([f])).get(e),g=()=>{m.delete(f),0===m.size&&r.delete(e)};return o.then(e=>(p(e),d(),a&&a.on("error",l),{unsubscribe:g,state:n,sql:c}))}function p(e){a=e.stream,n.pid=e.state.pid,n.secret=e.state.secret}async function h(e,r,i){if(!i)throw Error("Missing publication names");let n=await e.unsafe(`CREATE_REPLICATION_SLOT ${r} TEMPORARY LOGICAL pgoutput NOEXPORT_SNAPSHOT`),[o]=n,a=await e.unsafe(`START_REPLICATION SLOT ${r} LOGICAL ${o.consistent_point} (proto_version '1', publication_names '${i}')`).writable(),s={lsn:Buffer.concat(o.consistent_point.split("/").map(e=>Buffer.from(("00000000"+e).slice(-8),"hex")))};return a.on("data",function(r){var i,n,o,d,l;let u;119===r[0]?(i=r.subarray(25),n=s,o=e.options.parsers,d=c,l=t.transform,Object.entries({R:e=>{let t=1,r=n[e.readUInt32BE(t)]={schema:e.toString("utf8",t+=4,t=e.indexOf(0,t))||"pg_catalog",table:e.toString("utf8",t+1,t=e.indexOf(0,t+1)),columns:Array(e.readUInt16BE(t+=2)),keys:[]};t+=2;let i=0,a;for(;t<e.length;)(a=r.columns[i++]={key:e[t++],name:l.column.from?l.column.from(e.toString("utf8",t,t=e.indexOf(0,t))):e.toString("utf8",t,t=e.indexOf(0,t)),type:e.readUInt32BE(t+=1),parser:o[e.readUInt32BE(t)],atttypmod:e.readUInt32BE(t+=4)}).key&&r.keys.push(a),t+=4},Y:()=>{},O:()=>{},B:e=>{var t;t=e.readBigInt64BE(9),n.date=new Date(Date.UTC(2e3,0,1)+Number(t/BigInt(1e3))),n.lsn=e.subarray(1,9)},I:e=>{let t=1,r=n[e.readUInt32BE(t)],{row:i}=ld(e,r.columns,t+=7,l);d(i,{command:"insert",relation:r})},D:e=>{let t=1,r=n[e.readUInt32BE(t)],i=75===e[t+=4];d(i||79===e[t]?ld(e,r.columns,t+=3,l).row:null,{command:"delete",relation:r,key:i})},U:e=>{let t=1,r=n[e.readUInt32BE(t)],i=75===e[t+=4],o=i||79===e[t]?ld(e,r.columns,t+=3,l):null;o&&(t=o.i);let{row:a}=ld(e,r.columns,t+3,l);d(a,{command:"update",relation:r,key:i,old:o&&o.row})},T:()=>{},C:()=>{}}).reduce((e,[t,r])=>(e[t.charCodeAt(0)]=r,e),{})[i[0]](i)):107===r[0]&&r[17]&&(s.lsn=r.subarray(1,9),(u=Buffer.alloc(34))[0]=114,u.fill(s.lsn,1),u.writeBigInt64BE(BigInt(Date.now()-Date.UTC(2e3,0,1))*BigInt(1e3),25),a.write(u))}),a.on("error",function(e){console.error("Unexpected error during logical streaming - reconnecting",e)}),a.on("close",e.close),{stream:a,state:n.state};function c(e,t){let r=t.relation.schema+"."+t.relation.table;f("*",e,t),f("*:"+r,e,t),t.relation.keys.length&&f("*:"+r+"="+t.relation.keys.map(t=>e[t.name]),e,t),f(t.command,e,t),f(t.command+":"+r,e,t),t.relation.keys.length&&f(t.command+":"+r+"="+t.relation.keys.map(t=>e[t.name]),e,t)}}function f(e,t,i){r.has(e)&&r.get(e).forEach(({fn:r})=>r(t,i,e))}}(lu,{...r}),n=!1,o=d0(),a=d0(),s=d0(),c=d0(),d=d0(),l=d0(),u=d0(),p=d0(),h={connecting:a,reserved:s,closed:c,ended:d,open:l,busy:u,full:p},f=[...Array(r.max)].map(()=>d6(r,h,{onopen:U,onend:x,onclose:O})),m=g(function(e){return n?e.reject(dd("CONNECTION_ENDED",r,r)):l.length?T(l.shift(),e):c.length?S(c.shift(),e):void(u.length?T(u.shift(),e):o.push(e))});return Object.assign(m,{get parameters(){return r.parameters},largeObject:ll.bind(null,m),subscribe:i,CLOSE:da,END:da,PostgresError:dc,options:r,reserve:b,listen:y,begin:E,close:R,end:k}),m;function g(e){return e.debug=r.debug,Object.entries(r.types).reduce((e,[t,r])=>(e[t]=e=>new dm(e,r.to),e),t),Object.assign(i,{types:t,typed:t,unsafe:function(t,r=[],i={}){return 2!=arguments.length||Array.isArray(r)||(i=r,r=[]),new ds([t],r,e,v,{prepare:!1,...i,simple:"simple"in i?i.simple:0===r.length})},notify:w,array:function e(t,i){return Array.isArray(t)?new dm(t,i||(t.length?dC(t)||25:0),r.shared.typeArrayMap):e(Array.from(arguments))},json:A,file:function(t,r=[],i={}){return 2!=arguments.length||Array.isArray(r)||(i=r,r=[]),new ds([],r,r=>{dt.default.readFile(t,"utf8",(t,i)=>{if(t)return r.reject(t);r.strings=[i],e(r)})},v,{...i,simple:"simple"in i?i.simple:0===r.length})}}),i;function t(e,t){return new dm(e,t)}function i(t,...n){return t&&Array.isArray(t.raw)?new ds(t,n,e,v):"string"!=typeof t||n.length?new dg(t,n):new df(r.transform.column.to?r.transform.column.to(t):t)}}async function y(e,t,i){let n={fn:t,onlisten:i},o=y.sql||(y.sql=lu({...r,max:1,idle_timeout:null,max_lifetime:null,fetch_types:!1,onclose(){Object.entries(y.channels).forEach(([e,{listeners:t}])=>{delete y.channels[e],Promise.all(t.map(t=>y(e,t.fn,t.onlisten).catch(()=>{})))})},onnotify(e,t){e in y.channels&&y.channels[e].listeners.forEach(e=>e.fn(t))}})),a=y.channels||(y.channels={});if(e in a){a[e].listeners.push(n);let t=await a[e].result;return n.onlisten&&n.onlisten(),{state:t.state,unlisten:c}}a[e]={result:o`listen ${o.unsafe('"'+e.replace(/"/g,'""')+'"')}`,listeners:[n]};let s=await a[e].result;return n.onlisten&&n.onlisten(),{state:s.state,unlisten:c};async function c(){if(e in a!=!1&&(a[e].listeners=a[e].listeners.filter(e=>e!==n),!a[e].listeners.length))return delete a[e],o`unlisten ${o.unsafe('"'+e.replace(/"/g,'""')+'"')}`}}async function w(e,t){return await m`select pg_notify(${e}, ${""+t})`}async function b(){let e=d0(),t=l.length?l.shift():await new Promise((e,t)=>{let r={reserve:e,reject:t};o.push(r),c.length&&S(c.shift(),r)});_(t,s),t.reserved=()=>e.length?t.execute(e.shift()):_(t,s),t.reserved.release=!0;let r=g(function(r){t.queue===p?e.push(r):t.execute(r)||_(t,p)});return r.release=()=>{t.reserved=null,U(t)},r}async function E(e,t){t||(t=e,e="");let r=d0(),i=0,n,o=null;try{return await m.unsafe("begin "+e.replace(/[^a-z ]/ig,""),[],{onexecute:function(e){n=e,_(e,s),e.reserved=()=>r.length?e.execute(r.shift()):_(e,s)}}).execute(),await Promise.race([a(n,t),new Promise((e,t)=>n.onclose=t)])}catch(e){throw e}async function a(e,t,n){let s,c,d=g(function(t){t.catch(e=>s||(s=e)),e.queue===p?r.push(t):e.execute(t)||_(e,p)});d.savepoint=function t(r,n){return r&&Array.isArray(r.raw)?t(e=>e.apply(e,arguments)):(1==arguments.length&&(n=r,r=null),a(e,n,"s"+i+++(r?"_"+r:"")))},d.prepare=e=>o=e.replace(/[^a-z0-9$-_. ]/gi),n&&await d`savepoint ${d(n)}`;try{if(c=await new Promise((e,r)=>{let i=t(d);Promise.resolve(Array.isArray(i)?Promise.all(i):i).then(e,r)}),s)throw s}catch(e){throw await (n?d`rollback to ${d(n)}`:d`rollback`),e instanceof dc&&"25P02"===e.code&&s||e}return n||(o?await d`prepare transaction '${d.unsafe(o)}'`:await d`commit`),c}}function _(e,t){return e.queue.remove(e),t.push(e),e.queue=t,t===l?e.idleTimer.start():e.idleTimer.cancel(),e}function A(e){return new dm(e,3802)}function T(e,t){return e.execute(t)?_(e,u):_(e,p)}function v(e){return new Promise((t,i)=>{e.state?e.active?d6(r).cancel(e.state,t,i):e.cancelled={resolve:t,reject:i}:(o.remove(e),e.cancelled=!0,e.reject(du("57014","canceling statement due to user request")),t())})}async function k({timeout:e=null}={}){let t;return n||(await 1,n=Promise.race([new Promise(r=>null!==e&&(t=setTimeout(I,1e3*e,r))),Promise.all(f.map(e=>e.end()).concat(y.sql?y.sql.end({timeout:0}):[],i.sql?i.sql.end({timeout:0}):[]))]).then(()=>clearTimeout(t)))}async function R(){await Promise.all(f.map(e=>e.end()))}async function I(e){for(await Promise.all(f.map(e=>e.terminate()));o.length;)o.shift().reject(dd("CONNECTION_DESTROYED",r));e()}function S(e,t){return _(e,a),e.connect(t),e}function x(e){_(e,d)}function U(e){if(0===o.length)return _(e,l);let t=Math.ceil(o.length/(a.length+1)),r=!0;for(;r&&o.length&&t-- >0;){let t=o.shift();if(t.reserve)return t.reserve(e);r=e.execute(t)}r?_(e,u):_(e,p)}function O(e,t){_(e,c),e.reserved=null,e.onclose&&(e.onclose(t),e.onclose=null),r.onclose&&r.onclose(e.id),o.length&&S(e,o.shift())}}function lp(e){return(.5+Math.random()/2)*Math.min(3**e/100,20)}function lh(){return 60*(30+30*Math.random())}Object.assign(lu,{PostgresError:dc,toPascal:dB,pascal:dW,toCamel:dq,camel:dK,toKebab:dH,kebab:dF,fromPascal:dM,fromCamel:d$,fromKebab:dz,BigInt:{to:20,from:[20],parse:e=>BigInt(e),serialize:e=>e.toString()}});let lf=process.env.DATABASE_URL;lf||console.warn("DATABASE_URL not set - database features will be unavailable");let lm=lf?lu(lf,{max:10,idle_timeout:30,connect_timeout:10}):null,lg="http://localhost:21000",ly=process.env.BETTER_AUTH_SECRET||"xhpIwlb8J3/N8YJxOVJu0pLcp0LIULr4S36ZIJfX7o8=",lw=null===lm?(console.warn("[auth] Database not available - Better Auth disabled"),null):((e,t)=>{let r=t(e),{api:i}=a4(r,e);return{handler:async t=>{let i=await r,n=i.options.basePath||"/api/auth";if(!i.options.baseURL){let e=nF(void 0,n,t,void 0,i.options.advanced?.trustedProxyHeaders);if(e)i.baseURL=e,i.options.baseURL=nZ(i.baseURL)||void 0;else throw new rO.BetterAuthError("Could not get base URL from request. Please provide a valid base URL.")}i.trustedOrigins=await c$(i.options,t);let{handler:o}=((e,t)=>{let{api:r,middlewares:i}=a4(e,t),n=new URL(e.baseURL).pathname;return((e,t)=>{if(!t?.openapi?.disabled){let r={path:"/api/reference",...t?.openapi};e.openapi=i6(r.path,{method:"GET"},async t=>{let i,n;return new Response((i=await ne(e),n=r.scalar,`<!doctype html>
<html>
  <head>
    <title>Scalar API Reference</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <script
      id="api-reference"
      type="application/json">
    ${JSON.stringify(i)}
    </script>
	 <script>
      var configuration = {
	  	favicon: ${n?.logo?`data:image/svg+xml;utf8,${encodeURIComponent(n.logo)}`:void 0} ,
	   	theme: ${n?.theme||"saturn"},
        metaData: {
			title: ${n?.title||"Open API Reference"},
			description: ${n?.description||"Better Call Open API"},
		}
      }
      document.getElementById('api-reference').dataset.configuration =
        JSON.stringify(configuration)
    </script>
	  <script src="https://cdn.jsdelivr.net/npm/@scalar/api-reference"></script>
  </body>
</html>`),{headers:{"Content-Type":"text/html"}})})}let r=nr(),i=nr();for(let t of Object.values(e))if(!(!t.options||!t.path||t.options?.metadata?.SERVER_ONLY))for(let e of Array.isArray(t.options?.method)?t.options.method:[t.options?.method])no(r,e,t.path,t);if(t?.routerMiddleware?.length)for(let{path:e,middleware:r}of t.routerMiddleware)no(i,"*",e,r);let n=async e=>{let n=new URL(e.url),o=n.pathname,a=t?.basePath&&"/"!==t.basePath?o.split(t.basePath).reduce((e,r,i)=>(0!==i&&(i>1?e.push(`${t.basePath}${r}`):e.push(r)),e),[]).join(""):n.pathname;if(!a?.length||/\/{2,}/.test(a))return new Response(null,{status:404,statusText:"Not Found"});let s=function(e,t="",r,i){47===r.charCodeAt(r.length-1)&&(r=r.slice(0,-1));let n=e.static[r];if(n&&n.methods){let e=n.methods[t]||n.methods[""];if(void 0!==e)return e[0]}let o=ni(r),a=function e(t,r,i,n,o){if(o===n.length){if(r.methods){let e=r.methods[i]||r.methods[""];if(e)return e}if(r.param&&r.param.methods){let e=r.param.methods[i]||r.param.methods[""];if(e){let t=e[0].paramsMap;if(t?.[t?.length-1]?.[2])return e}}if(r.wildcard&&r.wildcard.methods){let e=r.wildcard.methods[i]||r.wildcard.methods[""];if(e){let t=e[0].paramsMap;if(t?.[t?.length-1]?.[2])return e}}return}let a=n[o];if(r.static){let s=r.static[a];if(s){let r=e(t,s,i,n,o+1);if(r)return r}}if(r.param){let s=e(t,r.param,i,n,o+1);if(s){if(r.param.hasRegexParam){let e=s.find(e=>e.paramsRegexp[o]?.test(a))||s.find(e=>!e.paramsRegexp[o]);return e?[e]:void 0}return s}}if(r.wildcard&&r.wildcard.methods)return r.wildcard.methods[i]||r.wildcard.methods[""]}(e,e.root,t,o,0)?.[0];if(void 0!==a)return{data:a.data,params:a.paramsMap?nn(o,a.paramsMap):void 0}}(r,e.method,a);if(a.endsWith("/")!==s?.data?.path?.endsWith("/")&&!t?.skipTrailingSlashes||!s?.data)return new Response(null,{status:404,statusText:"Not Found"});let c={};n.searchParams.forEach((e,t)=>{t in c?Array.isArray(c[t])?c[t].push(e):c[t]=[c[t],e]:c[t]=e});let d=s.data;try{let r=d.options.metadata?.allowedMediaTypes||t?.allowedMediaTypes,n={path:a,method:e.method,headers:e.headers,params:s.params?JSON.parse(JSON.stringify(s.params)):{},request:e,body:d.options.disableBody?void 0:await iM(d.options.cloneRequest?e.clone():e,r),query:c,_flag:"router",asResponse:!0,context:t?.routerContext},o=function(e,t="",r,i){47===r.charCodeAt(r.length-1)&&(r=r.slice(0,-1));let n=ni(r);return(function e(t,r,i,n,o,a=[]){let s=n[o];if(r.wildcard&&r.wildcard.methods){let e=r.wildcard.methods[i]||r.wildcard.methods[""];e&&a.push(...e)}if(r.param&&(e(t,r.param,i,n,o+1,a),o===n.length&&r.param.methods)){let e=r.param.methods[i]||r.param.methods[""];if(e){let t=e[0].paramsMap;t?.[t?.length-1]?.[2]&&a.push(...e)}}let c=r.static?.[s];if(c&&e(t,c,i,n,o+1,a),o===n.length&&r.methods){let e=r.methods[i]||r.methods[""];e&&a.push(...e)}return a})(e,e.root,t,n,0).map(e=>({data:e.data,params:e.paramsMap?nn(n,e.paramsMap):void 0}))}(i,"*",a);if(o?.length)for(let{data:e,params:t}of o){let r=await e({...n,params:t,asResponse:!1});if(r instanceof Response)return r}return await d(n)}catch(e){if(t?.onError)try{let r=await t.onError(e);if(r instanceof Response)return iW(r)}catch(e){if(iz(e))return iW(e);throw e}if(t?.throwError)throw e;if(iz(e))return iW(e);return console.error("# SERVER_ERROR: ",e),new Response(null,{status:500,statusText:"Internal Server Error"})}};return{handler:async e=>{let r=await t?.onRequest?.(e);if(r instanceof Response)return r;let i=await n(iK(r)?r:e),o=await t?.onResponse?.(i);return o instanceof Response?o:i},endpoints:e}})(r,{routerContext:e,openapi:{disabled:!0},basePath:n,routerMiddleware:[{path:"/**",middleware:n4},...i],allowedMediaTypes:["application/json"],skipTrailingSlashes:t.advanced?.skipTrailingSlashes??!1,async onRequest(t){let r=e.options.disabledPaths||[],i=new URL(t.url).pathname.replace(/\/+$/,"")||"/",o="/"===n?i:i.startsWith(n)?i.slice(n.length).replace(/\/+$/,"")||"/":i;if(r.includes(o))return new Response("Not Found",{status:404});let a=t;for(let t of e.options.plugins||[])if(t.onRequest){let r=await t.onRequest(a,e);if(r&&"response"in r)return r.response;r&&"request"in r&&(a=r.request)}return await oz(a,e)||a},async onResponse(t){for(let r of e.options.plugins||[])if(r.onResponse){let i=await r.onResponse(t,e);if(i)return i.response}return t},onError(r){if(r instanceof iH&&"FOUND"===r.status)return;if(t.onAPIError?.throw)throw r;if(t.onAPIError?.onError)return void t.onAPIError.onError(r,e);let i=t.logger?.level,n="error"===i||"warn"===i||"debug"===i?os.logger:void 0;if(t.logger?.disabled!==!0){if(r&&"object"==typeof r&&"message"in r&&"string"==typeof r.message&&(r.message.includes("no column")||r.message.includes("column")||r.message.includes("relation")||r.message.includes("table")||r.message.includes("does not exist")))return void e.logger?.error(r.message);r instanceof iH?("INTERNAL_SERVER_ERROR"===r.status&&e.logger.error(r.status,r),n?.error(r.message)):e.logger?.error(r&&"object"==typeof r&&"name"in r?r.name:"",r)}}})})(i,e);return Q(i.adapter,()=>o(t))},api:i,options:e,$context:r,$ERROR_CODES:{...e.plugins?.reduce((e,t)=>t.$ERROR_CODES?{...e,...t.$ERROR_CODES}:e,{}),...nX.BASE_ERROR_CODES}}})({database:function(){if(!lm)throw Error("Database not configured - set DATABASE_URL environment variable");return lm}(),secret:ly,baseURL:lg,plugins:[(p={debug:!1},h=p?.debug??!1,l=()=>{},u=h?{log:(e,...t)=>{console.log(`[Sigma Debug] ${e}`,...t)},warn:(e,...t)=>{console.warn(`[Sigma Debug] ${e}`,...t)},error:(e,...t)=>{console.error(`[Sigma Debug] ${e}`,...t)}}:{log:l,warn:l,error:l},{id:"sigma",schema:{user:{fields:{pubkey:{type:"string",required:!0,unique:!0},...p?.enableSubscription?{subscriptionTier:{type:"string",required:!1,defaultValue:"free"}}:{}}},session:{fields:{...p?.enableSubscription?{subscriptionTier:{type:"string",required:!1}}:{}}},oauthAccessToken:{fields:{selectedBapId:{type:"string",required:!1}}},oauthClient:{fields:{ownerBapId:{type:"string",required:!0},memberPubkey:{type:"string",required:!1}}},oauthConsent:{fields:{selectedBapId:{type:"string",required:!1}}}},hooks:{after:[{matcher:e=>"/oauth2/token"===e.path,handler:n2(async e=>{if(u.log("AFTER hook triggered for /oauth2/token"),"authorization_code"!==e.body.grant_type)return;let t=e.context.returned;if(t&&"object"==typeof t&&"access_token"in t&&p?.cache)try{let r=t.access_token,i=await cj(r),n=await e.context.adapter.findMany({model:"oauthAccessToken",where:[{field:"token",value:i}],limit:1});if(0===n.length||!n[0])return void u.warn("No access token found in database");let{userId:o,clientId:a}=n[0],s=(await e.context.adapter.findMany({model:"oauthConsent",where:[{field:"userId",value:o},{field:"clientId",value:a}],limit:1,sortBy:{field:"createdAt",direction:"desc"}}))[0];if(!s||!s.selectedBapId)return;let c=s.selectedBapId;if(await e.context.adapter.update({model:"oauthAccessToken",where:[{field:"token",value:i}],update:{selectedBapId:c}}),u.log(`Stored BAP ID in access token: user=${o.substring(0,15)}... bap=${c.substring(0,15)}...`),p?.getPool){let t=p.getPool(),r=(await t.query("SELECT bap_id, name, image, member_pubkey FROM profile WHERE bap_id = $1 AND user_id = $2 LIMIT 1",[c,o])).rows[0];r&&await e.context.adapter.update({model:"user",where:[{field:"id",value:o}],update:{name:r.name,image:r.image,...r.member_pubkey&&{pubkey:r.member_pubkey},updatedAt:new Date}})}}catch(e){u.error("Error storing identity selection:",e)}})},{matcher:e=>"/oauth2/consent"===e.path,handler:n2(async e=>{if(!p?.cache)return;let t=e.body,r=t.consent_code;if(t.accept&&r)try{let t=e.context.session;if(!t?.user?.id)return;await new Promise(e=>setTimeout(e,100));let i=(await e.context.adapter.findMany({model:"oauthConsent",where:[{field:"userId",value:t.user.id}],limit:1,sortBy:{field:"updatedAt",direction:"desc"}}))[0];if(!i)return;let{id:n}=i,o=await p.cache.get(`consent:${r}:bap_id`);if(!o)return;await e.context.adapter.update({model:"oauthConsent",where:[{field:"id",value:n}],update:{selectedBapId:o}}),u.log(`Stored BAP ID in consent: user=${t.user.id.substring(0,15)}... bap=${o.substring(0,15)}...`)}catch(e){u.error("Error storing consent identity selection:",e)}})}],before:[{matcher:e=>"/oauth2/token"===e.path,handler:n2(async e=>{let t=e.body,r=t.grant_type;if("authorization_code"===r){let r=t.client_id;if(!r)throw new iH("BAD_REQUEST",{error:"invalid_request",error_description:"Missing client_id in request body"});let i=await e.context.adapter.findMany({model:"oauthClient",where:[{field:"clientId",value:r}]});if(0===i.length)throw new iH("UNAUTHORIZED",{error:"invalid_client",error_description:`OAuth client not registered: ${r}`});let n=i[0],o=new Headers(e.headers||{}).get("x-auth-token");if(!o)throw new iH("UNAUTHORIZED",{error:"invalid_client",error_description:"Missing X-Auth-Token header for client authentication"});let a=(0,cL.parseAuthToken)(o);if(!a?.pubkey)throw new iH("UNAUTHORIZED",{error:"invalid_client",error_description:"Invalid Bitcoin auth token format - unable to extract pubkey"});let s=n.memberPubkey;if(!s)throw new iH("UNAUTHORIZED",{error:"invalid_client",error_description:`Client ${r} has no memberPubkey configured`});if(a.pubkey!==s)throw new iH("UNAUTHORIZED",{error:"invalid_client",error_description:"Signature pubkey does not match registered member key - check SIGMA_MEMBER_PRIVATE_KEY matches the public key registered for this OAuth client"});let c=new URLSearchParams;for(let[e,r]of Object.entries(t))null!=r&&c.set(e,String(r));let d=c.toString(),l={requestPath:"/api/auth/oauth2/token",timestamp:a.timestamp,body:d};if(!(0,cL.verifyAuthToken)(o,l,5))throw new iH("UNAUTHORIZED",{error:"invalid_client",error_description:"Bitcoin signature verification failed - signature expired or request body was modified"});u.log(`Client authenticated via Bitcoin signature (clientId: ${r})`);let p={...e.body,client_id:r};return{context:{...e,body:p}}}if("refresh_token"===r){if(!t.refresh_token)throw new iH("BAD_REQUEST",{error:"invalid_request",error_description:"Missing refresh_token"});let r=t.client_id;if(!r)throw new iH("BAD_REQUEST",{error:"invalid_request",error_description:"Missing client_id in request body"});let i=await e.context.adapter.findMany({model:"oauthClient",where:[{field:"clientId",value:r}]});if(0===i.length)throw new iH("UNAUTHORIZED",{error:"invalid_client",error_description:`OAuth client not registered: ${r}`});let n=i[0],o=new Headers(e.headers||{}).get("x-auth-token");if(!o)throw new iH("UNAUTHORIZED",{error:"invalid_client",error_description:"Missing X-Auth-Token header for client authentication"});let a=(0,cL.parseAuthToken)(o);if(!a?.pubkey)throw new iH("UNAUTHORIZED",{error:"invalid_client",error_description:"Invalid Bitcoin auth token format - unable to extract pubkey"});let s=n.memberPubkey;if(!s)throw new iH("UNAUTHORIZED",{error:"invalid_client",error_description:`Client ${r} has no memberPubkey configured`});if(a.pubkey!==s)throw new iH("UNAUTHORIZED",{error:"invalid_client",error_description:"Signature pubkey does not match registered member key - check SIGMA_MEMBER_PRIVATE_KEY matches the public key registered for this OAuth client"});let c=new URLSearchParams;for(let[e,r]of Object.entries(t))null!=r&&c.set(e,String(r));let d=c.toString(),l={requestPath:"/api/auth/oauth2/token",timestamp:a.timestamp,body:d};if(!(0,cL.verifyAuthToken)(o,l,5))throw new iH("UNAUTHORIZED",{error:"invalid_client",error_description:"Bitcoin signature verification failed - signature expired or request body was modified"});u.log(`Token refresh: client authenticated via Bitcoin signature (clientId: ${r})`);let p={...e.body,client_id:r};return{context:{...e,body:p}}}throw new iH("BAD_REQUEST",{error:"unsupported_grant_type",error_description:`Unsupported grant_type: ${r}`})})}]},endpoints:{storeConsentBapId:n6("/sigma/store-consent-bap-id",{method:"POST",body:iU.object({consentCode:iU.string(),bapId:iU.string()}),use:[oD]},async e=>{if(e.context.session,!p?.cache)throw new iH("INTERNAL_SERVER_ERROR",{message:"Plugin configuration error: cache not available"});let{consentCode:t,bapId:r}=e.body;try{let i=`consent:${t}:bap_id`;return await p.cache.set(i,r,{ex:300}),e.json({success:!0})}catch(e){throw u.error("Error storing consent BAP ID selection:",e),new iH("INTERNAL_SERVER_ERROR",{message:"Failed to store identity selection"})}}),signInSigma:n6("/sign-in/sigma",{method:"POST",body:iU.optional(iU.object({bapId:iU.string().optional()}))},async e=>{let t={};e.headers?.forEach((e,r)=>{t[r]="x-auth-token"===r.toLowerCase()?`${e.substring(0,20)}...`:e}),u.log("Sign-in request received",{headers:t,body:e.body,hasAuthToken:!!e.headers?.get("x-auth-token")});let r=e.headers?.get("x-auth-token");if(!r)throw new iH("UNAUTHORIZED",{message:"No auth token provided"});let i=(0,cL.parseAuthToken)(r);if(!i?.pubkey)throw new iH("BAD_REQUEST",{message:"Invalid auth token format"});let n={requestPath:"/api/auth/sign-in/sigma",timestamp:i.timestamp};if(!(0,cL.verifyAuthToken)(r,n,5))throw new iH("UNAUTHORIZED",{message:"Invalid auth token signature"});let o=i.pubkey,a=(await e.context.adapter.findMany({model:"user",where:[{field:"pubkey",value:o}]}))[0];if(!a&&p?.getPool){let t=p.getPool(),r=(await t.query("SELECT user_id FROM profile WHERE member_pubkey = $1 LIMIT 1",[o])).rows[0];if(r){let t=r.user_id;a=(await e.context.adapter.findMany({model:"user",where:[{field:"id",value:t}]}))[0]}}if(!a)try{a=await e.context.adapter.create({model:"user",data:{name:cP.PublicKey.fromString(o).toAddress(),pubkey:o,emailVerified:!1,createdAt:new Date,updatedAt:new Date}})}catch(t){if(t&&"object"==typeof t&&"code"in t&&"23505"===t.code){if(!(a=(await e.context.adapter.findMany({model:"user",where:[{field:"pubkey",value:o}]}))[0]))throw new iH("INTERNAL_SERVER_ERROR",{message:"User exists but cannot be found"})}else throw t}if(p?.resolveBAPId&&p?.getPool){let t=p.getPool(),r=await p.resolveBAPId(t,a.id,o,!0);if(r){u.log(`BAP ID resolved and registered: ${r.substring(0,20)}...`);let i=e.body?.bapId,n=(i?await t.query("SELECT bap_id, name, image, member_pubkey FROM profile WHERE bap_id = $1 AND user_id = $2 LIMIT 1",[i,a.id]):await t.query("SELECT bap_id, name, image, member_pubkey FROM profile WHERE user_id = $1 AND is_primary = true LIMIT 1",[a.id])).rows[0];n&&await e.context.adapter.update({model:"user",where:[{field:"id",value:a.id}],update:{name:n.name,image:n.image,...n.member_pubkey&&{pubkey:n.member_pubkey},updatedAt:new Date}});let o=await e.context.adapter.findMany({model:"user",where:[{field:"id",value:a.id}]});o[0]&&(a=o[0])}}let s=await e.context.internalAdapter.createSession(a.id);if(!s)throw new iH("INTERNAL_SERVER_ERROR",{message:"Internal Server Error",status:500});return await nq(e,{session:s,user:a}),e.json({token:s.token,user:{id:a.id,pubkey:a.pubkey,name:a.name}})})}}),(e=>{let t=e.clientRegistrationAllowedScopes;e.clientRegistrationDefaultScopes&&(t=Array.from(new Set(t?[...t,...e.clientRegistrationDefaultScopes]:[...e.clientRegistrationDefaultScopes])));let r=new Set((e.scopes??["openid","profile","email","offline_access"]).filter(e=>e.length));if(t){for(let e of t)if(!r.has(e))throw new rO.BetterAuthError(`clientRegistrationAllowedScope ${e} not found in scopes`)}for(let t of e.advertisedMetadata?.scopes_supported??[])if(!r?.has(t))throw new rO.BetterAuthError(`advertisedMetadata.scopes_supported ${t} not found in scopes`);let i=new Set(["sub","iss","aud","exp","iat","sid","scope","azp",...r.has("email")?["email","email_verified"]:[],...r.has("profile")?["name","picture","family_name","given_name"]:[]]),n={codeExpiresIn:600,accessTokenExpiresIn:3600,m2mAccessTokenExpiresIn:3600,refreshTokenExpiresIn:2592e3,allowUnauthenticatedClientRegistration:!1,allowDynamicClientRegistration:!1,disableJwtPlugin:!1,storeClientSecret:e.disableJwtPlugin?"encrypted":"hashed",storeTokens:"hashed",grantTypes:["authorization_code","client_credentials","refresh_token"],...e,scopes:Array.from(r),claims:Array.from(i),clientRegistrationAllowedScopes:t};if(n.grantTypes&&n.grantTypes.includes("refresh_token")&&!n.grantTypes.includes("authorization_code"))throw new rO.BetterAuthError("refresh_token grant requires authorization_code grant");if(n.disableJwtPlugin&&("hashed"===n.storeClientSecret||"object"==typeof n.storeClientSecret&&"hash"in n.storeClientSecret))throw new rO.BetterAuthError("unable to store hashed secrets because id tokens will be signed with secret");if(!n.disableJwtPlugin&&("encrypted"===n.storeClientSecret||"object"==typeof n.storeClientSecret&&("encrypt"in n.storeClientSecret||"decrypt"in n.storeClientSecret)))throw new rO.BetterAuthError("encryption method not recommended, please use 'hashed' or the 'hash' function");return{id:"oauthProvider",options:n,init:e=>{if(e.options.session&&!e.options.session.storeSessionInDatabase)throw new rO.BetterAuthError("OAuth Provider requires `session.storeSessionInDatabase: true` when using secondaryStorage");if(!n.disableJwtPlugin){let t=new URL(a7(e).options?.jwt?.issuer??e.baseURL).pathname;n.silenceWarnings?.oauthAuthServerConfig||"/"===e.options.basePath&&"/"===t||os.logger.warn(`Please ensure '/.well-known/oauth-authorization-server${"/"===t?"":t}' exists. Upon completion, clear with silenceWarnings.oauthAuthServerConfig.`),!n.silenceWarnings?.openidConfig&&e.options.basePath!==t&&n.scopes?.includes("openid")&&os.logger.warn(`Please ensure '${t}${t.endsWith("/")?"":"/"}.well-known/openid-configuration' exists. Upon completion, clear with silenceWarnings.openidConfig.`)}},hooks:{before:[{matcher:e=>e.body?.oauth_query,handler:n2(async e=>{let t=new URLSearchParams(e.body.oauth_query),r=t.get("sig"),i=Number(t.get("exp"));t.delete("sig"),t=new URLSearchParams(t);let n=await ik(t.toString(),e.context.secret);if(!r||!en(r,n)||new Date(1e3*i)<new Date)throw new iH("BAD_REQUEST",{error:"invalid_signature"});if(t.delete("exp"),await cN.set({query:new URLSearchParams(t).toString()}),"/sign-in/social"===e.path||"/sign-in/oauth2"===e.path){if(e.body.additionalData?.query)return;e.body.additionalData||(e.body.additionalData={}),e.body.additionalData.query=t.toString()}})}],after:[{matcher:e=>nO(e.context.responseHeaders?.get("set-cookie")||"").has(e.context.authCookies.sessionToken.name),handler:n2(async e=>{let t=nO(e.context.responseHeaders?.get("set-cookie")||"").get(e.context.authCookies.sessionToken.name)?.value.split(".")[0];if(!t)return;let r=(await cN.get())?.query??(await ee())?.query;if(!r)return;let i=new URLSearchParams(r),o=await e.context.internalAdapter.findSession(t);if(o)return e.context.session=o,e.query=sl(i,"login"),await sK(e,n)})}]},endpoints:{getOAuthServerConfig:n6("/.well-known/oauth-authorization-server",{method:"GET",metadata:{SERVER_ONLY:!0}},async e=>n.scopes&&n.scopes.includes("openid")?s$(e,n):sH(e,n.disableJwtPlugin?void 0:a7(e.context).options,{scopes_supported:n.advertisedMetadata?.scopes_supported??n.scopes})),getOpenIdConfig:n6("/.well-known/openid-configuration",{method:"GET",metadata:{SERVER_ONLY:!0}},async e=>{if(n.scopes&&!n.scopes.includes("openid"))throw new iH("NOT_FOUND");return s$(e,n)}),oauth2Authorize:n6("/oauth2/authorize",{method:"GET",query:iS.object({response_type:iS.enum(["code"]),client_id:iS.string(),redirect_uri:cg.optional(),scope:iS.string().optional(),state:iS.string().optional(),code_challenge:iS.string().optional(),code_challenge_method:iS.enum(["S256"]).optional(),nonce:iS.string().optional(),prompt:iS.enum(["consent","login","create","select_account","login consent","select_account consent"]).optional()}),metadata:{openapi:{description:"Authorize an OAuth2 request",parameters:[{name:"response_type",in:"query",required:!0,schema:{type:"string"},description:"OAuth2 response type (e.g., 'code')"},{name:"client_id",in:"query",required:!0,schema:{type:"string"},description:"OAuth2 client ID"},{name:"redirect_uri",in:"query",required:!1,schema:{type:"string",format:"uri"},description:"OAuth2 redirect URI"},{name:"scope",in:"query",required:!1,schema:{type:"string"},description:"OAuth2 scopes (space-separated)"},{name:"state",in:"query",required:!1,schema:{type:"string"},description:"OAuth2 state parameter"},{name:"code_challenge",in:"query",required:!1,schema:{type:"string"},description:"PKCE code challenge"},{name:"code_challenge_method",in:"query",required:!1,schema:{type:"string"},description:"PKCE code challenge method"},{name:"nonce",in:"query",required:!1,schema:{type:"string"},description:"OpenID Connect nonce"},{name:"prompt",in:"query",required:!1,schema:{type:"string"},description:"OAuth2 prompt parameter"}],responses:{302:{description:"Redirect to client with code or error",headers:{Location:{description:"Redirect URI with code or error",schema:{type:"string",format:"uri"}}}},400:{description:"Invalid request",content:{"application/json":{schema:{type:"object",properties:{error:{type:"string"},error_description:{type:"string"},state:{type:"string"}},required:["error"]}}}}}}}},async e=>sK(e,n,{isAuthorize:!0})),oauth2Consent:n6("/oauth2/consent",{method:"POST",body:iS.object({accept:iS.boolean().meta({description:"Accept or deny user consent for a set of scopes"}),scope:iS.string().optional().meta({description:"List of accept of accepted space-separated scopes. If none is provided, then all originally requested scopes are accepted."}),oauth_query:iS.string().optional().meta({description:"The redirected page's query parameters"})}),use:[oD],metadata:{openapi:{description:"Handle OAuth2 consent",responses:{200:{description:"Consent processed successfully",content:{"application/json":{schema:{type:"object",properties:{redirect_uri:{type:"string",format:"uri",description:"The URI to redirect to, either with an authorization code or an error"}},required:["redirect_uri"]}}}}}}}},async e=>sJ(e,n)),oauth2Continue:n6("/oauth2/continue",{method:"POST",body:iS.object({selected:iS.boolean().optional().meta({description:"Confirms an account has been selected and authorization can proceed."}),created:iS.boolean().optional().meta({description:"Confirms an account was registered"}),postLogin:iS.boolean().optional().meta({description:"Confirms organization and/or team selection."}),oauth_query:iS.string().optional().meta({description:"The redirected page's query parameters"})}),use:[oD],metadata:{openapi:{description:"Continues OAuth2 authorization flow",responses:{200:{description:"Consent processed successfully",content:{"application/json":{schema:{type:"object",properties:{redirect_uri:{type:"string",format:"uri",description:"The URI to redirect to, either with an authorization code or an error"}},required:["redirect_uri"]}}}}}}}},async e=>sG(e,n)),oauth2Token:n6("/oauth2/token",{method:"POST",body:iS.object({grant_type:iS.enum(["authorization_code","client_credentials","refresh_token"]),client_id:iS.string().optional(),client_secret:iS.string().optional(),code:iS.string().optional(),code_verifier:iS.string().optional(),redirect_uri:cg.optional(),refresh_token:iS.string().optional(),resource:iS.string().optional(),scope:iS.string().optional()}),metadata:{allowedMediaTypes:["application/x-www-form-urlencoded"],openapi:{description:"Obtain an OAuth2.1 access token",requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{grant_type:{type:"string",enum:["authorization_code","client_credentials","refresh_token"],description:"OAuth2 grant type"},client_id:{type:"string",description:"OAuth2 client ID"},client_secret:{type:"string",description:"OAuth2 client secret"},code:{type:"string",description:"Authorization code (for authorization_code grant)"},code_verifier:{type:"string",description:"PKCE code verifier (for authorization_code grant)"},redirect_uri:{type:"string",format:"uri",description:"Redirect URI (for authorization_code grant)"},refresh_token:{type:"string",description:"Refresh token (for refresh_token grant)"},resource:{type:"string",description:"Requested token resource (ie audience) to obtain a JWT formatted access token"},scope:{type:"string",description:"Requested scopes (for client_credentials grant)"}},required:["grant_type"]}}}},responses:{200:{description:"Access token response",content:{"application/json":{schema:{type:"object",properties:{access_token:{type:"string",description:"The access token issued by the authorization server"},token_type:{type:"string",description:"The type of the token issued",enum:["Bearer"]},expires_in:{type:"number",description:"Lifetime in seconds of the access token"},refresh_token:{type:"string",description:"Refresh token, if issued"},scope:{type:"string",description:"Scopes granted by the access token"},id_token:{type:"string",description:"ID Token (if OpenID Connect)"}},required:["access_token","token_type","expires_in"]}}}},400:{description:"Invalid request or error response",content:{"application/json":{schema:{type:"object",properties:{error:{type:"string"},error_description:{type:"string"},error_uri:{type:"string"}},required:["error"]}}}}}}}},async e=>s2(e,n)),oauth2Introspect:n6("/oauth2/introspect",{method:"POST",body:iS.object({client_id:iS.string().optional(),client_secret:iS.string().optional(),token:iS.string(),token_type_hint:iS.enum(["access_token","refresh_token"]).optional()}),metadata:{allowedMediaTypes:["application/x-www-form-urlencoded"],openapi:{description:"Introspect an OAuth2 access or refresh token",requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{client_id:{type:"string",description:"OAuth2 client ID"},client_secret:{type:"string",description:"OAuth2 client secret"},token:{type:"string",description:"The token to introspect (access or refresh token)"},token_type_hint:{type:"string",enum:["access_token","refresh_token"],description:"Hint about the type of the token submitted for introspection"},resource:{type:"string",description:"Introspects a token for a specific resource."}},required:["token"]}}}},responses:{200:{description:"Token introspection response",content:{"application/json":{schema:{type:"object",properties:{active:{type:"boolean",description:"Whether the token is active"},scope:{type:"string",description:"Scopes associated with the token"},client_id:{type:"string",description:"Client ID associated with the token"},username:{type:"string",description:"Username associated with the token"},token_type:{type:"string",description:"Type of the token"},exp:{type:"number",description:"Expiration time of the token (seconds since epoch)"},iat:{type:"number",description:"Issued at time (seconds since epoch)"},nbf:{type:"number",description:"Not before time (seconds since epoch)"},sub:{type:"string",description:"Subject of the token"},aud:{type:"string",description:"Audience of the token"},iss:{type:"string",description:"Issuer of the token"},jti:{type:"string",description:"JWT ID"}},required:["active"]}}}},400:{description:"Invalid request or error response",content:{"application/json":{schema:{type:"object",properties:{error:{type:"string"},error_description:{type:"string"},error_uri:{type:"string"}},required:["error"]}}}}}}}},async e=>cd(e,n)),oauth2Revoke:n6("/oauth2/revoke",{method:"POST",body:iS.object({client_id:iS.string().optional(),client_secret:iS.string().optional(),token:iS.string(),token_type_hint:iS.enum(["access_token","refresh_token"]).optional()}),metadata:{allowedMediaTypes:["application/x-www-form-urlencoded"],openapi:{description:"Revoke an OAuth2 access or refresh token",requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{client_id:{type:"string",description:"OAuth2 client ID"},client_secret:{type:"string",description:"OAuth2 client secret"},token:{type:"string",description:"The token to revoke (access or refresh token)"},token_type_hint:{type:"string",enum:["access_token","refresh_token"],description:"Hint about the type of the token submitted for revocation"}},required:["token"]}}}},responses:{200:{description:"Token revoked successfully. The response body is empty.",content:{"application/json":{schema:{type:"object",description:"Empty object on success"}}}},400:{description:"Invalid request or error response",content:{"application/json":{schema:{type:"object",properties:{error:{type:"string"},error_description:{type:"string"},error_uri:{type:"string"}},required:["error"]}}}}}}}},async e=>cD(e,n)),oauth2UserInfo:n6("/oauth2/userinfo",{method:"GET",metadata:{openapi:{description:"Get OpenID Connect user information (UserInfo endpoint)",security:[{bearerAuth:[]},{OAuth2:["openid","profile","email"]}],parameters:[{name:"Authorization",in:"header",required:!1,schema:{type:"string"},description:"Bearer access token"}],responses:{200:{description:"User information retrieved successfully",content:{"application/json":{schema:{type:"object",properties:{sub:{type:"string",description:"Subject identifier (user ID)"},email:{type:"string",format:"email",nullable:!0,description:"User's email address, included if 'email' scope is granted"},name:{type:"string",nullable:!0,description:"User's full name, included if 'profile' scope is granted"},picture:{type:"string",format:"uri",nullable:!0,description:"User's profile picture URL, included if 'profile' scope is granted"},given_name:{type:"string",nullable:!0,description:"User's given name, included if 'profile' scope is granted"},family_name:{type:"string",nullable:!0,description:"User's family name, included if 'profile' scope is granted"},email_verified:{type:"boolean",nullable:!0,description:"Whether the email is verified, included if 'email' scope is granted"}},required:["sub"]}}}},401:{description:"Unauthorized - invalid or missing access token",content:{"application/json":{schema:{type:"object",properties:{error:{type:"string"},error_description:{type:"string"}},required:["error"]}}}},403:{description:"Forbidden - insufficient scope",content:{"application/json":{schema:{type:"object",properties:{error:{type:"string"},error_description:{type:"string"}},required:["error"]}}}}}}}},async e=>s1(e,n)),oauth2EndSession:n6("/oauth2/end-session",{method:"GET",query:iS.object({id_token_hint:iS.string(),client_id:iS.string().optional(),post_logout_redirect_uri:cg.optional(),state:iS.string().optional()}),metadata:{openapi:{description:"RP-Initiated Logout endpoint. Allows clients to notify the OP that the End-User has logged out.",responses:{200:{description:"Logout successful. May include redirect_uri if post_logout_redirect_uri was provided.",content:{"application/json":{schema:{type:"object",properties:{redirect_uri:{type:"string",format:"uri",description:"URI to redirect to after logout (if post_logout_redirect_uri was provided)"},message:{type:"string",description:"Success message"}}}}}}}}}},async e=>cl(e,n)),registerOAuthClient:n6("/oauth2/register",{method:"POST",body:iS.object({redirect_uris:iS.array(cg).min(1).min(1),scope:iS.string().optional(),client_name:iS.string().optional(),client_uri:iS.string().optional(),logo_uri:iS.string().optional(),contacts:iS.array(iS.string().min(1)).min(1).optional(),tos_uri:iS.string().optional(),policy_uri:iS.string().optional(),software_id:iS.string().optional(),software_version:iS.string().optional(),software_statement:iS.string().optional(),post_logout_redirect_uris:iS.array(cg).min(1).optional(),token_endpoint_auth_method:iS.enum(["none","client_secret_basic","client_secret_post"]).default("client_secret_basic").optional(),grant_types:iS.array(iS.enum(["authorization_code","client_credentials","refresh_token"])).default(["authorization_code"]).optional(),response_types:iS.array(iS.enum(["code"])).default(["code"]).optional(),type:iS.enum(["web","native","user-agent-based"]).optional()}),metadata:{openapi:{description:"Register an OAuth2 application",responses:{200:{description:"OAuth2 application registered successfully",content:{"application/json":{schema:{type:"object",properties:{client_id:{type:"string",description:"Unique identifier for the client"},client_secret:{type:"string",description:"Secret key for the client"},client_secret_expires_at:{type:"number",description:"Time the client secret will expire. If 0, the client secret will never expire."},scope:{type:"string",description:"Space-separated scopes allowed by the client"},user_id:{type:"string",description:"ID of the user who registered the client, null if registered anonymously"},client_id_issued_at:{type:"number",description:"Creation timestamp of this client"},client_name:{type:"string",description:"Name of the OAuth2 application"},client_uri:{type:"string",description:"Name of the OAuth2 application"},logo_uri:{type:"string",description:"Icon URL for the application"},contacts:{type:"array",items:{type:"string"},description:"List representing ways to contact people responsible for this client, typically email addresses"},tos_uri:{type:"string",description:"Client's terms of service uri"},policy_uri:{type:"string",description:"Client's policy uri"},software_id:{type:"string",description:"Unique identifier assigned by the developer to help in the dynamic registration process"},software_version:{type:"string",description:"Version identifier for the software_id"},software_statement:{type:"string",description:"JWT containing metadata values about the client software as claims"},redirect_uris:{type:"array",items:{type:"string",format:"uri"},description:"List of allowed redirect uris"},post_logout_redirect_uris:{type:"array",items:{type:"string",format:"uri"},description:"List of allowed logout redirect uris"},token_endpoint_auth_method:{type:"string",description:"Requested authentication method for the token endpoint",enum:["none","client_secret_basic","client_secret_post"]},grant_types:{type:"array",items:{type:"string",enum:["authorization_code","client_credentials","refresh_token"]},description:"Requested authentication method for the token endpoint"},response_types:{type:"array",items:{type:"string",enum:["code"]},description:"Requested authentication method for the token endpoint"},public:{type:"boolean",description:"Whether the client is public as determined by the type"},type:{type:"string",description:"Type of the client",enum:["web","native","user-agent-based"]},disabled:{type:"boolean",description:"Whether the client is disabled"}},required:["client_id"]}}}}}}}},async e=>cu(e,n)),adminCreateOAuthClient:n6("/admin/oauth2/create-client",{method:"POST",body:iS.object({redirect_uris:iS.array(cg).min(1),scope:iS.string().optional(),client_name:iS.string().optional(),client_uri:iS.string().optional(),logo_uri:iS.string().optional(),contacts:iS.array(iS.string().min(1)).min(1).optional(),tos_uri:iS.string().optional(),policy_uri:iS.string().optional(),software_id:iS.string().optional(),software_version:iS.string().optional(),software_statement:iS.string().optional(),post_logout_redirect_uris:iS.array(cg).min(1).optional(),token_endpoint_auth_method:iS.enum(["none","client_secret_basic","client_secret_post"]).default("client_secret_basic").optional(),grant_types:iS.array(iS.enum(["authorization_code","client_credentials","refresh_token"])).default(["authorization_code"]).optional(),response_types:iS.array(iS.enum(["code"])).default(["code"]).optional(),type:iS.enum(["web","native","user-agent-based"]).optional(),client_secret_expires_at:iS.union([iS.string(),iS.number()]).optional().default(0),skip_consent:iS.boolean().optional(),enable_end_session:iS.boolean().optional(),metadata:iS.record(iS.string(),iS.unknown()).optional()}),metadata:{SERVER_ONLY:!0,openapi:{description:"Register an OAuth2 application",responses:{200:{description:"OAuth2 application registered successfully",content:{"application/json":{schema:{type:"object",properties:{client_id:{type:"string",description:"Unique identifier for the client"},client_secret:{type:"string",description:"Secret key for the client"},client_secret_expires_at:{type:"number",description:"Time the client secret will expire. If 0, the client secret will never expire."},scope:{type:"string",description:"Space-separated scopes allowed by the client"},user_id:{type:"string",description:"ID of the user who registered the client, null if registered anonymously"},client_id_issued_at:{type:"number",description:"Creation timestamp of this client"},client_name:{type:"string",description:"Name of the OAuth2 application"},client_uri:{type:"string",description:"URI of the OAuth2 application"},logo_uri:{type:"string",description:"Icon URI for the application"},contacts:{type:"array",items:{type:"string"},description:"List representing ways to contact people responsible for this client, typically email addresses"},tos_uri:{type:"string",description:"Client's terms of service uri"},policy_uri:{type:"string",description:"Client's policy uri"},software_id:{type:"string",description:"Unique identifier assigned by the developer to help in the dynamic registration process"},software_version:{type:"string",description:"Version identifier for the software_id"},software_statement:{type:"string",description:"JWT containing metadata values about the client software as claims"},redirect_uris:{type:"array",items:{type:"string",format:"uri"},description:"List of allowed redirect uris"},token_endpoint_auth_method:{type:"string",description:"Requested authentication method for the token endpoint",enum:["none","client_secret_basic","client_secret_post"]},grant_types:{type:"array",items:{type:"string",enum:["authorization_code","client_credentials","refresh_token"]},description:"Requested authentication method for the token endpoint"},response_types:{type:"array",items:{type:"string",enum:["code"]},description:"Requested authentication method for the token endpoint"},public:{type:"boolean",description:"Whether the client is public as determined by the type"},type:{type:"string",description:"Type of the client",enum:["web","native","user-agent-based"]},disabled:{type:"boolean",description:"Whether the client is disabled"},metadata:{type:"object",additionalProperties:!0,nullable:!0,description:"Additional metadata for the application"}},required:["client_id"]}}}}}}}},async e=>ch(e,n,{isRegister:!1})),createOAuthClient:n6("/oauth2/create-client",{method:"POST",use:[oD],body:iS.object({redirect_uris:iS.array(cg).min(1),scope:iS.string().optional(),client_name:iS.string().optional(),client_uri:iS.string().optional(),logo_uri:iS.string().optional(),contacts:iS.array(iS.string().min(1)).min(1).optional(),tos_uri:iS.string().optional(),policy_uri:iS.string().optional(),software_id:iS.string().optional(),software_version:iS.string().optional(),software_statement:iS.string().optional(),post_logout_redirect_uris:iS.array(cg).min(1).optional(),token_endpoint_auth_method:iS.enum(["none","client_secret_basic","client_secret_post"]).default("client_secret_basic").optional(),grant_types:iS.array(iS.enum(["authorization_code","client_credentials","refresh_token"])).default(["authorization_code"]).optional(),response_types:iS.array(iS.enum(["code"])).default(["code"]).optional(),type:iS.enum(["web","native","user-agent-based"]).optional()}),metadata:{openapi:{description:"Register an OAuth2 application",responses:{200:{description:"OAuth2 application registered successfully",content:{"application/json":{schema:{type:"object",properties:{client_id:{type:"string",description:"Unique identifier for the client"},client_secret:{type:"string",description:"Secret key for the client"},client_secret_expires_at:{type:"number",description:"Time the client secret will expire. If 0, the client secret will never expire."},scope:{type:"string",description:"Space-separated scopes allowed by the client"},user_id:{type:"string",description:"ID of the user who registered the client, null if registered anonymously"},client_id_issued_at:{type:"number",description:"Creation timestamp of this client"},client_name:{type:"string",description:"Name of the OAuth2 application"},client_uri:{type:"string",description:"URI of the OAuth2 application"},logo_uri:{type:"string",description:"Icon URI for the application"},contacts:{type:"array",items:{type:"string"},description:"List representing ways to contact people responsible for this client, typically email addresses"},tos_uri:{type:"string",description:"Client's terms of service uri"},policy_uri:{type:"string",description:"Client's policy uri"},software_id:{type:"string",description:"Unique identifier assigned by the developer to help in the dynamic registration process"},software_version:{type:"string",description:"Version identifier for the software_id"},software_statement:{type:"string",description:"JWT containing metadata values about the client software as claims"},redirect_uris:{type:"array",items:{type:"string",format:"uri"},description:"List of allowed redirect uris"},token_endpoint_auth_method:{type:"string",description:"Response types the client may use",enum:["none","client_secret_basic","client_secret_post"]},grant_types:{type:"array",items:{type:"string",enum:["authorization_code","client_credentials","refresh_token"]},description:"Requested authentication method for the token endpoint"},response_types:{type:"array",items:{type:"string",enum:["code"]},description:"Requested authentication method for the token endpoint"},public:{type:"boolean",description:"Whether the client is public as determined by the type"},type:{type:"string",description:"Type of the client",enum:["web","native","user-agent-based"]},disabled:{type:"boolean",description:"Whether the client is disabled"},metadata:{type:"object",additionalProperties:!0,nullable:!0,description:"Additional metadata for the application"}},required:["client_id"]}}}}}}}},async e=>ch(e,n,{isRegister:!1})),getOAuthClient:n6("/oauth2/get-client",{method:"GET",use:[oD],query:iS.object({client_id:iS.string()}),metadata:{openapi:{description:"Get OAuth2 formatted client details"}}},async e=>cy(e,n)),getOAuthClientPublic:n6("/oauth2/public-client",{method:"GET",use:[oD],query:iS.object({client_id:iS.string()}),metadata:{openapi:{description:"Gets publically available client fields"}}},async e=>cw(e,n)),getOAuthClients:n6("/oauth2/get-clients",{method:"GET",use:[oD],metadata:{openapi:{description:"Get OAuth2 formatted client details for a user or organization"}}},async e=>cb(e,n)),adminUpdateOAuthClient:n6("/admin/oauth2/update-client",{method:"PATCH",body:iS.object({client_id:iS.string(),update:iS.object({redirect_uris:iS.array(cg).min(1).optional(),scope:iS.string().optional(),client_name:iS.string().optional(),client_uri:iS.string().optional(),logo_uri:iS.string().optional(),contacts:iS.array(iS.string().min(1)).min(1).optional(),tos_uri:iS.string().optional(),policy_uri:iS.string().optional(),software_id:iS.string().optional(),software_version:iS.string().optional(),software_statement:iS.string().optional(),post_logout_redirect_uris:iS.array(cg).min(1).optional(),grant_types:iS.array(iS.enum(["authorization_code","client_credentials","refresh_token"])).optional(),response_types:iS.array(iS.enum(["code"])).optional(),type:iS.enum(["web","native","user-agent-based"]).optional(),client_secret_expires_at:iS.union([iS.string(),iS.number()]).optional(),skip_consent:iS.boolean().optional(),enable_end_session:iS.boolean().optional(),metadata:iS.record(iS.string(),iS.unknown()).optional()})}),metadata:{SERVER_ONLY:!0,openapi:{description:"Updates OAuth2 formatted client details."}}},async e=>c_(e,n)),updateOAuthClient:n6("/oauth2/update-client",{method:"POST",use:[oD],body:iS.object({client_id:iS.string(),update:iS.object({redirect_uris:iS.array(cg).min(1).optional(),scope:iS.string().optional(),client_name:iS.string().optional(),client_uri:iS.string().optional(),logo_uri:iS.string().optional(),contacts:iS.array(iS.string().min(1)).min(1).optional(),tos_uri:iS.string().optional(),policy_uri:iS.string().optional(),software_id:iS.string().optional(),software_version:iS.string().optional(),software_statement:iS.string().optional(),post_logout_redirect_uris:iS.array(cg).min(1).optional(),grant_types:iS.array(iS.enum(["authorization_code","client_credentials","refresh_token"])).optional(),response_types:iS.array(iS.enum(["code"])).optional(),type:iS.enum(["web","native","user-agent-based"]).optional()})}),metadata:{openapi:{description:"Updates OAuth2 formatted client details."}}},async e=>c_(e,n)),rotateClientSecret:n6("/oauth2/client/rotate-secret",{method:"POST",use:[oD],body:iS.object({client_id:iS.string()}),metadata:{openapi:{description:"Rotates a confidential client's secret"}}},async e=>cA(e,n)),deleteOAuthClient:n6("/oauth2/delete-client",{method:"POST",use:[oD],body:iS.object({client_id:iS.string()}),metadata:{openapi:{description:"Deletes an oauth client"}}},async e=>cE(e,n)),getOAuthConsent:n6("/oauth2/get-consent",{method:"GET",query:iS.object({id:iS.string()}),use:[oD],metadata:{openapi:{description:"Gets details of a specific OAuth2 consent for a user"}}},async e=>cv(e,n)),getOAuthConsents:n6("/oauth2/get-consents",{method:"GET",use:[oD],metadata:{openapi:{description:"Gets all available OAuth2 consents for a user"}}},async e=>ck(e,n)),updateOAuthConsent:n6("/oauth2/update-consent",{method:"POST",use:[oD],body:iS.object({id:iS.string(),update:iS.object({scopes:iS.array(iS.string())})}),metadata:{openapi:{description:"Updates consent granted to a client."}}},async e=>cI(e,n)),deleteOAuthConsent:n6("/oauth2/delete-consent",{method:"POST",use:[oD],body:iS.object({id:iS.string()}),metadata:{openapi:{description:"Deletes consent granted to a client"}}},async e=>cR(e,n))},schema:ny(cC,n?.schema)}})({loginPage:"/auth",consentPage:"/consent",allowDynamicClientRegistration:!0,codeExpiresIn:600,accessTokenExpiresIn:3600,refreshTokenExpiresIn:604800,defaultScope:"openid profile",scopes:["openid","profile","email","offline_access"]}),{id:"next-cookies",hooks:{after:[{matcher:e=>!0,handler:n2(async t=>{let r=t.context.responseHeaders;if((!("_flag"in t)||"router"!==t._flag)&&r instanceof Headers){let t,i=r?.get("set-cookie");if(!i)return;let n=nO(i),{cookies:o}=await e.A(29037);try{t=await o()}catch(e){if(e instanceof Error&&e.message.startsWith("`cookies` was called outside a request scope."))return;throw e}n.forEach((e,r)=>{if(!r)return;let i={sameSite:e.samesite,secure:e.secure,maxAge:e["max-age"],httpOnly:e.httponly,domain:e.domain,path:e.path};try{t.set(r,decodeURIComponent(e.value),i)}catch{}});return}})}]}}],session:{storeSessionInDatabase:!0,cookieCache:{enabled:!0,maxAge:300}},advanced:{useSecureCookies:!1,defaultCookieAttributes:{sameSite:"lax",secure:!1,httpOnly:!0,path:"/"}},trustedOrigins:[lg,"http://localhost:4200","http://localhost:3000","http://localhost:5173"]},c7),lb=lw?lw.handler:()=>N.NextResponse.json({error:"Better Auth not configured - DATABASE_URL not set"},{status:503});e.s(["GET",0,lb,"POST",0,lb],82007);var lE=e.i(82007);let l_=new y.AppRouteRouteModule({definition:{kind:w.RouteKind.APP_ROUTE,page:"/api/auth/[...all]/route",pathname:"/api/auth/[...all]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/web/src/app/api/auth/[...all]/route.ts",nextConfigOutput:"standalone",userland:lE}),{workAsyncStorage:lA,workUnitAsyncStorage:lT,serverHooks:lv}=l_;function lk(){return(0,b.patchFetch)({workAsyncStorage:lA,workUnitAsyncStorage:lT})}async function lR(e,t,r){l_.isDev&&(0,E.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/auth/[...all]/route";i=i.replace(/\/index$/,"")||"/";let n=await l_.prepare(e,t,{srcPage:i,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:o,params:a,nextConfig:s,parsedUrl:c,isDraftMode:d,prerenderManifest:l,routerServerContext:u,isOnDemandRevalidate:p,revalidateOnlyGenerated:h,resolvedPathname:f,clientReferenceManifest:m,serverActionsManifest:g}=n,y=(0,T.normalizeAppPath)(i),b=!!(l.dynamicRoutes[y]||l.routes[f]),N=async()=>((null==u?void 0:u.render404)?await u.render404(e,t,c,!1):t.end("This page could not be found"),null);if(b&&!d){let e=!!l.routes[f],t=l.dynamicRoutes[y];if(t&&!1===t.fallback&&!e){if(s.experimental.adapterPath)return await N();throw new D.NoFallbackError}}let P=null;!b||l_.isDev||d||(P="/index"===(P=f)?"/":P);let L=!0===l_.isDev||!b,j=b&&!L;g&&m&&(0,A.setManifestsSingleton)({page:i,clientReferenceManifest:m,serverActionsManifest:g});let q=e.method||"GET",B=(0,_.getTracer)(),H=B.getActiveScopeSpan(),$={params:a,prerenderManifest:l,renderOpts:{experimental:{authInterrupts:!!s.experimental.authInterrupts},cacheComponents:!!s.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,E.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:s.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i,n)=>l_.onRequestError(e,t,i,n,u)},sharedContext:{buildId:o}},M=new v.NodeNextRequest(e),z=new v.NodeNextResponse(t),V=k.NextRequestAdapter.fromNodeNextRequest(M,(0,k.signalFromNodeResponse)(t));try{let n=async e=>l_.handle(V,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==R.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${q} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${i}`)}),o=!!(0,E.getRequestMeta)(e,"minimalMode"),a=async a=>{var c,f;let m=async({previousCacheEntry:s})=>{try{if(!o&&p&&h&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await n(a);e.fetchMetrics=$.renderOpts.fetchMetrics;let c=$.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let d=$.renderOpts.collectedTags;if(!b)return await (0,S.sendResponse)(M,z,i,$.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,x.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[O.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=O.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,n=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=O.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:C.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==s?void 0:s.isStale)&&await l_.onRequestError(e,t,{routerKind:"App Router",routePath:i,routeType:"route",revalidateReason:(0,I.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:p})},!1,u),t}},g=await l_.handleResponse({req:e,nextConfig:s,cacheKey:P,routeKind:w.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:l,isRoutePPREnabled:!1,isOnDemandRevalidate:p,revalidateOnlyGenerated:h,responseGenerator:m,waitUntil:r.waitUntil,isMinimalMode:o});if(!b)return null;if((null==g||null==(c=g.value)?void 0:c.kind)!==C.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==g||null==(f=g.value)?void 0:f.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",p?"REVALIDATED":g.isMiss?"MISS":g.isStale?"STALE":"HIT"),d&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,x.fromNodeOutgoingHttpHeaders)(g.value.headers);return o&&b||y.delete(O.NEXT_CACHE_TAGS_HEADER),!g.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,U.getCacheControlHeader)(g.cacheControl)),await (0,S.sendResponse)(M,z,new Response(g.value.body,{headers:y,status:g.value.status||200})),null};H?await a(H):await B.withPropagatedContext(e.headers,()=>B.trace(R.BaseServerSpan.handleRequest,{spanName:`${q} ${i}`,kind:_.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},a))}catch(t){if(t instanceof D.NoFallbackError||await l_.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,I.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:p})},!1,u),b)throw t;return await (0,S.sendResponse)(M,z,new Response(null,{status:500})),null}}e.s(["handler",()=>lR,"patchFetch",()=>lk,"routeModule",()=>l_,"serverHooks",()=>lv,"workAsyncStorage",()=>lA,"workUnitAsyncStorage",()=>lT],47320)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__7be6b09e._.js.map