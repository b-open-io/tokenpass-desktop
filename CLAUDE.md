# CLAUDE.md

This file provides guidance to Claude Code when working with this repository.

## Project Overview

TokenPass Desktop is an Electron-based system tray application that bundles and runs the TokenPass identity server locally.

## Commands

```bash
bun install              # Install dependencies
bun start                # Run the app in dev mode
bun run build            # Build all platforms (macOS, Windows, Linux)
bun run build:mac        # macOS universal (arm64 + x64)
bun run build:mac:arm64  # macOS Apple Silicon only
bun run build:mac:x64    # macOS Intel only
bun run build:win        # Windows x64
bun run build:linux      # Linux x64
```

## Architecture

- **index.js** - Main Electron process:
  - Spawns the bundled Next.js standalone server (`node server.js`)
  - Creates system tray with Dashboard/Exit menu
  - Handles deep links (`sigmaauth://`, `tokenpass://`) for OAuth callbacks
  - Opens browser to http://localhost:21000 after server starts
  - Auto-update checking with user prompts (electron-updater)
  - Kills server process on app quit

- **server/** - Bundled Next.js standalone server (from tokenpass-server)
- **extraResources/icon.png** - Tray icon
- **build/entitlements.mac.plist** - macOS entitlements for hardened runtime
- **scripts/notarize.js** - Apple notarization after signing

Key behaviors:
- Singleton lock ensures only one instance runs
- Hides from dock on macOS (tray-only app)
- Server runs on port 21000
- Auto-updates: checks on launch, prompts user to download/install

## Code Signing & Notarization

macOS builds require these environment variables:
- `APPLE_ID` - Apple Developer account email
- `APPLE_APP_SPECIFIC_PASSWORD` - App-specific password from appleid.apple.com
- `APPLE_TEAM_ID` - Team ID from developer.apple.com
- `CSC_LINK` - Base64-encoded .p12 certificate
- `CSC_KEY_PASSWORD` - Certificate password

Windows signing (optional):
- `WIN_CSC_LINK` - Base64-encoded .pfx certificate
- `WIN_CSC_KEY_PASSWORD` - Certificate password

Without credentials, builds are unsigned (will trigger Gatekeeper/SmartScreen warnings).

## CI/CD

GitHub Actions workflow (`.github/workflows/release.yml`) triggers on version tags:

```bash
git tag v0.0.3
git push origin v0.0.3
```

This builds for all platforms in parallel, signs/notarizes, and creates a GitHub Release.

Required GitHub Secrets: `APPLE_ID`, `APPLE_APP_SPECIFIC_PASSWORD`, `APPLE_TEAM_ID`, `CSC_LINK`, `CSC_KEY_PASSWORD`

## Updating the Bundled Server

When tokenpass-server changes, rebuild and copy it:

```bash
# In tokenpass-server/web (must have output: "standalone" in next.config.ts)
bun run build

# In tokenpass-desktop
rm -rf server && mkdir -p server
cp -r ~/code/tokenpass-server/web/.next/standalone/* server/
cp -r ~/code/tokenpass-server/web/.next/static server/web/.next/
cp -r ~/code/tokenpass-server/web/public server/web/
```

## Auto-Updates

Uses electron-updater with GitHub Releases as the update source. Updates are:
1. Checked 5 seconds after app launch
2. User is prompted before downloading
3. User is prompted before installing (restart required)

The `publish` config in package.json points to `b-open-io/tokenpass-desktop`.

## Creating a Release

Follow these steps for every release:

### 1. Update Version

```bash
# Bump version in package.json (patch/minor/major)
npm version patch  # 0.0.3 -> 0.0.4
# or manually edit package.json
```

### 2. Commit Changes

```bash
git add -A
git commit -m "Release v0.0.X"
git push origin main
```

### 3. Create and Push Tag

```bash
git tag v0.0.X
git push origin v0.0.X
```

### 4. Monitor Build

Watch the build at: https://github.com/b-open-io/tokenpass-desktop/actions

### 5. Edit Release Notes

Once the release is created, edit it at: https://github.com/b-open-io/tokenpass-desktop/releases

Use this template:

```markdown
## What's New

- Feature or fix description

## Installation

### macOS
- **Apple Silicon (M1/M2/M3)**: Download `TokenPass-X.X.X-arm64.dmg`
- **Intel**: Download `TokenPass-X.X.X-x64.dmg`

### Windows
- Download `TokenPass Setup X.X.X.exe`

### Linux
- Download `TokenPass-X.X.X.AppImage`

## Checksums
<auto-generated by build>
```

### Release Naming Convention

- Tag format: `vX.X.X` (e.g., `v0.0.3`)
- Release title: `TokenPass Desktop vX.X.X`
- Always include platform-specific download instructions

## BSV Protocols

- **Type42 (BRC-42/BRC-43)** - Key derivation
- **BAP** - Bitcoin Attestation Protocol
- **BSM** - Bitcoin Signed Message
- **ECIES** - Encryption
